import{u as H,a as G,s as L,j as e}from"./index-CZDbzh2k.js";import{d as J,j as K,r as g}from"./vendor-CITejod9.js";import{i as z,e as T}from"./template-sharing-_gF8X_dF.js";import{T as Q}from"./template-saved-dialog-CDwbacER.js";import"./supabase-vtL5VWMt.js";import"./charts-D-QCyllA.js";import"./use-modal-scroll-lock-CmZrgGCz.js";function A(a){return Array.isArray(a)?a.map((n,s)=>({name:typeof n.name=="string"?n.name.trim():"",sets:typeof n.sets=="number"?n.sets:0,reps:typeof n.reps=="string"?n.reps.trim():"",rest_seconds:typeof n.rest_seconds=="number"?n.rest_seconds:0,position:typeof n.position=="number"?n.position:s+1})).sort((n,s)=>n.position!==s.position?n.position-s.position:n.name.localeCompare(s.name)):[]}function M(a){return{name:typeof a.name=="string"?a.name.trim():"",exercises:A(a.exercises)}}function q(a){return{name:typeof(a==null?void 0:a.name)=="string"?a.name.trim():"",exercises:A(a==null?void 0:a.template_exercises)}}function R(a,n){if(a.name!==n.name||a.exercises.length!==n.exercises.length)return!1;for(let s=0;s<a.exercises.length;s++){const d=a.exercises[s],l=n.exercises[s];if(d.name!==l.name||d.sets!==l.sets||d.reps!==l.reps||d.rest_seconds!==l.rest_seconds||d.position!==l.position)return!1}return!0}function E(a){return typeof a=="string"?a.trim().toLowerCase():""}const ae=()=>{const{user:a}=H(),n=J(),{t:s}=G(),[d]=K(),[l,j]=g.useState(null),[I,c]=g.useState(null),[h,v]=g.useState(!1),[k,F]=g.useState(!1),[$,b]=g.useState(!1),[V,w]=g.useState(null),[W,y]=g.useState("error"),[x,N]=g.useState(null);g.useEffect(()=>{(async()=>{const r=d.get("s"),i=d.get("data");if(!(!r&&!i))try{const m=window.location.href,p=await T(m);if(p){if(await _(p)){j(null),c(null);return}j(p),c(null)}else c(s.templateImport.invalidLink)}catch(m){c(m.message||s.templateImport.loadError)}})()},[d]),g.useEffect(()=>{const t=d.get("s"),r=d.get("data");!t&&!r&&!l&&!I&&C()},[d,l,I]);const C=async()=>{F(!0);try{if(!navigator.clipboard||!navigator.clipboard.readText)throw new Error(s.templateImport.clipboardNoAccess);const t=await navigator.clipboard.readText();if(z(t)){const r=await T(t);if(r){if(await _(r)){j(null),c(null);return}j(r),c(null)}else c(s.templateImport.clipboardInvalidLink)}else c(s.templateImport.clipboardNoLink)}catch(t){t.name==="NotAllowedError"?c(s.templateImport.clipboardPermissionDenied):c(s.templateImport.clipboardReadError+t.message)}finally{F(!1)}},_=async t=>{if(!a)return!1;try{const r=L,{data:i,error:m}=await r.from("workout_templates").select(`
          id,
          name,
          template_exercises (
            id,
            name,
            sets,
            reps,
            rest_seconds,
            position
          )
        `).eq("user_id",a.id);if(m)return console.error("Error checking existing templates before preview:",m),y("error"),w(s.templateImport.checkExistingError),b(!0),!1;if(i&&i.length>0){const p=M(t);let o=null;for(const f of i){const u=q(f);if(R(u,p))return y("error"),w(s.templateImport.duplicateExists),b(!0),!0;!o&&E(f.name)===E(t.name)&&(o=f)}o&&N({existingId:o.id,existingName:o.name||"",existingExercises:o.template_exercises||[],newTemplate:t})}return!1}catch(r){return console.error("Unexpected error while checking templates before preview:",r),y("error"),w(s.templateImport.checkExistingError),b(!0),!1}},S=async(t,r)=>{if(!a||!l)return;const i=L;if(t){const{error:u}=await i.from("template_exercises").delete().eq("template_id",t);if(u)throw u;const{error:P}=await i.from("workout_templates").delete().eq("id",t);if(P)throw P}const{data:m,error:p}=await i.from("workout_templates").insert({user_id:a.id,name:typeof r=="string"&&r.trim().length>0?r.trim():l.name}).select().single();if(p||!m)throw p||new Error(s.templateImport.createError);const o=l.exercises.map(u=>({template_id:m.id,name:u.name,sets:u.sets,reps:u.reps,rest_seconds:u.rest_seconds,position:u.position})),{error:f}=await i.from("template_exercises").insert(o);if(f)throw await i.from("workout_templates").delete().eq("id",m.id),f;n("/templates",{state:{message:s.templateImport.importSuccess.replace("{name}",l.name)}})},B=async()=>{if(!(!a||!l||h)){v(!0);try{const t=L,{data:r,error:i}=await t.from("workout_templates").select(`
          id,
          name,
          template_exercises (
            id,
            name,
            sets,
            reps,
            rest_seconds,
            position
          )
        `).eq("user_id",a.id);if(i){console.error("Error checking existing templates before import:",i),y("error"),w(s.templateImport.checkExistingError),b(!0);return}if(r&&r.length>0){const m=M(l);let p=!1,o=null;for(const f of r){const u=q(f);if(!o&&E(f.name)===E(l.name)&&(o=f),R(u,m)){p=!0;break}}if(p){y("error"),w(s.templateImport.duplicateExists),b(!0);return}if(o){N({existingId:o.id,existingName:o.name||"",existingExercises:o.template_exercises||[],newTemplate:l});return}}await S()}catch(t){console.error("Error importing template:",t),alert(s.templateImport.importError+((t==null?void 0:t.message)||String(t)))}finally{v(!1)}}},O=async()=>{if(!x||!a||!l){N(null);return}v(!0);try{const t=x.existingId;N(null),await S(t)}catch(t){console.error("Error replacing template:",t),y("error"),w(s.templateImport.replaceError),b(!0)}finally{v(!1)}},U=async()=>{var t;if(!x||!a||!l){N(null);return}v(!0);try{const r=typeof((t=x.newTemplate)==null?void 0:t.name)=="string"?x.newTemplate.name.trim():"",i=r?`${r} (1)`:`${s.templateImport.newTemplateName} (1)`;N(null),await S(void 0,i)}catch(r){console.error("Error creating new template with same name:",r),y("error"),w(s.templateImport.createNewError),b(!0)}finally{v(!1)}},D=async()=>{const t=window.prompt(s.templateImport.pastePrompt);if(!t)return;if(!z(t)){c(s.templateImport.invalidPastedLink);return}const r=await T(t);if(r){if(await _(r)){j(null),c(null);return}j(r),c(null)}else c(s.templateImport.extractError)};return a?e.jsxs("div",{className:"p-4 max-w-lg mx-auto",children:[e.jsxs("div",{className:"mb-4 glass card-dark p-4 flex items-center gap-4",children:[e.jsx("button",{onClick:()=>n("/templates"),className:"shrink-0 p-2 rounded-full border border-transparent text-white hover:border-white transition-colors",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("h1",{className:"text-2xl font-bold text-center flex-1",children:s.templateImport.title})]}),k&&e.jsx("div",{className:"glass card-dark p-8 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white text-center",children:s.templateImport.checkingClipboard})]})}),I&&!k&&e.jsxs("div",{className:"glass card-dark p-6 rounded-xl mb-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-red-400 shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("p",{className:"text-red-300",children:I})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:C,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:s.templateImport.checkClipboardAgain}),e.jsx("button",{onClick:D,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary",children:s.templateImport.pasteManually})]})]}),l&&!k&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"glass card-dark p-6 rounded-xl",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:l.name}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-gray-300",children:[s.templateImport.exercisesCount,": ",e.jsx("span",{className:"font-semibold text-white",children:l.exercises.length})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-400 mb-2",children:s.templateImport.exercisesList}),e.jsx("div",{className:"space-y-2",children:l.exercises.map((t,r)=>e.jsxs("div",{className:"text-sm text-gray-300 pl-4 border-l-2 border-white/20",children:[e.jsx("div",{className:"font-medium text-white",children:t.name}),e.jsx("div",{className:"text-xs text-gray-400",children:s.templateImport.setsReps.replace("{sets}",String(t.sets)).replace("{reps}",t.reps).replace("{rest}",String(t.rest_seconds))})]},r))})]})]})]}),e.jsx("button",{onClick:B,disabled:h,className:"btn-glass btn-glass-full btn-glass-lg btn-glass-primary disabled:opacity-50",children:h?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),e.jsx("span",{children:s.templateImport.importing})]}):s.templateImport.addTemplate}),e.jsx("button",{onClick:()=>n("/templates"),disabled:h,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary disabled:opacity-50",children:s.templateImport.cancel})]}),!l&&!I&&!k&&e.jsxs("div",{className:"glass card-dark p-8 rounded-xl text-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto mb-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("p",{className:"text-gray-400 mb-4",children:s.templateImport.copyLinkHint}),e.jsx("button",{onClick:C,className:"btn-glass btn-glass-md btn-glass-primary",children:s.templateImport.importFromClipboard}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:D,className:"btn-glass btn-glass-md btn-glass-secondary",children:s.templateImport.pasteManually})})]}),x&&e.jsxs("div",{className:"fixed inset-0 z-100 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>{h||N(null)}}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5 space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h2",{className:"text-lg font-semibold text-white text-center",children:s.templateImport.conflictTitle}),e.jsx("p",{className:"text-sm text-gray-300 text-center",children:s.templateImport.conflictDesc.replace("{name}",x.existingName||s.templateImport.noName)}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-200 mb-1",children:s.templateImport.existing}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:x.existingExercises.slice().sort((t,r)=>{const i=typeof t.position=="number"?t.position:0,m=typeof r.position=="number"?r.position:0;if(i!==m)return i-m;const p=typeof t.name=="string"?t.name:"",o=typeof r.name=="string"?r.name:"";return p.localeCompare(o)}).map((t,r)=>e.jsxs("div",{className:"text-xs text-gray-300 pl-3 border-l border-white/10",children:[e.jsx("div",{className:"font-medium text-white",children:t.name||s.templateImport.noName}),e.jsx("div",{className:"text-[11px] text-gray-400",children:s.templateImport.setsReps.replace("{sets}",String(typeof t.sets=="number"?t.sets:"-")).replace("{reps}",typeof t.reps=="string"?t.reps:"-").replace("{rest}",String(typeof t.rest_seconds=="number"?t.rest_seconds:"-"))})]},t.id??`${t.name||"exercise"}-${r}`))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-200 mb-1",children:s.templateImport.fromLink}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:x.newTemplate.exercises.slice().sort((t,r)=>t.position!==r.position?t.position-r.position:t.name.localeCompare(r.name)).map((t,r)=>e.jsxs("div",{className:"text-xs text-gray-300 pl-3 border-l border-white/10",children:[e.jsx("div",{className:"font-medium text-white",children:t.name||s.templateImport.noName}),e.jsx("div",{className:"text-[11px] text-gray-400",children:s.templateImport.setsReps.replace("{sets}",String(t.sets)).replace("{reps}",t.reps).replace("{rest}",String(t.rest_seconds))})]},`${t.name||"new-exercise"}-${r}`))})]})]}),e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx("button",{type:"button",onClick:O,disabled:h,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary disabled:opacity-50",children:h?s.templateImport.replacing:s.templateImport.replaceExisting}),e.jsxs("button",{type:"button",onClick:U,disabled:h,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary disabled:opacity-50",children:[s.templateImport.createNew,' ("',x.newTemplate.name,'" â†’ "',x.newTemplate.name,' (1)")']}),e.jsx("button",{type:"button",onClick:()=>N(null),disabled:h,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary disabled:opacity-50",children:s.templateImport.cancel})]})]})]}),e.jsx(Q,{open:$,onOpenChange:t=>{t||(b(!1),w(null))},onClose:()=>{b(!1),w(null)},message:V||s.templateImport.importError,variant:W})]}):e.jsx("div",{className:"p-4 max-w-lg mx-auto",children:e.jsxs("div",{className:"glass card-dark p-8 rounded-xl text-center",children:[e.jsx("p",{className:"text-gray-300 mb-4",children:s.templateImport.loginRequired}),e.jsx("button",{onClick:()=>n("/login"),className:"btn-glass btn-glass-md btn-glass-primary",children:s.templateImport.login})]})})};export{ae as default};
