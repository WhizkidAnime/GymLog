import{u as R,s as F,j as e}from"./index-CW2QqWzm.js";import{e as H,k as G,r as h}from"./vendor-BVca5W6X.js";import{i as z,e as T}from"./template-sharing-B-cLh6OM.js";import{T as J}from"./template-saved-dialog-DZ-J6BE7.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";import"./use-modal-scroll-lock-DlG-D3y9.js";function $(r){return Array.isArray(r)?r.map((a,o)=>({name:typeof a.name=="string"?a.name.trim():"",sets:typeof a.sets=="number"?a.sets:0,reps:typeof a.reps=="string"?a.reps.trim():"",rest_seconds:typeof a.rest_seconds=="number"?a.rest_seconds:0,position:typeof a.position=="number"?a.position:o+1})).sort((a,o)=>a.position!==o.position?a.position-o.position:a.name.localeCompare(o.name)):[]}function P(r){return{name:typeof r.name=="string"?r.name.trim():"",exercises:$(r.exercises)}}function M(r){return{name:typeof(r==null?void 0:r.name)=="string"?r.name.trim():"",exercises:$(r==null?void 0:r.template_exercises)}}function q(r,a){if(r.name!==a.name||r.exercises.length!==a.exercises.length)return!1;for(let o=0;o<r.exercises.length;o++){const n=r.exercises[o],p=a.exercises[o];if(n.name!==p.name||n.sets!==p.sets||n.reps!==p.reps||n.rest_seconds!==p.rest_seconds||n.position!==p.position)return!1}return!0}function C(r){return typeof r=="string"?r.trim().toLowerCase():""}const te=()=>{const{user:r}=R(),a=H(),[o]=G(),[n,p]=h.useState(null),[v,m]=h.useState(null),[g,N]=h.useState(!1),[k,S]=h.useState(!1),[A,b]=h.useState(!1),[V,w]=h.useState(null),[W,y]=h.useState("error"),[x,j]=h.useState(null);h.useEffect(()=>{(async()=>{const t=o.get("s"),i=o.get("data");if(!(!t&&!i))try{const c=window.location.href,d=await T(c);if(d){if(await E(d)){p(null),m(null);return}p(d),m(null)}else m("Неверный формат ссылки на шаблон")}catch(c){m(c.message||"Не удалось загрузить шаблон из ссылки")}})()},[o]),h.useEffect(()=>{const s=o.get("s"),t=o.get("data");!s&&!t&&!n&&!v&&_()},[o,n,v]);const _=async()=>{S(!0);try{if(!navigator.clipboard||!navigator.clipboard.readText)throw new Error("Clipboard API недоступен в этом окружении");const s=await navigator.clipboard.readText();if(z(s)){const t=await T(s);if(t){if(await E(t)){p(null),m(null);return}p(t),m(null)}else m("В буфере обмена ссылка неверного формата")}else m("В буфере обмена нет ссылки на шаблон. Скопируйте ссылку и попробуйте снова.")}catch(s){s.name==="NotAllowedError"?m("Нет доступа к буферу обмена. Вставьте ссылку вручную."):m("Не удалось прочитать буфер обмена: "+s.message)}finally{S(!1)}},E=async s=>{if(!r)return!1;try{const t=F,{data:i,error:c}=await t.from("workout_templates").select(`
          id,
          name,
          template_exercises (
            id,
            name,
            sets,
            reps,
            rest_seconds,
            position
          )
        `).eq("user_id",r.id);if(c)return console.error("Error checking existing templates before preview:",c),y("error"),w("Не удалось проверить существующие шаблоны перед импортом. Попробуйте ещё раз."),b(!0),!1;if(i&&i.length>0){const d=P(s);let l=null;for(const f of i){const u=M(f);if(q(u,d))return y("error"),w("Такой шаблон уже есть в списке. Импорт по ссылке отменён."),b(!0),!0;!l&&C(f.name)===C(s.name)&&(l=f)}l&&j({existingId:l.id,existingName:l.name||"",existingExercises:l.template_exercises||[],newTemplate:s})}return!1}catch(t){return console.error("Unexpected error while checking templates before preview:",t),y("error"),w("Не удалось проверить существующие шаблоны перед импортом. Попробуйте ещё раз."),b(!0),!1}},I=async(s,t)=>{if(!r||!n)return;const i=F;if(s){const{error:u}=await i.from("template_exercises").delete().eq("template_id",s);if(u)throw u;const{error:D}=await i.from("workout_templates").delete().eq("id",s);if(D)throw D}const{data:c,error:d}=await i.from("workout_templates").insert({user_id:r.id,name:typeof t=="string"&&t.trim().length>0?t.trim():n.name}).select().single();if(d||!c)throw d||new Error("Не удалось создать шаблон");const l=n.exercises.map(u=>({template_id:c.id,name:u.name,sets:u.sets,reps:u.reps,rest_seconds:u.rest_seconds,position:u.position})),{error:f}=await i.from("template_exercises").insert(l);if(f)throw await i.from("workout_templates").delete().eq("id",c.id),f;a("/templates",{state:{message:`Шаблон "${n.name}" успешно импортирован!`}})},B=async()=>{if(!(!r||!n||g)){N(!0);try{const s=F,{data:t,error:i}=await s.from("workout_templates").select(`
          id,
          name,
          template_exercises (
            id,
            name,
            sets,
            reps,
            rest_seconds,
            position
          )
        `).eq("user_id",r.id);if(i){console.error("Error checking existing templates before import:",i),y("error"),w("Не удалось проверить существующие шаблоны перед импортом. Попробуйте ещё раз."),b(!0);return}if(t&&t.length>0){const c=P(n);let d=!1,l=null;for(const f of t){const u=M(f);if(!l&&C(f.name)===C(n.name)&&(l=f),q(u,c)){d=!0;break}}if(d){y("error"),w("Такой шаблон уже есть в списке. Импорт по ссылке отменён."),b(!0);return}if(l){j({existingId:l.id,existingName:l.name||"",existingExercises:l.template_exercises||[],newTemplate:n});return}}await I()}catch(s){console.error("Error importing template:",s),alert("Не удалось импортировать шаблон: "+((s==null?void 0:s.message)||String(s)))}finally{N(!1)}}},O=async()=>{if(!x||!r||!n){j(null);return}N(!0);try{const s=x.existingId;j(null),await I(s)}catch(s){console.error("Error replacing template:",s),y("error"),w("Не удалось заменить существующий шаблон. Попробуйте ещё раз."),b(!0)}finally{N(!1)}},U=async()=>{var s;if(!x||!r||!n){j(null);return}N(!0);try{const t=typeof((s=x.newTemplate)==null?void 0:s.name)=="string"?x.newTemplate.name.trim():"",i=t?`${t} (1)`:"Новый шаблон (1)";j(null),await I(void 0,i)}catch(t){console.error("Error creating new template with same name:",t),y("error"),w("Не удалось создать новый шаблон. Попробуйте ещё раз."),b(!0)}finally{N(!1)}},L=async()=>{const s=window.prompt("Вставьте ссылку на шаблон из буфера обмена");if(!s)return;if(!z(s)){m("Вставленный текст не является валидной ссылкой на шаблон");return}const t=await T(s);if(t){if(await E(t)){p(null),m(null);return}p(t),m(null)}else m("Не удалось извлечь шаблон из ссылки")};return r?e.jsxs("div",{className:"p-4 max-w-lg mx-auto",children:[e.jsxs("div",{className:"mb-4 glass card-dark p-4 flex items-center gap-4",children:[e.jsx("button",{onClick:()=>a("/templates"),className:"shrink-0 p-2 rounded-full border border-transparent text-white hover:border-white transition-colors",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("h1",{className:"text-2xl font-bold text-center flex-1",children:"Импорт шаблона"})]}),k&&e.jsx("div",{className:"glass card-dark p-8 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white text-center",children:"Проверка буфера обмена..."})]})}),v&&!k&&e.jsxs("div",{className:"glass card-dark p-6 rounded-xl mb-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-red-400 shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("p",{className:"text-red-300",children:v})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:_,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:"Проверить буфер снова"}),e.jsx("button",{onClick:L,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary",children:"Вставить ссылку вручную"})]})]}),n&&!k&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"glass card-dark p-6 rounded-xl",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:n.name}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-gray-300",children:["Упражнений: ",e.jsx("span",{className:"font-semibold text-white",children:n.exercises.length})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-400 mb-2",children:"Упражнения:"}),e.jsx("div",{className:"space-y-2",children:n.exercises.map((s,t)=>e.jsxs("div",{className:"text-sm text-gray-300 pl-4 border-l-2 border-white/20",children:[e.jsx("div",{className:"font-medium text-white",children:s.name}),e.jsxs("div",{className:"text-xs text-gray-400",children:[s.sets," подходов × ",s.reps," повторов • Отдых: ",s.rest_seconds,"с"]})]},t))})]})]})]}),e.jsx("button",{onClick:B,disabled:g,className:"btn-glass btn-glass-full btn-glass-lg btn-glass-primary disabled:opacity-50",children:g?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),e.jsx("span",{children:"Импорт..."})]}):"Добавить шаблон"}),e.jsx("button",{onClick:()=>a("/templates"),disabled:g,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary disabled:opacity-50",children:"Отменить"})]}),!n&&!v&&!k&&e.jsxs("div",{className:"glass card-dark p-8 rounded-xl text-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto mb-4 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("p",{className:"text-gray-400 mb-4",children:"Скопируйте ссылку на шаблон и нажмите кнопку ниже"}),e.jsx("button",{onClick:_,className:"btn-glass btn-glass-md btn-glass-primary",children:"Импортировать из буфера"}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:L,className:"btn-glass btn-glass-md btn-glass-secondary",children:"Вставить ссылку вручную"})})]}),x&&e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:()=>{g||j(null)}}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5 space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h2",{className:"text-lg font-semibold text-white text-center",children:"Шаблон с таким названием уже существует"}),e.jsxs("p",{className:"text-sm text-gray-300 text-center",children:["Текущий шаблон «",x.existingName||"Без названия","» отличается от шаблона из ссылки. Проверьте различия и выберите действие."]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-200 mb-1",children:"Существующий"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:x.existingExercises.slice().sort((s,t)=>{const i=typeof s.position=="number"?s.position:0,c=typeof t.position=="number"?t.position:0;if(i!==c)return i-c;const d=typeof s.name=="string"?s.name:"",l=typeof t.name=="string"?t.name:"";return d.localeCompare(l)}).map((s,t)=>e.jsxs("div",{className:"text-xs text-gray-300 pl-3 border-l border-white/10",children:[e.jsx("div",{className:"font-medium text-white",children:s.name||"Без названия"}),e.jsxs("div",{className:"text-[11px] text-gray-400",children:[typeof s.sets=="number"?s.sets:"-"," подходов ×"," ",typeof s.reps=="string"?s.reps:"-"," повторов • Отдых:"," ",typeof s.rest_seconds=="number"?s.rest_seconds:"-","с"]})]},s.id??`${s.name||"exercise"}-${t}`))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-200 mb-1",children:"Из ссылки"}),e.jsx("div",{className:"space-y-1 max-h-40 overflow-y-auto",children:x.newTemplate.exercises.slice().sort((s,t)=>s.position!==t.position?s.position-t.position:s.name.localeCompare(t.name)).map((s,t)=>e.jsxs("div",{className:"text-xs text-gray-300 pl-3 border-l border-white/10",children:[e.jsx("div",{className:"font-medium text-white",children:s.name||"Без названия"}),e.jsxs("div",{className:"text-[11px] text-gray-400",children:[s.sets," подходов × ",s.reps," повторов • Отдых: ",s.rest_seconds,"с"]})]},`${s.name||"new-exercise"}-${t}`))})]})]}),e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx("button",{type:"button",onClick:O,disabled:g,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary disabled:opacity-50",children:g?"Замена...":"Заменить существующий шаблон"}),e.jsxs("button",{type:"button",onClick:U,disabled:g,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary disabled:opacity-50",children:['Создать новый шаблон ("',x.newTemplate.name,'" → "',x.newTemplate.name,' (1)")']}),e.jsx("button",{type:"button",onClick:()=>j(null),disabled:g,className:"btn-glass btn-glass-full btn-glass-md btn-glass-secondary disabled:opacity-50",children:"Отменить"})]})]})]}),e.jsx(J,{open:A,onOpenChange:s=>{s||(b(!1),w(null))},onClose:()=>{b(!1),w(null)},message:V||"Не удалось импортировать шаблон.",variant:W})]}):e.jsx("div",{className:"p-4 max-w-lg mx-auto",children:e.jsxs("div",{className:"glass card-dark p-8 rounded-xl text-center",children:[e.jsx("p",{className:"text-gray-300 mb-4",children:"Войдите, чтобы импортировать шаблоны"}),e.jsx("button",{onClick:()=>a("/login"),className:"btn-glass btn-glass-md btn-glass-primary",children:"Войти"})]})})};export{te as default};
