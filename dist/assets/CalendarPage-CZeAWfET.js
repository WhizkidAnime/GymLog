import{u as P,a as R,s as z,j as s}from"./index-DnCyT_Hf.js";import{e as q,u as B,r as f,f as U}from"./vendor-BVca5W6X.js";import{u as V}from"./usePageState-6XNG0ilq.js";import{f as y,g as G,a as J,b as Q}from"./date-helpers-C_0boXDq.js";import{W as X}from"./workout-icons-BL1p9R4x.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const m=new Map,E=3e4,re=()=>{var M,_;const{user:n}=P(),Y=q(),{t:k,language:$}=R(),h=B(),[W,g]=V({key:"calendar-page",initialState:{currentDate:new Date,workouts:[],loading:!0,hasInitialData:!1},ttl:1800*1e3}),{currentDate:t,workouts:I,loading:S,hasInitialData:u}=W,T=e=>{g(a=>({...a,currentDate:e}))},D=e=>{g(a=>({...a,workouts:e}))},b=e=>{g(a=>({...a,loading:e}))},x=e=>{g(a=>({...a,hasInitialData:e}))},l=f.useCallback(async(e=!1,a=!1)=>{if(!n)return;const o=`${n.id}:${t.getFullYear()}-${t.getMonth()}`,r=Date.now();let p=a;if(m.has(o)){const i=m.get(o),c=r-i.timestamp;if(e&&c<E){u||(D(i.workouts),b(!1),x(!0));return}c>=E&&(u||(D(i.workouts),x(!0)),p=!0)}p||b(!0);const w=new Date(t.getFullYear(),t.getMonth(),1),d=new Date(t.getFullYear(),t.getMonth()+1,0),{data:K,error:C}=await z.from("workouts").select("id, workout_date, template_id, icon, workout_templates(icon)").eq("user_id",n.id).gte("workout_date",y(w)).lte("workout_date",y(d));if(C)console.error("Error fetching workouts:",C);else{const i=(K||[]).map(c=>{var F;return{...c,template_icon:((F=c.workout_templates)==null?void 0:F.icon)||null,workout_icon:c.icon||null}});D(i),m.set(o,{workouts:i,timestamp:r})}b(!1),x(!0)},[n,t,u]);f.useEffect(()=>{u||l()},[t.getFullYear(),t.getMonth(),n]),f.useEffect(()=>{var o;if(!n||!((o=h.state)==null?void 0:o.removedDate))return;const a=`${n.id}:${t.getFullYear()}-${t.getMonth()}`;m.delete(a),l(!1,!1)},[(M=h.state)==null?void 0:M.removedDate,n,t,l]),f.useEffect(()=>{var o;if(!n||!((o=h.state)==null?void 0:o.refreshDate))return;const a=`${n.id}:${t.getFullYear()}-${t.getMonth()}`;m.delete(a),l(!1,!1)},[(_=h.state)==null?void 0:_.refreshDate,n,t,l]),f.useEffect(()=>{const e=()=>{document.visibilityState==="visible"&&l(!0)};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[l]);const O=G(t),A=J(t),H=k.calendar.daysOfWeek,v=new Date,L=e=>{const a=new Date(t.getFullYear(),t.getMonth(),e);Y(`/workout/${y(a)}`)},j=e=>{const a=new Date(t.getFullYear(),t.getMonth()+e,1);T(a),x(!1)},N=new Map;return I.forEach(e=>N.set(e.workout_date,e)),s.jsx("div",{className:"px-4 pt-4 pb-4 w-full max-w-5xl mx-auto flex flex-col items-center",children:S&&!u?s.jsx("div",{className:"fixed inset-0 flex items-center justify-center",style:{background:"transparent"},children:s.jsxs("div",{className:"flex flex-col items-center gap-4",children:[s.jsx("div",{className:"relative w-12 h-12",children:s.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),s.jsx("p",{className:"text-white text-center",children:k.calendar.loading})]})}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex justify-between items-center mb-6 glass p-2 rounded-xl w-full max-w-xl",children:[s.jsx("button",{onClick:()=>j(-1),className:"p-2 rounded-full text-white transition-colors focus:outline-none",style:{WebkitTapHighlightColor:"transparent"},children:"<"}),s.jsx("h1",{className:"text-xl font-bold text-center capitalize",children:Q(t,$)}),s.jsx("button",{onClick:()=>j(1),className:"p-2 rounded-full text-white transition-colors focus:outline-none",style:{WebkitTapHighlightColor:"transparent"},children:">"})]}),s.jsx("div",{className:"grid grid-cols-7 gap-3 text-center text-sm text-gray-500 mb-3 w-full max-w-xl",children:H.map(e=>s.jsx("div",{children:e},e))}),s.jsxs("div",{className:"grid grid-cols-7 gap-x-2 gap-y-4 w-full max-w-xl",children:[Array.from({length:A}).map((e,a)=>s.jsx("div",{},`empty-${a}`)),Array.from({length:O},(e,a)=>a+1).map(e=>{const a=e===v.getDate()&&t.getMonth()===v.getMonth()&&t.getFullYear()===v.getFullYear(),o=y(new Date(t.getFullYear(),t.getMonth(),e)),r=N.get(o),p=!!r,w=(r==null?void 0:r.workout_icon)||(r==null?void 0:r.template_icon),d=w?X[w]:null;return s.jsxs("div",{onClick:()=>L(e),className:"relative flex flex-col items-center justify-center h-12 w-10 sm:h-13 sm:w-11 md:h-14 md:w-12 lg:h-16 lg:w-14 cursor-pointer mx-auto overflow-visible focus:outline-none",style:{WebkitTapHighlightColor:"transparent"},children:[s.jsx("span",{className:`flex items-center justify-center h-8 w-8 sm:h-9 sm:w-9 md:h-10 md:w-10 lg:h-12 lg:w-12 rounded-full font-bold calendar-day ${a?"bg-blue-600 calendar-day-today":""} transition-colors`,children:e}),p&&s.jsx("div",{className:"pointer-events-none absolute -bottom-4 flex items-center justify-center",children:d?s.jsx("div",{className:"flex items-center justify-center",style:{color:d.color},children:U.createElement(d.component,{size:22,className:"opacity-90"})}):s.jsx("div",{className:"h-2 w-2 bg-blue-500 rounded-full"})})]},e)})]})]})})};export{re as default};
