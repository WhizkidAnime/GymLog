import{j as e,s as ee,u as Fe,W as Ie}from"./index-C9C52k7W.js";import{f as qe,r as a,e as Be,c as Me,j as nt,u as ot,L as at}from"./vendor-BVca5W6X.js";import{u as it}from"./usePageState-6XNG0ilq.js";import{u as Se}from"./useDebounce-C2cqH541.js";import{C as Pe}from"./confirm-dialog-BDjQ603X.js";import{c as Ee,f as ct}from"./date-helpers-BoyNci5t.js";import{n as Te,p as lt}from"./exercise-name-BJxyXXn3.js";import{W as Le}from"./workout-icons-Bpj0M02M.js";import{u as Ke}from"./use-modal-scroll-lock-DlG-D3y9.js";import{u as dt}from"./use-workout-actions-menu-C-5wTXkz.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const ut=({set:t,previousSet:r,onChange:d})=>{const p=`workout_set_draft:${t.id}`,n=`workout_set_last_non_max_reps:${t.id}`,o=l=>l==null?"":String(l).replace(".",","),w=l=>{if(l==="")return null;const u=Number(l.replace(",","."));return Number.isFinite(u)?u:null},x=l=>{let u=l.replace(".",",");u=u.replace(/[^\d,]/g,"");const S=u.indexOf(",");return S!==-1&&(u=u.slice(0,S+1)+u.slice(S+1).replace(/,/g,"")),u},j="макс.",b=l=>l==null?"":l==="0"?j:l,_=l=>{const u=l.trim();if(u==="")return null;const S=u.toLowerCase();return S==="макс"||S==="макс."||/^0+$/.test(u)?"0":u},D=l=>{const u=l.trim();return u===""?"":/^0+$/.test(u)||u.toLowerCase().startsWith("макс")?j:u.replace(/[^0-9]/g,"")},M=b(t.reps),[k,I]=a.useState(o(t.weight)),[y,F]=a.useState(M),[O,T]=a.useState(_(M)==="0"?null:M||null),[N,J]=a.useState(t.is_done),[g,c]=a.useState(!1),[m,L]=a.useState(()=>_(M)==="0"),V=Se(k,500),P=Se(y,500),K=!!r&&r.is_done&&r.weight!==null&&w(k)===null,Y=l=>{T(l);try{l&&l.trim()!==""?localStorage.setItem(n,l):localStorage.removeItem(n)}catch{}};a.useEffect(()=>{try{const l=localStorage.getItem(p);if(!l)return;const u=JSON.parse(l),S=new Date(t.updated_at).getTime();if(u.updatedAt>S){I(u.weight===""?"":o(u.weight));const Z=b(u.reps);F(Z);const q=_(Z)==="0"?null:Z||null;Y(q),J(u.isDone)}}catch{}},[]),a.useEffect(()=>{J(t.is_done)},[t.is_done]),a.useEffect(()=>{if(t.reps==="0")try{const l=localStorage.getItem(n);l&&l.trim()!==""&&T(l)}catch{}},[t.reps,n]),a.useEffect(()=>{(async()=>{const u=w(V),S=_(P);if(u!==(t.weight??null)||S!==(t.reps??null)||N!==t.is_done){const Z={weight:u===null?"":u,reps:S,isDone:N,updatedAt:Date.now()};try{localStorage.setItem(p,JSON.stringify(Z))}catch{}c(!0);const{error:q}=await ee.from("workout_sets").update({weight:u,reps:S,is_done:N,updated_at:new Date().toISOString()}).eq("id",t.id);if(q)console.error("Error saving set:",q);else{try{localStorage.removeItem(p)}catch{}const ne={...t,weight:u,reps:S,is_done:N,updated_at:new Date().toISOString()};d==null||d(ne)}setTimeout(()=>c(!1),500)}})()},[V,P,t.id,t.weight,t.reps,t.is_done,N,p]),a.useEffect(()=>{const l=w(V)!==null,u=_(P)!==null,S=l&&u;S&&!N?J(!0):!S&&N&&J(!1)},[V,P,N]);const z=N?"bg-green-500":"bg-transparent",se=N?"text-black":"text-inherit",re=_(y)==="0",f=m||re,v=()=>{const l=_(y),u=l!==null&&l!=="0";if(f)re&&(O!==null&&O.trim()!==""?F(O):F("")),L(!1);else{if(u){L(!0);return}_(y)!=="0"&&y.trim()!==""&&Y(y),F(j),L(!0)}};return e.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${z}`,children:[e.jsx("div",{className:`col-span-1 text-center font-medium ${se}`,children:t.set_index}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:k,onChange:l=>I(x(l.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-500 focus:placeholder-transparent hover:placeholder-transparent outline-none focus-visible:outline-none ${se}`,style:{backgroundColor:N?"#ffffff":"#18181b",color:N?"#0a0a0a":"#fafafa"}})}),K&&e.jsx("button",{type:"button",onClick:()=>{!r||r.weight===null||I(o(r.weight))},"aria-label":"Скопировать вес из предыдущего подхода",className:"btn-glass btn-glass-icon-round btn-glass-secondary absolute text-white h-6 w-6 p-0",style:{left:"50%",top:"50%",transform:"translate(-50%, -50%)",transition:"none",width:"1.5rem",height:"1.5rem",minWidth:"1.5rem",minHeight:"1.5rem",padding:0},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"12",height:"12",fill:"none",stroke:"currentColor",strokeWidth:"2.2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"5 15 12 8 19 15"})})}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:y,onChange:l=>{const u=D(l.target.value);if(F(u),_(u)!=="0"){const S=u.trim()===""?null:u;Y(S)}},className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-500 focus:placeholder-transparent hover:placeholder-transparent outline-none focus-visible:outline-none ${se}`,style:{backgroundColor:N?"#ffffff":"#18181b",color:N?"#0a0a0a":"#fafafa"}})}),e.jsx("div",{className:"col-span-1 flex justify-center",children:e.jsx("input",{type:"checkbox",checked:f,onChange:v,"aria-label":"Подход в отказ (макс.)",className:"h-6 w-6 rounded-md border border-gray-300 bg-white outline-none focus-visible:outline-none",style:{accentColor:"#000000",color:"#0a0a0a"}})}),g&&e.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},mt=qe.memo(ut,(t,r)=>{var d,p,n,o;return t.set.id===r.set.id&&t.set.weight===r.set.weight&&t.set.reps===r.set.reps&&t.set.is_done===r.set.is_done&&t.set.set_index===r.set.set_index&&t.set.updated_at===r.set.updated_at&&((d=t.previousSet)==null?void 0:d.weight)===((p=r.previousSet)==null?void 0:p.weight)&&((n=t.previousSet)==null?void 0:n.is_done)===((o=r.previousSet)==null?void 0:o.is_done)}),Ae=()=>{try{const t=localStorage.getItem("settings:timerStep");return t?Number(t):30}catch{return 30}},ft=({restSeconds:t,exerciseId:r,onAdjustRestSeconds:d,timerStep:p})=>{const n=r?`rest_timer:${r}`:void 0,[o,w]=a.useState(()=>p??Ae());a.useEffect(()=>{if(p!==void 0)w(p);else{const g=()=>{w(Ae())};window.addEventListener("storage",g);const c=()=>{w(Ae())};return window.addEventListener("focus",c),()=>{window.removeEventListener("storage",g),window.removeEventListener("focus",c)}}},[p]);const x=a.useRef(null),j=a.useRef(t),b=a.useRef({time:t,isActive:!1,endAt:null}),[_,D]=a.useState(()=>{if(!n)return{time:t,isActive:!1,endAt:null};try{const g=localStorage.getItem(n);if(!g)return{time:t,isActive:!1,endAt:null};const c=JSON.parse(g),m=360*60*1e3;if(Date.now()-c.savedAt>m)return localStorage.removeItem(n),{time:t,isActive:!1,endAt:null};if(c.isActive&&c.endAt){const L=Math.max(0,Math.floor((c.endAt-Date.now())/1e3));return L>0?{time:L,isActive:!0,endAt:c.endAt}:(localStorage.removeItem(n),{time:c.restSeconds,isActive:!1,endAt:null})}return{time:c.restSeconds,isActive:!1,endAt:null}}catch(g){return console.error("Error restoring timer state:",g),{time:t,isActive:!1,endAt:null}}}),{time:M,isActive:k,endAt:I}=_,y=a.useCallback((g,c)=>{if(n)try{const m={endAt:g.endAt,isActive:g.isActive,restSeconds:c??b.current.time??t,savedAt:Date.now()};localStorage.setItem(n,JSON.stringify(m))}catch(m){console.error("Error persisting timer:",m)}},[n,t]),F=a.useRef(y);a.useEffect(()=>{F.current=y},[y]),a.useEffect(()=>{b.current={time:M,isActive:k,endAt:I}},[M,k,I]),a.useEffect(()=>{if(!k||!I){x.current&&(window.clearInterval(x.current),x.current=null);return}let g=!1;const c=()=>{if(g)return;const L=Date.now(),V=Math.max(0,I-L),P=Math.floor(V/1e3);D(K=>({...K,time:P})),P<=0&&(g=!0,D(K=>({...K,isActive:!1,endAt:null,time:t})),x.current&&(window.clearInterval(x.current),x.current=null),n&&localStorage.removeItem(n))};c();const m=window.setInterval(c,1e3);return x.current=m,()=>{g=!0,x.current&&(window.clearInterval(x.current),x.current=null)}},[k,I,n,t]),a.useEffect(()=>{!k&&t!==j.current&&D(g=>({...g,time:t})),j.current=t},[t,k]),a.useEffect(()=>()=>{x.current&&(window.clearInterval(x.current),x.current=null);const{isActive:g,endAt:c}=b.current;g&&c&&F.current({endAt:c,isActive:!0})},[]);const O=()=>{D(g=>{if(g.isActive)return y({endAt:null,isActive:!1},g.time),x.current&&(window.clearInterval(x.current),x.current=null),{time:g.time,isActive:!1,endAt:null};const c=Date.now()+g.time*1e3;return y({endAt:c,isActive:!0},g.time),{time:g.time,isActive:!0,endAt:c}})},T=()=>{D({time:t,isActive:!1,endAt:null}),x.current&&(window.clearInterval(x.current),x.current=null),n&&localStorage.removeItem(n)},N=g=>{D(c=>{const m=Math.max(0,c.time+g);if(m===0)return y({endAt:null,isActive:!1},0),x.current&&(window.clearInterval(x.current),x.current=null),{time:0,isActive:!1,endAt:null};if(c.isActive){const L=Date.now()+m*1e3;return y({endAt:L,isActive:!0},m),{time:m,isActive:!0,endAt:L}}return y({endAt:null,isActive:!1},m),{time:m,isActive:!1,endAt:null}}),d==null||d(g)},J=g=>{const c=Math.floor(g/60),m=g%60;return`${c}:${m<10?"0":""}${m}`};return e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:()=>N(-o),disabled:M<=0&&!k,className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"-"}),e.jsx("div",{className:`text-6xl font-mono font-semibold leading-none min-w-[4ch] text-center ${k?"text-white":""}`,children:J(M)}),e.jsx("button",{onClick:()=>N(o),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3",children:[e.jsx("button",{onClick:O,className:`btn-glass btn-glass-icon-lg ${k?"btn-glass-danger":"btn-glass-primary"}`,children:k?"Стоп":"Старт"}),e.jsx("button",{onClick:T,className:"btn-glass btn-glass-icon-sm btn-glass-secondary",children:"Сброс"})]})]})},ht=7200*1e3,$e=new Map,wt=(t,r,d)=>`${t}:${r}:${d||"none"}`,gt=t=>{const r=$e.get(t);if(!r)return;if(Date.now()-r.timestamp>ht){$e.delete(t);return}return r.data},be=(t,r)=>{$e.set(t,{data:r,timestamp:Date.now()})},pt=({exercise:t,workoutDate:r,onUpdateExercise:d,onDeleteExercise:p})=>{var re;const[n,o]=a.useState(t.name),[w,x]=a.useState(t.sets),[j,b]=a.useState(t.rest_seconds),[_,D]=a.useState(!1),[M,k]=a.useState(null),[I,y]=a.useState("idle"),F=a.useRef(null),{user:O}=Fe(),T=Se(n,500),N=Se(j,500),[J,g]=a.useState(!1),c=a.useRef(t.name),m=a.useCallback(()=>{const f=F.current;f&&(f.style.height="auto",f.style.height=`${f.scrollHeight}px`)},[]);a.useEffect(()=>{t.name!==c.current&&(o(t.name),c.current=t.name),x(t.sets),b(t.rest_seconds)},[t.id,t.sets,t.rest_seconds]),a.useEffect(()=>{if(!O)return;const f=T.trim(),v=Te(f);if(!v){k(null),y("idle");return}const l=wt(O.id,v,r??null),u=gt(l);if(u!==void 0){k(u),y("ready");return}let S=!1;return y("loading"),(async()=>{try{let q=ee.from("workouts").select("id, workout_date, name, user_id").eq("user_id",O.id);r&&(q=q.lt("workout_date",r));const{data:ne,error:ke}=await q.order("workout_date",{ascending:!0});if(S)return;if(ke)throw ke;const we=(ne||[]).map(R=>({id:R.id,date:R.workout_date,name:R.name})),fe=new Map;we.forEach(R=>fe.set(R.id,{date:R.date,name:R.name}));const ae=we.map(R=>R.id);if(ae.length===0){k(null),be(l,null),y("ready");return}const{data:ye,error:ce}=await ee.from("workout_exercises").select("id, name, workout_id").in("workout_id",ae);if(S)return;if(ce)throw ce;const ie=new Set,le=new Map;if((ye||[]).forEach(R=>{const te=(R.name??"").trim();if(te&&Te(te)===v){const X=R.id;ie.add(X);const me=R.workout_id;me&&le.set(X,me)}}),ie.size===0){k(null),be(l,null),y("ready");return}const{data:he,error:ve}=await ee.from("exercise_progress_view").select("workout_date, workout_name, workout_id, exercise_id, max_weight, reps_at_max_weight").in("workout_id",ae).in("exercise_id",Array.from(ie));if(S)return;if(ve)throw ve;let de=(he||[]).map(R=>({workout_date:R.workout_date,workout_name:R.workout_name,workout_id:R.workout_id,exercise_id:R.exercise_id,max_weight:R.max_weight,reps_at_max_weight:R.reps_at_max_weight}));if(de.length===0){const{data:R,error:te}=await ee.from("workout_sets").select("id, workout_exercise_id, weight, reps, is_done, updated_at").in("workout_exercise_id",Array.from(ie)).order("updated_at",{ascending:!1});if(S)return;if(te)throw te;de=(R||[]).filter(X=>X.weight!==null&&Number(X.weight)===0).filter(X=>X.is_done||typeof X.reps=="string"&&X.reps.trim()!=="").map(X=>{const me=X.workout_exercise_id,ge=le.get(me);if(!ge)return null;const pe=fe.get(ge);return pe?{workout_date:pe.date,workout_name:pe.name,workout_id:ge,exercise_id:me,max_weight:0,reps_at_max_weight:X.reps}:null}).filter(X=>X!==null)}if(de.length===0){k(null),be(l,null),y("ready");return}const je=lt(f,de),ue=je.dataPoints[je.dataPoints.length-1];if(!ue){k(null),be(l,null),y("ready");return}const _e={weight:ue.weight,reps:ue.reps,workoutDate:ue.date};k(_e),be(l,_e),y("ready")}catch(q){console.error("Failed to fetch last exercise performance",q),y("error")}})(),()=>{S=!0}},[T,O,r]),a.useLayoutEffect(()=>{m()},[m,n]),a.useLayoutEffect(()=>{if(typeof ResizeObserver>"u")return;const f=F.current;if(!f)return;const v=new ResizeObserver(()=>{m()});return v.observe(f),()=>v.disconnect()},[m]),a.useEffect(()=>{(async()=>{if(!(T.trim()===""||T===t.name))try{await ee.from("workout_exercises").update({name:T}).eq("id",t.id);const v={...t,name:T};c.current=T,d(v)}catch(v){console.error("Failed to update exercise name",v)}})()},[T]),a.useEffect(()=>{(async()=>{if(N!==t.rest_seconds)try{await ee.from("workout_exercises").update({rest_seconds:N}).eq("id",t.id);const v={...t,rest_seconds:N};d(v)}catch(v){console.error("Failed to update rest seconds",v)}})()},[N,t,d]);const L=f=>{b(v=>Math.max(0,v+f))},V=async f=>{if(!(f<1||f===w||_)){D(!0);try{if(f>w){const v=Array.from({length:f-w},(q,ne)=>({workout_exercise_id:t.id,set_index:w+ne+1})),{data:l,error:u}=await ee.from("workout_sets").insert(v).select();if(u)throw u;const S=[...t.workout_sets,...l||[]].sort((q,ne)=>q.set_index-ne.set_index);await ee.from("workout_exercises").update({sets:f}).eq("id",t.id);const Z={...t,sets:f,workout_sets:S};d(Z)}else{const{error:v}=await ee.from("workout_sets").delete().eq("workout_exercise_id",t.id).gt("set_index",f);if(v)throw v;const l=t.workout_sets.filter(S=>S.set_index<=f);await ee.from("workout_exercises").update({sets:f}).eq("id",t.id);const u={...t,sets:f,workout_sets:l};d(u)}x(f)}catch(v){console.error("Failed to change sets count",v),alert("Не удалось изменить количество подходов")}finally{D(!1)}}},P=async()=>{const{error:f}=await ee.from("workout_sets").delete().eq("workout_exercise_id",t.id);if(f){console.error("Failed to delete sets of exercise",f),alert("Не удалось удалить подходы упражнения. Попробуйте снова.");return}const{error:v}=await ee.from("workout_exercises").delete().eq("id",t.id);if(v){console.error("Failed to delete exercise",v),alert("Не удалось удалить упражнение. Попробуйте снова.");return}p&&p(t.id)},K="макс.",Y=f=>f==null?"—":String(f).replace(".",","),z=f=>{if(f==null)return"—";const v=f.trim();return v?v==="0"?K:v:"—"},se=()=>n.trim()?I==="loading"?e.jsx("span",{className:"text-gray-400",children:"Поиск последнего результата…"}):I==="error"?e.jsx("span",{className:"text-red-300",children:"Не удалось загрузить данные"}):M?e.jsxs("span",{className:"text-white text-base font-semibold",children:[Y(M.weight)," кг × ",z(M.reps)]}):e.jsx("span",{className:"text-gray-500",children:"До этой даты нет данных по этому упражнению"}):e.jsx("span",{className:"text-gray-500",children:"Введите название, чтобы увидеть прошлый результат"});return e.jsxs("div",{id:`exercise-${t.id}`,className:"glass card-dark p-4 exercise-card",children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{value:n,onChange:f=>o(f.target.value),ref:F,rows:1,className:"w-full text-base sm:text-lg font-bold text-white whitespace-pre-wrap bg-white/10 hover:bg-white/15 focus:bg-white/10 border border-white/20 hover:border-white/30 focus:border-white/50 focus:ring-2 focus:ring-white/25 focus:outline-none rounded-xl px-4 pr-9 py-3 min-h-[3rem] resize-none overflow-y-hidden leading-relaxed transition-colors"}),n&&n.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{o(""),requestAnimationFrame(()=>m())},"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{"aria-label":"Удалить упражнение",className:"delete-btn btn-glass btn-glass-icon btn-glass-outline",onClick:()=>g(!0),type:"button",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-2xl bg-white/5 px-4 py-3 text-xs sm:text-sm text-gray-300",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-white",children:"Последний рабочий вес"}),(M==null?void 0:M.workoutDate)&&e.jsx("span",{className:"text-[0.7rem] uppercase tracking-wide text-gray-400",children:Ee(M.workoutDate)})]}),se()]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(ft,{restSeconds:j,exerciseId:t.id,onAdjustRestSeconds:L})}),e.jsxs("div",{className:"flex items-center justify-between text-sm py-3 sm:py-4 px-2 rounded-lg",style:{color:"#a1a1aa",backgroundColor:"rgba(255,255,255,0.02)"},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"whitespace-nowrap font-medium",children:"Подходы:"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{disabled:_||w<=1,onClick:()=>V(w-1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"−"}),e.jsx("span",{className:"min-w-[3ch] text-center text-white font-semibold",children:w}),e.jsx("button",{disabled:_||w>=30,onClick:()=>V(w+1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]})]}),((re=t.reps)==null?void 0:re.trim())&&e.jsxs("div",{className:"ml-3 flex-1 text-right whitespace-nowrap font-medium",children:["Повторы: ",t.reps]})]})]}),e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden",style:{color:"#a1a1aa",backgroundColor:"rgba(255,255,255,0.03)"},children:[e.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:"Подход"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Вес (кг)"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Повторы"}),e.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2 whitespace-nowrap",children:"В отказ"})]}),e.jsx("div",{className:"space-y-2",children:t.workout_sets.map((f,v,l)=>{const u=v>0?l[v-1]:void 0;return e.jsx(mt,{set:f,previousSet:u,onChange:S=>{const Z={...t,workout_sets:t.workout_sets.map(q=>q.id===S.id?S:q)};d(Z)}},f.id)})})]}),e.jsx(Pe,{open:J,onOpenChange:g,title:"Удалить упражнение?",description:t.name?`Вы собираетесь удалить упражнение "${t.name}". Действие необратимо.`:"Вы собираетесь удалить упражнение. Действие необратимо.",cancelText:"Отмена",variant:"danger",onConfirm:P})]})},xt=qe.memo(pt,(t,r)=>{const d=t.exercise,p=r.exercise;if(d.id!==p.id||d.name!==p.name||d.sets!==p.sets||d.rest_seconds!==p.rest_seconds||d.reps!==p.reps||t.workoutDate!==r.workoutDate||d.workout_sets.length!==p.workout_sets.length)return!1;for(let n=0;n<d.workout_sets.length;n++){const o=d.workout_sets[n],w=p.workout_sets[n];if(o.id!==w.id||o.weight!==w.weight||o.reps!==w.reps||o.is_done!==w.is_done)return!1}return!0}),ze=({normalizedDate:t,className:r=""})=>{const d=Be();return e.jsx("button",{onClick:()=>d("/calendar",{state:{refreshDate:t}}),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors z-10 bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${r}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})},bt=({normalizedDate:t,workoutName:r,isEditingName:d,editNameValue:p,isSavingWorkoutName:n,isScrolling:o,inputRef:w,onStartEditName:x,onChangeEditName:j,onSaveEditName:b,onCancelEditName:_,actionsRef:D,actionsBtnRef:M,onToggleActions:k,workoutIcon:I,editIconValue:y,onOpenIconPicker:F})=>{const O=d?y:I,T=O?Le[O]:null;return e.jsxs("div",{className:`glass card-dark p-4 flex items-center gap-4 header-container ${o?"scrolling":""}`,children:[e.jsx(ze,{normalizedDate:t,className:"shrink-0"}),e.jsx("div",{className:"flex-1 text-center",children:d?e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:F,disabled:n,className:"shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-50",title:"Выбрать иконку",children:T?e.jsx(T.component,{size:28}):e.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-gray-400",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"}),e.jsx("path",{d:"M12 8v8M8 12h8"})]})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:w,type:"text",value:p,onChange:N=>j(N.target.value),disabled:n,className:"w-full bg-white/10 text-lg font-bold text-white placeholder:text-gray-500 focus:outline-none focus:bg-white/20 rounded-md px-3 pr-9 py-2 transition-colors disabled:opacity-70",placeholder:"Название тренировки"}),p&&e.jsx("button",{type:"button",onClick:()=>j(""),"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:b,disabled:n,className:"shrink-0 p-1.5 rounded-full hover:bg-green-500/20 transition-colors disabled:opacity-50",title:"Сохранить",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:_,disabled:n,className:"shrink-0 p-1.5 rounded-full hover:bg-red-500/20 transition-colors disabled:opacity-50",title:"Отмена",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[T&&e.jsx("div",{className:"shrink-0 w-10 h-10 flex items-center justify-center",children:e.jsx(T.component,{size:32})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-white",children:r}),e.jsxs("p",{className:"text-md transition-all duration-300",style:{color:"#a1a1aa"},children:["Дата: ",Ee(t)]})]}),e.jsx("button",{onClick:x,className:"shrink-0 p-1.5 rounded-full hover:bg-white/10 transition-colors",title:"Редактировать название",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})})]})}),e.jsx("div",{className:"relative",ref:D,children:e.jsx("button",{ref:M,type:"button","aria-label":"Меню действий",className:"inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10",onClick:k,children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("circle",{cx:"12",cy:"5",r:"1"}),e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})})]})},kt=({open:t,templates:r,isCreating:d,onClose:p,onReplaceWithTemplate:n})=>t?Me.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:p}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Выберите шаблон"}),e.jsx("button",{onClick:p,className:"px-2 py-1 text-sm text-gray-300 hover:text-white",children:"✕"})]}),r.length===0?e.jsx("p",{className:"text-gray-400",children:"Нет доступных шаблонов."}):e.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-y-auto overscroll-contain pr-1",children:r.map(o=>e.jsx("button",{onClick:()=>n(o),disabled:d,className:"w-full text-left px-4 py-2 rounded-md border border-white/20 text-gray-100 hover:bg-white/5 disabled:opacity-50",children:d?"Применение...":o.name},o.id))})]})]}),document.body):null;function yt({normalizedDate:t,exercisesLength:r,scrollKey:d,location:p}){const[n,o]=a.useState(!1),w=a.useRef(!1),x=a.useRef(0),j=a.useRef(!1),b=a.useRef(!1);return a.useEffect(()=>{j.current=!1,b.current=!1},[t,p.key]),a.useEffect(()=>{if(!t||r===0||b.current)return;const _=()=>{var J;const k=(J=p.state)==null?void 0:J.focusExerciseId;if(!k||j.current)return!1;const I=document.getElementById(`exercise-${k}`);if(!I)return!1;j.current=!0,w.current=!0;const y=document.querySelector(".header-container"),F=y?y.getBoundingClientRect().bottom:0,O=12,T=I.getBoundingClientRect(),N=Math.max(0,window.scrollY+T.top-F-O);return window.scrollTo({top:N,behavior:"smooth"}),I.animate&&I.animate([{boxShadow:"0 0 0 rgba(59,130,246,0)"},{boxShadow:"0 0 0 4px rgba(59,130,246,0.6)"},{boxShadow:"0 0 0 rgba(59,130,246,0)"}],{duration:1200,easing:"ease-in-out"}),setTimeout(()=>{w.current=!1},600),!0},D=()=>{try{const k=localStorage.getItem(d);if(k){const I=parseInt(k,10);Number.isNaN(I)||(w.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:I,behavior:"auto"}),x.current=I,setTimeout(()=>{w.current=!1},100)})}))}}catch(k){console.error("Error restoring scroll:",k)}};_()||D(),b.current=!0},[t,r,d,p.state]),a.useEffect(()=>{if(!t)return;let _=!1;const D=()=>{x.current=window.scrollY,o(window.scrollY>0),!_&&!w.current&&(window.requestAnimationFrame(()=>{try{localStorage.setItem(d,String(x.current))}catch{}_=!1}),_=!0)};return window.addEventListener("scroll",D,{passive:!0}),()=>window.removeEventListener("scroll",D)},[t,d]),a.useEffect(()=>()=>{if(t&&x.current>0)try{localStorage.setItem(d,String(x.current))}catch{}},[t,d]),{isScrolling:n}}function De(t,r,d){const p=t.slice(),[n]=p.splice(r,1);return p.splice(d,0,n),p}const vt=({open:t,items:r,onClose:d,onSave:p})=>{const[n,o]=a.useState([]),w=a.useRef(null),[x,j]=a.useState(!1),[b,_]=a.useState(null),D=a.useRef(0),M=a.useRef(null),k=a.useMemo(()=>r.slice().sort((c,m)=>(c.position??0)-(m.position??0)),[r]);if(a.useEffect(()=>{t&&o(k)},[t,k]),Ke(t),!t)return null;const I=(c,m)=>{m<0||m>=n.length||o(L=>De(L,c,m))},y=c=>m=>{w.current=c,m.dataTransfer.effectAllowed="move"},F=c=>{c.preventDefault(),c.dataTransfer.dropEffect="move"},O=c=>m=>{m.preventDefault();const L=w.current;if(w.current=null,L==null||L===c)return;const V=n.findIndex(K=>K.id===L),P=n.findIndex(K=>K.id===c);V===-1||P===-1||o(K=>De(K,V,P))},T=c=>m=>{const L=m.touches[0];D.current=L.clientY,_(c)},N=c=>{if(!b)return;const L=c.touches[0].clientY,V=L-D.current,P=n.findIndex(z=>z.id===b);if(P===-1)return;const Y=Math.round(V/60);if(Math.abs(Y)>=1){const z=P+Y;z>=0&&z<n.length&&z!==P&&(o(se=>De(se,P,z)),D.current=L)}},J=()=>{_(null)},g=async()=>{j(!0);try{await p(n.map((c,m)=>({...c,position:m+1}))),d()}finally{j(!1)}};return Me.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:d}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Порядок упражнений"}),e.jsx("ol",{ref:M,className:"space-y-2 max-h-[55vh] overflow-y-auto pr-1",onTouchMove:N,onTouchEnd:J,children:n.map((c,m)=>e.jsxs("li",{draggable:!0,onDragStart:y(c.id),onDragOver:F,onDrop:O(c.id),className:`rounded-lg p-2 flex items-center gap-2 hover:bg-white/5 transition-colors ${b===c.id?"bg-white/20 scale-105":""}`,children:[e.jsxs("span",{className:"select-none w-6 text-center opacity-70",children:[m+1,"."]}),e.jsx("button",{type:"button","aria-label":"Перетащить",className:"cursor-grab px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 active:cursor-grabbing touch-none",draggable:!0,onDragStart:y(c.id),onTouchStart:T(c.id),children:"⋮⋮"}),e.jsx("div",{className:"flex-1 whitespace-normal break-words leading-snug",children:c.name||"Без названия"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>I(m,m-1),disabled:m===0,children:"↑"}),e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>I(m,m+1),disabled:m===n.length-1,children:"↓"})]})]},c.id))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:d,disabled:x,children:"Отмена"}),e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-primary",onClick:g,disabled:x,children:x?"Сохранение…":"Сохранить"})]})]})]}),document.body)},jt=({open:t,value:r,onClose:d,onChange:p})=>{if(!t)return null;const n=Object.keys(Le),o=w=>{p(w),d()};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:d,children:e.jsxs("div",{className:"glass card-dark p-4 rounded-xl w-[90%] max-w-sm mx-auto",onClick:w=>w.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4 text-center",children:"Выберите иконку"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>o(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${r===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"28",height:"28",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:"Нет"})]}),n.map(w=>{const{component:x,label:j}=Le[w],b=r===w;return e.jsxs("button",{type:"button",onClick:()=>o(w),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${b?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center",children:e.jsx(x,{size:28})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:j})]},w)})]}),e.jsx("button",{type:"button",onClick:d,className:"mt-4 w-full py-2 text-gray-400 hover:text-white transition-colors",children:"Отмена"})]})})},G=new Map,Oe=3e4,_t=t=>{if(!t)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const r=new Date(t);return Number.isNaN(r.getTime())?null:ct(r)},Tt=()=>{const{date:t}=nt(),{user:r}=Fe(),d=Be(),p=ot(),n=ee,o=a.useMemo(()=>_t(t),[t]),w=o?`workout-page:${o}`:"workout-page",[x,j]=it({key:w,initialState:{workout:null,exercises:[],templates:[],loading:!0,isCreating:!1,isSelectTemplateOpen:!1,hasInitialData:!1,isAddingExercise:!1,workoutName:"",isSavingWorkoutName:!1,isCardio:!1,isSavingCardio:!1,workoutIcon:null},ttl:1800*1e3}),{workout:b,exercises:_,templates:D,loading:M,isCreating:k,isSelectTemplateOpen:I,hasInitialData:y,isAddingExercise:F,workoutName:O,isSavingWorkoutName:T,isCardio:N,isSavingCardio:J,workoutIcon:g}=x,{isActionsOpen:c,menuPos:m,actionsRef:L,actionsBtnRef:V,toggleActions:P,closeActions:K}=dt(),Y=s=>j(i=>({...i,workout:s,workoutName:(s==null?void 0:s.name)??"",isSavingWorkoutName:!1,isCardio:(s==null?void 0:s.is_cardio)??!1,isSavingCardio:!1,workoutIcon:(s==null?void 0:s.icon)??null})),z=s=>j(i=>({...i,exercises:typeof s=="function"?s(i.exercises):s})),se=s=>j(i=>({...i,templates:typeof s=="function"?s(i.templates):s})),re=s=>j(i=>({...i,loading:s})),f=s=>j(i=>({...i,isCreating:s})),v=s=>j(i=>({...i,isSelectTemplateOpen:s})),l=s=>j(i=>({...i,hasInitialData:s})),u=s=>j(i=>({...i,isAddingExercise:s})),S=s=>j(i=>({...i,workoutName:s})),Z=s=>j(i=>({...i,isSavingWorkoutName:s})),q=s=>j(i=>({...i,isCardio:s})),ne=s=>j(i=>({...i,isSavingCardio:s})),[ke,we]=a.useState(!1),[fe,ae]=a.useState(!1),[ye,ce]=a.useState(O),[ie,le]=a.useState(g),he=a.useRef(null),[ve,de]=a.useState(!1),[je,ue]=a.useState(!1),_e=`scroll:workout:${o??""}`,{isScrolling:R}=yt({normalizedDate:o,exercisesLength:_.length,scrollKey:_e,location:p});Ke(I);const te=a.useCallback(async(s=!1,i=!1)=>{if(!r||!o){Y(null),z([]),re(!1),l(!0);return}const E=`${r.id}:${o}`,h=Date.now();if(G.has(E)){const W=G.get(E),H=h-W.timestamp;if(s&&H<Oe){y||(Y(W.workout),z(W.exercises),re(!1),l(!0));return}H>=Oe&&(y||(Y(W.workout),z(W.exercises),l(!0)),i=!0)}i||re(!0);const{data:C,error:B}=await n.from("workouts").select("*").eq("user_id",r.id).eq("workout_date",o).order("created_at",{ascending:!1}).limit(1);let A=(C==null?void 0:C[0])??null;if(B)console.error("Error fetching workout:",B);else if(A){if(A.template_id&&!A.icon)try{const{data:$}=await n.from("workout_templates").select("icon").eq("id",A.template_id).single();$!=null&&$.icon&&(A={...A,icon:$.icon},n.from("workouts").update({icon:$.icon}).eq("id",A.id).then(()=>{},()=>{}))}catch{}Y(A);const{data:W,error:H}=await n.from("workout_exercises").select("id, name, sets, reps, rest_seconds, position, workout_id, workout_sets ( id, workout_exercise_id, set_index, weight, reps, is_done, updated_at )").eq("workout_id",A.id).order("position");if(H)console.error("Error fetching exercises:",H);else{const $=W||[];$.forEach(oe=>{oe.workout_sets&&oe.workout_sets.sort((xe,Ne)=>xe.set_index-Ne.set_index)}),z($),G.set(E,{workout:A,exercises:$,timestamp:h})}}else Y(null),z([]),G.set(E,{workout:null,exercises:[],timestamp:h});const U=r?`templates-cache:${r.id}`:void 0;if(U)try{const W=localStorage.getItem(U);if(W){const H=JSON.parse(W);H.data&&se(H.data)}}catch{}n.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).then(({data:W,error:H})=>{if(H)console.error("Error fetching templates:",H.message);else if(se(W||[]),U)try{localStorage.setItem(U,JSON.stringify({ts:Date.now(),data:W}))}catch{}}),re(!1),l(!0)},[r,o,y]);a.useEffect(()=>{te()},[te]),a.useEffect(()=>{const s=()=>{document.visibilityState==="visible"&&te(!0)};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[te]),a.useEffect(()=>{o&&(localStorage.setItem("lastWorkoutPath",`/workout/${o}`),localStorage.setItem("lastWorkoutTimestamp",Date.now().toString()))},[o]),a.useEffect(()=>{fe&&he.current&&(he.current.focus(),he.current.select())},[fe]);const X=a.useCallback(s=>{j(i=>{const E=i.exercises.map(h=>h.id===s.id?s:h);if(r&&o&&i.workout){const h=`${r.id}:${o}`;G.set(h,{workout:i.workout,exercises:E,timestamp:Date.now()})}return{...i,exercises:E}})},[r,o]),me=a.useCallback(s=>{j(i=>{const E=i.exercises.filter(h=>h.id!==s);if(r&&o&&i.workout){const h=`${r.id}:${o}`;G.set(h,{workout:i.workout,exercises:E,timestamp:Date.now()})}return{...i,exercises:E}})},[r,o]),ge=async()=>{if(!(!r||!o||!b||F)){u(!0);try{const s=_.length>0?Math.max(..._.map(W=>typeof W.position=="number"?W.position:0))+1:1,{data:i,error:E}=await n.from("workout_exercises").insert({workout_id:b.id,name:"",sets:1,reps:"",rest_seconds:150,position:s}).select("id, name, sets, reps, rest_seconds, position, workout_id");if(E)throw E;const h=i==null?void 0:i[0];if(!h)throw new Error("Не удалось создать упражнение");const{data:C,error:B}=await n.from("workout_sets").insert({workout_exercise_id:h.id,set_index:1,weight:null,reps:null,is_done:!1,updated_at:new Date().toISOString()}).select("id, workout_exercise_id, set_index, weight, reps, is_done, updated_at");if(B)throw B;const A=C==null?void 0:C[0];if(!A)throw new Error("Не удалось создать подход");const U={...h,workout_sets:[A]};j(W=>{if(!W.workout)return W;const H=[...W.exercises,U].sort(($,oe)=>$.position-oe.position);if(r&&o){const $=`${r.id}:${o}`,oe=G.get($);oe&&G.set($,{workout:oe.workout,exercises:H,timestamp:Date.now()})}return{...W,exercises:H}})}catch(s){console.error("Failed to add exercise:",s),alert("Не удалось добавить упражнение. Попробуйте снова.")}finally{u(!1)}}},pe=async()=>{if(!(!r||!o)){f(!0);try{const{data:s,error:i}=await n.from("workouts").insert({user_id:r.id,workout_date:o,name:"Новая тренировка",template_id:null}).select().single();if(i)throw i;if(!s)throw new Error("Не удалось создать тренировку");Y(s),z([]),S(s.name);const E=`${r.id}:${o}`;G.set(E,{workout:s,exercises:[],timestamp:Date.now()})}catch(s){console.error("Failed to create custom workout:",s),alert("Не удалось создать тренировку. Попробуйте снова.")}finally{f(!1)}}},He=async s=>{if(!(!r||!o)){f(!0);try{const[{data:i},{data:E}]=await Promise.all([n.from("template_exercises").select("*").eq("template_id",s.id),n.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]),h=(E==null?void 0:E.icon)??s.icon??null,C=(E==null?void 0:E.name)??s.name,{data:B}=await n.from("workouts").insert({user_id:r.id,workout_date:o,name:C,template_id:s.id,icon:h}).select().single();if(!B)throw new Error("Failed to create workout entry.");const A=(i||[]).map($=>({workout_id:B.id,name:$.name,sets:$.sets,reps:$.reps,rest_seconds:$.rest_seconds,position:$.position})),{data:U}=await n.from("workout_exercises").insert(A).select();if(!U)throw new Error("Failed to create workout exercises.");const W=U.flatMap($=>Array.from({length:$.sets},(oe,xe)=>({workout_exercise_id:$.id,set_index:xe+1})));await n.from("workout_sets").insert(W);const H=`${r.id}:${o}`;G.delete(H),await te()}catch(i){console.error("Failed to create workout from template:",i),alert(`Не удалось создать тренировку: ${i.message}`)}finally{f(!1)}}},Ye=()=>{ce(O),le(g),ae(!0)},Je=async()=>{if(!r||!o||!b)return;const s=ye.trim();if(s.length===0){ce(O),le(g),ae(!1);return}const i=s!==b.name,E=ie!==b.icon;if(!i&&!E){ae(!1);return}Z(!0);try{const h={};i&&(h.name=s),E&&(h.icon=ie);const{data:C,error:B}=await n.from("workouts").update(h).eq("id",b.id).select().single();if(B)throw B;if(!C)throw new Error("Не удалось обновить тренировку");Y(C),ce(s),le(C.icon),ae(!1);const A=`${r.id}:${o}`;G.set(A,{workout:C,exercises:_,timestamp:Date.now()})}catch(h){console.error("Failed to update workout:",h),alert("Не удалось сохранить изменения. Попробуйте снова.")}finally{Z(!1)}},Ve=()=>{ce(O),le(g),ae(!1)},Xe=()=>{ue(!0)},Qe=s=>{le(s)},Re=async()=>{if(!r||!o||!b)return;const s=!N;q(s),ne(!0);try{const{data:i,error:E}=await n.from("workouts").update({is_cardio:s}).eq("id",b.id).select().single();if(E)throw E;if(!i)throw new Error("Не удалось обновить статус кардио");Y(i);const h=`${r.id}:${o}`;G.set(h,{workout:i,exercises:_,timestamp:Date.now()})}catch(i){console.error("Failed to update cardio status:",i),alert("Не удалось сохранить статус кардио."),q(!s)}finally{ne(!1)}},Ge=()=>{b&&we(!0)},Ze=async s=>{if(!r||!b)return;const i=new Map(s.map((h,C)=>[h.id,C+1]));z(h=>{const C=h.map(B=>({...B,position:i.get(B.id)??B.position}));return C.sort((B,A)=>(B.position??0)-(A.position??0)),C});const E=s.map((h,C)=>({id:h.id,position:C+1}));try{if(await Promise.all(E.map(async h=>{const{error:C}=await n.from("workout_exercises").update({position:h.position}).eq("id",h.id);if(C)throw C})),r&&o){const h=`${r.id}:${o}`,C=G.get(h);if(C){const B=[...C.exercises].map(A=>({...A,position:i.get(A.id)??A.position})).sort((A,U)=>(A.position??0)-(U.position??0));G.set(h,{workout:C.workout,exercises:B,timestamp:Date.now()})}}}catch(h){console.error("Failed to save new order:",h),alert("Не удалось сохранить порядок. Я вернул предыдущие данные."),await te()}},Ue=async()=>{if(!b)return;const{error:s}=await n.from("workouts").delete().eq("id",b.id);if(s){console.error("Error deleting workout:",s),alert("Не удалось удалить тренировку.");return}if(r&&o){const i=`${r.id}:${o}`;G.delete(i)}d("/calendar",{state:{removedDate:o}})},et=()=>{v(!0)},tt=async s=>{if(!(!r||!o||!b))try{f(!0);const[{data:i,error:E},{data:h,error:C}]=await Promise.all([n.from("template_exercises").select("*").eq("template_id",s.id),n.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]);if(E)throw E;if(C)throw C;const{data:B,error:A}=await n.from("workout_exercises").select("id").eq("workout_id",b.id);if(A)throw A;const U=(B||[]).map(Q=>Q.id);if(U.length>0){const{error:Q}=await n.from("workout_sets").delete().in("workout_exercise_id",U);if(Q)throw Q;const{error:Ce}=await n.from("workout_exercises").delete().eq("workout_id",b.id);if(Ce)throw Ce}const W=(h==null?void 0:h.icon)??s.icon??null,H=(h==null?void 0:h.name)??s.name,{error:$}=await n.from("workouts").update({name:H,template_id:s.id,icon:W}).eq("id",b.id);if($)throw $;const oe=(i||[]).map(Q=>({workout_id:b.id,name:Q.name,sets:Q.sets,reps:Q.reps,rest_seconds:Q.rest_seconds,position:Q.position})),{data:xe,error:Ne}=await n.from("workout_exercises").insert(oe).select();if(Ne)throw Ne;const We=(xe||[]).flatMap(Q=>Array.from({length:Q.sets},(Ce,rt)=>({workout_exercise_id:Q.id,set_index:rt+1})));if(We.length>0){const{error:Q}=await n.from("workout_sets").insert(We);if(Q)throw Q}const st=`${r.id}:${o}`;G.delete(st),v(!1),await te()}catch(i){console.error("Failed to replace workout from template:",i),alert(`Не удалось изменить тренировку: ${i.message}`)}finally{f(!1)}};return y?o?b?e.jsxs("div",{className:"relative px-4 space-y-4 pt-4 pb-10",children:[M&&e.jsx(Ie,{message:"Загрузка тренировки..."}),e.jsx("div",{className:`status-bar-blur ${R?"visible":""}`}),e.jsx(bt,{normalizedDate:o,workoutName:O,isEditingName:fe,editNameValue:ye,isSavingWorkoutName:T,isScrolling:R,inputRef:he,onStartEditName:Ye,onChangeEditName:ce,onSaveEditName:Je,onCancelEditName:Ve,actionsRef:L,actionsBtnRef:V,onToggleActions:P,workoutIcon:g,editIconValue:ie,onOpenIconPicker:Xe}),e.jsx("div",{className:"space-y-4",children:_.map(s=>e.jsx(xt,{exercise:s,workoutDate:o,onUpdateExercise:X,onDeleteExercise:me},s.id))}),e.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[e.jsx("p",{className:"text-white text-lg font-bold mb-3 text-center",children:"Было кардио?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>{N&&(q(!1),Re())},disabled:J,className:`flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 ease-out ${N?"bg-red-500/20 text-red-300 hover:bg-red-500/30 scale-95":"bg-red-500/80 text-white shadow-lg scale-100"} disabled:opacity-50`,children:"Нет"}),e.jsx("button",{onClick:()=>{N||(q(!0),Re())},disabled:J,className:`flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 ease-out ${N?"bg-green-500/80 text-white shadow-lg scale-100":"bg-green-500/20 text-green-300 hover:bg-green-500/30 scale-95"} disabled:opacity-50`,children:"Да"})]})]}),e.jsx("div",{children:e.jsx("button",{type:"button",onClick:ge,disabled:F,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary disabled:opacity-50",children:F?"Добавление...":"Добавить упражнение"})}),e.jsx(kt,{open:I,templates:D,isCreating:k,onClose:()=>v(!1),onReplaceWithTemplate:tt}),e.jsx(vt,{open:ve,onClose:()=>de(!1),items:_.map(s=>({id:s.id,name:s.name,position:s.position??0})),onSave:Ze}),e.jsx(Pe,{open:ke,onOpenChange:we,title:"Удалить тренировку?",description:`Вы собираетесь удалить тренировку на ${Ee(o)}. Действие необратимо.`,confirmText:"Удалить",cancelText:"Отмена",variant:"danger",onConfirm:Ue}),e.jsx(jt,{open:je,value:ie,onClose:()=>ue(!1),onChange:Qe}),c&&m&&Me.createPortal(e.jsxs("div",{className:"fixed menu-popover",style:{top:m.top,left:m.left,width:192},role:"menu",children:[e.jsx("button",{onClick:()=>{K(),de(!0)},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Поменять порядок упражнений"}),e.jsx("button",{onClick:()=>{K(),et()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Изменить тренировку"}),e.jsx("button",{onClick:()=>{K(),Ge()},className:"w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors rounded-lg",children:"Удалить"})]}),document.body)]}):k?e.jsx("div",{className:"px-4 pt-4",children:e.jsx(Ie,{message:"Создание..."})}):e.jsxs("div",{className:"max-w-lg mx-auto px-4 pt-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(ze,{normalizedDate:o}),e.jsxs("h1",{className:"flex-1 text-xl font-bold text-center",children:["Тренировка на ",Ee(o)]})]}),e.jsxs("div",{className:"mt-4 p-6 text-center",children:[D.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Выбрать шаблон"}),e.jsx("div",{className:"space-y-2",children:D.map(s=>e.jsx("button",{onClick:()=>He(s),disabled:k,className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md disabled:opacity-50",children:s.name},s.id))})]}):e.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[e.jsx("p",{className:"text-gray-400",children:"Сначала создайте шаблон."}),e.jsxs(at,{to:"/templates/new",className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Создать шаблон"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"button",onClick:pe,disabled:k,className:"btn-dashed",children:"Создать свой день"})})]})]}):null:e.jsx(Ie,{message:"Загрузка тренировки..."})};export{Tt as default};
