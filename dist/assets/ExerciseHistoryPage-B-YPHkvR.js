import{u as C,s as I,j as e}from"./index-DicrduyI.js";import{r as x,e as Q}from"./vendor-BVca5W6X.js";import{u as E}from"./useDebounce-C2cqH541.js";import{c as L}from"./date-helpers-BoyNci5t.js";import{u as R}from"./use-scroll-restoration-CZtb4aM8.js";import{u as U}from"./usePageState-6XNG0ilq.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const $=180*1e3;function q(){const{user:g}=C(),[i,a]=U({key:"exercise-history-page",initialState:{searchQuery:"",results:[],loading:!1,hasSearched:!1,lastUpdated:null,lastQuery:null},ttl:1800*1e3}),{searchQuery:h,results:y,loading:k,hasSearched:f,lastUpdated:c,lastQuery:u}=i,d=x.useRef(0),N=x.useCallback(t=>{a(r=>({...r,searchQuery:t}))},[a]),j=x.useCallback(()=>{d.current+=1,a(t=>t.searchQuery===""&&t.results.length===0&&!t.hasSearched&&!t.loading&&t.lastUpdated===null&&t.lastQuery===null?t:{...t,searchQuery:"",results:[],hasSearched:!1,loading:!1,lastUpdated:null,lastQuery:null})},[a]),b=x.useCallback(async t=>{const r=t.trim();if(!g||!r){a(l=>({...l,results:[],hasSearched:!1,loading:!1,lastUpdated:null}));return}const m=++d.current;a(l=>d.current!==m?l:{...l,loading:!0,hasSearched:!0});try{const{data:l,error:w}=await I.from("workout_exercises").select(`
          id,
          name,
          workout_id,
          workout_sets (
            set_index,
            weight,
            reps,
            is_done,
            is_dropset,
            parent_set_index
          ),
          workouts!inner (
            id,
            workout_date,
            name,
            user_id
          )
        `).eq("workouts.user_id",g.id).ilike("name",`%${r}%`).order("workouts(workout_date)",{ascending:!1});if(w)throw w;const v=[];l&&l.forEach(o=>{if(!o.workouts)return;const D=(o.workout_sets||[]).map(n=>({setIndex:n.set_index,weight:n.weight,reps:n.reps,isDone:n.is_done,isDropset:n.is_dropset??!1,parentSetIndex:n.parent_set_index??null})).sort((n,p)=>{const _=n.isDropset?n.parentSetIndex??n.setIndex:n.setIndex,S=p.isDropset?p.parentSetIndex??p.setIndex:p.setIndex;return _!==S?_-S:n.isDropset!==p.isDropset?n.isDropset?1:-1:n.setIndex-p.setIndex});v.push({exerciseName:o.name,exerciseId:o.id,workoutDate:o.workouts.workout_date,workoutName:o.workouts.name,workoutId:o.workouts.id,sets:D})}),a(o=>d.current!==m?o:{...o,results:v,lastUpdated:Date.now(),lastQuery:r})}catch(l){console.error("Error searching exercises:",l),a(w=>d.current!==m?w:{...w,results:[]})}finally{a(l=>d.current!==m?l:{...l,loading:!1})}},[g,a]),s=x.useCallback(t=>{const r=t.trim();return r?!!(u===r&&c&&Date.now()-c<$):!1},[u,c]);return{pageState:i,searchQuery:h,results:y,loading:k,hasSearched:f,lastUpdated:c,lastQuery:u,setSearchQuery:N,clearSearch:j,searchExercises:b,shouldUseCache:s}}const T=()=>{const g=Q(),{searchQuery:i,results:a,loading:h,hasSearched:y,setSearchQuery:k,clearSearch:f,searchExercises:c,shouldUseCache:u}=q(),d=E(i,500),N="scroll:exercise-history",j=x.useRef(null);x.useEffect(()=>{const s=d.trim();if(!s){f();return}u(s)||c(s)},[d,c,u,f]),R({key:N,enabled:a.length>0}),x.useEffect(()=>{const s=()=>{if(document.visibilityState==="visible"){const t=i.trim();t&&!u(t)&&c(t)}};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[i,c,u]);const b=(s,t)=>{g(`/workout/${s}`,{state:{focusExerciseId:t}})};return e.jsxs("div",{className:"p-4 space-y-4 max-w-4xl mx-auto pt-safe",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"История упражнений"}),e.jsx("div",{className:"glass card-dark rounded-full px-4 py-3 search-container",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-5 w-5 text-gray-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 21l-4.35-4.35m0 0A7.5 7.5 0 103.5 10.5a7.5 7.5 0 0013.15 6.15z"})}),e.jsx("input",{ref:j,type:"text",value:i,onChange:s=>k(s.target.value),placeholder:"Поиск","aria-label":"Поиск упражнений",className:"flex-1 bg-transparent border-0 outline-none ring-0 focus:outline-none focus:ring-0 appearance-none text-white placeholder-white/60 text-base shadow-none search-input"}),e.jsx("button",{type:"button",onClick:()=>{var s;f(),(s=j.current)==null||s.focus()},"aria-label":"Очистить","aria-hidden":!i,className:`shrink-0 w-7 h-7 grid place-items-center rounded-full text-gray-400 hover:text-gray-200 hover:bg-white/10 transition ${i?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-4 w-4",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 6l12 12M18 6L6 18"})})})]})}),h&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white text-center",children:"Поиск..."})]})}),!h&&y&&a.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-400 text-lg",children:"Упражнения не найдены"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Попробуйте изменить запрос"})]}),!h&&!y&&!i&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto text-gray-600 mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),e.jsx("p",{className:"text-gray-400 text-lg",children:"Начните вводить название упражнения"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Вы увидите историю всех тренировок с этим упражнением"})]}),!h&&a.length>0&&e.jsx("div",{className:"space-y-4",children:a.map((s,t)=>e.jsxs("div",{className:"glass card-dark rounded-lg p-4 hover:bg-white/5 transition-colors cursor-pointer",onClick:()=>b(s.workoutDate,s.exerciseId),children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-baseline justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-white leading-tight",children:s.exerciseName}),e.jsx("p",{className:"text-sm font-medium text-blue-400 shrink-0",children:L(s.workoutDate)})]}),e.jsx("p",{className:"text-sm text-gray-400 mt-0.5",children:s.workoutName})]}),e.jsx("div",{className:"space-y-2",children:s.sets.length>0?e.jsx("div",{className:"grid grid-cols-1 gap-2",children:s.sets.map((r,m)=>e.jsxs("div",{className:`grid grid-cols-[96px_1fr_1fr] items-center gap-2 px-3 py-2 rounded border ${r.isDropset?"bg-purple-500/10 border-purple-500/30 ml-4":"bg-gray-800/30 border-gray-700/60"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[r.isDone&&e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-gray-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),r.isDropset?e.jsxs("span",{className:"text-sm text-purple-400 flex items-center gap-1",children:[e.jsx("span",{className:"text-xs",children:"↳"})," Дроп"]}):e.jsxs("span",{className:"text-sm text-gray-400",children:["Подход ",r.setIndex]})]}),e.jsxs("div",{className:"text-sm flex items-baseline gap-1 whitespace-nowrap tabular-nums",children:[e.jsx("span",{className:"text-gray-400",children:"Вес:"}),e.jsx("span",{className:"text-white",children:r.weight!==null?`${r.weight} кг`:"—"})]}),e.jsxs("div",{className:"text-sm flex items-baseline gap-1 whitespace-nowrap tabular-nums",children:[e.jsx("span",{className:"text-gray-400",children:"Повторы:"}),e.jsx("span",{className:"text-white",children:r.reps??"—"})]})]},m))}):e.jsx("p",{className:"text-sm text-gray-500",children:"Нет данных о подходах"})})]},`${s.workoutId}-${t}`))})]})};export{T as default};
