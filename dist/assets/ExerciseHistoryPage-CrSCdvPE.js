import{u as S,s as _,j as e}from"./index-c23xV8dA.js";import{r as u,e as Q}from"./vendor-BVca5W6X.js";import{u as E}from"./useDebounce-C2cqH541.js";import{c as D}from"./date-helpers-BoyNci5t.js";import{u as I}from"./use-scroll-restoration-CZtb4aM8.js";import{u as L}from"./usePageState-6XNG0ilq.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const R=180*1e3;function U(){const{user:p}=S(),[l,r]=L({key:"exercise-history-page",initialState:{searchQuery:"",results:[],loading:!1,hasSearched:!1,lastUpdated:null,lastQuery:null},ttl:1800*1e3}),{searchQuery:h,results:w,loading:j,hasSearched:g,lastUpdated:o,lastQuery:d}=l,c=u.useRef(0),k=u.useCallback(t=>{r(a=>({...a,searchQuery:t}))},[r]),y=u.useCallback(()=>{c.current+=1,r(t=>t.searchQuery===""&&t.results.length===0&&!t.hasSearched&&!t.loading&&t.lastUpdated===null&&t.lastQuery===null?t:{...t,searchQuery:"",results:[],hasSearched:!1,loading:!1,lastUpdated:null,lastQuery:null})},[r]),N=u.useCallback(async t=>{const a=t.trim();if(!p||!a){r(n=>({...n,results:[],hasSearched:!1,loading:!1,lastUpdated:null}));return}const x=++c.current;r(n=>c.current!==x?n:{...n,loading:!0,hasSearched:!0});try{const{data:n,error:f}=await _.from("workout_exercises").select(`
          id,
          name,
          workout_id,
          workout_sets (
            set_index,
            weight,
            reps,
            is_done
          ),
          workouts!inner (
            id,
            workout_date,
            name,
            user_id
          )
        `).eq("workouts.user_id",p.id).ilike("name",`%${a}%`).order("workouts(workout_date)",{ascending:!1});if(f)throw f;const b=[];n&&n.forEach(i=>{if(!i.workouts)return;const v=(i.workout_sets||[]).map(m=>({setIndex:m.set_index,weight:m.weight,reps:m.reps,isDone:m.is_done})).sort((m,C)=>m.setIndex-C.setIndex);b.push({exerciseName:i.name,exerciseId:i.id,workoutDate:i.workouts.workout_date,workoutName:i.workouts.name,workoutId:i.workouts.id,sets:v})}),r(i=>c.current!==x?i:{...i,results:b,lastUpdated:Date.now(),lastQuery:a})}catch(n){console.error("Error searching exercises:",n),r(f=>c.current!==x?f:{...f,results:[]})}finally{r(n=>c.current!==x?n:{...n,loading:!1})}},[p,r]),s=u.useCallback(t=>{const a=t.trim();return a?!!(d===a&&o&&Date.now()-o<R):!1},[d,o]);return{pageState:l,searchQuery:h,results:w,loading:j,hasSearched:g,lastUpdated:o,lastQuery:d,setSearchQuery:k,clearSearch:y,searchExercises:N,shouldUseCache:s}}const P=()=>{const p=Q(),{searchQuery:l,results:r,loading:h,hasSearched:w,setSearchQuery:j,clearSearch:g,searchExercises:o,shouldUseCache:d}=U(),c=E(l,500),k="scroll:exercise-history",y=u.useRef(null);u.useEffect(()=>{const s=c.trim();if(!s){g();return}d(s)||o(s)},[c,o,d,g]),I({key:k,enabled:r.length>0}),u.useEffect(()=>{const s=()=>{if(document.visibilityState==="visible"){const t=l.trim();t&&!d(t)&&o(t)}};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[l,o,d]);const N=(s,t)=>{p(`/workout/${s}`,{state:{focusExerciseId:t}})};return e.jsxs("div",{className:"p-4 space-y-4 max-w-4xl mx-auto pt-safe",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"История упражнений"}),e.jsx("div",{className:"glass card-dark rounded-full px-4 py-3 search-container",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-5 w-5 text-gray-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 21l-4.35-4.35m0 0A7.5 7.5 0 103.5 10.5a7.5 7.5 0 0013.15 6.15z"})}),e.jsx("input",{ref:y,type:"text",value:l,onChange:s=>j(s.target.value),placeholder:"Поиск","aria-label":"Поиск упражнений",className:"flex-1 bg-transparent border-0 outline-none ring-0 focus:outline-none focus:ring-0 appearance-none text-white placeholder-white/60 text-base shadow-none search-input"}),e.jsx("button",{type:"button",onClick:()=>{var s;g(),(s=y.current)==null||s.focus()},"aria-label":"Очистить","aria-hidden":!l,className:`shrink-0 w-7 h-7 grid place-items-center rounded-full text-gray-400 hover:text-gray-200 hover:bg-white/10 transition ${l?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-4 w-4",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 6l12 12M18 6L6 18"})})})]})}),h&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white text-center",children:"Поиск..."})]})}),!h&&w&&r.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-400 text-lg",children:"Упражнения не найдены"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Попробуйте изменить запрос"})]}),!h&&!w&&!l&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto text-gray-600 mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),e.jsx("p",{className:"text-gray-400 text-lg",children:"Начните вводить название упражнения"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Вы увидите историю всех тренировок с этим упражнением"})]}),!h&&r.length>0&&e.jsx("div",{className:"space-y-4",children:r.map((s,t)=>e.jsxs("div",{className:"glass card-dark rounded-lg p-4 hover:bg-white/5 transition-colors cursor-pointer",onClick:()=>N(s.workoutDate,s.exerciseId),children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-baseline justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-white leading-tight",children:s.exerciseName}),e.jsx("p",{className:"text-sm font-medium text-blue-400 shrink-0",children:D(s.workoutDate)})]}),e.jsx("p",{className:"text-sm text-gray-400 mt-0.5",children:s.workoutName})]}),e.jsx("div",{className:"space-y-2",children:s.sets.length>0?e.jsx("div",{className:"grid grid-cols-1 gap-2",children:s.sets.map((a,x)=>e.jsxs("div",{className:"grid grid-cols-[96px_1fr_1fr] items-center gap-2 px-3 py-2 rounded bg-gray-800/30 border border-gray-700/60",children:[e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[a.isDone&&e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-gray-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),e.jsxs("span",{className:"text-sm text-gray-400",children:["Подход ",a.setIndex]})]}),e.jsxs("div",{className:"text-sm flex items-baseline gap-1 whitespace-nowrap tabular-nums",children:[e.jsx("span",{className:"text-gray-400",children:"Вес:"}),e.jsx("span",{className:"text-white",children:a.weight!==null?`${a.weight} кг`:"—"})]}),e.jsxs("div",{className:"text-sm flex items-baseline gap-1 whitespace-nowrap tabular-nums",children:[e.jsx("span",{className:"text-gray-400",children:"Повторы:"}),e.jsx("span",{className:"text-white",children:a.reps??"—"})]})]},x))}):e.jsx("p",{className:"text-sm text-gray-500",children:"Нет данных о подходах"})})]},`${s.workoutId}-${t}`))})]})};export{P as default};
