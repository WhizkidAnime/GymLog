import{a as M,j as e,u as H,W as z,s as Q}from"./index-CLP7Nca7.js";import{j as A,e as K,r as m,f as y}from"./vendor-BVca5W6X.js";import{C as U}from"./confirm-dialog-4Kqi95RT.js";import{T as V}from"./template-saved-dialog-CgXVQ97b.js";import{u as X}from"./use-header-scroll-Cg2zr4na.js";import{W as D}from"./workout-icons-EzFPQzR0.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";import"./use-modal-scroll-lock-DlG-D3y9.js";const Y=({value:i,onChange:u})=>{const{t:c}=M(),a=Object.keys(D);return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-2 template-label",children:c.iconPicker.title}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>u(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all icon-picker-btn ${i===null?"icon-picker-selected":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400 font-bold",children:c.iconPicker.none})]}),a.map(l=>{const{component:x,color:h}=D[l],j=c.iconPicker.icons[l],v=i===l;return e.jsxs("button",{type:"button",onClick:()=>u(l),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all icon-picker-btn ${v?"icon-picker-selected":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center",style:{color:h},children:e.jsx(x,{size:24})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300 font-bold",children:j||l})]},l)})]})]})},C=()=>({_tempId:Date.now()+Math.random(),name:"",sets:void 0,reps:"",rest_seconds:void 0}),le=()=>{const{id:i}=A(),{user:u}=H(),c=K(),{t:a}=M(),l=Q,[x,h]=m.useState(""),[j,v]=m.useState(null),[g,f]=m.useState([C()]),[O,k]=m.useState(!0),[I,S]=m.useState(!1),[N,L]=m.useState({open:!1}),[P,E]=m.useState(!1),T=X(),_=y.useRef({}),W=y.useRef(null),w=y.useCallback(t=>{t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)},[]);y.useLayoutEffect(()=>{g.forEach(t=>{const s=_.current[t._tempId];s&&w(s)})},[g,w]);const $=({className:t=""})=>e.jsx("button",{type:"button",onClick:()=>c("/templates"),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${t}`,"aria-label":a.templateEditor.backToTemplates,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})});m.useEffect(()=>{i?(async()=>{k(!0);const[{data:s,error:n},{data:d,error:o}]=await Promise.all([l.from("workout_templates").select("id, name, icon").eq("id",i).single(),l.from("template_exercises").select("id, name, sets, reps, rest_seconds, position").eq("template_id",i).order("position")]);if(n){console.error("Error fetching template",n),c("/templates");return}if(o&&console.error("Error fetching exercises",o),s){h(s.name),v(s.icon);const r=(d||[]).map(p=>({...p,_tempId:Math.random()}));f(r.length>0?r:[C()])}k(!1)})():k(!1)},[i,c]);const b=(t,s,n)=>{f(d=>d.map(o=>{if(o._tempId===t){const r={...o};if(s==="sets"||s==="rest_seconds"){const p=parseInt(n,10);r[s]=isNaN(p)?"":p}else r[s]=n;return r}return o}))},q=()=>{f([...g,C()])},B=t=>{L({open:!0,tempId:t})},R=t=>{f(s=>s.map(n=>n._tempId===t?{...n,_state:"deleting"}:n)),setTimeout(()=>{f(s=>s.filter(n=>n._tempId!==t))},300)},F=async t=>{if(t.preventDefault(),!u){alert("You must be logged in to save a template.");return}S(!0);try{const{data:s,error:n}=await l.from("workout_templates").upsert({id:i,name:x,user_id:u.id,icon:j}).select("id").single();if(n||!s)throw n||new Error("Failed to save template.");const d=s.id;if(i){const{error:r}=await l.from("template_exercises").delete().eq("template_id",d);if(r)throw r}const o=g.filter(r=>r.name&&r.name.trim()!=="").map((r,p)=>({template_id:d,name:r.name,sets:Number(r.sets)||1,reps:r.reps||"1",rest_seconds:Number(r.rest_seconds)||0,position:p}));if(o.length>0){const{error:r}=await l.from("template_exercises").insert(o);if(r)throw r}E(!0)}catch(s){console.error("Error saving template:",s);try{const d=i?l.from("workout_templates").select("id").eq("id",i).maybeSingle():l.from("workout_templates").select("id").eq("user_id",u.id).eq("name",x).order("created_at",{ascending:!1}).limit(1).maybeSingle(),{data:o}=await d,r=o==null?void 0:o.id;if(r){const{count:p}=await l.from("template_exercises").select("id",{count:"exact",head:!0}).eq("template_id",r);E(!0);return}}catch{}const n=(s.message||"").includes("invalid input syntax for type integer")?'Не удалось сохранить диапазон повторений (например, "10-12"). Пожалуйста, убедитесь, что схема вашей базы данных обновлена. В Supabase SQL Editor нужно выполнить скрипт, чтобы колонка "reps" имела тип TEXT.':`Ошибка сохранения: ${s.message}`;alert(n)}finally{S(!1)}};return O?e.jsx(z,{message:a.templateEditor.loading}):e.jsxs("div",{className:"relative p-4 max-w-lg mx-auto template-editor",children:[e.jsx("div",{className:`status-bar-blur ${T?"visible":""}`}),e.jsx("div",{ref:W,className:"top-sentinel","aria-hidden":"true"}),e.jsxs("div",{className:`mb-6 glass card-dark p-4 flex items-center gap-4 header-container ${T?"scrolling":""}`,children:[e.jsx($,{className:"shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0 text-center",children:e.jsx("h1",{className:"text-xl font-bold",children:i?a.templateEditor.editTemplate:a.templateEditor.newTemplate})})]}),e.jsxs("form",{onSubmit:F,className:"space-y-6",style:{paddingBottom:"calc(0.5rem + env(safe-area-inset-bottom, 0px))"},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"template-name",className:"block text-xl font-semibold template-label",children:a.templateEditor.dayName}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{id:"template-name",type:"text",value:x,onChange:t=>h(t.target.value),placeholder:a.templateEditor.dayNamePlaceholder,required:!0,className:"mt-1 block w-full px-3 pr-9 py-2 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 template-input"}),x&&e.jsx("button",{type:"button",onClick:()=>h(""),"aria-label":a.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx(Y,{value:j,onChange:v}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:a.templateEditor.exercises}),g.map(t=>e.jsx("div",{className:`exercise-card relative transition-all duration-300 ease-in-out ${t._state==="deleting"?"opacity-0 max-h-0 p-0 border-0 m-0":"glass card-dark"}`,children:e.jsxs("div",{className:`${t._state==="deleting"?"hidden":"p-4 space-y-3"}`,children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{ref:s=>_.current[t._tempId]=s,placeholder:a.templateEditor.exercisePlaceholder,value:t.name||"",onChange:s=>{b(t._tempId,"name",s.target.value),w(s.currentTarget)},rows:1,className:"w-full px-3 pr-9 py-2 rounded-md resize-none overflow-y-hidden min-h-[2.5rem] leading-relaxed template-input"}),t.name&&t.name.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{b(t._tempId,"name","");const s=_.current[t._tempId];s&&w(s)},"aria-label":a.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{type:"button",onClick:()=>B(t._tempId),className:"delete-btn btn-glass btn-glass-icon btn-glass-outline","aria-label":a.exercise.deleteExercise,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs template-sublabel",children:a.templateEditor.setsLabel}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"3",value:t.sets??"",onChange:s=>b(t._tempId,"sets",s.target.value),className:"w-full p-1 text-center rounded-md template-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs template-sublabel",children:a.templateEditor.repsLabel}),e.jsx("input",{type:"text",placeholder:"10-12",value:t.reps||"",onChange:s=>b(t._tempId,"reps",s.target.value),className:"w-full p-1 text-center rounded-md template-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs template-sublabel",children:a.templateEditor.restLabel}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"60",value:t.rest_seconds??"",onChange:s=>b(t._tempId,"rest_seconds",s.target.value),className:"w-full p-1 text-center rounded-md template-input"})]})]})]})},t._tempId)),e.jsx("button",{type:"button",onClick:q,className:"btn-dashed",children:a.templateEditor.addExercise})]}),e.jsx("button",{type:"submit",disabled:I,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:I?a.templateEditor.saving:a.templateEditor.saveTemplate})]}),e.jsx(U,{open:N.open,onOpenChange:t=>L({open:t}),title:a.templateEditor.deleteExercise,description:a.templateEditor.deleteExerciseDesc,confirmText:a.common.delete,cancelText:a.common.cancel,variant:"danger",onConfirm:async()=>{N.tempId!==void 0&&R(N.tempId)}}),e.jsx(V,{open:P,onOpenChange:E,onClose:()=>c("/templates")})]})};export{le as default};
