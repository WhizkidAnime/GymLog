import{j as e,u as F,s as P}from"./index-XgLgGVJK.js";import{j as H,e as z,r as c,f as y}from"./vendor-BVca5W6X.js";import{C as Q}from"./confirm-dialog-JlztVqT1.js";import{T as A}from"./template-saved-dialog-TV2TXl0Z.js";import{u as K}from"./use-header-scroll-Cg2zr4na.js";import{W as U}from"./workout-loading-overlay-B8OOFS9S.js";import{W as L}from"./workout-icons-CbeUKMv2.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";import"./use-modal-scroll-lock-DlG-D3y9.js";const V=({value:l,onChange:m})=>{const p=Object.keys(L);return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-2",style:{color:"#ffffffff"},children:"Иконка дня"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>m(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${l===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:"Нет"})]}),p.map(n=>{const{component:u,label:h,color:b}=L[n],j=l===n;return e.jsxs("button",{type:"button",onClick:()=>m(n),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${j?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center",style:{color:b},children:e.jsx(u,{size:24})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:h})]},n)})]})]})},C=()=>({_tempId:Date.now()+Math.random(),name:"",sets:void 0,reps:"",rest_seconds:void 0}),ne=()=>{const{id:l}=H(),{user:m}=F(),p=z(),n=P,[u,h]=c.useState(""),[b,j]=c.useState(null),[f,x]=c.useState([C()]),[T,w]=c.useState(!0),[E,I]=c.useState(!1),[k,S]=c.useState({open:!1}),[M,N]=c.useState(!1),D=K(),_=y.useRef({}),O=y.useRef(null),v=y.useCallback(t=>{t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)},[]);y.useLayoutEffect(()=>{f.forEach(t=>{const s=_.current[t._tempId];s&&v(s)})},[f,v]);const W=({className:t=""})=>e.jsx("button",{type:"button",onClick:()=>p("/templates"),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${t}`,"aria-label":"Назад к шаблонам",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})});c.useEffect(()=>{l?(async()=>{w(!0);const[{data:s,error:a},{data:i,error:o}]=await Promise.all([n.from("workout_templates").select("id, name, icon").eq("id",l).single(),n.from("template_exercises").select("id, name, sets, reps, rest_seconds, position").eq("template_id",l).order("position")]);if(a){console.error("Error fetching template",a),p("/templates");return}if(o&&console.error("Error fetching exercises",o),s){h(s.name),j(s.icon);const r=(i||[]).map(d=>({...d,_tempId:Math.random()}));x(r.length>0?r:[C()])}w(!1)})():w(!1)},[l,p]);const g=(t,s,a)=>{x(i=>i.map(o=>{if(o._tempId===t){const r={...o};if(s==="sets"||s==="rest_seconds"){const d=parseInt(a,10);r[s]=isNaN(d)?"":d}else r[s]=a;return r}return o}))},$=()=>{x([...f,C()])},q=t=>{S({open:!0,tempId:t})},B=t=>{x(s=>s.map(a=>a._tempId===t?{...a,_state:"deleting"}:a)),setTimeout(()=>{x(s=>s.filter(a=>a._tempId!==t))},300)},R=async t=>{if(t.preventDefault(),!m){alert("You must be logged in to save a template.");return}I(!0);try{const{data:s,error:a}=await n.from("workout_templates").upsert({id:l,name:u,user_id:m.id,icon:b}).select("id").single();if(a||!s)throw a||new Error("Failed to save template.");const i=s.id;if(l){const{error:r}=await n.from("template_exercises").delete().eq("template_id",i);if(r)throw r}const o=f.filter(r=>r.name&&r.name.trim()!=="").map((r,d)=>({template_id:i,name:r.name,sets:Number(r.sets)||1,reps:r.reps||"1",rest_seconds:Number(r.rest_seconds)||0,position:d}));if(o.length>0){const{error:r}=await n.from("template_exercises").insert(o);if(r)throw r}N(!0)}catch(s){console.error("Error saving template:",s);try{const i=l?n.from("workout_templates").select("id").eq("id",l).maybeSingle():n.from("workout_templates").select("id").eq("user_id",m.id).eq("name",u).order("created_at",{ascending:!1}).limit(1).maybeSingle(),{data:o}=await i,r=o==null?void 0:o.id;if(r){const{count:d}=await n.from("template_exercises").select("id",{count:"exact",head:!0}).eq("template_id",r);N(!0);return}}catch{}const a=(s.message||"").includes("invalid input syntax for type integer")?'Не удалось сохранить диапазон повторений (например, "10-12"). Пожалуйста, убедитесь, что схема вашей базы данных обновлена. В Supabase SQL Editor нужно выполнить скрипт, чтобы колонка "reps" имела тип TEXT.':`Ошибка сохранения: ${s.message}`;alert(a)}finally{I(!1)}};return T?e.jsx(U,{message:"Загрузка редактора..."}):e.jsxs("div",{className:"relative p-4 max-w-lg mx-auto template-editor",children:[e.jsx("div",{className:`status-bar-blur ${D?"visible":""}`}),e.jsx("div",{ref:O,className:"top-sentinel","aria-hidden":"true"}),e.jsxs("div",{className:`mb-6 glass card-dark p-4 flex items-center gap-4 header-container ${D?"scrolling":""}`,children:[e.jsx(W,{className:"shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0 text-center",children:e.jsx("h1",{className:"text-xl font-bold",children:l?"Редактировать шаблон":"Новый шаблон"})})]}),e.jsxs("form",{onSubmit:R,className:"space-y-6",style:{paddingBottom:"calc(0.5rem + env(safe-area-inset-bottom, 0px))"},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"template-name",className:"block text-xl font-semibold",style:{color:"#ffffffff"},children:"Название дня"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{id:"template-name",type:"text",value:u,onChange:t=>h(t.target.value),placeholder:"Например, Push Day",required:!0,className:"mt-1 block w-full px-3 pr-9 py-2 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",style:{backgroundColor:"#18181b",color:"#fafafa",border:"1px solid #3f3f46"}}),u&&e.jsx("button",{type:"button",onClick:()=>h(""),"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx(V,{value:b,onChange:j}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Упражнения"}),f.map(t=>e.jsx("div",{className:`exercise-card relative transition-all duration-300 ease-in-out ${t._state==="deleting"?"opacity-0 max-h-0 p-0 border-0 m-0":"glass card-dark"}`,children:e.jsxs("div",{className:`${t._state==="deleting"?"hidden":"p-4 space-y-3"}`,children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{ref:s=>_.current[t._tempId]=s,placeholder:"Название упражнения",value:t.name||"",onChange:s=>{g(t._tempId,"name",s.target.value),v(s.currentTarget)},rows:1,className:"w-full px-3 pr-9 py-2 rounded-md resize-none overflow-y-hidden min-h-[2.5rem] leading-relaxed",style:{backgroundColor:"#18181b",color:"#fafafa",border:"1px solid #3f3f46",fontFamily:"inherit"}}),t.name&&t.name.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{g(t._tempId,"name","");const s=_.current[t._tempId];s&&v(s)},"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{type:"button",onClick:()=>q(t._tempId),className:"delete-btn btn-glass btn-glass-icon btn-glass-outline","aria-label":"Удалить упражнение",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",style:{color:"#e4e4e7"},children:"Подходы"}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"3",value:t.sets??"",onChange:s=>g(t._tempId,"sets",s.target.value),className:"w-full p-1 text-center rounded-md",style:{backgroundColor:"#18181b",color:"#fafafa",border:"1px solid #3f3f46"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",style:{color:"#e4e4e7"},children:"Повторы"}),e.jsx("input",{type:"text",placeholder:"10-12",value:t.reps||"",onChange:s=>g(t._tempId,"reps",s.target.value),className:"w-full p-1 text-center rounded-md",style:{backgroundColor:"#18181b",color:"#fafafa",border:"1px solid #3f3f46"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs",style:{color:"#e4e4e7"},children:"Отдых (сек)"}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"60",value:t.rest_seconds??"",onChange:s=>g(t._tempId,"rest_seconds",s.target.value),className:"w-full p-1 text-center rounded-md",style:{backgroundColor:"#18181b",color:"#fafafa",border:"1px solid #3f3f46"}})]})]})]})},t._tempId)),e.jsx("button",{type:"button",onClick:$,className:"btn-dashed",children:"+ Добавить упражнение"})]}),e.jsx("button",{type:"submit",disabled:E,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:E?"Сохранение...":"Сохранить шаблон"})]}),e.jsx(Q,{open:k.open,onOpenChange:t=>S({open:t}),title:"Удалить упражнение?",description:"Это упражнение будет удалено из шаблона. Действие необратимо.",confirmText:"Удалить",cancelText:"Отмена",variant:"danger",onConfirm:async()=>{k.tempId!==void 0&&B(k.tempId)}}),e.jsx(A,{open:M,onOpenChange:N,onClose:()=>p("/templates")})]})};export{ne as default};
