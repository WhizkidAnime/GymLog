import{a as W,j as e,u as A,W as K,s as U}from"./index-BtV5doUL.js";import{j as V,e as X,u as Y,r as m,f as w}from"./vendor-BVca5W6X.js";import{C as G}from"./confirm-dialog-BcWcSFSI.js";import{T as J}from"./template-saved-dialog-Dhidh0Lo.js";import{u as Z}from"./use-header-scroll-Cg2zr4na.js";import{W as O}from"./workout-icons-uMbJxgo_.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";import"./use-modal-scroll-lock-DlG-D3y9.js";const ee=({value:o,onChange:u})=>{const{t:c}=W(),y=Object.keys(O);return e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-semibold mb-2 template-label",children:c.iconPicker.title}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>u(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all icon-picker-btn ${o===null?"icon-picker-selected":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400 font-bold",children:c.iconPicker.none})]}),y.map(a=>{const{component:i,color:v}=O[a],h=c.iconPicker.icons[a],x=o===a;return e.jsxs("button",{type:"button",onClick:()=>u(a),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all icon-picker-btn ${x?"icon-picker-selected":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center",style:{color:v},children:e.jsx(i,{size:24})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300 font-bold",children:h||a})]},a)})]})]})},C=()=>({_tempId:Date.now()+Math.random(),name:"",sets:void 0,reps:"",rest_seconds:void 0}),de=()=>{var P;const{id:o}=V(),{user:u}=A(),c=X(),y=Y(),{t:a}=W(),i=U,v=((P=y.state)==null?void 0:P.from)==="archive"?"/templates/archive":"/templates",[h,x]=m.useState(""),[I,S]=m.useState(null),[g,f]=m.useState([C()]),[$,k]=m.useState(!0),[L,T]=m.useState(!1),[N,D]=m.useState({open:!1}),[q,E]=m.useState(!1),M=Z(),_=w.useRef({}),B=w.useRef(null),j=w.useCallback(t=>{t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)},[]);w.useLayoutEffect(()=>{g.forEach(t=>{const s=_.current[t._tempId];s&&j(s)})},[g,j]);const R=({className:t=""})=>e.jsx("button",{type:"button",onClick:()=>c(v),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${t}`,"aria-label":a.templateEditor.backToTemplates,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})});m.useEffect(()=>{o?(async()=>{k(!0);const[{data:s,error:n},{data:d,error:l}]=await Promise.all([i.from("workout_templates").select("id, name, icon").eq("id",o).single(),i.from("template_exercises").select("id, name, sets, reps, rest_seconds, position").eq("template_id",o).order("position")]);if(n){console.error("Error fetching template",n),c("/templates");return}if(l&&console.error("Error fetching exercises",l),s){x(s.name),S(s.icon);const r=(d||[]).map(p=>({...p,_tempId:Math.random()}));f(r.length>0?r:[C()])}k(!1)})():k(!1)},[o,c]);const b=(t,s,n)=>{f(d=>d.map(l=>{if(l._tempId===t){const r={...l};if(s==="sets"||s==="rest_seconds"){const p=parseInt(n,10);r[s]=isNaN(p)?"":p}else r[s]=n;return r}return l}))},F=()=>{f([...g,C()])},H=t=>{D({open:!0,tempId:t})},z=t=>{f(s=>s.map(n=>n._tempId===t?{...n,_state:"deleting"}:n)),setTimeout(()=>{f(s=>s.filter(n=>n._tempId!==t))},300)},Q=async t=>{if(t.preventDefault(),!u){alert("You must be logged in to save a template.");return}T(!0);try{const{data:s,error:n}=await i.from("workout_templates").upsert({id:o,name:h,user_id:u.id,icon:I}).select("id").single();if(n||!s)throw n||new Error("Failed to save template.");const d=s.id;if(o){const{error:r}=await i.from("template_exercises").delete().eq("template_id",d);if(r)throw r}const l=g.filter(r=>r.name&&r.name.trim()!=="").map((r,p)=>({template_id:d,name:r.name,sets:Number(r.sets)||1,reps:r.reps||"1",rest_seconds:Number(r.rest_seconds)||0,position:p}));if(l.length>0){const{error:r}=await i.from("template_exercises").insert(l);if(r)throw r}E(!0)}catch(s){console.error("Error saving template:",s);try{const d=o?i.from("workout_templates").select("id").eq("id",o).maybeSingle():i.from("workout_templates").select("id").eq("user_id",u.id).eq("name",h).order("created_at",{ascending:!1}).limit(1).maybeSingle(),{data:l}=await d,r=l==null?void 0:l.id;if(r){const{count:p}=await i.from("template_exercises").select("id",{count:"exact",head:!0}).eq("template_id",r);E(!0);return}}catch{}const n=(s.message||"").includes("invalid input syntax for type integer")?'Не удалось сохранить диапазон повторений (например, "10-12"). Пожалуйста, убедитесь, что схема вашей базы данных обновлена. В Supabase SQL Editor нужно выполнить скрипт, чтобы колонка "reps" имела тип TEXT.':`Ошибка сохранения: ${s.message}`;alert(n)}finally{T(!1)}};return $?e.jsx(K,{message:a.templateEditor.loading}):e.jsxs("div",{className:"relative p-4 max-w-lg mx-auto template-editor",children:[e.jsx("div",{className:`status-bar-blur ${M?"visible":""}`}),e.jsx("div",{ref:B,className:"top-sentinel","aria-hidden":"true"}),e.jsxs("div",{className:`mb-6 glass card-dark p-4 flex items-center gap-4 header-container ${M?"scrolling":""}`,children:[e.jsx(R,{className:"shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0 text-center",children:e.jsx("h1",{className:"text-xl font-bold",children:o?a.templateEditor.editTemplate:a.templateEditor.newTemplate})})]}),e.jsxs("form",{onSubmit:Q,className:"space-y-6",style:{paddingBottom:"calc(0.5rem + env(safe-area-inset-bottom, 0px))"},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"template-name",className:"block text-xl font-semibold template-label",children:a.templateEditor.dayName}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{id:"template-name",type:"text",value:h,onChange:t=>x(t.target.value),placeholder:a.templateEditor.dayNamePlaceholder,required:!0,className:"mt-1 block w-full px-3 pr-9 py-2 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 template-input"}),h&&e.jsx("button",{type:"button",onClick:()=>x(""),"aria-label":a.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx(ee,{value:I,onChange:S}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:a.templateEditor.exercises}),g.map(t=>e.jsx("div",{className:`exercise-card relative transition-all duration-300 ease-in-out ${t._state==="deleting"?"opacity-0 max-h-0 p-0 border-0 m-0":"glass card-dark"}`,children:e.jsxs("div",{className:`${t._state==="deleting"?"hidden":"p-4 space-y-3"}`,children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{ref:s=>_.current[t._tempId]=s,placeholder:a.templateEditor.exercisePlaceholder,value:t.name||"",onChange:s=>{b(t._tempId,"name",s.target.value),j(s.currentTarget)},rows:1,className:"w-full px-3 pr-9 py-2 rounded-md resize-none overflow-y-hidden min-h-[2.5rem] leading-relaxed template-input"}),t.name&&t.name.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{b(t._tempId,"name","");const s=_.current[t._tempId];s&&j(s)},"aria-label":a.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{type:"button",onClick:()=>H(t._tempId),className:"delete-btn btn-glass btn-glass-icon btn-glass-outline","aria-label":a.exercise.deleteExercise,children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs template-sublabel",children:a.templateEditor.setsLabel}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"3",value:t.sets??"",onChange:s=>b(t._tempId,"sets",s.target.value),className:"w-full p-1 text-center rounded-md template-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs template-sublabel",children:a.templateEditor.repsLabel}),e.jsx("input",{type:"text",placeholder:"10-12",value:t.reps||"",onChange:s=>b(t._tempId,"reps",s.target.value),className:"w-full p-1 text-center rounded-md template-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs template-sublabel",children:a.templateEditor.restLabel}),e.jsx("input",{type:"number",inputMode:"numeric",placeholder:"60",value:t.rest_seconds??"",onChange:s=>b(t._tempId,"rest_seconds",s.target.value),className:"w-full p-1 text-center rounded-md template-input"})]})]})]})},t._tempId)),e.jsx("button",{type:"button",onClick:F,className:"btn-dashed",children:a.templateEditor.addExercise})]}),e.jsx("button",{type:"submit",disabled:L,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:L?a.templateEditor.saving:a.templateEditor.saveTemplate})]}),e.jsx(G,{open:N.open,onOpenChange:t=>D({open:t}),title:a.templateEditor.deleteExercise,description:a.templateEditor.deleteExerciseDesc,confirmText:a.common.delete,cancelText:a.common.cancel,variant:"danger",onConfirm:async()=>{N.tempId!==void 0&&z(N.tempId)}}),e.jsx(J,{open:q,onOpenChange:E,onClose:()=>c(v)})]})};export{de as default};
