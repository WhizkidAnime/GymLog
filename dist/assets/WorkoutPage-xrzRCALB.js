import{j as e,s as ee,u as Oe}from"./index-DJGkhl9Z.js";import{f as Fe,r as a,e as qe,c as Le,j as rt,u as nt,L as ot}from"./vendor-BVca5W6X.js";import{u as at}from"./usePageState-6XNG0ilq.js";import{u as Se}from"./useDebounce-C2cqH541.js";import{C as Be}from"./confirm-dialog-Bo5_LRl8.js";import{c as Ee,f as it}from"./date-helpers-BoyNci5t.js";import{n as We,p as ct}from"./exercise-name-BJxyXXn3.js";import{W as De}from"./workout-icons-C7AdcnVm.js";import{W as Ae}from"./workout-loading-overlay-RFfDNnxN.js";import{u as Pe}from"./use-modal-scroll-lock-DlG-D3y9.js";import{u as lt}from"./use-workout-actions-menu-C-5wTXkz.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const dt=({set:t,previousSet:n,onChange:l})=>{const f=`workout_set_draft:${t.id}`,r=`workout_set_last_non_max_reps:${t.id}`,o=c=>c==null?"":String(c).replace(".",","),p=c=>{if(c==="")return null;const u=Number(c.replace(",","."));return Number.isFinite(u)?u:null},T=c=>{let u=c.replace(".",",");u=u.replace(/[^\d,]/g,"");const j=u.indexOf(",");return j!==-1&&(u=u.slice(0,j+1)+u.slice(j+1).replace(/,/g,"")),u},x="макс.",b=c=>c==null?"":c==="0"?x:c,g=c=>{const u=c.trim();if(u==="")return null;const j=u.toLowerCase();return j==="макс"||j==="макс."||/^0+$/.test(u)?"0":u},$=c=>{const u=c.trim();return u===""?"":/^0+$/.test(u)||u.toLowerCase().startsWith("макс")?x:u.replace(/[^0-9]/g,"")},A=b(t.reps),[N,L]=a.useState(o(t.weight)),[S,O]=a.useState(A),[W,h]=a.useState(g(A)==="0"?null:A||null),[d,E]=a.useState(t.is_done),[P,v]=a.useState(!1),[y,F]=a.useState(()=>g(A)==="0"),Q=Se(N,500),Y=Se(S,500),G=!!n&&n.is_done&&n.weight!==null&&p(N)===null,H=c=>{h(c);try{c&&c.trim()!==""?localStorage.setItem(r,c):localStorage.removeItem(r)}catch{}};a.useEffect(()=>{try{const c=localStorage.getItem(f);if(!c)return;const u=JSON.parse(c),j=new Date(t.updated_at).getTime();if(u.updatedAt>j){L(u.weight===""?"":o(u.weight));const Z=b(u.reps);O(Z);const q=g(Z)==="0"?null:Z||null;H(q),E(u.isDone)}}catch{}},[]),a.useEffect(()=>{E(t.is_done)},[t.is_done]),a.useEffect(()=>{if(t.reps==="0")try{const c=localStorage.getItem(r);c&&c.trim()!==""&&h(c)}catch{}},[t.reps,r]),a.useEffect(()=>{(async()=>{const u=p(Q),j=g(Y);if(u!==(t.weight??null)||j!==(t.reps??null)||d!==t.is_done){const Z={weight:u===null?"":u,reps:j,isDone:d,updatedAt:Date.now()};try{localStorage.setItem(f,JSON.stringify(Z))}catch{}v(!0);const{error:q}=await ee.from("workout_sets").update({weight:u,reps:j,is_done:d,updated_at:new Date().toISOString()}).eq("id",t.id);if(q)console.error("Error saving set:",q);else{try{localStorage.removeItem(f)}catch{}const ne={...t,weight:u,reps:j,is_done:d,updated_at:new Date().toISOString()};l==null||l(ne)}setTimeout(()=>v(!1),500)}})()},[Q,Y,t.id,t.weight,t.reps,t.is_done,d,f]),a.useEffect(()=>{const c=p(Q)!==null,u=g(Y)!==null,j=c&&u;j&&!d?E(!0):!j&&d&&E(!1)},[Q,Y,d]);const K=d?"bg-green-500":"bg-transparent",se=d?"text-black":"text-inherit",re=g(S)==="0",m=y||re,k=()=>{const c=g(S),u=c!==null&&c!=="0";if(m)re&&(W!==null&&W.trim()!==""?O(W):O("")),F(!1);else{if(u){F(!0);return}g(S)!=="0"&&S.trim()!==""&&H(S),O(x),F(!0)}};return e.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${K}`,children:[e.jsx("div",{className:`col-span-1 text-center font-medium ${se}`,children:t.set_index}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:N,onChange:c=>L(T(c.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-500 focus:placeholder-transparent hover:placeholder-transparent outline-none focus-visible:outline-none ${se}`,style:{backgroundColor:d?"#ffffff":"#18181b",color:d?"#0a0a0a":"#fafafa"}})}),G&&e.jsx("button",{type:"button",onClick:()=>{!n||n.weight===null||L(o(n.weight))},"aria-label":"Скопировать вес из предыдущего подхода",className:"btn-glass btn-glass-icon-round btn-glass-secondary absolute text-white h-6 w-6 p-0",style:{left:"50%",top:"50%",transform:"translate(-50%, -50%)",transition:"none",width:"1.5rem",height:"1.5rem",minWidth:"1.5rem",minHeight:"1.5rem",padding:0},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"12",height:"12",fill:"none",stroke:"currentColor",strokeWidth:"2.2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"5 15 12 8 19 15"})})}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:S,onChange:c=>{const u=$(c.target.value);if(O(u),g(u)!=="0"){const j=u.trim()===""?null:u;H(j)}},className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-500 focus:placeholder-transparent hover:placeholder-transparent outline-none focus-visible:outline-none ${se}`,style:{backgroundColor:d?"#ffffff":"#18181b",color:d?"#0a0a0a":"#fafafa"}})}),e.jsx("div",{className:"col-span-1 flex justify-center",children:e.jsx("input",{type:"checkbox",checked:m,onChange:k,"aria-label":"Подход в отказ (макс.)",className:"h-6 w-6 rounded-md border border-gray-300 bg-white outline-none focus-visible:outline-none",style:{accentColor:"#000000",color:"#0a0a0a"}})}),P&&e.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},ut=Fe.memo(dt,(t,n)=>{var l,f,r,o;return t.set.id===n.set.id&&t.set.weight===n.set.weight&&t.set.reps===n.set.reps&&t.set.is_done===n.set.is_done&&t.set.set_index===n.set.set_index&&t.set.updated_at===n.set.updated_at&&((l=t.previousSet)==null?void 0:l.weight)===((f=n.previousSet)==null?void 0:f.weight)&&((r=t.previousSet)==null?void 0:r.is_done)===((o=n.previousSet)==null?void 0:o.is_done)}),mt=({restSeconds:t,exerciseId:n,onAdjustRestSeconds:l})=>{const f=n?`rest_timer:${n}`:void 0,r=a.useRef(null),o=a.useRef(t),p=a.useRef({time:t,isActive:!1,endAt:null}),[T,x]=a.useState(()=>{if(!f)return{time:t,isActive:!1,endAt:null};try{const h=localStorage.getItem(f);if(!h)return{time:t,isActive:!1,endAt:null};const d=JSON.parse(h),E=360*60*1e3;if(Date.now()-d.savedAt>E)return localStorage.removeItem(f),{time:t,isActive:!1,endAt:null};if(d.isActive&&d.endAt){const P=Math.max(0,Math.floor((d.endAt-Date.now())/1e3));return P>0?{time:P,isActive:!0,endAt:d.endAt}:(localStorage.removeItem(f),{time:d.restSeconds,isActive:!1,endAt:null})}return{time:d.restSeconds,isActive:!1,endAt:null}}catch(h){return console.error("Error restoring timer state:",h),{time:t,isActive:!1,endAt:null}}}),{time:b,isActive:g,endAt:$}=T,A=a.useCallback((h,d)=>{if(f)try{const E={endAt:h.endAt,isActive:h.isActive,restSeconds:d??p.current.time??t,savedAt:Date.now()};localStorage.setItem(f,JSON.stringify(E))}catch(E){console.error("Error persisting timer:",E)}},[f,t]),N=a.useRef(A);a.useEffect(()=>{N.current=A},[A]),a.useEffect(()=>{p.current={time:b,isActive:g,endAt:$}},[b,g,$]),a.useEffect(()=>{if(!g||!$){r.current&&(window.clearInterval(r.current),r.current=null);return}let h=!1;const d=()=>{if(h)return;const P=Date.now(),v=Math.max(0,$-P),y=Math.floor(v/1e3);x(F=>({...F,time:y})),y<=0&&(h=!0,x(F=>({...F,isActive:!1,endAt:null,time:t})),r.current&&(window.clearInterval(r.current),r.current=null),f&&localStorage.removeItem(f))};d();const E=window.setInterval(d,1e3);return r.current=E,()=>{h=!0,r.current&&(window.clearInterval(r.current),r.current=null)}},[g,$,f,t]),a.useEffect(()=>{!g&&t!==o.current&&x(h=>({...h,time:t})),o.current=t},[t,g]),a.useEffect(()=>()=>{r.current&&(window.clearInterval(r.current),r.current=null);const{isActive:h,endAt:d}=p.current;h&&d&&N.current({endAt:d,isActive:!0})},[]);const L=()=>{x(h=>{if(h.isActive)return A({endAt:null,isActive:!1},h.time),r.current&&(window.clearInterval(r.current),r.current=null),{time:h.time,isActive:!1,endAt:null};const d=Date.now()+h.time*1e3;return A({endAt:d,isActive:!0},h.time),{time:h.time,isActive:!0,endAt:d}})},S=()=>{x({time:t,isActive:!1,endAt:null}),r.current&&(window.clearInterval(r.current),r.current=null),f&&localStorage.removeItem(f)},O=h=>{x(d=>{const E=Math.max(0,d.time+h);if(E===0)return A({endAt:null,isActive:!1},0),r.current&&(window.clearInterval(r.current),r.current=null),{time:0,isActive:!1,endAt:null};if(d.isActive){const P=Date.now()+E*1e3;return A({endAt:P,isActive:!0},E),{time:E,isActive:!0,endAt:P}}return A({endAt:null,isActive:!1},E),{time:E,isActive:!1,endAt:null}}),l==null||l(h)},W=h=>{const d=Math.floor(h/60),E=h%60;return`${d}:${E<10?"0":""}${E}`};return e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:()=>O(-30),disabled:b<=0&&!g,className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"-"}),e.jsx("div",{className:`text-6xl font-mono font-semibold leading-none min-w-[4ch] text-center ${g?"text-white":""}`,children:W(b)}),e.jsx("button",{onClick:()=>O(30),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3",children:[e.jsx("button",{onClick:L,className:`btn-glass btn-glass-icon-lg ${g?"btn-glass-danger":"btn-glass-primary"}`,children:g?"Стоп":"Старт"}),e.jsx("button",{onClick:S,className:"btn-glass btn-glass-icon-sm btn-glass-secondary",children:"Сброс"})]})]})},ft=7200*1e3,$e=new Map,ht=(t,n,l)=>`${t}:${n}:${l||"none"}`,wt=t=>{const n=$e.get(t);if(!n)return;if(Date.now()-n.timestamp>ft){$e.delete(t);return}return n.data},be=(t,n)=>{$e.set(t,{data:n,timestamp:Date.now()})},pt=({exercise:t,workoutDate:n,onUpdateExercise:l,onDeleteExercise:f})=>{var re;const[r,o]=a.useState(t.name),[p,T]=a.useState(t.sets),[x,b]=a.useState(t.rest_seconds),[g,$]=a.useState(!1),[A,N]=a.useState(null),[L,S]=a.useState("idle"),O=a.useRef(null),{user:W}=Oe(),h=Se(r,500),d=Se(x,500),[E,P]=a.useState(!1),v=a.useRef(t.name),y=a.useCallback(()=>{const m=O.current;m&&(m.style.height="auto",m.style.height=`${m.scrollHeight}px`)},[]);a.useEffect(()=>{t.name!==v.current&&(o(t.name),v.current=t.name),T(t.sets),b(t.rest_seconds)},[t.id,t.sets,t.rest_seconds]),a.useEffect(()=>{if(!W)return;const m=h.trim(),k=We(m);if(!k){N(null),S("idle");return}const c=ht(W.id,k,n??null),u=wt(c);if(u!==void 0){N(u),S("ready");return}let j=!1;return S("loading"),(async()=>{try{let q=ee.from("workouts").select("id, workout_date, name, user_id").eq("user_id",W.id);n&&(q=q.lt("workout_date",n));const{data:ne,error:ke}=await q.order("workout_date",{ascending:!0});if(j)return;if(ke)throw ke;const we=(ne||[]).map(M=>({id:M.id,date:M.workout_date,name:M.name})),fe=new Map;we.forEach(M=>fe.set(M.id,{date:M.date,name:M.name}));const ae=we.map(M=>M.id);if(ae.length===0){N(null),be(c,null),S("ready");return}const{data:ye,error:ce}=await ee.from("workout_exercises").select("id, name, workout_id").in("workout_id",ae);if(j)return;if(ce)throw ce;const ie=new Set,le=new Map;if((ye||[]).forEach(M=>{const te=(M.name??"").trim();if(te&&We(te)===k){const J=M.id;ie.add(J);const me=M.workout_id;me&&le.set(J,me)}}),ie.size===0){N(null),be(c,null),S("ready");return}const{data:he,error:ve}=await ee.from("exercise_progress_view").select("workout_date, workout_name, workout_id, exercise_id, max_weight, reps_at_max_weight").in("workout_id",ae).in("exercise_id",Array.from(ie));if(j)return;if(ve)throw ve;let de=(he||[]).map(M=>({workout_date:M.workout_date,workout_name:M.workout_name,workout_id:M.workout_id,exercise_id:M.exercise_id,max_weight:M.max_weight,reps_at_max_weight:M.reps_at_max_weight}));if(de.length===0){const{data:M,error:te}=await ee.from("workout_sets").select("id, workout_exercise_id, weight, reps, is_done, updated_at").in("workout_exercise_id",Array.from(ie)).order("updated_at",{ascending:!1});if(j)return;if(te)throw te;de=(M||[]).filter(J=>J.weight!==null&&Number(J.weight)===0).filter(J=>J.is_done||typeof J.reps=="string"&&J.reps.trim()!=="").map(J=>{const me=J.workout_exercise_id,pe=le.get(me);if(!pe)return null;const ge=fe.get(pe);return ge?{workout_date:ge.date,workout_name:ge.name,workout_id:pe,exercise_id:me,max_weight:0,reps_at_max_weight:J.reps}:null}).filter(J=>J!==null)}if(de.length===0){N(null),be(c,null),S("ready");return}const je=ct(m,de),ue=je.dataPoints[je.dataPoints.length-1];if(!ue){N(null),be(c,null),S("ready");return}const _e={weight:ue.weight,reps:ue.reps,workoutDate:ue.date};N(_e),be(c,_e),S("ready")}catch(q){console.error("Failed to fetch last exercise performance",q),S("error")}})(),()=>{j=!0}},[h,W,n]),a.useLayoutEffect(()=>{y()},[y,r]),a.useLayoutEffect(()=>{if(typeof ResizeObserver>"u")return;const m=O.current;if(!m)return;const k=new ResizeObserver(()=>{y()});return k.observe(m),()=>k.disconnect()},[y]),a.useEffect(()=>{(async()=>{if(!(h.trim()===""||h===t.name))try{await ee.from("workout_exercises").update({name:h}).eq("id",t.id);const k={...t,name:h};v.current=h,l(k)}catch(k){console.error("Failed to update exercise name",k)}})()},[h]),a.useEffect(()=>{(async()=>{if(d!==t.rest_seconds)try{await ee.from("workout_exercises").update({rest_seconds:d}).eq("id",t.id);const k={...t,rest_seconds:d};l(k)}catch(k){console.error("Failed to update rest seconds",k)}})()},[d,t,l]);const F=m=>{b(k=>Math.max(0,k+m))},Q=async m=>{if(!(m<1||m===p||g)){$(!0);try{if(m>p){const k=Array.from({length:m-p},(q,ne)=>({workout_exercise_id:t.id,set_index:p+ne+1})),{data:c,error:u}=await ee.from("workout_sets").insert(k).select();if(u)throw u;const j=[...t.workout_sets,...c||[]].sort((q,ne)=>q.set_index-ne.set_index);await ee.from("workout_exercises").update({sets:m}).eq("id",t.id);const Z={...t,sets:m,workout_sets:j};l(Z)}else{const{error:k}=await ee.from("workout_sets").delete().eq("workout_exercise_id",t.id).gt("set_index",m);if(k)throw k;const c=t.workout_sets.filter(j=>j.set_index<=m);await ee.from("workout_exercises").update({sets:m}).eq("id",t.id);const u={...t,sets:m,workout_sets:c};l(u)}T(m)}catch(k){console.error("Failed to change sets count",k),alert("Не удалось изменить количество подходов")}finally{$(!1)}}},Y=async()=>{const{error:m}=await ee.from("workout_sets").delete().eq("workout_exercise_id",t.id);if(m){console.error("Failed to delete sets of exercise",m),alert("Не удалось удалить подходы упражнения. Попробуйте снова.");return}const{error:k}=await ee.from("workout_exercises").delete().eq("id",t.id);if(k){console.error("Failed to delete exercise",k),alert("Не удалось удалить упражнение. Попробуйте снова.");return}f&&f(t.id)},G="макс.",H=m=>m==null?"—":String(m).replace(".",","),K=m=>{if(m==null)return"—";const k=m.trim();return k?k==="0"?G:k:"—"},se=()=>r.trim()?L==="loading"?e.jsx("span",{className:"text-gray-400",children:"Поиск последнего результата…"}):L==="error"?e.jsx("span",{className:"text-red-300",children:"Не удалось загрузить данные"}):A?e.jsxs("span",{className:"text-white text-base font-semibold",children:[H(A.weight)," кг × ",K(A.reps)]}):e.jsx("span",{className:"text-gray-500",children:"До этой даты нет данных по этому упражнению"}):e.jsx("span",{className:"text-gray-500",children:"Введите название, чтобы увидеть прошлый результат"});return e.jsxs("div",{id:`exercise-${t.id}`,className:"glass card-dark p-4 exercise-card",children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{value:r,onChange:m=>o(m.target.value),ref:O,rows:1,className:"w-full text-base sm:text-lg font-bold text-white whitespace-pre-wrap bg-white/10 hover:bg-white/15 focus:bg-white/10 border border-white/20 hover:border-white/30 focus:border-white/50 focus:ring-2 focus:ring-white/25 focus:outline-none rounded-xl px-4 pr-9 py-3 min-h-[3rem] resize-none overflow-y-hidden leading-relaxed transition-colors"}),r&&r.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{o(""),requestAnimationFrame(()=>y())},"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{"aria-label":"Удалить упражнение",className:"delete-btn btn-glass btn-glass-icon btn-glass-outline",onClick:()=>P(!0),type:"button",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-2xl bg-white/5 px-4 py-3 text-xs sm:text-sm text-gray-300",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-white",children:"Последний рабочий вес"}),(A==null?void 0:A.workoutDate)&&e.jsx("span",{className:"text-[0.7rem] uppercase tracking-wide text-gray-400",children:Ee(A.workoutDate)})]}),se()]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(mt,{restSeconds:x,exerciseId:t.id,onAdjustRestSeconds:F})}),e.jsxs("div",{className:"flex items-center justify-between text-sm py-3 sm:py-4 px-2 rounded-lg",style:{color:"#a1a1aa",backgroundColor:"rgba(255,255,255,0.02)"},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"whitespace-nowrap font-medium",children:"Подходы:"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{disabled:g||p<=1,onClick:()=>Q(p-1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"−"}),e.jsx("span",{className:"min-w-[3ch] text-center text-white font-semibold",children:p}),e.jsx("button",{disabled:g||p>=30,onClick:()=>Q(p+1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]})]}),((re=t.reps)==null?void 0:re.trim())&&e.jsxs("div",{className:"ml-3 flex-1 text-right whitespace-nowrap font-medium",children:["Повторы: ",t.reps]})]})]}),e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden",style:{color:"#a1a1aa",backgroundColor:"rgba(255,255,255,0.03)"},children:[e.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:"Подход"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Вес (кг)"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Повторы"}),e.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2 whitespace-nowrap",children:"В отказ"})]}),e.jsx("div",{className:"space-y-2",children:t.workout_sets.map((m,k,c)=>{const u=k>0?c[k-1]:void 0;return e.jsx(ut,{set:m,previousSet:u,onChange:j=>{const Z={...t,workout_sets:t.workout_sets.map(q=>q.id===j.id?j:q)};l(Z)}},m.id)})})]}),e.jsx(Be,{open:E,onOpenChange:P,title:"Удалить упражнение?",description:t.name?`Вы собираетесь удалить упражнение "${t.name}". Действие необратимо.`:"Вы собираетесь удалить упражнение. Действие необратимо.",cancelText:"Отмена",variant:"danger",onConfirm:Y})]})},gt=Fe.memo(pt,(t,n)=>{const l=t.exercise,f=n.exercise;if(l.id!==f.id||l.name!==f.name||l.sets!==f.sets||l.rest_seconds!==f.rest_seconds||l.reps!==f.reps||t.workoutDate!==n.workoutDate||l.workout_sets.length!==f.workout_sets.length)return!1;for(let r=0;r<l.workout_sets.length;r++){const o=l.workout_sets[r],p=f.workout_sets[r];if(o.id!==p.id||o.weight!==p.weight||o.reps!==p.reps||o.is_done!==p.is_done)return!1}return!0}),Ke=({normalizedDate:t,className:n=""})=>{const l=qe();return e.jsx("button",{onClick:()=>l("/calendar",{state:{refreshDate:t}}),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors z-10 bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${n}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})},xt=({normalizedDate:t,workoutName:n,isEditingName:l,editNameValue:f,isSavingWorkoutName:r,isScrolling:o,inputRef:p,onStartEditName:T,onChangeEditName:x,onSaveEditName:b,onCancelEditName:g,actionsRef:$,actionsBtnRef:A,onToggleActions:N,workoutIcon:L,editIconValue:S,onOpenIconPicker:O})=>{const W=l?S:L,h=W?De[W]:null;return e.jsxs("div",{className:`glass card-dark p-4 flex items-center gap-4 header-container ${o?"scrolling":""}`,children:[e.jsx(Ke,{normalizedDate:t,className:"shrink-0"}),e.jsx("div",{className:"flex-1 text-center",children:l?e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:O,disabled:r,className:"shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-50",title:"Выбрать иконку",children:h?e.jsx(h.component,{size:28}):e.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-gray-400",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"}),e.jsx("path",{d:"M12 8v8M8 12h8"})]})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:p,type:"text",value:f,onChange:d=>x(d.target.value),disabled:r,className:"w-full bg-white/10 text-lg font-bold text-white placeholder:text-gray-500 focus:outline-none focus:bg-white/20 rounded-md px-3 pr-9 py-2 transition-colors disabled:opacity-70",placeholder:"Название тренировки"}),f&&e.jsx("button",{type:"button",onClick:()=>x(""),"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:b,disabled:r,className:"shrink-0 p-1.5 rounded-full hover:bg-green-500/20 transition-colors disabled:opacity-50",title:"Сохранить",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:g,disabled:r,className:"shrink-0 p-1.5 rounded-full hover:bg-red-500/20 transition-colors disabled:opacity-50",title:"Отмена",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[h&&e.jsx("div",{className:"shrink-0 w-10 h-10 flex items-center justify-center",children:e.jsx(h.component,{size:32})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-white",children:n}),e.jsxs("p",{className:"text-md transition-all duration-300",style:{color:"#a1a1aa"},children:["Дата: ",Ee(t)]})]}),e.jsx("button",{onClick:T,className:"shrink-0 p-1.5 rounded-full hover:bg-white/10 transition-colors",title:"Редактировать название",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})})]})}),e.jsx("div",{className:"relative",ref:$,children:e.jsx("button",{ref:A,type:"button","aria-label":"Меню действий",className:"inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10",onClick:N,children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("circle",{cx:"12",cy:"5",r:"1"}),e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})})]})},bt=({open:t,templates:n,isCreating:l,onClose:f,onReplaceWithTemplate:r})=>t?Le.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:f}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Выберите шаблон"}),e.jsx("button",{onClick:f,className:"px-2 py-1 text-sm text-gray-300 hover:text-white",children:"✕"})]}),n.length===0?e.jsx("p",{className:"text-gray-400",children:"Нет доступных шаблонов."}):e.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-y-auto overscroll-contain pr-1",children:n.map(o=>e.jsx("button",{onClick:()=>r(o),disabled:l,className:"w-full text-left px-4 py-2 rounded-md border border-white/20 text-gray-100 hover:bg-white/5 disabled:opacity-50",children:l?"Применение...":o.name},o.id))})]})]}),document.body):null;function kt({normalizedDate:t,exercisesLength:n,scrollKey:l,location:f}){const[r,o]=a.useState(!1),p=a.useRef(!1),T=a.useRef(0),x=a.useRef(!1),b=a.useRef(!1);return a.useEffect(()=>{x.current=!1,b.current=!1},[t,f.key]),a.useEffect(()=>{if(!t||n===0||b.current)return;const g=()=>{var E;const N=(E=f.state)==null?void 0:E.focusExerciseId;if(!N||x.current)return!1;const L=document.getElementById(`exercise-${N}`);if(!L)return!1;x.current=!0,p.current=!0;const S=document.querySelector(".header-container"),O=S?S.getBoundingClientRect().bottom:0,W=12,h=L.getBoundingClientRect(),d=Math.max(0,window.scrollY+h.top-O-W);return window.scrollTo({top:d,behavior:"smooth"}),L.animate&&L.animate([{boxShadow:"0 0 0 rgba(59,130,246,0)"},{boxShadow:"0 0 0 4px rgba(59,130,246,0.6)"},{boxShadow:"0 0 0 rgba(59,130,246,0)"}],{duration:1200,easing:"ease-in-out"}),setTimeout(()=>{p.current=!1},600),!0},$=()=>{try{const N=localStorage.getItem(l);if(N){const L=parseInt(N,10);Number.isNaN(L)||(p.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:L,behavior:"auto"}),T.current=L,setTimeout(()=>{p.current=!1},100)})}))}}catch(N){console.error("Error restoring scroll:",N)}};g()||$(),b.current=!0},[t,n,l,f.state]),a.useEffect(()=>{if(!t)return;let g=!1;const $=()=>{T.current=window.scrollY,o(window.scrollY>0),!g&&!p.current&&(window.requestAnimationFrame(()=>{try{localStorage.setItem(l,String(T.current))}catch{}g=!1}),g=!0)};return window.addEventListener("scroll",$,{passive:!0}),()=>window.removeEventListener("scroll",$)},[t,l]),a.useEffect(()=>()=>{if(t&&T.current>0)try{localStorage.setItem(l,String(T.current))}catch{}},[t,l]),{isScrolling:r}}function Ie(t,n,l){const f=t.slice(),[r]=f.splice(n,1);return f.splice(l,0,r),f}const yt=({open:t,items:n,onClose:l,onSave:f})=>{const[r,o]=a.useState([]),p=a.useRef(null),[T,x]=a.useState(!1),[b,g]=a.useState(null),$=a.useRef(0),A=a.useRef(null),N=a.useMemo(()=>n.slice().sort((v,y)=>(v.position??0)-(y.position??0)),[n]);if(a.useEffect(()=>{t&&o(N)},[t,N]),Pe(t),!t)return null;const L=(v,y)=>{y<0||y>=r.length||o(F=>Ie(F,v,y))},S=v=>y=>{p.current=v,y.dataTransfer.effectAllowed="move"},O=v=>{v.preventDefault(),v.dataTransfer.dropEffect="move"},W=v=>y=>{y.preventDefault();const F=p.current;if(p.current=null,F==null||F===v)return;const Q=r.findIndex(G=>G.id===F),Y=r.findIndex(G=>G.id===v);Q===-1||Y===-1||o(G=>Ie(G,Q,Y))},h=v=>y=>{const F=y.touches[0];$.current=F.clientY,g(v)},d=v=>{if(!b)return;const F=v.touches[0].clientY,Q=F-$.current,Y=r.findIndex(K=>K.id===b);if(Y===-1)return;const H=Math.round(Q/60);if(Math.abs(H)>=1){const K=Y+H;K>=0&&K<r.length&&K!==Y&&(o(se=>Ie(se,Y,K)),$.current=F)}},E=()=>{g(null)},P=async()=>{x(!0);try{await f(r.map((v,y)=>({...v,position:y+1}))),l()}finally{x(!1)}};return Le.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:l}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Порядок упражнений"}),e.jsx("ol",{ref:A,className:"space-y-2 max-h-[55vh] overflow-y-auto pr-1",onTouchMove:d,onTouchEnd:E,children:r.map((v,y)=>e.jsxs("li",{draggable:!0,onDragStart:S(v.id),onDragOver:O,onDrop:W(v.id),className:`rounded-lg p-2 flex items-center gap-2 hover:bg-white/5 transition-colors ${b===v.id?"bg-white/20 scale-105":""}`,children:[e.jsxs("span",{className:"select-none w-6 text-center opacity-70",children:[y+1,"."]}),e.jsx("button",{type:"button","aria-label":"Перетащить",className:"cursor-grab px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 active:cursor-grabbing touch-none",draggable:!0,onDragStart:S(v.id),onTouchStart:h(v.id),children:"⋮⋮"}),e.jsx("div",{className:"flex-1 whitespace-normal break-words leading-snug",children:v.name||"Без названия"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>L(y,y-1),disabled:y===0,children:"↑"}),e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>L(y,y+1),disabled:y===r.length-1,children:"↓"})]})]},v.id))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:l,disabled:T,children:"Отмена"}),e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-primary",onClick:P,disabled:T,children:T?"Сохранение…":"Сохранить"})]})]})]}),document.body)},vt=({open:t,value:n,onClose:l,onChange:f})=>{if(!t)return null;const r=Object.keys(De),o=p=>{f(p),l()};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:l,children:e.jsxs("div",{className:"glass card-dark p-4 rounded-xl w-[90%] max-w-sm mx-auto",onClick:p=>p.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4 text-center",children:"Выберите иконку"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>o(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${n===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"28",height:"28",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:"Нет"})]}),r.map(p=>{const{component:T,label:x}=De[p],b=n===p;return e.jsxs("button",{type:"button",onClick:()=>o(p),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${b?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center",children:e.jsx(T,{size:28})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:x})]},p)})]}),e.jsx("button",{type:"button",onClick:l,className:"mt-4 w-full py-2 text-gray-400 hover:text-white transition-colors",children:"Отмена"})]})})},X=new Map,Te=3e4,jt=t=>{if(!t)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const n=new Date(t);return Number.isNaN(n.getTime())?null:it(n)},Tt=()=>{const{date:t}=rt(),{user:n}=Oe(),l=qe(),f=nt(),r=ee,o=a.useMemo(()=>jt(t),[t]),p=o?`workout-page:${o}`:"workout-page",[T,x]=at({key:p,initialState:{workout:null,exercises:[],templates:[],loading:!0,isCreating:!1,isSelectTemplateOpen:!1,hasInitialData:!1,isAddingExercise:!1,workoutName:"",isSavingWorkoutName:!1,isCardio:!1,isSavingCardio:!1,workoutIcon:null},ttl:1800*1e3}),{workout:b,exercises:g,templates:$,loading:A,isCreating:N,isSelectTemplateOpen:L,hasInitialData:S,isAddingExercise:O,workoutName:W,isSavingWorkoutName:h,isCardio:d,isSavingCardio:E,workoutIcon:P}=T,{isActionsOpen:v,menuPos:y,actionsRef:F,actionsBtnRef:Q,toggleActions:Y,closeActions:G}=lt(),H=s=>x(i=>({...i,workout:s,workoutName:(s==null?void 0:s.name)??"",isSavingWorkoutName:!1,isCardio:(s==null?void 0:s.is_cardio)??!1,isSavingCardio:!1,workoutIcon:(s==null?void 0:s.icon)??null})),K=s=>x(i=>({...i,exercises:typeof s=="function"?s(i.exercises):s})),se=s=>x(i=>({...i,templates:typeof s=="function"?s(i.templates):s})),re=s=>x(i=>({...i,loading:s})),m=s=>x(i=>({...i,isCreating:s})),k=s=>x(i=>({...i,isSelectTemplateOpen:s})),c=s=>x(i=>({...i,hasInitialData:s})),u=s=>x(i=>({...i,isAddingExercise:s})),j=s=>x(i=>({...i,workoutName:s})),Z=s=>x(i=>({...i,isSavingWorkoutName:s})),q=s=>x(i=>({...i,isCardio:s})),ne=s=>x(i=>({...i,isSavingCardio:s})),[ke,we]=a.useState(!1),[fe,ae]=a.useState(!1),[ye,ce]=a.useState(W),[ie,le]=a.useState(P),he=a.useRef(null),[ve,de]=a.useState(!1),[je,ue]=a.useState(!1),_e=`scroll:workout:${o??""}`,{isScrolling:M}=kt({normalizedDate:o,exercisesLength:g.length,scrollKey:_e,location:f});Pe(L);const te=a.useCallback(async(s=!1,i=!1)=>{if(!n||!o){H(null),K([]),re(!1),c(!0);return}const _=`${n.id}:${o}`,w=Date.now();if(X.has(_)){const R=X.get(_),z=w-R.timestamp;if(s&&z<Te){S||(H(R.workout),K(R.exercises),re(!1),c(!0));return}z>=Te&&(S||(H(R.workout),K(R.exercises),c(!0)),i=!0)}i||re(!0);const{data:C,error:B}=await r.from("workouts").select("*").eq("user_id",n.id).eq("workout_date",o).order("created_at",{ascending:!1}).limit(1);let I=(C==null?void 0:C[0])??null;if(B)console.error("Error fetching workout:",B);else if(I){if(I.template_id&&!I.icon)try{const{data:D}=await r.from("workout_templates").select("icon").eq("id",I.template_id).single();D!=null&&D.icon&&(I={...I,icon:D.icon},r.from("workouts").update({icon:D.icon}).eq("id",I.id).then(()=>{},()=>{}))}catch{}H(I);const{data:R,error:z}=await r.from("workout_exercises").select("id, name, sets, reps, rest_seconds, position, workout_id, workout_sets ( id, workout_exercise_id, set_index, weight, reps, is_done, updated_at )").eq("workout_id",I.id).order("position");if(z)console.error("Error fetching exercises:",z);else{const D=R||[];D.forEach(oe=>{oe.workout_sets&&oe.workout_sets.sort((xe,Ne)=>xe.set_index-Ne.set_index)}),K(D),X.set(_,{workout:I,exercises:D,timestamp:w})}}else H(null),K([]),X.set(_,{workout:null,exercises:[],timestamp:w});const U=n?`templates-cache:${n.id}`:void 0;if(U)try{const R=localStorage.getItem(U);if(R){const z=JSON.parse(R);z.data&&se(z.data)}}catch{}r.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",n.id).then(({data:R,error:z})=>{if(z)console.error("Error fetching templates:",z.message);else if(se(R||[]),U)try{localStorage.setItem(U,JSON.stringify({ts:Date.now(),data:R}))}catch{}}),re(!1),c(!0)},[n,o,S]);a.useEffect(()=>{te()},[te]),a.useEffect(()=>{const s=()=>{document.visibilityState==="visible"&&te(!0)};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[te]),a.useEffect(()=>{o&&(localStorage.setItem("lastWorkoutPath",`/workout/${o}`),localStorage.setItem("lastWorkoutTimestamp",Date.now().toString()))},[o]),a.useEffect(()=>{fe&&he.current&&(he.current.focus(),he.current.select())},[fe]);const J=a.useCallback(s=>{x(i=>{const _=i.exercises.map(w=>w.id===s.id?s:w);if(n&&o&&i.workout){const w=`${n.id}:${o}`;X.set(w,{workout:i.workout,exercises:_,timestamp:Date.now()})}return{...i,exercises:_}})},[n,o]),me=a.useCallback(s=>{x(i=>{const _=i.exercises.filter(w=>w.id!==s);if(n&&o&&i.workout){const w=`${n.id}:${o}`;X.set(w,{workout:i.workout,exercises:_,timestamp:Date.now()})}return{...i,exercises:_}})},[n,o]),pe=async()=>{if(!(!n||!o||!b||O)){u(!0);try{const s=g.length>0?Math.max(...g.map(R=>typeof R.position=="number"?R.position:0))+1:1,{data:i,error:_}=await r.from("workout_exercises").insert({workout_id:b.id,name:"",sets:1,reps:"",rest_seconds:150,position:s}).select("id, name, sets, reps, rest_seconds, position, workout_id");if(_)throw _;const w=i==null?void 0:i[0];if(!w)throw new Error("Не удалось создать упражнение");const{data:C,error:B}=await r.from("workout_sets").insert({workout_exercise_id:w.id,set_index:1,weight:null,reps:null,is_done:!1,updated_at:new Date().toISOString()}).select("id, workout_exercise_id, set_index, weight, reps, is_done, updated_at");if(B)throw B;const I=C==null?void 0:C[0];if(!I)throw new Error("Не удалось создать подход");const U={...w,workout_sets:[I]};x(R=>{if(!R.workout)return R;const z=[...R.exercises,U].sort((D,oe)=>D.position-oe.position);if(n&&o){const D=`${n.id}:${o}`,oe=X.get(D);oe&&X.set(D,{workout:oe.workout,exercises:z,timestamp:Date.now()})}return{...R,exercises:z}})}catch(s){console.error("Failed to add exercise:",s),alert("Не удалось добавить упражнение. Попробуйте снова.")}finally{u(!1)}}},ge=async()=>{if(!(!n||!o)){m(!0);try{const{data:s,error:i}=await r.from("workouts").insert({user_id:n.id,workout_date:o,name:"Новая тренировка",template_id:null}).select().single();if(i)throw i;if(!s)throw new Error("Не удалось создать тренировку");H(s),K([]),j(s.name);const _=`${n.id}:${o}`;X.set(_,{workout:s,exercises:[],timestamp:Date.now()})}catch(s){console.error("Failed to create custom workout:",s),alert("Не удалось создать тренировку. Попробуйте снова.")}finally{m(!1)}}},ze=async s=>{if(!(!n||!o)){m(!0);try{const[{data:i},{data:_}]=await Promise.all([r.from("template_exercises").select("*").eq("template_id",s.id),r.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]),w=(_==null?void 0:_.icon)??s.icon??null,C=(_==null?void 0:_.name)??s.name,{data:B}=await r.from("workouts").insert({user_id:n.id,workout_date:o,name:C,template_id:s.id,icon:w}).select().single();if(!B)throw new Error("Failed to create workout entry.");const I=(i||[]).map(D=>({workout_id:B.id,name:D.name,sets:D.sets,reps:D.reps,rest_seconds:D.rest_seconds,position:D.position})),{data:U}=await r.from("workout_exercises").insert(I).select();if(!U)throw new Error("Failed to create workout exercises.");const R=U.flatMap(D=>Array.from({length:D.sets},(oe,xe)=>({workout_exercise_id:D.id,set_index:xe+1})));await r.from("workout_sets").insert(R);const z=`${n.id}:${o}`;X.delete(z),await te()}catch(i){console.error("Failed to create workout from template:",i),alert(`Не удалось создать тренировку: ${i.message}`)}finally{m(!1)}}},He=()=>{ce(W),le(P),ae(!0)},Ye=async()=>{if(!n||!o||!b)return;const s=ye.trim();if(s.length===0){ce(W),le(P),ae(!1);return}const i=s!==b.name,_=ie!==b.icon;if(!i&&!_){ae(!1);return}Z(!0);try{const w={};i&&(w.name=s),_&&(w.icon=ie);const{data:C,error:B}=await r.from("workouts").update(w).eq("id",b.id).select().single();if(B)throw B;if(!C)throw new Error("Не удалось обновить тренировку");H(C),ce(s),le(C.icon),ae(!1);const I=`${n.id}:${o}`;X.set(I,{workout:C,exercises:g,timestamp:Date.now()})}catch(w){console.error("Failed to update workout:",w),alert("Не удалось сохранить изменения. Попробуйте снова.")}finally{Z(!1)}},Je=()=>{ce(W),le(P),ae(!1)},Ve=()=>{ue(!0)},Xe=s=>{le(s)},Me=async()=>{if(!n||!o||!b)return;const s=!d;q(s),ne(!0);try{const{data:i,error:_}=await r.from("workouts").update({is_cardio:s}).eq("id",b.id).select().single();if(_)throw _;if(!i)throw new Error("Не удалось обновить статус кардио");H(i);const w=`${n.id}:${o}`;X.set(w,{workout:i,exercises:g,timestamp:Date.now()})}catch(i){console.error("Failed to update cardio status:",i),alert("Не удалось сохранить статус кардио."),q(!s)}finally{ne(!1)}},Qe=()=>{b&&we(!0)},Ge=async s=>{if(!n||!b)return;const i=new Map(s.map((w,C)=>[w.id,C+1]));K(w=>{const C=w.map(B=>({...B,position:i.get(B.id)??B.position}));return C.sort((B,I)=>(B.position??0)-(I.position??0)),C});const _=s.map((w,C)=>({id:w.id,position:C+1}));try{if(await Promise.all(_.map(async w=>{const{error:C}=await r.from("workout_exercises").update({position:w.position}).eq("id",w.id);if(C)throw C})),n&&o){const w=`${n.id}:${o}`,C=X.get(w);if(C){const B=[...C.exercises].map(I=>({...I,position:i.get(I.id)??I.position})).sort((I,U)=>(I.position??0)-(U.position??0));X.set(w,{workout:C.workout,exercises:B,timestamp:Date.now()})}}}catch(w){console.error("Failed to save new order:",w),alert("Не удалось сохранить порядок. Я вернул предыдущие данные."),await te()}},Ze=async()=>{if(!b)return;const{error:s}=await r.from("workouts").delete().eq("id",b.id);if(s){console.error("Error deleting workout:",s),alert("Не удалось удалить тренировку.");return}if(n&&o){const i=`${n.id}:${o}`;X.delete(i)}l("/calendar",{state:{removedDate:o}})},Ue=()=>{k(!0)},et=async s=>{if(!(!n||!o||!b))try{m(!0);const[{data:i,error:_},{data:w,error:C}]=await Promise.all([r.from("template_exercises").select("*").eq("template_id",s.id),r.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]);if(_)throw _;if(C)throw C;const{data:B,error:I}=await r.from("workout_exercises").select("id").eq("workout_id",b.id);if(I)throw I;const U=(B||[]).map(V=>V.id);if(U.length>0){const{error:V}=await r.from("workout_sets").delete().in("workout_exercise_id",U);if(V)throw V;const{error:Ce}=await r.from("workout_exercises").delete().eq("workout_id",b.id);if(Ce)throw Ce}const R=(w==null?void 0:w.icon)??s.icon??null,z=(w==null?void 0:w.name)??s.name,{error:D}=await r.from("workouts").update({name:z,template_id:s.id,icon:R}).eq("id",b.id);if(D)throw D;const oe=(i||[]).map(V=>({workout_id:b.id,name:V.name,sets:V.sets,reps:V.reps,rest_seconds:V.rest_seconds,position:V.position})),{data:xe,error:Ne}=await r.from("workout_exercises").insert(oe).select();if(Ne)throw Ne;const Re=(xe||[]).flatMap(V=>Array.from({length:V.sets},(Ce,st)=>({workout_exercise_id:V.id,set_index:st+1})));if(Re.length>0){const{error:V}=await r.from("workout_sets").insert(Re);if(V)throw V}const tt=`${n.id}:${o}`;X.delete(tt),k(!1),await te()}catch(i){console.error("Failed to replace workout from template:",i),alert(`Не удалось изменить тренировку: ${i.message}`)}finally{m(!1)}};return S?o?b?e.jsxs("div",{className:"relative px-4 space-y-4 pt-4 pb-10",children:[A&&e.jsx(Ae,{message:"Загрузка тренировки..."}),e.jsx("div",{className:`status-bar-blur ${M?"visible":""}`}),e.jsx(xt,{normalizedDate:o,workoutName:W,isEditingName:fe,editNameValue:ye,isSavingWorkoutName:h,isScrolling:M,inputRef:he,onStartEditName:He,onChangeEditName:ce,onSaveEditName:Ye,onCancelEditName:Je,actionsRef:F,actionsBtnRef:Q,onToggleActions:Y,workoutIcon:P,editIconValue:ie,onOpenIconPicker:Ve}),e.jsx("div",{className:"space-y-4",children:g.map(s=>e.jsx(gt,{exercise:s,workoutDate:o,onUpdateExercise:J,onDeleteExercise:me},s.id))}),e.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[e.jsx("p",{className:"text-white text-lg font-bold mb-3 text-center",children:"Было кардио?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>{d&&(q(!1),Me())},disabled:E,className:`flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 ease-out ${d?"bg-red-500/20 text-red-300 hover:bg-red-500/30 scale-95":"bg-red-500/80 text-white shadow-lg scale-100"} disabled:opacity-50`,children:"Нет"}),e.jsx("button",{onClick:()=>{d||(q(!0),Me())},disabled:E,className:`flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 ease-out ${d?"bg-green-500/80 text-white shadow-lg scale-100":"bg-green-500/20 text-green-300 hover:bg-green-500/30 scale-95"} disabled:opacity-50`,children:"Да"})]})]}),e.jsx("div",{children:e.jsx("button",{type:"button",onClick:pe,disabled:O,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary disabled:opacity-50",children:O?"Добавление...":"Добавить упражнение"})}),e.jsx(bt,{open:L,templates:$,isCreating:N,onClose:()=>k(!1),onReplaceWithTemplate:et}),e.jsx(yt,{open:ve,onClose:()=>de(!1),items:g.map(s=>({id:s.id,name:s.name,position:s.position??0})),onSave:Ge}),e.jsx(Be,{open:ke,onOpenChange:we,title:"Удалить тренировку?",description:`Вы собираетесь удалить тренировку на ${Ee(o)}. Действие необратимо.`,confirmText:"Удалить",cancelText:"Отмена",variant:"danger",onConfirm:Ze}),e.jsx(vt,{open:je,value:ie,onClose:()=>ue(!1),onChange:Xe}),v&&y&&Le.createPortal(e.jsxs("div",{className:"fixed menu-popover",style:{top:y.top,left:y.left,width:192},role:"menu",children:[e.jsx("button",{onClick:()=>{G(),de(!0)},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Поменять порядок упражнений"}),e.jsx("button",{onClick:()=>{G(),Ue()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Изменить тренировку"}),e.jsx("button",{onClick:()=>{G(),Qe()},className:"w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors rounded-lg",children:"Удалить"})]}),document.body)]}):N?e.jsx("div",{className:"px-4 pt-4",children:e.jsx(Ae,{message:"Создание..."})}):e.jsxs("div",{className:"max-w-lg mx-auto px-4 pt-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(Ke,{normalizedDate:o}),e.jsxs("h1",{className:"flex-1 text-xl font-bold text-center",children:["Тренировка на ",Ee(o)]})]}),e.jsxs("div",{className:"mt-4 p-6 text-center",children:[$.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Выбрать шаблон"}),e.jsx("div",{className:"space-y-2",children:$.map(s=>e.jsx("button",{onClick:()=>ze(s),disabled:N,className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md disabled:opacity-50",children:s.name},s.id))})]}):e.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[e.jsx("p",{className:"text-gray-400",children:"Сначала создайте шаблон."}),e.jsxs(ot,{to:"/templates/new",className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Создать шаблон"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"button",onClick:ge,disabled:N,className:"btn-dashed",children:"Создать свой день"})})]})]}):null:e.jsx(Ae,{message:"Загрузка тренировки..."})};export{Tt as default};
