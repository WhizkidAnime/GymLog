import{u as W,s as i,j as e,W as q}from"./index-Bdz1zsQX.js";import{e as A,r as n,f as j,L as B,c as M}from"./vendor-BVca5W6X.js";import{u as P}from"./usePageState-6XNG0ilq.js";import{C as R}from"./confirm-dialog-DRF9UlNS.js";import{g as F}from"./template-sharing-DsQw5SXG.js";import{T as I}from"./template-saved-dialog-4ct3fUQh.js";import{u as $}from"./use-workout-actions-menu-C-5wTXkz.js";import{W as T}from"./workout-icons-fWyEnQPM.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";import"./use-modal-scroll-lock-DlG-D3y9.js";const H="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='512'%20height='512'%20viewBox='0%200%2024%2024'%3e%3cpath%20fill='%23ffffff'%20d='M21%2014a1%201%200%200%200-1%201v4a1%201%200%200%201-1%201H5a1%201%200%200%201-1-1v-4a1%201%200%200%200-2%200v4a3%203%200%200%200%203%203h14a3%203%200%200%200%203-3v-4a1%201%200%200%200-1-1Zm-9.71%201.71a1%201%200%200%200%20.33.21a.94.94%200%200%200%20.76%200a1%201%200%200%200%20.33-.21l4-4a1%201%200%200%200-1.42-1.42L13%2012.59V3a1%201%200%200%200-2%200v9.59l-2.29-2.3a1%201%200%201%200-1.42%201.42Z'/%3e%3c/svg%3e",Z=({id:r,name:y,onDeleted:k,onShare:p})=>{const[l,c]=j.useState(!1),[N,o]=j.useState(!1),{isActionsOpen:d,menuPos:u,actionsRef:C,actionsBtnRef:g,toggleActions:S,closeActions:v}=$(),h=()=>{v(),p(r,y)},f=()=>{v(),o(!0)},b=async()=>{if(!l){c(!0);try{const{error:m}=await i.from("template_exercises").delete().eq("template_id",r);if(m)throw m;const{error:x}=await i.from("workout_templates").delete().eq("id",r);if(x)throw x;k(r),o(!1)}catch(m){console.error("Error deleting template",m),alert("Не удалось удалить шаблон.")}finally{c(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{ref:g,onClick:S,className:"p-2 text-white hover:text-gray-300 transition-colors","aria-label":"Меню шаблона",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 8c1.1 0 2-1 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 1-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 1-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})})}),d&&u&&M.createPortal(e.jsxs("div",{ref:C,className:"fixed menu-popover space-y-0.5",style:{top:u.top,left:u.left,width:192},role:"menu",children:[e.jsx("button",{onClick:h,className:"w-full text-left px-4 py-2 text-sm text-gray-100 hover:bg-white/10 transition-colors rounded-lg",children:"Поделиться"}),e.jsx("button",{onClick:f,disabled:l,className:"w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 disabled:opacity-50 transition-colors rounded-lg",children:l?"Удаление...":"Удалить"})]}),document.body)]}),e.jsx(R,{open:N,onOpenChange:o,title:"Удалить шаблон?",description:"Шаблон и все его упражнения будут удалены. Действие необратимо.",confirmText:"Удалить",cancelText:"Отмена",variant:"danger",onConfirm:b})]})},ae=()=>{const{user:r}=W(),y=A(),[k,p]=n.useState(!1),[l,c]=n.useState(null),[N,o]=n.useState(!1),[d,u]=n.useState(null),[C,g]=n.useState(!1),[S,v]=n.useState(null),[h,f]=P({key:"templates-page",initialState:{templates:[],loading:!0},ttl:1800*1e3}),{templates:b,loading:m}=h,x=t=>{f(a=>({...a,templates:t,loading:!1}))},L=t=>{f(a=>({...a,loading:t}))},_=j.useCallback(async()=>{if(!r)return;h.templates.length>0||L(!0);const{data:a,error:s}=await i.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).order("created_at",{ascending:!1});s?console.error("Error fetching templates:",s):x(a||[])},[r,h.templates.length]),E=t=>{f(a=>({...a,templates:a.templates.filter(s=>s.id!==t)})),_()},O=async t=>{var a;try{if((a=navigator.clipboard)!=null&&a.writeText)return await navigator.clipboard.writeText(t),{ok:!0}}catch(s){console.warn("clipboard writeText failed:",s)}try{const s=document.createElement("textarea");s.value=t,s.setAttribute("readonly",""),s.style.position="absolute",s.style.left="-9999px",document.body.appendChild(s),s.select();const w=document.execCommand("copy");return document.body.removeChild(s),w?{ok:!0}:{ok:!1,reason:"execCommand returned false"}}catch(s){return{ok:!1,reason:String(s)}}},D=async(t,a)=>{p(!0);try{const{data:s,error:w}=await i.from("template_exercises").select("name, sets, reps, rest_seconds, position").eq("template_id",t).order("position");if(w)throw w;if(!s||s.length===0){alert("Этот шаблон пуст. Добавьте упражнения перед тем, как делиться.");return}const z=await F({name:a,exercises:s});u(z),o(!0),v(a)}catch(s){console.error("Error sharing template:",s),alert("Не удалось сгенерировать ссылку: "+((s==null?void 0:s.message)||String(s)))}finally{p(!1)}};return n.useEffect(()=>{_()},[r,_]),n.useEffect(()=>{const t=i.channel("workout_templates_changes").on("postgres_changes",{event:"*",schema:"public",table:"workout_templates",filter:r?`user_id=eq.${r.id}`:void 0},()=>{(async()=>{if(!r)return;const{data:a}=await i.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).order("created_at",{ascending:!1});x(a||[])})()}).subscribe();return()=>{i.removeChannel(t)}},[r]),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"relative flex justify-start items-center mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Шаблоны"}),e.jsx("div",{className:"absolute right-0 -top-3 h-10 w-28","aria-hidden":"true"})]}),l&&e.jsx(I,{open:!!l,onOpenChange:c,templateName:l}),m?e.jsx(q,{message:"Загрузка шаблонов..."}):b.length===0?e.jsx("div",{className:"mt-4 p-8 text-center glass",children:e.jsx("p",{className:"text-gray-500",children:"У вас еще нет шаблонов. Создайте первый!"})}):e.jsx("div",{className:"space-y-3",children:b.map(t=>e.jsxs("div",{className:"relative p-4 glass card-dark flex items-center justify-between gap-3",children:[e.jsxs("button",{onClick:()=>window.location.hash=`#/templates/${t.id}`,className:"text-left flex-1 hover:opacity-90 flex items-center gap-3",children:[t.icon&&T[t.icon]&&e.jsx("div",{style:{color:T[t.icon].color},children:j.createElement(T[t.icon].component,{size:24})}),e.jsx("h2",{className:"font-semibold text-lg text-gray-100",children:t.name})]}),e.jsx(Z,{id:t.id,name:t.name,onDeleted:E,onShare:D})]},t.id))}),e.jsxs("div",{className:"fixed left-0 right-0 bottom-[calc(env(safe-area-inset-bottom)+5.75rem)] z-30 flex justify-center gap-3",children:[e.jsx(B,{to:"/templates/new",className:"glass-button-create",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4v16m8-8H4"})})}),e.jsx("button",{onClick:()=>y("/templates/import"),className:"glass-button-create",title:"Импортировать шаблон",children:e.jsx("img",{src:H,alt:"Импорт шаблона",className:"h-5 w-5"})})]}),k&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:e.jsx("div",{className:"glass card-dark p-6 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white",children:"Генерация ссылки..."})]})})}),N&&d&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:e.jsxs("div",{className:"glass card-dark p-6 rounded-xl max-w-lg w-[92%] max-h-[85vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Скопировать ссылку, чтобы поделиться шаблоном"}),e.jsx("textarea",{readOnly:!0,value:d,rows:3,onFocus:t=>t.currentTarget.select(),className:"mb-4 w-full resize-none bg-black/30 text-gray-100 rounded-md p-3 font-mono text-xs leading-relaxed break-all max-h-[40vh] overflow-y-auto"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx("button",{onClick:async()=>{if(!d)return;g(!0);const t=await O(d);g(!1),t.ok?(c(`${S}`),setTimeout(()=>c(null),2e3),o(!1)):alert(`Автокопирование не сработало. Скопируйте ссылку вручную: долгий тап → Копировать.

Ошибка: `+t.reason)},className:"glass-button-create",children:C?"Копирование...":"Копировать"}),e.jsx("button",{onClick:()=>o(!1),className:"glass-button-danger",children:"Закрыть"})]})]})})]})};export{ae as default};
