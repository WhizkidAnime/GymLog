import{a as oe,j as t,s as V,u as Fe,W as qe,g as te}from"./index-DLlh-EXJ.js";import{e as _e,r as o,d as Ke,b as $e,L as Ye,i as Ge,u as Ue}from"./vendor-CITejod9.js";import{u as xe}from"./useDebounce-B6B7GD0a.js";import{C as He}from"./confirm-dialog-DYhAWqhp.js";import{c as Ce,f as Xe}from"./date-helpers-C_0boXDq.js";import{n as Re,p as Qe}from"./exercise-name-BJxyXXn3.js";import{W as De}from"./workout-icons-Dk80Mfo0.js";import{u as Ve}from"./use-modal-scroll-lock-CmZrgGCz.js";import{u as Ze}from"./use-workout-actions-menu-D8nZy4RT.js";import{u as Pe}from"./usePageState-Qdkxdikz.js";import"./supabase-vtL5VWMt.js";import"./charts-D-QCyllA.js";const ze=({set:e,previousSet:s,onChange:r,onAddDropset:c,onDeleteDropset:a,isLastInGroup:d})=>{const{t:h}=oe(),u=`workout_set_draft:${e.id}`,p=`workout_set_last_non_max_reps:${e.id}`,b=y=>y==null?"":String(y).replace(".",","),k=y=>{if(y==="")return null;const i=Number(y.replace(",","."));return Number.isFinite(i)?i:null},_=y=>{let i=y.replace(".",",");i=i.replace(/[^\d,]/g,"");const m=i.indexOf(",");return m!==-1&&(i=i.slice(0,m+1)+i.slice(m+1).replace(/,/g,"")),i},A=h.common.max,C=y=>y==null?"":y==="0"?A:y,f=y=>{const i=y.trim();if(i==="")return null;const m=i.toLowerCase();return m==="макс"||m==="макс."||m==="max"||m==="max."||/^0+$/.test(i)?"0":i},R=y=>{const i=y.trim();if(i==="")return"";if(/^0+$/.test(i))return A;const m=i.toLowerCase();return m.startsWith("макс")||m.startsWith("max")?A:i.replace(/[^0-9]/g,"")},D=C(e.reps),[W,O]=o.useState(b(e.weight)),[B,L]=o.useState(D),[H,S]=o.useState(f(D)==="0"?null:D||null),[n,l]=o.useState(e.is_done),[g,w]=o.useState(!1),[j,E]=o.useState(()=>f(D)==="0"),I=xe(W,500),F=xe(B,500),z=!(e.is_dropset??!1)&&!!s&&s.is_done&&s.weight!==null&&k(W)===null,K=y=>{S(y);try{y&&y.trim()!==""?localStorage.setItem(p,y):localStorage.removeItem(p)}catch{}};o.useEffect(()=>{try{const y=localStorage.getItem(u);if(!y)return;const i=JSON.parse(y),m=new Date(e.updated_at).getTime();if(i.updatedAt>m){O(i.weight===""?"":b(i.weight));const N=C(i.reps);L(N);const v=f(N)==="0"?null:N||null;K(v),l(i.isDone)}}catch{}},[]),o.useEffect(()=>{l(e.is_done)},[e.is_done]),o.useEffect(()=>{if(e.reps==="0")try{const y=localStorage.getItem(p);y&&y.trim()!==""&&S(y)}catch{}},[e.reps,p]);const Z=_e.useRef(r);o.useEffect(()=>{Z.current=r},[r]),o.useEffect(()=>{(async()=>{var N;const i=k(I),m=f(F);if(i!==(e.weight??null)||m!==(e.reps??null)||n!==e.is_done){const v={weight:i===null?"":i,reps:m,isDone:n,updatedAt:Date.now()};try{localStorage.setItem(u,JSON.stringify(v))}catch{}w(!0);const{error:M}=await V.from("workout_sets").update({weight:i,reps:m,is_done:n,updated_at:new Date().toISOString()}).eq("id",e.id);if(M)console.error("Error saving set:",M);else{try{localStorage.removeItem(u)}catch{}const G={...e,weight:i,reps:m,is_done:n,updated_at:new Date().toISOString()};(N=Z.current)==null||N.call(Z,G)}setTimeout(()=>w(!1),500)}})()},[I,F,e.id,e.weight,e.reps,e.is_done,n,u]),o.useEffect(()=>{const y=k(I)!==null,i=f(F)!==null,m=y&&i;m&&!n?l(!0):!m&&n&&l(!1)},[I,F,n]);const ie=n?"bg-green-500":"bg-transparent",ae=n?"text-black":"text-inherit",le=n?"setrow-input-done-white":"",ne=f(B)==="0",x=j||ne,T=()=>{const y=f(B),i=y!==null&&y!=="0";if(x)ne&&(H!==null&&H.trim()!==""?L(H):L("")),E(!1);else{if(i){E(!0);return}f(B)!=="0"&&B.trim()!==""&&K(B),L(A),E(!0)}},X=e.is_dropset??!1,me=n?X?X&&n?"bg-purple-500/80":"":ie:X?"bg-purple-500/10 border-l-2 border-purple-500/50 ml-3":"";return t.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${me||ie}`,children:[t.jsxs("div",{className:`col-span-1 text-center font-medium ${ae} flex items-center justify-center`,children:[X&&t.jsx("span",{className:`text-xs mr-0.5 dropset-indicator ${n?"is-done":""}`,children:"↳"}),t.jsx("span",{children:X?h.setRow.dropset:e.set_index}),!X&&d&&c&&t.jsx("button",{type:"button",onClick:()=>c(e.id),"aria-label":h.setRow.addDropset,className:`absolute left-12 w-5 h-5 flex items-center justify-center rounded transition-colors shrink-0 dropset-btn ${n?"is-done hover:bg-black/10":"hover:bg-white/10"}`,title:h.setRow.addDropset,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4",children:t.jsx("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})})})]}),t.jsxs("div",{className:"col-span-2 flex justify-center relative",children:[t.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:W,onChange:y=>O(_(y.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-xs placeholder:text-gray-400 focus:placeholder-transparent outline-hidden focus-visible:outline-hidden setrow-input ${le} ${ae}`}),z&&t.jsx("button",{type:"button",onClick:()=>{!s||s.weight===null||O(b(s.weight))},"aria-label":h.setRow.copyWeight,className:"absolute left-full top-1/2 -translate-y-1/2 -ml-1.5 z-20 w-6 h-6 flex items-center justify-center rounded-full bg-zinc-700 text-white hover:bg-zinc-600 shadow-md transition-colors copy-prev-weight-btn",title:h.setRow.copyWeight,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"14",height:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"5 15 12 8 19 15"})})})]}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:B,onChange:y=>{const i=R(y.target.value);if(L(i),f(i)!=="0"){const m=i.trim()===""?null:i;K(m)}},className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-xs placeholder:text-gray-400 focus:placeholder-transparent outline-hidden focus-visible:outline-hidden setrow-input ${le} ${ae}`})}),t.jsxs("div",{className:"col-span-1 flex items-center justify-center",children:[!X&&t.jsx("input",{type:"checkbox",checked:x,onChange:T,"aria-label":h.setRow.toFailure,className:"h-6 w-6 rounded-md border border-gray-300 bg-white outline-hidden focus-visible:outline-hidden shrink-0",style:{accentColor:"#000000",color:"#0a0a0a"}}),X&&t.jsxs("div",{className:"flex items-center justify-end gap-1 w-14",children:[d&&c?t.jsx("button",{type:"button",onClick:()=>c(e.id),"aria-label":h.setRow.addDropset,className:`w-6 h-6 flex items-center justify-center rounded transition-colors shrink-0 font-bold dropset-btn ${n?"is-done hover:bg-black/10":"hover:bg-white/20"}`,title:h.setRow.addDropset,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:t.jsx("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})})}):t.jsx("div",{className:"w-6 h-6 shrink-0"}),a&&t.jsx("button",{type:"button",onClick:()=>a(e.id),"aria-label":h.setRow.deleteDropset,className:`w-6 h-6 flex items-center justify-center rounded transition-colors shrink-0 font-bold dropset-btn ${n?"is-done hover:bg-black/10":"hover:bg-white/20"}`,title:h.setRow.deleteDropset,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:t.jsx("path",{fillRule:"evenodd",d:"M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z",clipRule:"evenodd"})})})]})]}),g&&t.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},et=_e.memo(ze,(e,s)=>{var r,c,a,d;return e.set.id===s.set.id&&e.set.weight===s.set.weight&&e.set.reps===s.set.reps&&e.set.is_done===s.set.is_done&&e.set.set_index===s.set.set_index&&e.set.updated_at===s.set.updated_at&&e.set.is_dropset===s.set.is_dropset&&e.set.parent_set_index===s.set.parent_set_index&&((r=e.previousSet)==null?void 0:r.weight)===((c=s.previousSet)==null?void 0:c.weight)&&((a=e.previousSet)==null?void 0:a.is_done)===((d=s.previousSet)==null?void 0:d.is_done)&&e.isLastInGroup===s.isLastInGroup&&e.onAddDropset===s.onAddDropset&&e.onDeleteDropset===s.onDeleteDropset}),tt=({set:e,displayIndex:s,onChange:r,onDelete:c})=>{const a=`workout_set_draft:${e.id}`,d=n=>n==null?"":String(n).replace(".",","),h=n=>{if(n==="")return null;const l=Number(n.replace(",","."));return Number.isFinite(l)?l:null},u=n=>{let l=n.replace(".",",");l=l.replace(/[^\d,]/g,"");const g=l.indexOf(",");return g!==-1&&(l=l.slice(0,g+1)+l.slice(g+1).replace(/,/g,"")),l},p=n=>{const l=n.trim();return l===""?"":l.replace(/[^0-9]/g,"")},[b,k]=o.useState(d(e.weight)),[_,A]=o.useState(e.reps??""),[C,f]=o.useState(e.is_done),[R,D]=o.useState(!1),W=xe(b,500),O=xe(_,500);o.useEffect(()=>{try{const n=localStorage.getItem(a);if(!n)return;const l=JSON.parse(n),g=new Date(e.updated_at).getTime();l.updatedAt>g&&(k(l.weight===""?"":d(l.weight)),A(l.reps??""),f(l.isDone))}catch{}},[]),o.useEffect(()=>{f(e.is_done)},[e.is_done]);const B=_e.useRef(r);o.useEffect(()=>{B.current=r},[r]),o.useEffect(()=>{(async()=>{var w;const l=h(W),g=O.trim()===""?null:O.trim();if(l!==(e.weight??null)||g!==(e.reps??null)||C!==e.is_done){const j={weight:l===null?"":l,reps:g,isDone:C,updatedAt:Date.now()};try{localStorage.setItem(a,JSON.stringify(j))}catch{}D(!0);const{error:E}=await V.from("workout_sets").update({weight:l,reps:g,is_done:C,updated_at:new Date().toISOString()}).eq("id",e.id);if(E)console.error("Error saving warmup set:",E);else{try{localStorage.removeItem(a)}catch{}const I={...e,weight:l,reps:g,is_done:C,updated_at:new Date().toISOString()};(w=B.current)==null||w.call(B,I)}setTimeout(()=>D(!1),500)}})()},[W,O,e.id,e.weight,e.reps,e.is_done,C,a]),o.useEffect(()=>{const n=h(W)!==null,l=O.trim()!=="",g=n&&l;g&&!C?f(!0):!g&&C&&f(!1)},[W,O,C]);const L=C?"bg-sky-400/80":"bg-transparent",H=C?"text-black":"text-inherit",S=C?"setrow-input-done-white":"";return t.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${L}`,children:[t.jsx("div",{className:`col-span-1 text-center font-medium ${H} flex items-center justify-start pl-1 sm:pl-2`,children:t.jsx("span",{children:s})}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:b,onChange:n=>k(u(n.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-xs placeholder:text-gray-400 focus:placeholder-transparent outline-hidden focus-visible:outline-hidden setrow-input ${S} ${H}`})}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:_,onChange:n=>A(p(n.target.value)),className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-xs placeholder:text-gray-400 focus:placeholder-transparent outline-hidden focus-visible:outline-hidden setrow-input ${S} ${H}`})}),t.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2",children:c&&t.jsx("button",{type:"button",onClick:()=>c(e.id),className:`warmup-delete-btn w-6 h-6 flex items-center justify-center rounded transition-colors shrink-0 ${C?"hover:bg-black/10 text-black/70":"hover:bg-white/20 text-white/70"}`,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4",children:t.jsx("path",{fillRule:"evenodd",d:"M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z",clipRule:"evenodd"})})})}),R&&t.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},st=_e.memo(tt,(e,s)=>e.set.id===s.set.id&&e.set.weight===s.set.weight&&e.set.reps===s.set.reps&&e.set.is_done===s.set.is_done&&e.set.updated_at===s.set.updated_at&&e.displayIndex===s.displayIndex&&e.onDelete===s.onDelete),Ae=()=>{try{const e=localStorage.getItem("settings:timerStep");return e?Number(e):30}catch{return 30}},rt=({restSeconds:e,exerciseId:s,onAdjustRestSeconds:r,timerStep:c})=>{const{t:a}=oe(),d=s?`rest_timer:${s}`:void 0,[h,u]=o.useState(()=>c??Ae());o.useEffect(()=>{if(c!==void 0)u(c);else{const S=()=>{u(Ae())};window.addEventListener("storage",S);const n=()=>{u(Ae())};return window.addEventListener("focus",n),()=>{window.removeEventListener("storage",S),window.removeEventListener("focus",n)}}},[c]);const p=o.useRef(null),b=o.useRef(e),k=o.useRef({time:e,isActive:!1,endAt:null}),[_,A]=o.useState(()=>{if(!d)return{time:e,isActive:!1,endAt:null};try{const S=localStorage.getItem(d);if(!S)return{time:e,isActive:!1,endAt:null};const n=JSON.parse(S),l=360*60*1e3;if(Date.now()-n.savedAt>l)return localStorage.removeItem(d),{time:e,isActive:!1,endAt:null};if(n.isActive&&n.endAt){const g=Math.max(0,Math.floor((n.endAt-Date.now())/1e3));return g>0?{time:g,isActive:!0,endAt:n.endAt}:(localStorage.removeItem(d),{time:n.restSeconds,isActive:!1,endAt:null})}return{time:n.restSeconds,isActive:!1,endAt:null}}catch(S){return console.error("Error restoring timer state:",S),{time:e,isActive:!1,endAt:null}}}),{time:C,isActive:f,endAt:R}=_,D=o.useCallback((S,n)=>{if(d)try{const l={endAt:S.endAt,isActive:S.isActive,restSeconds:n??k.current.time??e,savedAt:Date.now()};localStorage.setItem(d,JSON.stringify(l))}catch(l){console.error("Error persisting timer:",l)}},[d,e]),W=o.useRef(D);o.useEffect(()=>{W.current=D},[D]),o.useEffect(()=>{k.current={time:C,isActive:f,endAt:R}},[C,f,R]),o.useEffect(()=>{if(!f||!R){p.current&&(window.clearInterval(p.current),p.current=null);return}let S=!1;const n=()=>{if(S)return;const g=Date.now(),w=Math.max(0,R-g),j=Math.floor(w/1e3);A(E=>({...E,time:j})),j<=0&&(S=!0,A(E=>({...E,isActive:!1,endAt:null,time:e})),p.current&&(window.clearInterval(p.current),p.current=null),d&&localStorage.removeItem(d))};n();const l=window.setInterval(n,1e3);return p.current=l,()=>{S=!0,p.current&&(window.clearInterval(p.current),p.current=null)}},[f,R,d,e]),o.useEffect(()=>{!f&&e!==b.current&&A(S=>({...S,time:e})),b.current=e},[e,f]),o.useEffect(()=>()=>{p.current&&(window.clearInterval(p.current),p.current=null);const{isActive:S,endAt:n}=k.current;S&&n&&W.current({endAt:n,isActive:!0})},[]);const O=()=>{A(S=>{if(S.isActive)return D({endAt:null,isActive:!1},S.time),p.current&&(window.clearInterval(p.current),p.current=null),{time:S.time,isActive:!1,endAt:null};const n=Date.now()+S.time*1e3;return D({endAt:n,isActive:!0},S.time),{time:S.time,isActive:!0,endAt:n}})},B=()=>{A({time:e,isActive:!1,endAt:null}),p.current&&(window.clearInterval(p.current),p.current=null),d&&localStorage.removeItem(d)},L=S=>{A(n=>{const l=Math.max(0,n.time+S);if(l===0)return D({endAt:null,isActive:!1},0),p.current&&(window.clearInterval(p.current),p.current=null),{time:0,isActive:!1,endAt:null};if(n.isActive){const g=Date.now()+l*1e3;return D({endAt:g,isActive:!0},l),{time:l,isActive:!0,endAt:g}}return D({endAt:null,isActive:!1},l),{time:l,isActive:!1,endAt:null}}),r==null||r(S)},H=S=>{const n=Math.floor(S/60),l=S%60;return`${n}:${l<10?"0":""}${l}`};return t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"flex items-center justify-center gap-4",children:[t.jsx("button",{onClick:()=>L(-h),disabled:C<=0&&!f,className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),t.jsx("div",{className:`text-6xl font-mono font-semibold leading-none min-w-[4ch] text-center ${f?"text-white":""}`,children:H(C)}),t.jsx("button",{onClick:()=>L(h),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("line",{x1:"8",y1:"3",x2:"8",y2:"13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]})})]}),t.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3",children:[t.jsx("button",{onClick:O,className:`btn-glass btn-glass-icon-lg ${f?"btn-glass-danger":"btn-glass-primary"}`,children:f?a.timer.stop:a.timer.start}),t.jsx("button",{onClick:B,className:"btn-glass btn-glass-icon-sm btn-glass-secondary",children:a.timer.reset})]})]})},nt=7200*1e3,We=new Map,ot=(e,s,r)=>`${e}:${s}:${r||"none"}`,it=e=>{const s=We.get(e);if(!s)return;if(Date.now()-s.timestamp>nt){We.delete(e);return}return s.data},ye=(e,s)=>{We.set(e,{data:s,timestamp:Date.now()})},at=({exercise:e,workoutDate:s,onUpdateExercise:r,onDeleteExercise:c})=>{var y;const{t:a,language:d}=oe(),h=d==="ru",[u,p]=o.useState(e.name),[b,k]=o.useState(e.sets),[_,A]=o.useState(()=>e.workout_sets.filter(i=>i.is_warmup).length),[C,f]=o.useState(e.rest_seconds),[R,D]=o.useState(!1),[W,O]=o.useState(null),[B,L]=o.useState("idle"),H=o.useRef(null),{user:S}=Fe(),n=xe(u,500),l=xe(C,500),[g,w]=o.useState(!1),j=o.useRef(e.name),E=o.useRef(e);o.useEffect(()=>{E.current=e},[e]);const I=o.useCallback(()=>{const i=H.current;i&&(i.style.height="auto",i.style.height=`${i.scrollHeight}px`)},[]);o.useEffect(()=>{e.name!==j.current&&(p(e.name),j.current=e.name),k(e.sets),f(e.rest_seconds),A(e.workout_sets.filter(i=>i.is_warmup).length)},[e.id,e.sets,e.rest_seconds,e.workout_sets]),o.useEffect(()=>{if(!S)return;const i=n.trim(),m=Re(i);if(!m){O(null),L("idle");return}const N=ot(S.id,m,s??null),v=it(N);if(v!==void 0){O(v),L("ready");return}let M=!1;return L("loading"),(async()=>{try{let q=V.from("workouts").select("id, workout_date, name, user_id").eq("user_id",S.id);s&&(q=q.lt("workout_date",s));const{data:$,error:U}=await q.order("workout_date",{ascending:!0});if(M)return;if(U)throw U;const P=($||[]).map(Y=>({id:Y.id,date:Y.workout_date,name:Y.name})),se=new Map;P.forEach(Y=>se.set(Y.id,{date:Y.date,name:Y.name}));const re=P.map(Y=>Y.id);if(re.length===0){O(null),ye(N,null),L("ready");return}const{data:pe,error:ge}=await V.from("workout_exercises").select("id, name, workout_id").in("workout_id",re);if(M)return;if(ge)throw ge;const we=new Set,je=new Map;if((pe||[]).forEach(Y=>{const he=(Y.name??"").trim();if(he&&Re(he)===m){const ee=Y.id;we.add(ee);const fe=Y.workout_id;fe&&je.set(ee,fe)}}),we.size===0){O(null),ye(N,null),L("ready");return}const{data:Ee,error:Ne}=await V.from("exercise_progress_view").select("workout_date, workout_name, workout_id, exercise_id, max_weight, reps_at_max_weight").in("workout_id",re).in("exercise_id",Array.from(we));if(M)return;if(Ne)throw Ne;let be=(Ee||[]).map(Y=>({workout_date:Y.workout_date,workout_name:Y.workout_name,workout_id:Y.workout_id,exercise_id:Y.exercise_id,max_weight:Y.max_weight,reps_at_max_weight:Y.reps_at_max_weight}));if(be.length===0){const{data:Y,error:he}=await V.from("workout_sets").select("id, workout_exercise_id, weight, reps, is_done, updated_at").in("workout_exercise_id",Array.from(we)).order("updated_at",{ascending:!1});if(M)return;if(he)throw he;be=(Y||[]).filter(ee=>ee.weight!==null&&Number(ee.weight)===0).filter(ee=>ee.is_done||typeof ee.reps=="string"&&ee.reps.trim()!=="").map(ee=>{const fe=ee.workout_exercise_id,ce=je.get(fe);if(!ce)return null;const Ie=se.get(ce);return Ie?{workout_date:Ie.date,workout_name:Ie.name,workout_id:ce,exercise_id:fe,max_weight:0,reps_at_max_weight:ee.reps}:null}).filter(ee=>ee!==null)}if(be.length===0){O(null),ye(N,null),L("ready");return}const Se=Qe(i,be),ke=Se.dataPoints[Se.dataPoints.length-1];if(!ke){O(null),ye(N,null),L("ready");return}const ve={weight:ke.weight,reps:ke.reps,workoutDate:ke.date};O(ve),ye(N,ve),L("ready")}catch(q){console.error("Failed to fetch last exercise performance",q),L("error")}})(),()=>{M=!0}},[n,S,s]),o.useLayoutEffect(()=>{I()},[I,u]),o.useLayoutEffect(()=>{if(typeof ResizeObserver>"u")return;const i=H.current;if(!i)return;const m=new ResizeObserver(()=>{I()});return m.observe(i),()=>m.disconnect()},[I]),o.useEffect(()=>{(async()=>{if(!(n.trim()===""||n===e.name))try{await V.from("workout_exercises").update({name:n}).eq("id",e.id);const m={...e,name:n};j.current=n,r(m)}catch(m){console.error("Failed to update exercise name",m)}})()},[n]),o.useEffect(()=>{(async()=>{if(l!==e.rest_seconds)try{await V.from("workout_exercises").update({rest_seconds:l}).eq("id",e.id);const m={...e,rest_seconds:l};r(m)}catch(m){console.error("Failed to update rest seconds",m)}})()},[l,e,r]);const F=i=>{f(m=>Math.max(0,m+i))},J=async i=>{if(!(i<1||i===b||R)){D(!0);try{if(i>b){const m=Array.from({length:i-b},(q,$)=>({workout_exercise_id:e.id,set_index:b+$+1,is_dropset:!1})),{data:N,error:v}=await V.from("workout_sets").insert(m).select();if(v)throw v;const M=[...e.workout_sets,...N||[]].sort((q,$)=>{const U=q.is_dropset??!1,P=$.is_dropset??!1,se=U?q.parent_set_index??q.set_index:q.set_index,re=P?$.parent_set_index??$.set_index:$.set_index;return se!==re?se-re:U!==P?U?1:-1:q.set_index-$.set_index});await V.from("workout_exercises").update({sets:i}).eq("id",e.id);const G={...e,sets:i,workout_sets:M};r(G)}else{const N=e.workout_sets.filter($=>!$.is_dropset&&$.set_index>i).map($=>$.id),v=new Set(N);let M=0;for(const $ of e.workout_sets){if(!$.is_dropset&&$.set_index>i){v.add($.id);let U=M+1;for(;U<e.workout_sets.length&&e.workout_sets[U].is_dropset;)v.add(e.workout_sets[U].id),U++}M++}if(v.size>0){const{error:$}=await V.from("workout_sets").delete().in("id",Array.from(v));if($)throw $}const G=e.workout_sets.filter($=>!v.has($.id));await V.from("workout_exercises").update({sets:i}).eq("id",e.id);const q={...e,sets:i,workout_sets:G};r(q)}k(i)}catch(m){console.error("Failed to change sets count",m),alert(a.exercise.errors.failedToChangeSets)}finally{D(!1)}}},z=async()=>{const{error:i}=await V.from("workout_sets").delete().eq("workout_exercise_id",e.id);if(i){console.error("Failed to delete sets of exercise",i),alert(a.exercise.errors.failedToDeleteSets);return}const{error:m}=await V.from("workout_exercises").delete().eq("id",e.id);if(m){console.error("Failed to delete exercise",m),alert(a.exercise.errors.failedToDeleteExercise);return}c&&c(e.id)},K=a.common.max,Z=i=>i==null?"—":String(i).replace(".",","),ie=i=>{if(i==null)return"—";const m=i.trim();return m?m==="0"?K:m:"—"},ae=()=>u.trim()?B==="loading"?t.jsx("span",{className:"text-gray-400",children:a.exercise.searchingLastResult}):B==="error"?t.jsx("span",{className:"text-red-300",children:a.exercise.loadError}):W?t.jsxs("span",{className:"text-white text-base font-semibold",children:[Z(W.weight)," ",a.common.kg," × ",ie(W.reps)]}):t.jsx("span",{className:"text-gray-500",children:a.exercise.noDataBeforeDate}):t.jsx("span",{className:"text-gray-500",children:a.exercise.enterNameToSeeResult}),le=o.useCallback(i=>{const m=E.current,N={...m,workout_sets:m.workout_sets.map(v=>v.id===i.id?i:v)};r(N)},[r]),ne=o.useCallback(async i=>{const m=E.current,N=m.workout_sets.findIndex(M=>M.id===i);if(N===-1)return;const v=m.workout_sets[N];try{const M=v.is_dropset?v.parent_set_index??v.set_index:v.set_index,q=Math.max(...m.workout_sets.map(pe=>pe.set_index))+1,{data:$,error:U}=await V.from("workout_sets").insert({workout_exercise_id:m.id,set_index:q,weight:null,reps:null,is_done:!1,is_dropset:!0,parent_set_index:M,updated_at:new Date().toISOString()}).select().single();if(U)throw U;let P=N+1;for(;P<m.workout_sets.length&&m.workout_sets[P].is_dropset;)P++;const se=[...m.workout_sets];se.splice(P,0,$);const re={...m,workout_sets:se};r(re)}catch(M){console.error("Failed to add dropset",M),alert(a.exercise.errors.failedToAddDropset)}},[r]),x=o.useCallback(async i=>{const m=E.current,N=m.workout_sets.find(v=>v.id===i);if(!(!N||!N.is_dropset))try{const{error:v}=await V.from("workout_sets").delete().eq("id",i);if(v)throw v;const M={...m,workout_sets:m.workout_sets.filter(G=>G.id!==i)};r(M)}catch(v){console.error("Failed to delete dropset",v),alert(a.exercise.errors.failedToDeleteDropset)}},[r]),T=o.useCallback((i,m,N)=>{const v=N[m+1];return i.is_dropset,!v||!v.is_dropset},[]),X=async i=>{if(!(i<0||i===_||R)){D(!0);try{const m=e.workout_sets.filter(v=>v.is_warmup),N=m.length;if(i>N){const v=e.workout_sets.length>0?Math.max(...e.workout_sets.map(re=>re.set_index)):0,M=Array.from({length:i-N},(re,pe)=>({workout_exercise_id:e.id,set_index:v+pe+1,is_dropset:!1,is_warmup:!0})),{data:G,error:q}=await V.from("workout_sets").insert(M).select();if(q)throw q;const $=[...m,...G||[]],U=e.workout_sets.filter(re=>!re.is_warmup),P=[...$,...U],se={...e,workout_sets:P};r(se)}else{const M=m.slice(i).map($=>$.id);if(M.length>0){const{error:$}=await V.from("workout_sets").delete().in("id",M);if($)throw $}const G=e.workout_sets.filter($=>!M.includes($.id)),q={...e,workout_sets:G};r(q)}A(i)}catch(m){console.error("Failed to change warmup sets count",m),alert(a.exercise.errors.failedToChangeSets)}finally{D(!1)}}},ue=o.useCallback(async i=>{const m=E.current,N=m.workout_sets.find(v=>v.id===i);if(!(!N||!N.is_warmup))try{const{error:v}=await V.from("workout_sets").delete().eq("id",i);if(v)throw v;const M=m.workout_sets.filter(q=>q.id!==i),G={...m,workout_sets:M};r(G)}catch(v){console.error("Failed to delete warmup set",v)}},[r]),de=e.workout_sets.filter(i=>i.is_warmup),me=e.workout_sets.filter(i=>!i.is_warmup);return t.jsxs("div",{id:`exercise-${e.id}`,className:"glass card-dark p-4 exercise-card",children:[t.jsxs("div",{className:"exercise-card-header mb-3",children:[t.jsxs("div",{className:"name-wrap relative",children:[t.jsx("textarea",{value:u,onChange:i=>p(i.target.value),ref:H,rows:1,className:"w-full text-base sm:text-lg font-bold text-white whitespace-pre-wrap bg-white/10 hover:bg-white/15 focus:bg-white/10 border border-white/20 hover:border-white/30 focus:border-white/50 focus:ring-2 focus:ring-white/25 focus:outline-hidden rounded-xl px-4 pr-9 py-3 min-h-12 resize-none overflow-y-hidden leading-relaxed transition-colors"}),u&&u.trim()!==""&&t.jsx("button",{type:"button",onClick:()=>{p(""),requestAnimationFrame(()=>I())},"aria-label":a.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),t.jsx("button",{"aria-label":a.exercise.deleteExercise,className:"delete-btn btn-glass btn-glass-icon btn-glass-outline",onClick:()=>w(!0),type:"button",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("path",{d:"M3 6h18"}),t.jsx("path",{d:"M8 6l1-2h6l1 2"}),t.jsx("path",{d:"M10 11v6"}),t.jsx("path",{d:"M14 11v6"}),t.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"rounded-2xl bg-white/5 px-4 py-3 text-xs sm:text-sm text-gray-300",children:[t.jsxs("div",{className:"mb-1 flex items-center justify-between gap-3",children:[t.jsx("span",{className:"font-semibold text-white",children:a.exercise.lastWeight}),(W==null?void 0:W.workoutDate)&&t.jsx("span",{className:"text-[0.7rem] uppercase tracking-wide text-gray-400",children:Ce(W.workoutDate)})]}),ae()]}),t.jsx("div",{className:"flex justify-center",children:t.jsx(rt,{restSeconds:C,exerciseId:e.id,onAdjustRestSeconds:F})}),t.jsxs("div",{className:"flex items-center text-sm py-3 sm:py-4 px-2 rounded-lg warmup-row-header",children:[t.jsxs("span",{className:`font-medium text-sky-300 mr-2${h?" max-w-[90px]":""}`,children:[a.exercise.warmupSets,":"]}),t.jsxs("div",{className:"inline-flex items-center gap-1",children:[t.jsx("button",{disabled:R||_<=0,onClick:()=>X(_-1),className:"btn-glass btn-glass-icon-round-sm btn-glass-secondary",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),t.jsx("span",{className:"min-w-[2ch] text-center text-white font-semibold",children:_}),t.jsx("button",{disabled:R||_>=10,onClick:()=>X(_+1),className:"btn-glass btn-glass-icon-round-sm btn-glass-secondary",children:t.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("line",{x1:"8",y1:"3",x2:"8",y2:"13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]})})]})]}),de.length>0&&t.jsxs("div",{className:"space-y-2 mt-0! pt-1",children:[t.jsxs("div",{className:"warmup-sets-header grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden",children:[t.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:a.exercise.set}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:a.exercise.weight}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:a.exercise.reps}),t.jsx("div",{className:"col-span-1"})]}),t.jsx("div",{className:"space-y-2",children:de.map((i,m)=>t.jsx(st,{set:i,displayIndex:m+1,onChange:le,onDelete:ue},i.id))})]}),t.jsxs("div",{className:"mt-2 flex items-center justify-between text-sm py-3 sm:py-4 px-2 rounded-lg exercise-row-header",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsxs("span",{className:`font-medium mr-2${h?" max-w-[90px]":""}`,children:[a.exercise.sets,":"]}),t.jsxs("div",{className:"inline-flex items-center gap-1",children:[t.jsx("button",{disabled:R||b<=1,onClick:()=>J(b-1),className:"btn-glass btn-glass-icon-round-sm btn-glass-secondary",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),t.jsx("span",{className:"min-w-[2ch] text-center text-white font-semibold",children:b}),t.jsx("button",{disabled:R||b>=30,onClick:()=>J(b+1),className:"btn-glass btn-glass-icon-round-sm btn-glass-secondary",children:t.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("line",{x1:"8",y1:"3",x2:"8",y2:"13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]})})]})]}),((y=e.reps)==null?void 0:y.trim())&&t.jsxs("div",{className:"whitespace-nowrap font-medium",children:[a.exercise.reps,": ",e.reps]})]})]}),t.jsxs("div",{className:"space-y-3 pt-1",children:[t.jsxs("div",{className:"grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden exercise-sets-header",children:[t.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:a.exercise.set}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:a.exercise.weight}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:a.exercise.reps}),t.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2 whitespace-nowrap",children:a.exercise.toFailure})]}),t.jsx("div",{className:"space-y-2",children:me.map((i,m,N)=>{let v;if(!i.is_dropset){for(let M=m-1;M>=0;M--)if(!N[M].is_dropset){v=N[M];break}}return t.jsx(et,{set:i,previousSet:v,onChange:le,onAddDropset:ne,onDeleteDropset:x,isLastInGroup:T(i,m,N)},i.id)})})]}),t.jsx(He,{open:g,onOpenChange:w,title:a.exercise.deleteExercise,description:e.name?a.exercise.deleteExerciseDesc.replace("{name}",e.name):a.exercise.deleteExerciseDescNoName,confirmText:a.common.delete,cancelText:a.common.cancel,variant:"danger",onConfirm:z})]})},lt=_e.memo(at,(e,s)=>{const r=e.exercise,c=s.exercise;if(r.id!==c.id||r.name!==c.name||r.sets!==c.sets||r.rest_seconds!==c.rest_seconds||r.reps!==c.reps||e.workoutDate!==s.workoutDate||r.workout_sets.length!==c.workout_sets.length)return!1;for(let a=0;a<r.workout_sets.length;a++){const d=r.workout_sets[a],h=c.workout_sets[a];if(d.id!==h.id||d.weight!==h.weight||d.reps!==h.reps||d.is_done!==h.is_done||d.is_dropset!==h.is_dropset||d.parent_set_index!==h.parent_set_index||d.is_warmup!==h.is_warmup)return!1}return!0}),Je=({normalizedDate:e,className:s=""})=>{const r=Ke();return t.jsx("button",{onClick:()=>r("/calendar",{state:{refreshDate:e}}),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors z-10 bg-transparent hover:border-white active:border-white focus:outline-hidden back-button-plain ${s}`,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})},ct=({normalizedDate:e,workoutName:s,isEditingName:r,editNameValue:c,isSavingWorkoutName:a,isScrolling:d,inputRef:h,onStartEditName:u,onChangeEditName:p,onSaveEditName:b,onCancelEditName:k,actionsRef:_,actionsBtnRef:A,onToggleActions:C,workoutIcon:f,editIconValue:R,onOpenIconPicker:D})=>{var L;const{t:W}=oe(),O=r?R:f,B=O?De[O]:null;return t.jsxs("div",{className:`glass card-dark p-4 flex items-center gap-4 header-container ${d?"scrolling":""}`,children:[t.jsx(Je,{normalizedDate:e,className:"shrink-0"}),t.jsx("div",{className:"flex-1 text-center",children:r?t.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:D,disabled:a,className:"shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-50",title:W.iconPicker.title,children:B?t.jsx(B.component,{size:28}):t.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-gray-400",children:[t.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"}),t.jsx("path",{d:"M12 8v8M8 12h8"})]})}),t.jsxs("div",{className:"relative flex-1",children:[t.jsx("input",{ref:h,type:"text",value:c,onChange:H=>p(H.target.value),disabled:a,className:"w-full bg-white/10 text-lg font-bold text-white placeholder:text-gray-500 focus:outline-hidden focus:bg-white/20 rounded-md px-3 pr-9 py-2 transition-colors disabled:opacity-70",placeholder:((L=W.workout.emptyState)==null?void 0:L.title)||"Workout name"}),c&&t.jsx("button",{type:"button",onClick:()=>p(""),"aria-label":W.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.jsx("button",{onClick:b,disabled:a,className:"shrink-0 p-1.5 rounded-full hover:bg-green-500/20 transition-colors disabled:opacity-50",title:W.common.save,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsx("button",{onClick:k,disabled:a,className:"shrink-0 p-1.5 rounded-full hover:bg-red-500/20 transition-colors disabled:opacity-50",title:W.common.cancel,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[B&&t.jsx("div",{className:"shrink-0 w-10 h-10 flex items-center justify-center",children:t.jsx(B.component,{size:32})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-white",children:s}),t.jsxs("p",{className:"text-md transition-all duration-300 workout-date-text",children:[W.workoutHeader.date,": ",Ce(e)]})]}),t.jsx("button",{onClick:u,className:"shrink-0 p-1.5 rounded-full hover:bg-white/10 transition-colors",title:W.common.edit||"Edit",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})})]})}),t.jsx("div",{className:"relative",ref:_,children:t.jsx("button",{ref:A,type:"button","aria-label":W.profile.menu,className:"inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10",onClick:C,children:t.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[t.jsx("circle",{cx:"12",cy:"5",r:"1"}),t.jsx("circle",{cx:"12",cy:"12",r:"1"}),t.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})})]})},dt=({open:e,templates:s,isCreating:r,onClose:c,onReplaceWithTemplate:a})=>{const{t:d}=oe();return e?$e.createPortal(t.jsxs("div",{className:"fixed inset-0 z-100 flex items-center justify-center p-4 overscroll-contain",children:[t.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:c}),t.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-lg font-semibold",children:d.workoutTemplateSelect.title}),t.jsx("button",{onClick:c,className:"px-2 py-1 text-sm text-gray-300 hover:text-white",children:"✕"})]}),s.length===0?t.jsx("p",{className:"text-gray-400",children:d.workoutTemplateSelect.noTemplates}):t.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-y-auto overscroll-contain pr-1",children:s.map(h=>t.jsx("button",{onClick:()=>a(h),disabled:r,className:"w-full text-left px-4 py-2 rounded-md border border-white/20 text-gray-100 hover:bg-white/5 disabled:opacity-50",children:r?d.workoutTemplateSelect.applying:h.name},h.id))})]})]}),document.body):null};function ut({normalizedDate:e,templates:s,isCreating:r,onCreateWorkout:c,onCreateCustomWorkout:a}){const{t:d}=oe();return r?t.jsx("div",{className:"px-4 pt-4",children:t.jsx(qe,{message:d.workoutEmptyState.creating})}):t.jsxs("div",{className:"max-w-lg mx-auto px-4 pt-4",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[t.jsx(Je,{normalizedDate:e}),t.jsx("h1",{className:"flex-1 text-xl font-bold text-center",children:d.workoutEmptyState.workoutOn.replace("{date}",Ce(e))})]}),t.jsxs("div",{className:"mt-4 p-6 text-center",children:[s.length>0?t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:d.workoutEmptyState.selectTemplate}),t.jsx("div",{className:"space-y-2",children:s.map(h=>t.jsx("button",{onClick:()=>c(h),disabled:r,className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md disabled:opacity-50",children:h.name},h.id))})]}):t.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[t.jsx("p",{className:"text-gray-400",children:d.workoutEmptyState.createTemplateFirst}),t.jsxs(Ye,{to:"/templates/new",className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),d.workoutEmptyState.createTemplate]})]}),t.jsx("div",{className:"mt-4",children:t.jsx("button",{type:"button",onClick:a,disabled:r,className:"btn-dashed",children:d.workoutEmptyState.createCustomDay})})]})]})}function mt({isCardio:e,isSaving:s,onToggle:r}){const{t:c}=oe();return t.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[t.jsx("p",{className:"text-white text-lg font-bold mb-3 text-center",children:c.workoutCardio.question}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>{e&&r()},disabled:s,className:`flex-1 py-2.5 px-4 rounded-xl font-medium transition duration-200 ease-in-out ${e?"bg-red-500/30 text-white border border-red-400/40 supports-[hover:hover]:hover:bg-red-500/40 supports-[hover:hover]:hover:shadow-xs":"bg-red-500/80 text-white shadow-lg border border-red-400/60"} active:brightness-100 disabled:cursor-not-allowed disabled:pointer-events-none focus:outline-hidden focus-visible:outline-hidden [-webkit-tap-highlight-color:transparent]`,children:c.workoutCardio.no}),t.jsx("button",{onClick:()=>{e||r()},disabled:s,className:`flex-1 py-2.5 px-4 rounded-xl font-medium transition duration-200 ease-in-out ${e?"bg-green-500/80 text-white shadow-lg border border-green-400/60":"bg-green-500/30 text-white border border-green-400/40 supports-[hover:hover]:hover:bg-green-500/40 supports-[hover:hover]:hover:shadow-xs"} active:brightness-100 disabled:cursor-not-allowed disabled:pointer-events-none focus:outline-hidden focus-visible:outline-hidden [-webkit-tap-highlight-color:transparent]`,children:c.workoutCardio.yes})]})]})}function ht({notes:e,isSaving:s,onChange:r}){const{t:c}=oe();return t.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-white text-lg font-bold",children:c.workoutNotes.title}),s&&t.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[t.jsx("span",{className:"w-3 h-3 border border-white/30 border-t-white rounded-full animate-spin"}),c.workoutNotes.saving]})]}),t.jsx("textarea",{value:e,onChange:a=>r(a.target.value),placeholder:c.workoutNotes.placeholder,rows:5,className:"w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-400 text-sm resize-none focus:outline-hidden focus:ring-1 focus:ring-blue-500/50 focus:border-blue-500/50 transition-colors"})]})}function ft({isOpen:e,menuPos:s,onReorder:r,onChangeTemplate:c,onDelete:a,onClose:d}){const{t:h}=oe();return!e||!s?null:$e.createPortal(t.jsxs("div",{className:"fixed menu-popover",style:{top:s.top,left:s.left,width:192},role:"menu",children:[t.jsx("button",{onClick:()=>{d(),r()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:h.workoutActions.reorderExercises}),t.jsx("button",{onClick:()=>{d(),c()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:h.workoutActions.changeWorkout}),t.jsx("button",{onClick:()=>{d(),a()},className:"w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors rounded-lg",children:h.workoutActions.delete})]}),document.body)}function pt({normalizedDate:e,exercisesLength:s,scrollKey:r,location:c}){const[a,d]=o.useState(!1),h=o.useRef(!1),u=o.useRef(0),p=o.useRef(!1),b=o.useRef(!1);return o.useEffect(()=>{p.current=!1,b.current=!1},[e,c.key]),o.useEffect(()=>{if(!e||s===0||b.current)return;const k=()=>{var L;const C=(L=c.state)==null?void 0:L.focusExerciseId;if(!C||p.current)return!1;const f=document.getElementById(`exercise-${C}`);if(!f)return!1;p.current=!0,h.current=!0;const R=document.querySelector(".header-container"),D=R?R.getBoundingClientRect().bottom:0,W=12,O=f.getBoundingClientRect(),B=Math.max(0,window.scrollY+O.top-D-W);return window.scrollTo({top:B,behavior:"smooth"}),f.animate&&f.animate([{boxShadow:"0 0 0 rgba(59,130,246,0)"},{boxShadow:"0 0 0 4px rgba(59,130,246,0.6)"},{boxShadow:"0 0 0 rgba(59,130,246,0)"}],{duration:1200,easing:"ease-in-out"}),setTimeout(()=>{h.current=!1},600),!0},_=()=>{try{const C=localStorage.getItem(r);if(C){const f=parseInt(C,10);Number.isNaN(f)||(h.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:f,behavior:"auto"}),u.current=f,setTimeout(()=>{h.current=!1},100)})}))}}catch(C){console.error("Error restoring scroll:",C)}};k()||_(),b.current=!0},[e,s,r,c.state]),o.useEffect(()=>{if(!e)return;let k=!1;const _=()=>{u.current=window.scrollY,d(window.scrollY>0),!k&&!h.current&&(window.requestAnimationFrame(()=>{try{localStorage.setItem(r,String(u.current))}catch{}k=!1}),k=!0)};return window.addEventListener("scroll",_,{passive:!0}),()=>window.removeEventListener("scroll",_)},[e,r]),o.useEffect(()=>()=>{if(e&&u.current>0)try{localStorage.setItem(r,String(u.current))}catch{}},[e,r]),{isScrolling:a}}const Q=new Map,Le=3e4,wt=e=>{if(!e)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const s=new Date(e);return Number.isNaN(s.getTime())?null:Xe(s)};function xt(){const{date:e}=Ge(),{user:s}=Fe(),r=Ue(),c=V,a=o.useMemo(()=>wt(e),[e]),d=a?`workout-page:${a}`:"workout-page",[h,u]=Pe({key:d,initialState:{workout:null,exercises:[],templates:[],loading:!0,isCreating:!1,isSelectTemplateOpen:!1,hasInitialData:!1,isAddingExercise:!1,workoutName:"",isSavingWorkoutName:!1,isCardio:!1,isSavingCardio:!1,workoutIcon:null,workoutNotes:"",isSavingNotes:!1},ttl:1800*1e3}),{workout:p,exercises:b,templates:k,loading:_,isCreating:A,isSelectTemplateOpen:C,hasInitialData:f,isAddingExercise:R,workoutName:D,isSavingWorkoutName:W,isCardio:O,isSavingCardio:B,workoutIcon:L,workoutNotes:H,isSavingNotes:S}=h,n=o.useCallback(x=>u(T=>({...T,workout:x,workoutName:(x==null?void 0:x.name)??"",isSavingWorkoutName:!1,isCardio:(x==null?void 0:x.is_cardio)??!1,isSavingCardio:!1,workoutIcon:(x==null?void 0:x.icon)??null,workoutNotes:(x==null?void 0:x.notes)??"",isSavingNotes:!1})),[u]),l=o.useCallback(x=>u(T=>({...T,exercises:typeof x=="function"?x(T.exercises):x})),[u]),g=o.useCallback(x=>u(T=>({...T,templates:typeof x=="function"?x(T.templates):x})),[u]),w=o.useCallback(x=>u(T=>({...T,loading:x})),[u]),j=o.useCallback(x=>u(T=>({...T,isCreating:x})),[u]),E=o.useCallback(x=>u(T=>({...T,isSelectTemplateOpen:x})),[u]),I=o.useCallback(x=>u(T=>({...T,hasInitialData:x})),[u]),F=o.useCallback(x=>u(T=>({...T,isAddingExercise:x})),[u]),J=o.useCallback(x=>u(T=>({...T,workoutName:x})),[u]),z=o.useCallback(x=>u(T=>({...T,isSavingWorkoutName:x})),[u]),K=o.useCallback(x=>u(T=>({...T,isCardio:x})),[u]),Z=o.useCallback(x=>u(T=>({...T,isSavingCardio:x})),[u]),ie=o.useCallback(x=>u(T=>({...T,workoutIcon:x})),[u]),ae=o.useCallback(x=>u(T=>({...T,workoutNotes:x})),[u]),le=o.useCallback(x=>u(T=>({...T,isSavingNotes:x})),[u]),ne=o.useCallback(async(x=!1,T=!1)=>{if(!s||!a){n(null),l([]),w(!1),I(!0);return}const X=`${s.id}:${a}`,ue=Date.now();if(Q.has(X)){const m=Q.get(X),N=ue-m.timestamp;if(x&&N<Le){f||(n(m.workout),l(m.exercises),w(!1),I(!0));return}N>=Le&&(f||(n(m.workout),l(m.exercises),I(!0)),T=!0)}T||w(!0);const{data:de,error:me}=await c.from("workouts").select("*").eq("user_id",s.id).eq("workout_date",a).order("created_at",{ascending:!1}).limit(1);let y=(de==null?void 0:de[0])??null;if(me)console.error("Error fetching workout:",me);else if(y){if(y.template_id&&!y.icon)try{const{data:v}=await c.from("workout_templates").select("icon").eq("id",y.template_id).single();v!=null&&v.icon&&(y={...y,icon:v.icon},c.from("workouts").update({icon:v.icon}).eq("id",y.id).then(()=>{},()=>{}))}catch{}n(y);const{data:m,error:N}=await c.from("workout_exercises").select("id, name, sets, reps, rest_seconds, position, workout_id, workout_sets ( id, workout_exercise_id, set_index, weight, reps, is_done, is_dropset, parent_set_index, is_warmup, updated_at )").eq("workout_id",y.id).order("position");if(N)console.error("Error fetching exercises:",N);else{const v=m||[];v.forEach(M=>{M.workout_sets&&M.workout_sets.sort((G,q)=>{const $=G.is_dropset??!1,U=q.is_dropset??!1,P=$?G.parent_set_index??G.set_index:G.set_index,se=U?q.parent_set_index??q.set_index:q.set_index;return P!==se?P-se:$!==U?$?1:-1:G.set_index-q.set_index})}),l(v),Q.set(X,{workout:y,exercises:v,timestamp:ue})}}else n(null),l([]),Q.set(X,{workout:null,exercises:[],timestamp:ue});const i=s?`templates-cache:${s.id}`:void 0;if(i)try{const m=localStorage.getItem(i);if(m){const N=JSON.parse(m);N.data&&g(N.data)}}catch{}c.from("workout_templates").select("id, name, created_at, user_id, icon, is_archived").eq("user_id",s.id).eq("is_archived",!1).then(({data:m,error:N})=>{if(N)console.error("Error fetching templates:",N.message);else if(g(m||[]),i)try{localStorage.setItem(i,JSON.stringify({ts:Date.now(),data:m}))}catch{}}),w(!1),I(!0)},[s,a,f,n,l,w,I,g]);return o.useEffect(()=>{ne()},[ne]),o.useEffect(()=>{const x=()=>{document.visibilityState==="visible"&&ne(!0)};return document.addEventListener("visibilitychange",x),()=>document.removeEventListener("visibilitychange",x)},[ne]),o.useEffect(()=>{a&&(localStorage.setItem("lastWorkoutPath",`/workout/${a}`),localStorage.setItem("lastWorkoutTimestamp",Date.now().toString()))},[a]),{user:s,normalizedDate:a,location:r,workout:p,exercises:b,templates:k,loading:_,isCreating:A,isSelectTemplateOpen:C,hasInitialData:f,isAddingExercise:R,workoutName:D,isSavingWorkoutName:W,isCardio:O,isSavingCardio:B,workoutIcon:L,workoutNotes:H,isSavingNotes:S,setPageState:u,setWorkout:n,setExercises:l,setTemplates:g,setLoading:w,setIsCreating:j,setIsSelectTemplateOpen:E,setHasInitialData:I,setIsAddingExercise:F,setWorkoutName:J,setIsSavingWorkoutName:z,setIsCardio:K,setIsSavingCardio:Z,setWorkoutIcon:ie,setWorkoutNotes:ae,setIsSavingNotes:le,fetchWorkoutData:ne}}function gt({user:e,normalizedDate:s,workout:r,exercises:c,setPageState:a,setWorkout:d,setExercises:h,setIsCreating:u,setIsAddingExercise:p,setWorkoutName:b,setIsSelectTemplateOpen:k,fetchWorkoutData:_,isAddingExercise:A}){const C=Ke(),f=V,R=o.useCallback(n=>{a(l=>{const g=l.exercises.map(w=>w.id===n.id?n:w);if(e&&s&&l.workout){const w=`${e.id}:${s}`;Q.set(w,{workout:l.workout,exercises:g,timestamp:Date.now()})}return{...l,exercises:g}})},[e,s,a]),D=o.useCallback(n=>{a(l=>{const g=l.exercises.filter(w=>String(w.id)!==String(n));if(e&&s&&l.workout){const w=`${e.id}:${s}`;Q.set(w,{workout:l.workout,exercises:g,timestamp:Date.now()})}return{...l,exercises:g}})},[e,s,a]),W=o.useCallback(async()=>{if(!(!e||!s||!r||A)){p(!0);try{const n=c.length>0?Math.max(...c.map(J=>typeof J.position=="number"?J.position:0))+1:1,{data:l,error:g}=await f.from("workout_exercises").insert({workout_id:r.id,name:"",sets:1,reps:"",rest_seconds:150,position:n}).select("id, name, sets, reps, rest_seconds, position, workout_id");if(g)throw g;const w=l==null?void 0:l[0];if(!w)throw new Error(te().hooks.failedToCreateExercise);const{data:j,error:E}=await f.from("workout_sets").insert({workout_exercise_id:w.id,set_index:1,weight:null,reps:null,is_done:!1,is_dropset:!1,updated_at:new Date().toISOString()}).select("id, workout_exercise_id, set_index, weight, reps, is_done, is_dropset, updated_at");if(E)throw E;const I=j==null?void 0:j[0];if(!I)throw new Error(te().hooks.failedToCreateSet);const F={...w,workout_sets:[I]};a(J=>{if(!J.workout)return J;const z=[...J.exercises,F].sort((K,Z)=>K.position-Z.position);if(e&&s){const K=`${e.id}:${s}`,Z=Q.get(K);Z&&Q.set(K,{workout:Z.workout,exercises:z,timestamp:Date.now()})}return{...J,exercises:z}})}catch(n){console.error("Failed to add exercise:",n),alert(te().hooks.failedToAddExercise)}finally{p(!1)}}},[e,s,r,c,A,a,p]),O=o.useCallback(async()=>{if(!(!e||!s)){u(!0);try{const{data:n,error:l}=await f.from("workouts").insert({user_id:e.id,workout_date:s,name:te().hooks.newWorkout,template_id:null}).select().single();if(l)throw l;if(!n)throw new Error(te().hooks.failedToCreateWorkoutEntry);d(n),h([]),b(n.name);const g=`${e.id}:${s}`;Q.set(g,{workout:n,exercises:[],timestamp:Date.now()})}catch(n){console.error("Failed to create custom workout:",n),alert(te().hooks.failedToCreateWorkoutTryAgain)}finally{u(!1)}}},[e,s,u,d,h,b]),B=o.useCallback(async n=>{if(!(!e||!s)){u(!0);try{const[{data:l},{data:g}]=await Promise.all([f.from("template_exercises").select("*").eq("template_id",n.id),f.from("workout_templates").select("id, name, icon").eq("id",n.id).single()]),w=(g==null?void 0:g.icon)??n.icon??null,j=(g==null?void 0:g.name)??n.name,{data:E}=await f.from("workouts").insert({user_id:e.id,workout_date:s,name:j,template_id:n.id,icon:w}).select().single();if(!E)throw new Error("Failed to create workout entry.");const I=(l||[]).map(K=>({workout_id:E.id,name:K.name,sets:K.sets,reps:K.reps,rest_seconds:K.rest_seconds,position:K.position})),{data:F}=await f.from("workout_exercises").insert(I).select();if(!F)throw new Error("Failed to create workout exercises.");const J=F.flatMap(K=>Array.from({length:K.sets},(Z,ie)=>({workout_exercise_id:K.id,set_index:ie+1})));await f.from("workout_sets").insert(J);const z=`${e.id}:${s}`;Q.delete(z),await _()}catch(l){console.error("Failed to create workout from template:",l),alert(te().hooks.failedToCreateFromTemplate+l.message)}finally{u(!1)}}},[e,s,u,_]),L=o.useCallback(async n=>{if(!(!e||!s||!r))try{u(!0);const[{data:l,error:g},{data:w,error:j}]=await Promise.all([f.from("template_exercises").select("*").eq("template_id",n.id),f.from("workout_templates").select("id, name, icon").eq("id",n.id).single()]);if(g)throw g;if(j)throw j;const{data:E,error:I}=await f.from("workout_exercises").select("id").eq("workout_id",r.id);if(I)throw I;const F=(E||[]).map(x=>x.id);if(F.length>0){const{error:x}=await f.from("workout_sets").delete().in("workout_exercise_id",F);if(x)throw x;const{error:T}=await f.from("workout_exercises").delete().eq("workout_id",r.id);if(T)throw T}const J=(w==null?void 0:w.icon)??n.icon??null,z=(w==null?void 0:w.name)??n.name,{error:K}=await f.from("workouts").update({name:z,template_id:n.id,icon:J}).eq("id",r.id);if(K)throw K;const Z=(l||[]).map(x=>({workout_id:r.id,name:x.name,sets:x.sets,reps:x.reps,rest_seconds:x.rest_seconds,position:x.position})),{data:ie,error:ae}=await f.from("workout_exercises").insert(Z).select();if(ae)throw ae;const le=(ie||[]).flatMap(x=>Array.from({length:x.sets},(T,X)=>({workout_exercise_id:x.id,set_index:X+1})));if(le.length>0){const{error:x}=await f.from("workout_sets").insert(le);if(x)throw x}const ne=`${e.id}:${s}`;Q.delete(ne),k(!1),await _()}catch(l){console.error("Failed to replace workout from template:",l),alert(te().hooks.failedToChangeWorkout+l.message)}finally{u(!1)}},[e,s,r,u,k,_]),H=o.useCallback(async()=>{if(!r)return;const{error:n}=await f.from("workouts").delete().eq("id",r.id);if(n){console.error("Error deleting workout:",n),alert(te().hooks.failedToDeleteWorkout);return}if(e&&s){const l=`${e.id}:${s}`;Q.delete(l)}C("/calendar",{state:{removedDate:s}})},[r,e,s,C]),S=o.useCallback(async n=>{if(!e||!r)return;const l=new Map(n.map((w,j)=>[w.id,j+1]));h(w=>{const j=w.map(E=>({...E,position:l.get(E.id)??E.position}));return j.sort((E,I)=>(E.position??0)-(I.position??0)),j});const g=n.map((w,j)=>({id:w.id,position:j+1}));try{if(await Promise.all(g.map(async w=>{const{error:j}=await f.from("workout_exercises").update({position:w.position}).eq("id",w.id);if(j)throw j})),e&&s){const w=`${e.id}:${s}`,j=Q.get(w);if(j){const E=[...j.exercises].map(I=>({...I,position:l.get(I.id)??I.position})).sort((I,F)=>(I.position??0)-(F.position??0));Q.set(w,{workout:j.workout,exercises:E,timestamp:Date.now()})}}}catch(w){console.error("Failed to save new order:",w),alert(te().hooks.failedToSaveOrder),await _()}},[e,r,s,h,_]);return{handleUpdateExercise:R,handleDeleteExercise:D,handleAddExercise:W,handleCreateCustomWorkout:O,handleCreateWorkout:B,handleReplaceWithTemplate:L,handleDeleteWorkout:H,handleSaveNewOrder:S}}function bt({user:e,normalizedDate:s,workout:r,exercises:c,workoutName:a,workoutIcon:d,setWorkout:h,setWorkoutName:u,setIsSavingWorkoutName:p}){const b=V,k=o.useRef(null),[_,A]=o.useState(!1),[C,f]=o.useState(a),[R,D]=o.useState(d),[W,O]=o.useState(!1);o.useEffect(()=>{_&&k.current&&(k.current.focus(),k.current.select())},[_]);const B=o.useCallback(()=>{f(a),D(d),A(!0)},[a,d]),L=o.useCallback(async()=>{if(!e||!s||!r)return;const w=C.trim();if(w.length===0){f(a),D(d),A(!1);return}const j=w!==r.name,E=R!==r.icon;if(!j&&!E){A(!1);return}p(!0);try{const I={};j&&(I.name=w),E&&(I.icon=R);const{data:F,error:J}=await b.from("workouts").update(I).eq("id",r.id).select().single();if(J)throw J;if(!F)throw new Error(te().hooks.failedToUpdateWorkout);h(F),f(w),D(F.icon),A(!1);const z=`${e.id}:${s}`;Q.set(z,{workout:F,exercises:c,timestamp:Date.now()})}catch(I){console.error("Failed to update workout:",I),alert(te().hooks.failedToSaveChanges)}finally{p(!1)}},[e,s,r,c,C,R,a,d,h,p]),H=o.useCallback(()=>{f(a),D(d),A(!1)},[a,d]),S=o.useCallback(()=>{O(!0)},[]),n=o.useCallback(w=>{D(w)},[]),l=o.useCallback(async()=>{if(!e||!s||!r)return;const w=a.trim();if(w.length===0){u(r.name);return}if(w!==r.name){p(!0);try{const{data:j,error:E}=await b.from("workouts").update({name:w}).eq("id",r.id).select().single();if(E)throw E;if(!j)throw new Error(te().hooks.failedToUpdateWorkoutName);h(j);const I=`${e.id}:${s}`;Q.set(I,{workout:j,exercises:c,timestamp:Date.now()})}catch(j){console.error("Failed to update workout name:",j),alert(te().hooks.failedToSaveName),u(r.name)}finally{p(!1)}}},[e,s,r,c,a,h,u,p]),g=o.useCallback(w=>{w.key==="Enter"&&w.currentTarget.blur()},[]);return{inputRef:k,isEditingName:_,editNameValue:C,editIconValue:R,isIconPickerOpen:W,setIsIconPickerOpen:O,setEditNameValue:f,handleStartEditName:B,handleSaveEditName:L,handleCancelEditName:H,handleOpenIconPicker:S,handleIconChange:n,handleSaveWorkoutName:l,handleWorkoutNameKeyDown:g}}function kt({user:e,normalizedDate:s,workout:r,exercises:c,isCardio:a,setIsCardio:d,setIsSavingCardio:h,setWorkout:u}){const p=V;return{handleToggleCardio:o.useCallback(async()=>{if(!e||!s||!r)return;const k=!a;d(k),h(!0);try{const{data:_,error:A}=await p.from("workouts").update({is_cardio:k}).eq("id",r.id).select().single();if(A)throw A;if(!_)throw new Error(te().hooks.failedToUpdateCardio);u(_);const C=`${e.id}:${s}`;Q.set(C,{workout:_,exercises:c,timestamp:Date.now()})}catch(_){console.error("Failed to update cardio status:",_),alert(te().hooks.failedToSaveCardio),d(!k)}finally{h(!1)}},[e,s,r,c,a,d,h,u])}}function vt({user:e,normalizedDate:s,workout:r,workoutNotes:c,setIsSavingNotes:a}){const d=V,h=xe(c,800),u=o.useRef(c);o.useEffect(()=>{u.current=c},[c]),o.useEffect(()=>{if(!e||!s||!r||h===(r.notes??""))return;(async()=>{a(!0);try{const{error:b}=await d.from("workouts").update({notes:h||null}).eq("id",r.id);if(b)throw b;const k=`${e.id}:${s}`,_=Q.get(k);_&&_.workout&&Q.set(k,{..._,workout:{..._.workout,notes:h||null},timestamp:Date.now()})}catch(b){console.error("Failed to save notes:",b)}finally{a(!1)}})()},[h,e,s,r==null?void 0:r.id,a])}function yt({user:e,workout:s,setWorkout:r}){const c=V,a=o.useCallback(async()=>{if(!e||!s)return;const b=new Date().toISOString(),{error:k}=await c.from("workouts").update({start_time:b}).eq("id",s.id);if(k){console.error("Error starting workout:",k);return}r({...s,start_time:b})},[e,s,r,c]),d=o.useCallback(async()=>{if(!e||!s)return;const b=new Date().toISOString(),{error:k}=await c.from("workouts").update({end_time:b}).eq("id",s.id);if(k){console.error("Error ending workout:",k);return}r({...s,end_time:b})},[e,s,r,c]),h=o.useCallback(async b=>{if(!e||!s)return;const{error:k}=await c.from("workouts").update({start_time:b}).eq("id",s.id);if(k){console.error("Error updating start time:",k);return}r({...s,start_time:b})},[e,s,r,c]),u=o.useCallback(async b=>{if(!e||!s)return;const{error:k}=await c.from("workouts").update({end_time:b}).eq("id",s.id);if(k){console.error("Error updating end time:",k);return}r({...s,end_time:b})},[e,s,r,c]),p=o.useCallback(async()=>{if(!e||!s)return;const{error:b}=await c.from("workouts").update({start_time:null,end_time:null}).eq("id",s.id);if(b){console.error("Error clearing workout time:",b);return}r({...s,start_time:null,end_time:null})},[e,s,r,c]);return{startTime:(s==null?void 0:s.start_time)??null,endTime:(s==null?void 0:s.end_time)??null,handleStartWorkout:a,handleEndWorkout:d,handleUpdateStartTime:h,handleUpdateEndTime:u,handleClearWorkoutTime:p}}const Me=e=>e?new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"",_t=(e,s,r)=>{const c=new Date(e),d=new Date(s).getTime()-c.getTime(),h=Math.floor(d/(1e3*60*60)),u=Math.floor(d%(1e3*60*60)/(1e3*60)),p=Math.floor(d%(1e3*60)/1e3);return h>0?`${h}${r.hours} ${u}${r.minutes} ${p}${r.seconds}`:u>0?`${u}${r.minutes} ${p}${r.seconds}`:`${p}${r.seconds}`},Oe=e=>{if(!e)return"";const s=new Date(e),r=c=>c.toString().padStart(2,"0");return`${r(s.getHours())}:${r(s.getMinutes())}:${r(s.getSeconds())}`},Be=(e,s)=>{const r=s?new Date(s):new Date,[c,a,d]=e.split(":").map(Number);return r.setHours(c,a,d||0,0),r.toISOString()},jt=({startTime:e,endTime:s,onUpdateStartTime:r,onUpdateEndTime:c,onClear:a})=>{const{t:d}=oe(),[h,u]=o.useState(!1),[p,b]=o.useState(""),[k,_]=o.useState("");if(!e&&!s)return null;const A=()=>{b(Oe(e)),_(Oe(s)),u(!0)},C=()=>{p&&e&&r(Be(p,e)),k&&s&&c(Be(k,s)),u(!1)},f=()=>{u(!1)};return t.jsxs("div",{className:"glass card-dark p-4 space-y-2",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold text-white",children:d.workoutTime.title}),t.jsxs("div",{className:"flex items-center gap-1",children:[!h&&t.jsx("button",{type:"button",onClick:A,className:"p-1.5 rounded-full hover:bg-white/10 transition-colors",title:d.workoutTime.editTime,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-300",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),t.jsx("button",{type:"button",onClick:a,className:"p-1.5 rounded-full hover:bg-red-500/20 transition-colors",title:d.workoutTime.deleteTime,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]}),t.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:d.workoutTime.start}),h?t.jsx("input",{type:"time",step:"1",value:p,onChange:R=>b(R.target.value),className:"bg-white/10 text-green-400 font-mono text-sm rounded px-2 py-1 focus:outline-hidden focus:bg-white/20"}):t.jsx("span",{className:"text-green-400 font-mono",children:Me(e)})]}),s&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:d.workoutTime.end}),h?t.jsx("input",{type:"time",step:"1",value:k,onChange:R=>_(R.target.value),className:"bg-white/10 text-red-400 font-mono text-sm rounded px-2 py-1 focus:outline-hidden focus:bg-white/20"}):t.jsx("span",{className:"text-red-400 font-mono",children:Me(s)})]}),h&&t.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[t.jsx("button",{type:"button",onClick:f,className:"px-3 py-1 rounded bg-white/10 hover:bg-white/20 text-gray-300 text-sm transition-colors",children:d.common.cancel}),t.jsx("button",{type:"button",onClick:C,className:"px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-sm transition-colors",children:d.common.save})]}),!h&&e&&s&&t.jsxs("div",{className:"flex justify-between pt-2 border-t border-white/10",children:[t.jsx("span",{children:d.workoutTime.duration}),t.jsx("span",{className:"text-white dark:text-white font-mono duration-value",children:_t(e,s,{hours:d.workoutTime.hours,minutes:d.workoutTime.minutes,seconds:d.workoutTime.seconds})})]})]})]})};function Te(e,s,r){const c=e.slice(),[a]=c.splice(s,1);return c.splice(r,0,a),c}const Nt=({open:e,items:s,onClose:r,onSave:c})=>{const{t:a}=oe(),[d,h]=o.useState([]),u=o.useRef(null),[p,b]=o.useState(!1),[k,_]=o.useState(null),A=o.useRef(0),C=o.useRef(null),f=o.useMemo(()=>s.slice().sort((n,l)=>(n.position??0)-(l.position??0)),[s]);if(o.useEffect(()=>{e&&h(f)},[e,f]),Ve(e),!e)return null;const R=(n,l)=>{l<0||l>=d.length||h(g=>Te(g,n,l))},D=n=>l=>{u.current=n,l.dataTransfer.effectAllowed="move"},W=n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},O=n=>l=>{l.preventDefault();const g=u.current;if(u.current=null,g==null||g===n)return;const w=d.findIndex(E=>E.id===g),j=d.findIndex(E=>E.id===n);w===-1||j===-1||h(E=>Te(E,w,j))},B=n=>l=>{const g=l.touches[0];A.current=g.clientY,_(n)},L=n=>{if(!k)return;const g=n.touches[0].clientY,w=g-A.current,j=d.findIndex(F=>F.id===k);if(j===-1)return;const I=Math.round(w/60);if(Math.abs(I)>=1){const F=j+I;F>=0&&F<d.length&&F!==j&&(h(J=>Te(J,j,F)),A.current=g)}},H=()=>{_(null)},S=async()=>{b(!0);try{await c(d.map((n,l)=>({...n,position:l+1}))),r()}finally{b(!1)}};return $e.createPortal(t.jsxs("div",{className:"fixed inset-0 z-100 flex items-center justify-center p-4 overscroll-contain",children:[t.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:r}),t.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:a.reorderExercises.title}),t.jsx("ol",{ref:C,className:"space-y-2 max-h-[55vh] overflow-y-auto pr-1",onTouchMove:L,onTouchEnd:H,children:d.map((n,l)=>t.jsxs("li",{draggable:!0,onDragStart:D(n.id),onDragOver:W,onDrop:O(n.id),className:`rounded-lg p-2 flex items-center gap-2 hover:bg-white/5 transition-colors ${k===n.id?"bg-white/20 scale-105":""}`,children:[t.jsxs("span",{className:"select-none w-6 text-center opacity-70",children:[l+1,"."]}),t.jsx("button",{type:"button","aria-label":a.reorderExercises.drag,className:"cursor-grab px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 active:cursor-grabbing touch-none",draggable:!0,onDragStart:D(n.id),onTouchStart:B(n.id),children:"⋮⋮"}),t.jsx("div",{className:"flex-1 whitespace-normal wrap-break-word leading-snug",children:n.name||a.reorderExercises.noName}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>R(l,l-1),disabled:l===0,children:"↑"}),t.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>R(l,l+1),disabled:l===d.length-1,children:"↓"})]})]},n.id))}),t.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[t.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:r,disabled:p,children:a.common.cancel}),t.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-primary",onClick:S,disabled:p,children:p?a.reorderExercises.saving:a.common.save})]})]})]}),document.body)},St=({open:e,value:s,onClose:r,onChange:c})=>{const{t:a}=oe();if(!e)return null;const d=Object.keys(De),h=u=>{c(u),r()};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-xs",onClick:r,children:t.jsxs("div",{className:"glass card-dark p-4 rounded-xl w-[90%] max-w-sm mx-auto",onClick:u=>u.stopPropagation(),children:[t.jsx("h2",{className:"text-lg font-semibold text-white mb-4 text-center",children:a.workoutIconPicker.title}),t.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[t.jsxs("button",{type:"button",onClick:()=>h(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${s===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[t.jsx("div",{className:"w-10 h-10 flex items-center justify-center text-gray-500",children:t.jsx("svg",{viewBox:"0 0 24 24",width:"28",height:"28",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:t.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),t.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:a.workoutIconPicker.none})]}),d.map(u=>{const{component:p,label:b}=De[u],k=s===u;return t.jsxs("button",{type:"button",onClick:()=>h(u),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${k?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[t.jsx("div",{className:"w-10 h-10 flex items-center justify-center",children:t.jsx(p,{size:28})}),t.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:b})]},u)})]}),t.jsx("button",{type:"button",onClick:r,className:"mt-4 w-full py-2 text-gray-400 hover:text-white transition-colors",children:a.common.cancel})]})})},Bt=()=>{const{t:e}=oe(),s=xt(),{user:r,normalizedDate:c,location:a,workout:d,exercises:h,templates:u,isCreating:p,isSelectTemplateOpen:b,hasInitialData:k,isAddingExercise:_,workoutName:A,isSavingWorkoutName:C,isCardio:f,isSavingCardio:R,workoutIcon:D,workoutNotes:W,isSavingNotes:O,setPageState:B,setWorkout:L,setExercises:H,setIsCreating:S,setIsSelectTemplateOpen:n,setIsAddingExercise:l,setWorkoutName:g,setIsSavingWorkoutName:w,setIsCardio:j,setIsSavingCardio:E,setWorkoutNotes:I,setIsSavingNotes:F,fetchWorkoutData:J}=s,{isActionsOpen:z,menuPos:K,actionsRef:Z,actionsBtnRef:ie,toggleActions:ae,closeActions:le}=Ze(),{handleUpdateExercise:ne,handleDeleteExercise:x,handleAddExercise:T,handleCreateCustomWorkout:X,handleCreateWorkout:ue,handleReplaceWithTemplate:de,handleDeleteWorkout:me,handleSaveNewOrder:y}=gt({user:r,normalizedDate:c,workout:d,exercises:h,setPageState:B,setWorkout:L,setExercises:H,setIsCreating:S,setIsAddingExercise:l,setWorkoutName:g,setIsSelectTemplateOpen:n,fetchWorkoutData:J,isAddingExercise:_}),{inputRef:i,isEditingName:m,editNameValue:N,editIconValue:v,isIconPickerOpen:M,setIsIconPickerOpen:G,setEditNameValue:q,handleStartEditName:$,handleSaveEditName:U,handleCancelEditName:P,handleOpenIconPicker:se,handleIconChange:re}=bt({user:r,normalizedDate:c,workout:d,exercises:h,workoutName:A,workoutIcon:D,setWorkout:L,setWorkoutName:g,setIsSavingWorkoutName:w}),{handleToggleCardio:pe}=kt({user:r,normalizedDate:c,workout:d,exercises:h,isCardio:f,setIsCardio:j,setIsSavingCardio:E,setWorkout:L});vt({user:r,normalizedDate:c,workout:d,workoutNotes:W,setIsSavingNotes:F});const{startTime:ge,endTime:we,handleStartWorkout:je,handleEndWorkout:Ee,handleUpdateStartTime:Ne,handleUpdateEndTime:be,handleClearWorkoutTime:Se}=yt({user:r,workout:d,setWorkout:L}),[ke,ve]=o.useState(!1),[Y,he]=o.useState(!1),ee=`scroll:workout:${c??""}`,{isScrolling:fe}=pt({normalizedDate:c,exercisesLength:h.length,scrollKey:ee,location:a});return Ve(b),k?c?d?t.jsxs("div",{className:"relative px-4 space-y-4 pt-4 pb-10",children:[t.jsx("div",{className:`status-bar-blur ${fe?"visible":""}`}),t.jsx(ct,{normalizedDate:c,workoutName:A,isEditingName:m,editNameValue:N,isSavingWorkoutName:C,isScrolling:fe,inputRef:i,onStartEditName:$,onChangeEditName:q,onSaveEditName:U,onCancelEditName:P,actionsRef:Z,actionsBtnRef:ie,onToggleActions:ae,workoutIcon:D,editIconValue:v,onOpenIconPicker:se}),!ge&&t.jsx("button",{type:"button",onClick:je,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:e.workoutTime.startWorkout}),t.jsx("div",{className:"space-y-4",children:h.map(ce=>t.jsx(lt,{exercise:ce,workoutDate:c,onUpdateExercise:ne,onDeleteExercise:x},ce.id))}),ge&&!we&&t.jsx("button",{type:"button",onClick:Ee,className:"btn-glass btn-glass-full btn-glass-md bg-red-600 hover:bg-red-700 text-white font-semibold",children:e.workoutTime.endWorkout}),t.jsx("div",{children:t.jsx("button",{type:"button",onClick:T,disabled:_,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary text-white disabled:opacity-50",children:_?e.workout.adding:e.workout.addExercise})}),t.jsx(mt,{isCardio:f,isSaving:R,onToggle:pe}),t.jsx(ht,{notes:W,isSaving:O,onChange:I}),t.jsx(jt,{startTime:ge,endTime:we,onUpdateStartTime:Ne,onUpdateEndTime:be,onClear:Se}),t.jsx(dt,{open:b,templates:u,isCreating:p,onClose:()=>n(!1),onReplaceWithTemplate:de}),t.jsx(Nt,{open:Y,onClose:()=>he(!1),items:h.map(ce=>({id:ce.id,name:ce.name,position:ce.position??0})),onSave:y}),t.jsx(He,{open:ke,onOpenChange:ve,title:e.workout.deleteWorkout,description:e.workout.deleteWorkoutDesc.replace("{date}",Ce(c)),confirmText:e.common.delete,cancelText:e.common.cancel,variant:"danger",onConfirm:me}),t.jsx(St,{open:M,value:v,onClose:()=>G(!1),onChange:re}),t.jsx(ft,{isOpen:z,menuPos:K,onReorder:()=>he(!0),onChangeTemplate:()=>n(!0),onDelete:()=>ve(!0),onClose:le})]}):t.jsx(ut,{normalizedDate:c,templates:u,isCreating:p,onCreateWorkout:ue,onCreateCustomWorkout:X}):null:t.jsx(qe,{message:e.workout.loading})};export{Bt as default};
