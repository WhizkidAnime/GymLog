import{j as e,s as ee,u as qe,W as Ae}from"./index-c23xV8dA.js";import{f as Be,r as a,e as Pe,c as Re,j as dt,u as ut,L as mt}from"./vendor-BVca5W6X.js";import{u as ft}from"./usePageState-6XNG0ilq.js";import{u as ye}from"./useDebounce-C2cqH541.js";import{C as Ke}from"./confirm-dialog-BbVc54X7.js";import{c as Ee,f as ht}from"./date-helpers-BoyNci5t.js";import{n as Oe,p as wt}from"./exercise-name-BJxyXXn3.js";import{W as Le}from"./workout-icons-BviB-x_R.js";import{u as ze}from"./use-modal-scroll-lock-DlG-D3y9.js";import{u as gt}from"./use-workout-actions-menu-C-5wTXkz.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const pt=({set:t,previousSet:r,onChange:d})=>{const x=`workout_set_draft:${t.id}`,n=`workout_set_last_non_max_reps:${t.id}`,o=u=>u==null?"":String(u).replace(".",","),g=u=>{if(u==="")return null;const l=Number(u.replace(",","."));return Number.isFinite(l)?l:null},b=u=>{let l=u.replace(".",",");l=l.replace(/[^\d,]/g,"");const A=l.indexOf(",");return A!==-1&&(l=l.slice(0,A+1)+l.slice(A+1).replace(/,/g,"")),l},y="макс.",w=u=>u==null?"":u==="0"?y:u,N=u=>{const l=u.trim();if(l==="")return null;const A=l.toLowerCase();return A==="макс"||A==="макс."||/^0+$/.test(l)?"0":l},D=u=>{const l=u.trim();return l===""?"":/^0+$/.test(l)||l.toLowerCase().startsWith("макс")?y:l.replace(/[^0-9]/g,"")},M=w(t.reps),[v,C]=a.useState(o(t.weight)),[j,F]=a.useState(M),[O,T]=a.useState(N(M)==="0"?null:M||null),[S,V]=a.useState(t.is_done),[p,c]=a.useState(!1),[f,$]=a.useState(()=>N(M)==="0"),z=ye(v,500),K=ye(j,500),X=!!r&&r.is_done&&r.weight!==null&&g(v)===null,ne=u=>{T(u);try{u&&u.trim()!==""?localStorage.setItem(n,u):localStorage.removeItem(n)}catch{}};a.useEffect(()=>{try{const u=localStorage.getItem(x);if(!u)return;const l=JSON.parse(u),A=new Date(t.updated_at).getTime();if(l.updatedAt>A){C(l.weight===""?"":o(l.weight));const P=w(l.reps);F(P);const se=N(P)==="0"?null:P||null;ne(se),V(l.isDone)}}catch{}},[]),a.useEffect(()=>{V(t.is_done)},[t.is_done]),a.useEffect(()=>{if(t.reps==="0")try{const u=localStorage.getItem(n);u&&u.trim()!==""&&T(u)}catch{}},[t.reps,n]),a.useEffect(()=>{(async()=>{const l=g(z),A=N(K);if(l!==(t.weight??null)||A!==(t.reps??null)||S!==t.is_done){const P={weight:l===null?"":l,reps:A,isDone:S,updatedAt:Date.now()};try{localStorage.setItem(x,JSON.stringify(P))}catch{}c(!0);const{error:se}=await ee.from("workout_sets").update({weight:l,reps:A,is_done:S,updated_at:new Date().toISOString()}).eq("id",t.id);if(se)console.error("Error saving set:",se);else{try{localStorage.removeItem(x)}catch{}const ie={...t,weight:l,reps:A,is_done:S,updated_at:new Date().toISOString()};d==null||d(ie)}setTimeout(()=>c(!1),500)}})()},[z,K,t.id,t.weight,t.reps,t.is_done,S,x]),a.useEffect(()=>{const u=g(z)!==null,l=N(K)!==null,A=u&&l;A&&!S?V(!0):!A&&S&&V(!1)},[z,K,S]);const Z=S?"bg-green-500":"bg-transparent",Q=S?"text-black":"text-inherit",te=S?"setrow-input-done-white":"",h=N(j)==="0",k=f||h,q=()=>{const u=N(j),l=u!==null&&u!=="0";if(k)h&&(O!==null&&O.trim()!==""?F(O):F("")),$(!1);else{if(l){$(!0);return}N(j)!=="0"&&j.trim()!==""&&ne(j),F(y),$(!0)}};return e.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${Z}`,children:[e.jsx("div",{className:`col-span-1 text-center font-medium ${Q}`,children:t.set_index}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:v,onChange:u=>C(b(u.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${te} ${Q}`})}),X&&e.jsx("button",{type:"button",onClick:()=>{!r||r.weight===null||C(o(r.weight))},"aria-label":"Скопировать вес из предыдущего подхода",className:"btn-glass btn-glass-icon-round btn-glass-secondary absolute text-white h-6 w-6 p-0",style:{left:"50%",top:"50%",transform:"translate(-50%, -50%)",transition:"none",width:"1.5rem",height:"1.5rem",minWidth:"1.5rem",minHeight:"1.5rem",padding:0},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"12",height:"12",fill:"none",stroke:"currentColor",strokeWidth:"2.2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"5 15 12 8 19 15"})})}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:j,onChange:u=>{const l=D(u.target.value);if(F(l),N(l)!=="0"){const A=l.trim()===""?null:l;ne(A)}},className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${te} ${Q}`})}),e.jsx("div",{className:"col-span-1 flex justify-center",children:e.jsx("input",{type:"checkbox",checked:k,onChange:q,"aria-label":"Подход в отказ (макс.)",className:"h-6 w-6 rounded-md border border-gray-300 bg-white outline-none focus-visible:outline-none",style:{accentColor:"#000000",color:"#0a0a0a"}})}),p&&e.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},xt=Be.memo(pt,(t,r)=>{var d,x,n,o;return t.set.id===r.set.id&&t.set.weight===r.set.weight&&t.set.reps===r.set.reps&&t.set.is_done===r.set.is_done&&t.set.set_index===r.set.set_index&&t.set.updated_at===r.set.updated_at&&((d=t.previousSet)==null?void 0:d.weight)===((x=r.previousSet)==null?void 0:x.weight)&&((n=t.previousSet)==null?void 0:n.is_done)===((o=r.previousSet)==null?void 0:o.is_done)}),De=()=>{try{const t=localStorage.getItem("settings:timerStep");return t?Number(t):30}catch{return 30}},bt=({restSeconds:t,exerciseId:r,onAdjustRestSeconds:d,timerStep:x})=>{const n=r?`rest_timer:${r}`:void 0,[o,g]=a.useState(()=>x??De());a.useEffect(()=>{if(x!==void 0)g(x);else{const p=()=>{g(De())};window.addEventListener("storage",p);const c=()=>{g(De())};return window.addEventListener("focus",c),()=>{window.removeEventListener("storage",p),window.removeEventListener("focus",c)}}},[x]);const b=a.useRef(null),y=a.useRef(t),w=a.useRef({time:t,isActive:!1,endAt:null}),[N,D]=a.useState(()=>{if(!n)return{time:t,isActive:!1,endAt:null};try{const p=localStorage.getItem(n);if(!p)return{time:t,isActive:!1,endAt:null};const c=JSON.parse(p),f=360*60*1e3;if(Date.now()-c.savedAt>f)return localStorage.removeItem(n),{time:t,isActive:!1,endAt:null};if(c.isActive&&c.endAt){const $=Math.max(0,Math.floor((c.endAt-Date.now())/1e3));return $>0?{time:$,isActive:!0,endAt:c.endAt}:(localStorage.removeItem(n),{time:c.restSeconds,isActive:!1,endAt:null})}return{time:c.restSeconds,isActive:!1,endAt:null}}catch(p){return console.error("Error restoring timer state:",p),{time:t,isActive:!1,endAt:null}}}),{time:M,isActive:v,endAt:C}=N,j=a.useCallback((p,c)=>{if(n)try{const f={endAt:p.endAt,isActive:p.isActive,restSeconds:c??w.current.time??t,savedAt:Date.now()};localStorage.setItem(n,JSON.stringify(f))}catch(f){console.error("Error persisting timer:",f)}},[n,t]),F=a.useRef(j);a.useEffect(()=>{F.current=j},[j]),a.useEffect(()=>{w.current={time:M,isActive:v,endAt:C}},[M,v,C]),a.useEffect(()=>{if(!v||!C){b.current&&(window.clearInterval(b.current),b.current=null);return}let p=!1;const c=()=>{if(p)return;const $=Date.now(),z=Math.max(0,C-$),K=Math.floor(z/1e3);D(X=>({...X,time:K})),K<=0&&(p=!0,D(X=>({...X,isActive:!1,endAt:null,time:t})),b.current&&(window.clearInterval(b.current),b.current=null),n&&localStorage.removeItem(n))};c();const f=window.setInterval(c,1e3);return b.current=f,()=>{p=!0,b.current&&(window.clearInterval(b.current),b.current=null)}},[v,C,n,t]),a.useEffect(()=>{!v&&t!==y.current&&D(p=>({...p,time:t})),y.current=t},[t,v]),a.useEffect(()=>()=>{b.current&&(window.clearInterval(b.current),b.current=null);const{isActive:p,endAt:c}=w.current;p&&c&&F.current({endAt:c,isActive:!0})},[]);const O=()=>{D(p=>{if(p.isActive)return j({endAt:null,isActive:!1},p.time),b.current&&(window.clearInterval(b.current),b.current=null),{time:p.time,isActive:!1,endAt:null};const c=Date.now()+p.time*1e3;return j({endAt:c,isActive:!0},p.time),{time:p.time,isActive:!0,endAt:c}})},T=()=>{D({time:t,isActive:!1,endAt:null}),b.current&&(window.clearInterval(b.current),b.current=null),n&&localStorage.removeItem(n)},S=p=>{D(c=>{const f=Math.max(0,c.time+p);if(f===0)return j({endAt:null,isActive:!1},0),b.current&&(window.clearInterval(b.current),b.current=null),{time:0,isActive:!1,endAt:null};if(c.isActive){const $=Date.now()+f*1e3;return j({endAt:$,isActive:!0},f),{time:f,isActive:!0,endAt:$}}return j({endAt:null,isActive:!1},f),{time:f,isActive:!1,endAt:null}}),d==null||d(p)},V=p=>{const c=Math.floor(p/60),f=p%60;return`${c}:${f<10?"0":""}${f}`};return e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:()=>S(-o),disabled:M<=0&&!v,className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"-"}),e.jsx("div",{className:`text-6xl font-mono font-semibold leading-none min-w-[4ch] text-center ${v?"text-white":""}`,children:V(M)}),e.jsx("button",{onClick:()=>S(o),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3",children:[e.jsx("button",{onClick:O,className:`btn-glass btn-glass-icon-lg ${v?"btn-glass-danger":"btn-glass-primary"}`,children:v?"Стоп":"Старт"}),e.jsx("button",{onClick:T,className:"btn-glass btn-glass-icon-sm btn-glass-secondary",children:"Сброс"})]})]})},kt=7200*1e3,Me=new Map,yt=(t,r,d)=>`${t}:${r}:${d||"none"}`,vt=t=>{const r=Me.get(t);if(!r)return;if(Date.now()-r.timestamp>kt){Me.delete(t);return}return r.data},ke=(t,r)=>{Me.set(t,{data:r,timestamp:Date.now()})},jt=({exercise:t,workoutDate:r,onUpdateExercise:d,onDeleteExercise:x})=>{var te;const[n,o]=a.useState(t.name),[g,b]=a.useState(t.sets),[y,w]=a.useState(t.rest_seconds),[N,D]=a.useState(!1),[M,v]=a.useState(null),[C,j]=a.useState("idle"),F=a.useRef(null),{user:O}=qe(),T=ye(n,500),S=ye(y,500),[V,p]=a.useState(!1),c=a.useRef(t.name),f=a.useCallback(()=>{const h=F.current;h&&(h.style.height="auto",h.style.height=`${h.scrollHeight}px`)},[]);a.useEffect(()=>{t.name!==c.current&&(o(t.name),c.current=t.name),b(t.sets),w(t.rest_seconds)},[t.id,t.sets,t.rest_seconds]),a.useEffect(()=>{if(!O)return;const h=T.trim(),k=Oe(h);if(!k){v(null),j("idle");return}const q=yt(O.id,k,r??null),u=vt(q);if(u!==void 0){v(u),j("ready");return}let l=!1;return j("loading"),(async()=>{try{let P=ee.from("workouts").select("id, workout_date, name, user_id").eq("user_id",O.id);r&&(P=P.lt("workout_date",r));const{data:se,error:ie}=await P.order("workout_date",{ascending:!0});if(l)return;if(ie)throw ie;const pe=(se||[]).map(R=>({id:R.id,date:R.workout_date,name:R.name})),ve=new Map;pe.forEach(R=>ve.set(R.id,{date:R.date,name:R.name}));const we=pe.map(R=>R.id);if(we.length===0){v(null),ke(q,null),j("ready");return}const{data:Ce,error:xe}=await ee.from("workout_exercises").select("id, name, workout_id").in("workout_id",we);if(l)return;if(xe)throw xe;const le=new Set,de=new Map;if((Ce||[]).forEach(R=>{const fe=(R.name??"").trim();if(fe&&Oe(fe)===k){const J=R.id;le.add(J);const he=R.workout_id;he&&de.set(J,he)}}),le.size===0){v(null),ke(q,null),j("ready");return}const{data:je,error:ue}=await ee.from("exercise_progress_view").select("workout_date, workout_name, workout_id, exercise_id, max_weight, reps_at_max_weight").in("workout_id",we).in("exercise_id",Array.from(le));if(l)return;if(ue)throw ue;let ae=(je||[]).map(R=>({workout_date:R.workout_date,workout_name:R.workout_name,workout_id:R.workout_id,exercise_id:R.exercise_id,max_weight:R.max_weight,reps_at_max_weight:R.reps_at_max_weight}));if(ae.length===0){const{data:R,error:fe}=await ee.from("workout_sets").select("id, workout_exercise_id, weight, reps, is_done, updated_at").in("workout_exercise_id",Array.from(le)).order("updated_at",{ascending:!1});if(l)return;if(fe)throw fe;ae=(R||[]).filter(J=>J.weight!==null&&Number(J.weight)===0).filter(J=>J.is_done||typeof J.reps=="string"&&J.reps.trim()!=="").map(J=>{const he=J.workout_exercise_id,ge=de.get(he);if(!ge)return null;const re=ve.get(ge);return re?{workout_date:re.date,workout_name:re.name,workout_id:ge,exercise_id:he,max_weight:0,reps_at_max_weight:J.reps}:null}).filter(J=>J!==null)}if(ae.length===0){v(null),ke(q,null),j("ready");return}const me=wt(h,ae),ce=me.dataPoints[me.dataPoints.length-1];if(!ce){v(null),ke(q,null),j("ready");return}const _e={weight:ce.weight,reps:ce.reps,workoutDate:ce.date};v(_e),ke(q,_e),j("ready")}catch(P){console.error("Failed to fetch last exercise performance",P),j("error")}})(),()=>{l=!0}},[T,O,r]),a.useLayoutEffect(()=>{f()},[f,n]),a.useLayoutEffect(()=>{if(typeof ResizeObserver>"u")return;const h=F.current;if(!h)return;const k=new ResizeObserver(()=>{f()});return k.observe(h),()=>k.disconnect()},[f]),a.useEffect(()=>{(async()=>{if(!(T.trim()===""||T===t.name))try{await ee.from("workout_exercises").update({name:T}).eq("id",t.id);const k={...t,name:T};c.current=T,d(k)}catch(k){console.error("Failed to update exercise name",k)}})()},[T]),a.useEffect(()=>{(async()=>{if(S!==t.rest_seconds)try{await ee.from("workout_exercises").update({rest_seconds:S}).eq("id",t.id);const k={...t,rest_seconds:S};d(k)}catch(k){console.error("Failed to update rest seconds",k)}})()},[S,t,d]);const $=h=>{w(k=>Math.max(0,k+h))},z=async h=>{if(!(h<1||h===g||N)){D(!0);try{if(h>g){const k=Array.from({length:h-g},(P,se)=>({workout_exercise_id:t.id,set_index:g+se+1})),{data:q,error:u}=await ee.from("workout_sets").insert(k).select();if(u)throw u;const l=[...t.workout_sets,...q||[]].sort((P,se)=>P.set_index-se.set_index);await ee.from("workout_exercises").update({sets:h}).eq("id",t.id);const A={...t,sets:h,workout_sets:l};d(A)}else{const{error:k}=await ee.from("workout_sets").delete().eq("workout_exercise_id",t.id).gt("set_index",h);if(k)throw k;const q=t.workout_sets.filter(l=>l.set_index<=h);await ee.from("workout_exercises").update({sets:h}).eq("id",t.id);const u={...t,sets:h,workout_sets:q};d(u)}b(h)}catch(k){console.error("Failed to change sets count",k),alert("Не удалось изменить количество подходов")}finally{D(!1)}}},K=async()=>{const{error:h}=await ee.from("workout_sets").delete().eq("workout_exercise_id",t.id);if(h){console.error("Failed to delete sets of exercise",h),alert("Не удалось удалить подходы упражнения. Попробуйте снова.");return}const{error:k}=await ee.from("workout_exercises").delete().eq("id",t.id);if(k){console.error("Failed to delete exercise",k),alert("Не удалось удалить упражнение. Попробуйте снова.");return}x&&x(t.id)},X="макс.",ne=h=>h==null?"—":String(h).replace(".",","),Z=h=>{if(h==null)return"—";const k=h.trim();return k?k==="0"?X:k:"—"},Q=()=>n.trim()?C==="loading"?e.jsx("span",{className:"text-gray-400",children:"Поиск последнего результата…"}):C==="error"?e.jsx("span",{className:"text-red-300",children:"Не удалось загрузить данные"}):M?e.jsxs("span",{className:"text-white text-base font-semibold",children:[ne(M.weight)," кг × ",Z(M.reps)]}):e.jsx("span",{className:"text-gray-500",children:"До этой даты нет данных по этому упражнению"}):e.jsx("span",{className:"text-gray-500",children:"Введите название, чтобы увидеть прошлый результат"});return e.jsxs("div",{id:`exercise-${t.id}`,className:"glass card-dark p-4 exercise-card",children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{value:n,onChange:h=>o(h.target.value),ref:F,rows:1,className:"w-full text-base sm:text-lg font-bold text-white whitespace-pre-wrap bg-white/10 hover:bg-white/15 focus:bg-white/10 border border-white/20 hover:border-white/30 focus:border-white/50 focus:ring-2 focus:ring-white/25 focus:outline-none rounded-xl px-4 pr-9 py-3 min-h-[3rem] resize-none overflow-y-hidden leading-relaxed transition-colors"}),n&&n.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{o(""),requestAnimationFrame(()=>f())},"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{"aria-label":"Удалить упражнение",className:"delete-btn btn-glass btn-glass-icon btn-glass-outline",onClick:()=>p(!0),type:"button",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-2xl bg-white/5 px-4 py-3 text-xs sm:text-sm text-gray-300",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-white",children:"Последний рабочий вес"}),(M==null?void 0:M.workoutDate)&&e.jsx("span",{className:"text-[0.7rem] uppercase tracking-wide text-gray-400",children:Ee(M.workoutDate)})]}),Q()]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(bt,{restSeconds:y,exerciseId:t.id,onAdjustRestSeconds:$})}),e.jsxs("div",{className:"flex items-center justify-between text-sm py-3 sm:py-4 px-2 rounded-lg exercise-row-header",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"whitespace-nowrap font-medium",children:"Подходы:"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{disabled:N||g<=1,onClick:()=>z(g-1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"−"}),e.jsx("span",{className:"min-w-[3ch] text-center text-white font-semibold",children:g}),e.jsx("button",{disabled:N||g>=30,onClick:()=>z(g+1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]})]}),((te=t.reps)==null?void 0:te.trim())&&e.jsxs("div",{className:"ml-3 flex-1 text-right whitespace-nowrap font-medium",children:["Повторы: ",t.reps]})]})]}),e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden exercise-sets-header",children:[e.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:"Подход"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Вес (кг)"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Повторы"}),e.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2 whitespace-nowrap",children:"В отказ"})]}),e.jsx("div",{className:"space-y-2",children:t.workout_sets.map((h,k,q)=>{const u=k>0?q[k-1]:void 0;return e.jsx(xt,{set:h,previousSet:u,onChange:l=>{const A={...t,workout_sets:t.workout_sets.map(P=>P.id===l.id?l:P)};d(A)}},h.id)})})]}),e.jsx(Ke,{open:V,onOpenChange:p,title:"Удалить упражнение?",description:t.name?`Вы собираетесь удалить упражнение "${t.name}". Действие необратимо.`:"Вы собираетесь удалить упражнение. Действие необратимо.",cancelText:"Отмена",variant:"danger",onConfirm:K})]})},_t=Be.memo(jt,(t,r)=>{const d=t.exercise,x=r.exercise;if(d.id!==x.id||d.name!==x.name||d.sets!==x.sets||d.rest_seconds!==x.rest_seconds||d.reps!==x.reps||t.workoutDate!==r.workoutDate||d.workout_sets.length!==x.workout_sets.length)return!1;for(let n=0;n<d.workout_sets.length;n++){const o=d.workout_sets[n],g=x.workout_sets[n];if(o.id!==g.id||o.weight!==g.weight||o.reps!==g.reps||o.is_done!==g.is_done)return!1}return!0}),He=({normalizedDate:t,className:r=""})=>{const d=Pe();return e.jsx("button",{onClick:()=>d("/calendar",{state:{refreshDate:t}}),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors z-10 bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${r}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})},Nt=({normalizedDate:t,workoutName:r,isEditingName:d,editNameValue:x,isSavingWorkoutName:n,isScrolling:o,inputRef:g,onStartEditName:b,onChangeEditName:y,onSaveEditName:w,onCancelEditName:N,actionsRef:D,actionsBtnRef:M,onToggleActions:v,workoutIcon:C,editIconValue:j,onOpenIconPicker:F})=>{const O=d?j:C,T=O?Le[O]:null;return e.jsxs("div",{className:`glass card-dark p-4 flex items-center gap-4 header-container ${o?"scrolling":""}`,children:[e.jsx(He,{normalizedDate:t,className:"shrink-0"}),e.jsx("div",{className:"flex-1 text-center",children:d?e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:F,disabled:n,className:"shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-50",title:"Выбрать иконку",children:T?e.jsx(T.component,{size:28}):e.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-gray-400",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"}),e.jsx("path",{d:"M12 8v8M8 12h8"})]})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:g,type:"text",value:x,onChange:S=>y(S.target.value),disabled:n,className:"w-full bg-white/10 text-lg font-bold text-white placeholder:text-gray-500 focus:outline-none focus:bg-white/20 rounded-md px-3 pr-9 py-2 transition-colors disabled:opacity-70",placeholder:"Название тренировки"}),x&&e.jsx("button",{type:"button",onClick:()=>y(""),"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:w,disabled:n,className:"shrink-0 p-1.5 rounded-full hover:bg-green-500/20 transition-colors disabled:opacity-50",title:"Сохранить",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:N,disabled:n,className:"shrink-0 p-1.5 rounded-full hover:bg-red-500/20 transition-colors disabled:opacity-50",title:"Отмена",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[T&&e.jsx("div",{className:"shrink-0 w-10 h-10 flex items-center justify-center",children:e.jsx(T.component,{size:32})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-white",children:r}),e.jsxs("p",{className:"text-md transition-all duration-300 workout-date-text",children:["Дата: ",Ee(t)]})]}),e.jsx("button",{onClick:b,className:"shrink-0 p-1.5 rounded-full hover:bg-white/10 transition-colors",title:"Редактировать название",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})})]})}),e.jsx("div",{className:"relative",ref:D,children:e.jsx("button",{ref:M,type:"button","aria-label":"Меню действий",className:"inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10",onClick:v,children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("circle",{cx:"12",cy:"5",r:"1"}),e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})})]})},St=({open:t,templates:r,isCreating:d,onClose:x,onReplaceWithTemplate:n})=>t?Re.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:x}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Выберите шаблон"}),e.jsx("button",{onClick:x,className:"px-2 py-1 text-sm text-gray-300 hover:text-white",children:"✕"})]}),r.length===0?e.jsx("p",{className:"text-gray-400",children:"Нет доступных шаблонов."}):e.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-y-auto overscroll-contain pr-1",children:r.map(o=>e.jsx("button",{onClick:()=>n(o),disabled:d,className:"w-full text-left px-4 py-2 rounded-md border border-white/20 text-gray-100 hover:bg-white/5 disabled:opacity-50",children:d?"Применение...":o.name},o.id))})]})]}),document.body):null;function Et({normalizedDate:t,exercisesLength:r,scrollKey:d,location:x}){const[n,o]=a.useState(!1),g=a.useRef(!1),b=a.useRef(0),y=a.useRef(!1),w=a.useRef(!1);return a.useEffect(()=>{y.current=!1,w.current=!1},[t,x.key]),a.useEffect(()=>{if(!t||r===0||w.current)return;const N=()=>{var V;const v=(V=x.state)==null?void 0:V.focusExerciseId;if(!v||y.current)return!1;const C=document.getElementById(`exercise-${v}`);if(!C)return!1;y.current=!0,g.current=!0;const j=document.querySelector(".header-container"),F=j?j.getBoundingClientRect().bottom:0,O=12,T=C.getBoundingClientRect(),S=Math.max(0,window.scrollY+T.top-F-O);return window.scrollTo({top:S,behavior:"smooth"}),C.animate&&C.animate([{boxShadow:"0 0 0 rgba(59,130,246,0)"},{boxShadow:"0 0 0 4px rgba(59,130,246,0.6)"},{boxShadow:"0 0 0 rgba(59,130,246,0)"}],{duration:1200,easing:"ease-in-out"}),setTimeout(()=>{g.current=!1},600),!0},D=()=>{try{const v=localStorage.getItem(d);if(v){const C=parseInt(v,10);Number.isNaN(C)||(g.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:C,behavior:"auto"}),b.current=C,setTimeout(()=>{g.current=!1},100)})}))}}catch(v){console.error("Error restoring scroll:",v)}};N()||D(),w.current=!0},[t,r,d,x.state]),a.useEffect(()=>{if(!t)return;let N=!1;const D=()=>{b.current=window.scrollY,o(window.scrollY>0),!N&&!g.current&&(window.requestAnimationFrame(()=>{try{localStorage.setItem(d,String(b.current))}catch{}N=!1}),N=!0)};return window.addEventListener("scroll",D,{passive:!0}),()=>window.removeEventListener("scroll",D)},[t,d]),a.useEffect(()=>()=>{if(t&&b.current>0)try{localStorage.setItem(d,String(b.current))}catch{}},[t,d]),{isScrolling:n}}function $e(t,r,d){const x=t.slice(),[n]=x.splice(r,1);return x.splice(d,0,n),x}const Ct=({open:t,items:r,onClose:d,onSave:x})=>{const[n,o]=a.useState([]),g=a.useRef(null),[b,y]=a.useState(!1),[w,N]=a.useState(null),D=a.useRef(0),M=a.useRef(null),v=a.useMemo(()=>r.slice().sort((c,f)=>(c.position??0)-(f.position??0)),[r]);if(a.useEffect(()=>{t&&o(v)},[t,v]),ze(t),!t)return null;const C=(c,f)=>{f<0||f>=n.length||o($=>$e($,c,f))},j=c=>f=>{g.current=c,f.dataTransfer.effectAllowed="move"},F=c=>{c.preventDefault(),c.dataTransfer.dropEffect="move"},O=c=>f=>{f.preventDefault();const $=g.current;if(g.current=null,$==null||$===c)return;const z=n.findIndex(X=>X.id===$),K=n.findIndex(X=>X.id===c);z===-1||K===-1||o(X=>$e(X,z,K))},T=c=>f=>{const $=f.touches[0];D.current=$.clientY,N(c)},S=c=>{if(!w)return;const $=c.touches[0].clientY,z=$-D.current,K=n.findIndex(Z=>Z.id===w);if(K===-1)return;const ne=Math.round(z/60);if(Math.abs(ne)>=1){const Z=K+ne;Z>=0&&Z<n.length&&Z!==K&&(o(Q=>$e(Q,K,Z)),D.current=$)}},V=()=>{N(null)},p=async()=>{y(!0);try{await x(n.map((c,f)=>({...c,position:f+1}))),d()}finally{y(!1)}};return Re.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:d}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Порядок упражнений"}),e.jsx("ol",{ref:M,className:"space-y-2 max-h-[55vh] overflow-y-auto pr-1",onTouchMove:S,onTouchEnd:V,children:n.map((c,f)=>e.jsxs("li",{draggable:!0,onDragStart:j(c.id),onDragOver:F,onDrop:O(c.id),className:`rounded-lg p-2 flex items-center gap-2 hover:bg-white/5 transition-colors ${w===c.id?"bg-white/20 scale-105":""}`,children:[e.jsxs("span",{className:"select-none w-6 text-center opacity-70",children:[f+1,"."]}),e.jsx("button",{type:"button","aria-label":"Перетащить",className:"cursor-grab px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 active:cursor-grabbing touch-none",draggable:!0,onDragStart:j(c.id),onTouchStart:T(c.id),children:"⋮⋮"}),e.jsx("div",{className:"flex-1 whitespace-normal break-words leading-snug",children:c.name||"Без названия"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>C(f,f-1),disabled:f===0,children:"↑"}),e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>C(f,f+1),disabled:f===n.length-1,children:"↓"})]})]},c.id))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:d,disabled:b,children:"Отмена"}),e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-primary",onClick:p,disabled:b,children:b?"Сохранение…":"Сохранить"})]})]})]}),document.body)},It=({open:t,value:r,onClose:d,onChange:x})=>{if(!t)return null;const n=Object.keys(Le),o=g=>{x(g),d()};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:d,children:e.jsxs("div",{className:"glass card-dark p-4 rounded-xl w-[90%] max-w-sm mx-auto",onClick:g=>g.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4 text-center",children:"Выберите иконку"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>o(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${r===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"28",height:"28",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:"Нет"})]}),n.map(g=>{const{component:b,label:y}=Le[g],w=r===g;return e.jsxs("button",{type:"button",onClick:()=>o(g),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${w?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center",children:e.jsx(b,{size:28})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:y})]},g)})]}),e.jsx("button",{type:"button",onClick:d,className:"mt-4 w-full py-2 text-gray-400 hover:text-white transition-colors",children:"Отмена"})]})})},Y=new Map,Fe=3e4,At=t=>{if(!t)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const r=new Date(t);return Number.isNaN(r.getTime())?null:ht(r)},Kt=()=>{const{date:t}=dt(),{user:r}=qe(),d=Pe(),x=ut(),n=ee,o=a.useMemo(()=>At(t),[t]),g=o?`workout-page:${o}`:"workout-page",[b,y]=ft({key:g,initialState:{workout:null,exercises:[],templates:[],loading:!0,isCreating:!1,isSelectTemplateOpen:!1,hasInitialData:!1,isAddingExercise:!1,workoutName:"",isSavingWorkoutName:!1,isCardio:!1,isSavingCardio:!1,workoutIcon:null,workoutNotes:"",isSavingNotes:!1},ttl:1800*1e3}),{workout:w,exercises:N,templates:D,loading:M,isCreating:v,isSelectTemplateOpen:C,hasInitialData:j,isAddingExercise:F,workoutName:O,isSavingWorkoutName:T,isCardio:S,isSavingCardio:V,workoutIcon:p,workoutNotes:c,isSavingNotes:f}=b,{isActionsOpen:$,menuPos:z,actionsRef:K,actionsBtnRef:X,toggleActions:ne,closeActions:Z}=gt(),Q=s=>y(i=>({...i,workout:s,workoutName:(s==null?void 0:s.name)??"",isSavingWorkoutName:!1,isCardio:(s==null?void 0:s.is_cardio)??!1,isSavingCardio:!1,workoutIcon:(s==null?void 0:s.icon)??null,workoutNotes:(s==null?void 0:s.notes)??"",isSavingNotes:!1})),te=s=>y(i=>({...i,exercises:typeof s=="function"?s(i.exercises):s})),h=s=>y(i=>({...i,templates:typeof s=="function"?s(i.templates):s})),k=s=>y(i=>({...i,loading:s})),q=s=>y(i=>({...i,isCreating:s})),u=s=>y(i=>({...i,isSelectTemplateOpen:s})),l=s=>y(i=>({...i,hasInitialData:s})),A=s=>y(i=>({...i,isAddingExercise:s})),P=s=>y(i=>({...i,workoutName:s})),se=s=>y(i=>({...i,isSavingWorkoutName:s})),ie=s=>y(i=>({...i,isCardio:s})),pe=s=>y(i=>({...i,isSavingCardio:s})),ve=s=>y(i=>({...i,workoutNotes:s})),we=s=>y(i=>({...i,isSavingNotes:s})),[Ce,xe]=a.useState(!1),[le,de]=a.useState(!1),[je,ue]=a.useState(O),[ae,me]=a.useState(p),ce=a.useRef(null),[_e,R]=a.useState(!1),[fe,J]=a.useState(!1),he=`scroll:workout:${o??""}`,{isScrolling:ge}=Et({normalizedDate:o,exercisesLength:N.length,scrollKey:he,location:x});ze(C);const re=a.useCallback(async(s=!1,i=!1)=>{if(!r||!o){Q(null),te([]),k(!1),l(!0);return}const _=`${r.id}:${o}`,m=Date.now();if(Y.has(_)){const W=Y.get(_),H=m-W.timestamp;if(s&&H<Fe){j||(Q(W.workout),te(W.exercises),k(!1),l(!0));return}H>=Fe&&(j||(Q(W.workout),te(W.exercises),l(!0)),i=!0)}i||k(!0);const{data:E,error:B}=await n.from("workouts").select("*").eq("user_id",r.id).eq("workout_date",o).order("created_at",{ascending:!1}).limit(1);let I=(E==null?void 0:E[0])??null;if(B)console.error("Error fetching workout:",B);else if(I){if(I.template_id&&!I.icon)try{const{data:L}=await n.from("workout_templates").select("icon").eq("id",I.template_id).single();L!=null&&L.icon&&(I={...I,icon:L.icon},n.from("workouts").update({icon:L.icon}).eq("id",I.id).then(()=>{},()=>{}))}catch{}Q(I);const{data:W,error:H}=await n.from("workout_exercises").select("id, name, sets, reps, rest_seconds, position, workout_id, workout_sets ( id, workout_exercise_id, set_index, weight, reps, is_done, updated_at )").eq("workout_id",I.id).order("position");if(H)console.error("Error fetching exercises:",H);else{const L=W||[];L.forEach(oe=>{oe.workout_sets&&oe.workout_sets.sort((be,Se)=>be.set_index-Se.set_index)}),te(L),Y.set(_,{workout:I,exercises:L,timestamp:m})}}else Q(null),te([]),Y.set(_,{workout:null,exercises:[],timestamp:m});const U=r?`templates-cache:${r.id}`:void 0;if(U)try{const W=localStorage.getItem(U);if(W){const H=JSON.parse(W);H.data&&h(H.data)}}catch{}n.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).then(({data:W,error:H})=>{if(H)console.error("Error fetching templates:",H.message);else if(h(W||[]),U)try{localStorage.setItem(U,JSON.stringify({ts:Date.now(),data:W}))}catch{}}),k(!1),l(!0)},[r,o,j]);a.useEffect(()=>{re()},[re]),a.useEffect(()=>{const s=()=>{document.visibilityState==="visible"&&re(!0)};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[re]),a.useEffect(()=>{o&&(localStorage.setItem("lastWorkoutPath",`/workout/${o}`),localStorage.setItem("lastWorkoutTimestamp",Date.now().toString()))},[o]),a.useEffect(()=>{le&&ce.current&&(ce.current.focus(),ce.current.select())},[le]);const Ye=a.useCallback(s=>{y(i=>{const _=i.exercises.map(m=>m.id===s.id?s:m);if(r&&o&&i.workout){const m=`${r.id}:${o}`;Y.set(m,{workout:i.workout,exercises:_,timestamp:Date.now()})}return{...i,exercises:_}})},[r,o]),Je=a.useCallback(s=>{y(i=>{const _=i.exercises.filter(m=>m.id!==s);if(r&&o&&i.workout){const m=`${r.id}:${o}`;Y.set(m,{workout:i.workout,exercises:_,timestamp:Date.now()})}return{...i,exercises:_}})},[r,o]),Ve=async()=>{if(!(!r||!o||!w||F)){A(!0);try{const s=N.length>0?Math.max(...N.map(W=>typeof W.position=="number"?W.position:0))+1:1,{data:i,error:_}=await n.from("workout_exercises").insert({workout_id:w.id,name:"",sets:1,reps:"",rest_seconds:150,position:s}).select("id, name, sets, reps, rest_seconds, position, workout_id");if(_)throw _;const m=i==null?void 0:i[0];if(!m)throw new Error("Не удалось создать упражнение");const{data:E,error:B}=await n.from("workout_sets").insert({workout_exercise_id:m.id,set_index:1,weight:null,reps:null,is_done:!1,updated_at:new Date().toISOString()}).select("id, workout_exercise_id, set_index, weight, reps, is_done, updated_at");if(B)throw B;const I=E==null?void 0:E[0];if(!I)throw new Error("Не удалось создать подход");const U={...m,workout_sets:[I]};y(W=>{if(!W.workout)return W;const H=[...W.exercises,U].sort((L,oe)=>L.position-oe.position);if(r&&o){const L=`${r.id}:${o}`,oe=Y.get(L);oe&&Y.set(L,{workout:oe.workout,exercises:H,timestamp:Date.now()})}return{...W,exercises:H}})}catch(s){console.error("Failed to add exercise:",s),alert("Не удалось добавить упражнение. Попробуйте снова.")}finally{A(!1)}}},Xe=async()=>{if(!(!r||!o)){q(!0);try{const{data:s,error:i}=await n.from("workouts").insert({user_id:r.id,workout_date:o,name:"Новая тренировка",template_id:null}).select().single();if(i)throw i;if(!s)throw new Error("Не удалось создать тренировку");Q(s),te([]),P(s.name);const _=`${r.id}:${o}`;Y.set(_,{workout:s,exercises:[],timestamp:Date.now()})}catch(s){console.error("Failed to create custom workout:",s),alert("Не удалось создать тренировку. Попробуйте снова.")}finally{q(!1)}}},Qe=async s=>{if(!(!r||!o)){q(!0);try{const[{data:i},{data:_}]=await Promise.all([n.from("template_exercises").select("*").eq("template_id",s.id),n.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]),m=(_==null?void 0:_.icon)??s.icon??null,E=(_==null?void 0:_.name)??s.name,{data:B}=await n.from("workouts").insert({user_id:r.id,workout_date:o,name:E,template_id:s.id,icon:m}).select().single();if(!B)throw new Error("Failed to create workout entry.");const I=(i||[]).map(L=>({workout_id:B.id,name:L.name,sets:L.sets,reps:L.reps,rest_seconds:L.rest_seconds,position:L.position})),{data:U}=await n.from("workout_exercises").insert(I).select();if(!U)throw new Error("Failed to create workout exercises.");const W=U.flatMap(L=>Array.from({length:L.sets},(oe,be)=>({workout_exercise_id:L.id,set_index:be+1})));await n.from("workout_sets").insert(W);const H=`${r.id}:${o}`;Y.delete(H),await re()}catch(i){console.error("Failed to create workout from template:",i),alert(`Не удалось создать тренировку: ${i.message}`)}finally{q(!1)}}},Ge=()=>{ue(O),me(p),de(!0)},Ze=async()=>{if(!r||!o||!w)return;const s=je.trim();if(s.length===0){ue(O),me(p),de(!1);return}const i=s!==w.name,_=ae!==w.icon;if(!i&&!_){de(!1);return}se(!0);try{const m={};i&&(m.name=s),_&&(m.icon=ae);const{data:E,error:B}=await n.from("workouts").update(m).eq("id",w.id).select().single();if(B)throw B;if(!E)throw new Error("Не удалось обновить тренировку");Q(E),ue(s),me(E.icon),de(!1);const I=`${r.id}:${o}`;Y.set(I,{workout:E,exercises:N,timestamp:Date.now()})}catch(m){console.error("Failed to update workout:",m),alert("Не удалось сохранить изменения. Попробуйте снова.")}finally{se(!1)}},Ue=()=>{ue(O),me(p),de(!1)},et=()=>{J(!0)},tt=s=>{me(s)},We=async()=>{if(!r||!o||!w)return;const s=!S;ie(s),pe(!0);try{const{data:i,error:_}=await n.from("workouts").update({is_cardio:s}).eq("id",w.id).select().single();if(_)throw _;if(!i)throw new Error("Не удалось обновить статус кардио");Q(i);const m=`${r.id}:${o}`;Y.set(m,{workout:i,exercises:N,timestamp:Date.now()})}catch(i){console.error("Failed to update cardio status:",i),alert("Не удалось сохранить статус кардио."),ie(!s)}finally{pe(!1)}},Ne=ye(c,800),st=a.useRef(c);a.useEffect(()=>{st.current=c},[c]),a.useEffect(()=>{if(!r||!o||!w||Ne===(w.notes??""))return;(async()=>{we(!0);try{const{error:i}=await n.from("workouts").update({notes:Ne||null}).eq("id",w.id);if(i)throw i;const _=`${r.id}:${o}`,m=Y.get(_);m&&m.workout&&Y.set(_,{...m,workout:{...m.workout,notes:Ne||null},timestamp:Date.now()})}catch(i){console.error("Failed to save notes:",i)}finally{we(!1)}})()},[Ne,r,o,w==null?void 0:w.id]);const rt=()=>{w&&xe(!0)},nt=async s=>{if(!r||!w)return;const i=new Map(s.map((m,E)=>[m.id,E+1]));te(m=>{const E=m.map(B=>({...B,position:i.get(B.id)??B.position}));return E.sort((B,I)=>(B.position??0)-(I.position??0)),E});const _=s.map((m,E)=>({id:m.id,position:E+1}));try{if(await Promise.all(_.map(async m=>{const{error:E}=await n.from("workout_exercises").update({position:m.position}).eq("id",m.id);if(E)throw E})),r&&o){const m=`${r.id}:${o}`,E=Y.get(m);if(E){const B=[...E.exercises].map(I=>({...I,position:i.get(I.id)??I.position})).sort((I,U)=>(I.position??0)-(U.position??0));Y.set(m,{workout:E.workout,exercises:B,timestamp:Date.now()})}}}catch(m){console.error("Failed to save new order:",m),alert("Не удалось сохранить порядок. Я вернул предыдущие данные."),await re()}},ot=async()=>{if(!w)return;const{error:s}=await n.from("workouts").delete().eq("id",w.id);if(s){console.error("Error deleting workout:",s),alert("Не удалось удалить тренировку.");return}if(r&&o){const i=`${r.id}:${o}`;Y.delete(i)}d("/calendar",{state:{removedDate:o}})},it=()=>{u(!0)},at=async s=>{if(!(!r||!o||!w))try{q(!0);const[{data:i,error:_},{data:m,error:E}]=await Promise.all([n.from("template_exercises").select("*").eq("template_id",s.id),n.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]);if(_)throw _;if(E)throw E;const{data:B,error:I}=await n.from("workout_exercises").select("id").eq("workout_id",w.id);if(I)throw I;const U=(B||[]).map(G=>G.id);if(U.length>0){const{error:G}=await n.from("workout_sets").delete().in("workout_exercise_id",U);if(G)throw G;const{error:Ie}=await n.from("workout_exercises").delete().eq("workout_id",w.id);if(Ie)throw Ie}const W=(m==null?void 0:m.icon)??s.icon??null,H=(m==null?void 0:m.name)??s.name,{error:L}=await n.from("workouts").update({name:H,template_id:s.id,icon:W}).eq("id",w.id);if(L)throw L;const oe=(i||[]).map(G=>({workout_id:w.id,name:G.name,sets:G.sets,reps:G.reps,rest_seconds:G.rest_seconds,position:G.position})),{data:be,error:Se}=await n.from("workout_exercises").insert(oe).select();if(Se)throw Se;const Te=(be||[]).flatMap(G=>Array.from({length:G.sets},(Ie,lt)=>({workout_exercise_id:G.id,set_index:lt+1})));if(Te.length>0){const{error:G}=await n.from("workout_sets").insert(Te);if(G)throw G}const ct=`${r.id}:${o}`;Y.delete(ct),u(!1),await re()}catch(i){console.error("Failed to replace workout from template:",i),alert(`Не удалось изменить тренировку: ${i.message}`)}finally{q(!1)}};return j?o?w?e.jsxs("div",{className:"relative px-4 space-y-4 pt-4 pb-10",children:[M&&e.jsx(Ae,{message:"Загрузка тренировки..."}),e.jsx("div",{className:`status-bar-blur ${ge?"visible":""}`}),e.jsx(Nt,{normalizedDate:o,workoutName:O,isEditingName:le,editNameValue:je,isSavingWorkoutName:T,isScrolling:ge,inputRef:ce,onStartEditName:Ge,onChangeEditName:ue,onSaveEditName:Ze,onCancelEditName:Ue,actionsRef:K,actionsBtnRef:X,onToggleActions:ne,workoutIcon:p,editIconValue:ae,onOpenIconPicker:et}),e.jsx("div",{className:"space-y-4",children:N.map(s=>e.jsx(_t,{exercise:s,workoutDate:o,onUpdateExercise:Ye,onDeleteExercise:Je},s.id))}),e.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[e.jsx("p",{className:"text-white text-lg font-bold mb-3 text-center",children:"Было кардио?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>{S&&(ie(!1),We())},disabled:V,className:`flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 ease-out ${S?"bg-red-500/20 text-red-300 hover:bg-red-500/30 scale-95":"bg-red-500/80 text-white shadow-lg scale-100"} disabled:opacity-50`,children:"Нет"}),e.jsx("button",{onClick:()=>{S||(ie(!0),We())},disabled:V,className:`flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-200 ease-out ${S?"bg-green-500/80 text-white shadow-lg scale-100":"bg-green-500/20 text-green-300 hover:bg-green-500/30 scale-95"} disabled:opacity-50`,children:"Да"})]})]}),e.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-white text-lg font-bold",children:"Заметки"}),f&&e.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[e.jsx("span",{className:"w-3 h-3 border border-white/30 border-t-white rounded-full animate-spin"}),"Сохранение..."]})]}),e.jsx("textarea",{value:c,onChange:s=>ve(s.target.value),placeholder:"Как себя чувствовали, что получилось, над чем надо поработать",rows:5,className:"w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-400 text-sm resize-none focus:outline-none focus:ring-1 focus:ring-blue-500/50 focus:border-blue-500/50 transition-colors"})]}),e.jsx("div",{children:e.jsx("button",{type:"button",onClick:Ve,disabled:F,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary disabled:opacity-50",children:F?"Добавление...":"Добавить упражнение"})}),e.jsx(St,{open:C,templates:D,isCreating:v,onClose:()=>u(!1),onReplaceWithTemplate:at}),e.jsx(Ct,{open:_e,onClose:()=>R(!1),items:N.map(s=>({id:s.id,name:s.name,position:s.position??0})),onSave:nt}),e.jsx(Ke,{open:Ce,onOpenChange:xe,title:"Удалить тренировку?",description:`Вы собираетесь удалить тренировку на ${Ee(o)}. Действие необратимо.`,confirmText:"Удалить",cancelText:"Отмена",variant:"danger",onConfirm:ot}),e.jsx(It,{open:fe,value:ae,onClose:()=>J(!1),onChange:tt}),$&&z&&Re.createPortal(e.jsxs("div",{className:"fixed menu-popover",style:{top:z.top,left:z.left,width:192},role:"menu",children:[e.jsx("button",{onClick:()=>{Z(),R(!0)},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Поменять порядок упражнений"}),e.jsx("button",{onClick:()=>{Z(),it()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Изменить тренировку"}),e.jsx("button",{onClick:()=>{Z(),rt()},className:"w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors rounded-lg",children:"Удалить"})]}),document.body)]}):v?e.jsx("div",{className:"px-4 pt-4",children:e.jsx(Ae,{message:"Создание..."})}):e.jsxs("div",{className:"max-w-lg mx-auto px-4 pt-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(He,{normalizedDate:o}),e.jsxs("h1",{className:"flex-1 text-xl font-bold text-center",children:["Тренировка на ",Ee(o)]})]}),e.jsxs("div",{className:"mt-4 p-6 text-center",children:[D.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Выбрать шаблон"}),e.jsx("div",{className:"space-y-2",children:D.map(s=>e.jsx("button",{onClick:()=>Qe(s),disabled:v,className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md disabled:opacity-50",children:s.name},s.id))})]}):e.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[e.jsx("p",{className:"text-gray-400",children:"Сначала создайте шаблон."}),e.jsxs(mt,{to:"/templates/new",className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Создать шаблон"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"button",onClick:Xe,disabled:v,className:"btn-dashed",children:"Создать свой день"})})]})]}):null:e.jsx(Ae,{message:"Загрузка тренировки..."})};export{Kt as default};
