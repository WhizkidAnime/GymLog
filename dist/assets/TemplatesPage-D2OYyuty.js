import{u as M,a as q,s as c,j as e,W as I}from"./index-DnqATjGw.js";import{d as P,r as i,e as b,L as O,b as R}from"./vendor-CITejod9.js";import{u as F}from"./usePageState-Qdkxdikz.js";import{C as $}from"./confirm-dialog-BRILMb2I.js";import{g as H}from"./template-sharing-op9gnb2q.js";import{T as K}from"./template-saved-dialog-2mDPnmd-.js";import{u as Z}from"./use-workout-actions-menu-D8nZy4RT.js";import{W as D}from"./workout-icons-D3MsLGOF.js";import"./supabase-vtL5VWMt.js";import"./charts-D-QCyllA.js";import"./use-modal-scroll-lock-CmZrgGCz.js";const G="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='512'%20height='512'%20viewBox='0%200%2024%2024'%3e%3cpath%20fill='%23ffffff'%20d='M21%2014a1%201%200%200%200-1%201v4a1%201%200%200%201-1%201H5a1%201%200%200%201-1-1v-4a1%201%200%200%200-2%200v4a3%203%200%200%200%203%203h14a3%203%200%200%200%203-3v-4a1%201%200%200%200-1-1Zm-9.71%201.71a1%201%200%200%200%20.33.21a.94.94%200%200%200%20.76%200a1%201%200%200%200%20.33-.21l4-4a1%201%200%200%200-1.42-1.42L13%2012.59V3a1%201%200%200%200-2%200v9.59l-2.29-2.3a1%201%200%201%200-1.42%201.42Z'/%3e%3c/svg%3e",U="/GymLog/assets/archive-BrLSszgK.svg",V=({id:l,name:S,onDeleted:r,onArchived:_,onShare:w})=>{const{t:n}=q(),[m,y]=b.useState(!1),[d,p]=b.useState(!1),[T,x]=b.useState(!1),{isActionsOpen:j,menuPos:g,actionsRef:E,actionsBtnRef:v,toggleActions:h,closeActions:u}=Z(),L=()=>{u(),w(l,S)},k=()=>{u(),x(!0)},A=async()=>{if(!d){u(),p(!0);try{const{error:o}=await c.from("workout_templates").update({is_archived:!0}).eq("id",l);if(o)throw o;_(l)}catch(o){console.error("Error archiving template",o),alert(n.templates.archiveError)}finally{p(!1)}}},f=async()=>{if(!m){y(!0);try{const{error:o}=await c.from("template_exercises").delete().eq("template_id",l);if(o)throw o;const{error:N}=await c.from("workout_templates").delete().eq("id",l);if(N)throw N;r(l),x(!1)}catch(o){console.error("Error deleting template",o),alert(n.templates.deleteError)}finally{y(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{ref:v,onClick:h,className:"p-2 text-white hover:text-gray-300 transition-colors","aria-label":n.templates.menuLabel,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 8c1.1 0 2-1 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 1-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 1-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})})}),j&&g&&R.createPortal(e.jsxs("div",{ref:E,className:"fixed menu-popover space-y-0.5",style:{top:g.top,left:g.left,width:192},role:"menu",children:[e.jsx("button",{onClick:L,className:"w-full text-left px-4 py-2 text-sm text-gray-100 hover:bg-white/10 transition-colors rounded-lg",children:n.templates.share}),e.jsx("button",{onClick:A,disabled:d,className:"w-full text-left px-4 py-2 text-sm text-gray-100 hover:bg-white/10 disabled:opacity-50 transition-colors rounded-lg",children:d?n.templates.archiving:n.templates.addToArchive}),e.jsx("button",{onClick:k,disabled:m,className:"w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 disabled:opacity-50 transition-colors rounded-lg",children:m?n.templates.deleting:n.templates.delete})]}),document.body)]}),e.jsx($,{open:T,onOpenChange:x,title:n.templates.deleteConfirm,description:n.templates.deleteConfirmDesc,confirmText:n.common.delete,cancelText:n.common.cancel,variant:"danger",onConfirm:f})]})},oe=()=>{const{user:l}=M(),S=P(),{t:r}=q(),[_,w]=i.useState(!1),[n,m]=i.useState(null),[y,d]=i.useState(!1),[p,T]=i.useState(null),[x,j]=i.useState(!1),[g,E]=i.useState(null),[v,h]=F({key:"templates-page",initialState:{templates:[],loading:!0},ttl:1800*1e3}),{templates:u,loading:L}=v,k=t=>{h(a=>({...a,templates:t,loading:!1}))},A=t=>{h(a=>({...a,loading:t}))},f=b.useCallback(async()=>{if(!l)return;v.templates.length>0||A(!0);const{data:a,error:s}=await c.from("workout_templates").select("id, name, created_at, user_id, icon, is_archived").eq("user_id",l.id).eq("is_archived",!1).order("created_at",{ascending:!1});s?console.error("Error fetching templates:",s):k(a||[])},[l,v.templates.length]),o=t=>{h(a=>({...a,templates:a.templates.filter(s=>s.id!==t)})),f()},N=t=>{h(a=>({...a,templates:a.templates.filter(s=>s.id!==t)})),f()},z=async t=>{var a;try{if((a=navigator.clipboard)!=null&&a.writeText)return await navigator.clipboard.writeText(t),{ok:!0}}catch(s){console.warn("clipboard writeText failed:",s)}try{const s=document.createElement("textarea");s.value=t,s.setAttribute("readonly",""),s.style.position="absolute",s.style.left="-9999px",document.body.appendChild(s),s.select();const C=document.execCommand("copy");return document.body.removeChild(s),C?{ok:!0}:{ok:!1,reason:"execCommand returned false"}}catch(s){return{ok:!1,reason:String(s)}}},B=async(t,a)=>{w(!0);try{const{data:s,error:C}=await c.from("template_exercises").select("name, sets, reps, rest_seconds, position").eq("template_id",t).order("position");if(C)throw C;if(!s||s.length===0){alert(r.templates.emptyTemplateError);return}const W=await H({name:a,exercises:s});T(W),d(!0),E(a)}catch(s){console.error("Error sharing template:",s),alert(r.templates.shareError+((s==null?void 0:s.message)||String(s)))}finally{w(!1)}};return i.useEffect(()=>{f()},[l,f]),i.useEffect(()=>{const t=c.channel("workout_templates_changes").on("postgres_changes",{event:"*",schema:"public",table:"workout_templates",filter:l?`user_id=eq.${l.id}`:void 0},()=>{(async()=>{if(!l)return;const{data:a}=await c.from("workout_templates").select("id, name, created_at, user_id, icon, is_archived").eq("user_id",l.id).eq("is_archived",!1).order("created_at",{ascending:!1});k(a||[])})()}).subscribe();return()=>{c.removeChannel(t)}},[l]),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"flex items-end justify-between mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold",children:r.templates.title}),e.jsx(O,{to:"/templates/archive",className:"archive-icon-link px-2 pt-2 pb-[5px] transition-colors","aria-label":r.templates.archive,title:r.templates.archive,children:e.jsx("img",{src:U,alt:"",className:"archive-icon-img h-6 w-6"})})]}),n&&e.jsx(K,{open:!!n,onOpenChange:m,templateName:n}),L?e.jsx(I,{message:r.templates.loading}):u.length===0?e.jsx("div",{className:"mt-4 p-8 text-center glass",children:e.jsx("p",{className:"text-gray-500",children:r.templates.empty})}):e.jsx("div",{className:"space-y-3",children:u.map(t=>e.jsxs("div",{className:"relative p-4 glass card-dark flex items-center justify-between gap-3",children:[e.jsxs("button",{onClick:()=>window.location.hash=`#/templates/${t.id}`,className:"text-left flex-1 hover:opacity-90 flex items-center gap-3",children:[t.icon&&D[t.icon]&&e.jsx("div",{style:{color:D[t.icon].color},children:b.createElement(D[t.icon].component,{size:24})}),e.jsx("h2",{className:"font-semibold text-lg text-gray-100",children:t.name})]}),e.jsx(V,{id:t.id,name:t.name,onDeleted:o,onArchived:N,onShare:B})]},t.id))}),e.jsxs("div",{className:"fixed left-0 right-0 bottom-[calc(env(safe-area-inset-bottom)+5.75rem)] z-30 flex justify-center gap-3",children:[e.jsx(O,{to:"/templates/new",className:"glass-button-create",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4v16m8-8H4"})})}),e.jsx("button",{onClick:()=>S("/templates/import"),className:"glass-button-create",title:r.templates.importTemplate,children:e.jsx("img",{src:G,alt:r.templates.importTemplate,className:"h-5 w-5"})})]}),_&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:e.jsx("div",{className:"glass card-dark p-6 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white",children:r.templates.generatingLink})]})})}),y&&p&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:e.jsxs("div",{className:"glass card-dark p-6 rounded-xl max-w-lg w-[92%] max-h-[85vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:r.templates.shareTitle}),e.jsx("textarea",{readOnly:!0,value:p,rows:3,onFocus:t=>t.currentTarget.select(),className:"mb-4 w-full resize-none bg-black/30 text-gray-100 rounded-md p-3 font-mono text-xs leading-relaxed break-all max-h-[40vh] overflow-y-auto"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx("button",{onClick:async()=>{if(!p)return;j(!0);const t=await z(p);j(!1),t.ok?(m(`${g}`),setTimeout(()=>m(null),2e3),d(!1)):alert(r.templates.copyError+`

Error: `+t.reason)},className:"glass-button-create",children:x?r.common.copying:r.common.copy}),e.jsx("button",{onClick:()=>d(!1),className:"glass-button-danger",children:r.common.close})]})]})})]})};export{oe as default};
