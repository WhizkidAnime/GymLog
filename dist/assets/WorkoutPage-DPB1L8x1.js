import{a as ie,j as t,s as V,u as Be,W as Fe,g as te}from"./index-CnYkLsFa.js";import{f as ye,r as o,e as qe,c as We,L as Je,j as Ye,u as Ge}from"./vendor-BVca5W6X.js";import{u as fe}from"./useDebounce-C2cqH541.js";import{C as Ke}from"./confirm-dialog-3P8s-Dms.js";import{c as Ee,f as Ue}from"./date-helpers-C_0boXDq.js";import{n as Re,p as Xe}from"./exercise-name-BJxyXXn3.js";import{W as De}from"./workout-icons-D1jTU-WH.js";import{u as He}from"./use-modal-scroll-lock-DlG-D3y9.js";import{u as Qe}from"./use-workout-actions-menu-C-5wTXkz.js";import{u as Ze}from"./usePageState-6XNG0ilq.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const Pe=({set:e,previousSet:s,onChange:r,onAddDropset:c,onDeleteDropset:i,isLastInGroup:d})=>{const{t:m}=ie(),u=`workout_set_draft:${e.id}`,k=`workout_set_last_non_max_reps:${e.id}`,v=l=>l==null?"":String(l).replace(".",","),y=l=>{if(l==="")return null;const w=Number(l.replace(",","."));return Number.isFinite(w)?w:null},C=l=>{let w=l.replace(".",",");w=w.replace(/[^\d,]/g,"");const f=w.indexOf(",");return f!==-1&&(w=w.slice(0,f+1)+w.slice(f+1).replace(/,/g,"")),w},A=m.common.max,j=l=>l==null?"":l==="0"?A:l,p=l=>{const w=l.trim();if(w==="")return null;const f=w.toLowerCase();return f==="макс"||f==="макс."||f==="max"||f==="max."||/^0+$/.test(w)?"0":w},L=l=>{const w=l.trim();if(w==="")return"";if(/^0+$/.test(w))return A;const f=w.toLowerCase();return f.startsWith("макс")||f.startsWith("max")?A:w.replace(/[^0-9]/g,"")},D=j(e.reps),[$,R]=o.useState(v(e.weight)),[M,O]=o.useState(D),[q,S]=o.useState(p(D)==="0"?null:D||null),[n,a]=o.useState(e.is_done),[b,x]=o.useState(!1),[_,E]=o.useState(()=>p(D)==="0"),I=fe($,500),B=fe(M,500),z=!(e.is_dropset??!1)&&!!s&&s.is_done&&s.weight!==null&&y($)===null,H=l=>{S(l);try{l&&l.trim()!==""?localStorage.setItem(k,l):localStorage.removeItem(k)}catch{}};o.useEffect(()=>{try{const l=localStorage.getItem(u);if(!l)return;const w=JSON.parse(l),f=new Date(e.updated_at).getTime();if(w.updatedAt>f){R(w.weight===""?"":v(w.weight));const N=j(w.reps);O(N);const K=p(N)==="0"?null:N||null;H(K),a(w.isDone)}}catch{}},[]),o.useEffect(()=>{a(e.is_done)},[e.is_done]),o.useEffect(()=>{if(e.reps==="0")try{const l=localStorage.getItem(k);l&&l.trim()!==""&&S(l)}catch{}},[e.reps,k]);const Q=ye.useRef(r);o.useEffect(()=>{Q.current=r},[r]),o.useEffect(()=>{(async()=>{var N;const w=y(I),f=p(B);if(w!==(e.weight??null)||f!==(e.reps??null)||n!==e.is_done){const K={weight:w===null?"":w,reps:f,isDone:n,updatedAt:Date.now()};try{localStorage.setItem(u,JSON.stringify(K))}catch{}x(!0);const{error:F}=await V.from("workout_sets").update({weight:w,reps:f,is_done:n,updated_at:new Date().toISOString()}).eq("id",e.id);if(F)console.error("Error saving set:",F);else{try{localStorage.removeItem(u)}catch{}const W={...e,weight:w,reps:f,is_done:n,updated_at:new Date().toISOString()};(N=Q.current)==null||N.call(Q,W)}setTimeout(()=>x(!1),500)}})()},[I,B,e.id,e.weight,e.reps,e.is_done,n,u]),o.useEffect(()=>{const l=y(I)!==null,w=p(B)!==null,f=l&&w;f&&!n?a(!0):!f&&n&&a(!1)},[I,B,n]);const ne=n?"bg-green-500":"bg-transparent",oe=n?"text-black":"text-inherit",ae=n?"setrow-input-done-white":"",re=p(M)==="0",g=_||re,T=()=>{const l=p(M),w=l!==null&&l!=="0";if(g)re&&(q!==null&&q.trim()!==""?O(q):O("")),E(!1);else{if(w){E(!0);return}p(M)!=="0"&&M.trim()!==""&&H(M),O(A),E(!0)}},U=e.is_dropset??!1,h=n?U?U&&n?"bg-purple-500/80":"":ne:U?"bg-purple-500/10 border-l-2 border-purple-500/50 ml-3":"";return t.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${h||ne}`,children:[t.jsxs("div",{className:`col-span-1 text-center font-medium ${oe} flex items-center justify-center`,children:[U&&t.jsx("span",{className:`text-xs mr-0.5 dropset-indicator ${n?"is-done":""}`,children:"↳"}),t.jsx("span",{children:U?m.setRow.dropset:e.set_index}),!U&&d&&c&&t.jsx("button",{type:"button",onClick:()=>c(e.id),"aria-label":m.setRow.addDropset,className:`absolute left-12 w-5 h-5 flex items-center justify-center rounded transition-colors flex-shrink-0 dropset-btn ${n?"is-done hover:bg-black/10":"hover:bg-white/10"}`,title:m.setRow.addDropset,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4",children:t.jsx("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})})})]}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:$,onChange:l=>R(C(l.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${ae} ${oe}`})}),z&&t.jsx("button",{type:"button",onClick:()=>{!s||s.weight===null||R(v(s.weight))},"aria-label":m.setRow.copyWeight,className:"btn-glass btn-glass-icon-round btn-glass-secondary absolute text-white h-6 w-6 p-0",style:{left:"50%",top:"50%",transform:"translate(-50%, -50%)",transition:"none",width:"1.5rem",height:"1.5rem",minWidth:"1.5rem",minHeight:"1.5rem",padding:0},children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"12",height:"12",fill:"none",stroke:"currentColor",strokeWidth:"2.2",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"5 15 12 8 19 15"})})}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:M,onChange:l=>{const w=L(l.target.value);if(O(w),p(w)!=="0"){const f=w.trim()===""?null:w;H(f)}},className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${ae} ${oe}`})}),t.jsxs("div",{className:"col-span-1 flex items-center justify-center",children:[!U&&t.jsx("input",{type:"checkbox",checked:g,onChange:T,"aria-label":m.setRow.toFailure,className:"h-6 w-6 rounded-md border border-gray-300 bg-white outline-none focus-visible:outline-none flex-shrink-0",style:{accentColor:"#000000",color:"#0a0a0a"}}),U&&t.jsxs("div",{className:"flex items-center justify-end gap-1 w-14",children:[d&&c?t.jsx("button",{type:"button",onClick:()=>c(e.id),"aria-label":m.setRow.addDropset,className:`w-6 h-6 flex items-center justify-center rounded transition-colors flex-shrink-0 font-bold dropset-btn ${n?"is-done hover:bg-black/10":"hover:bg-white/20"}`,title:m.setRow.addDropset,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:t.jsx("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})})}):t.jsx("div",{className:"w-6 h-6 flex-shrink-0"}),i&&t.jsx("button",{type:"button",onClick:()=>i(e.id),"aria-label":m.setRow.deleteDropset,className:`w-6 h-6 flex items-center justify-center rounded transition-colors flex-shrink-0 font-bold dropset-btn ${n?"is-done hover:bg-black/10":"hover:bg-white/20"}`,title:m.setRow.deleteDropset,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:t.jsx("path",{fillRule:"evenodd",d:"M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z",clipRule:"evenodd"})})})]})]}),b&&t.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},ze=ye.memo(Pe,(e,s)=>{var r,c,i,d;return e.set.id===s.set.id&&e.set.weight===s.set.weight&&e.set.reps===s.set.reps&&e.set.is_done===s.set.is_done&&e.set.set_index===s.set.set_index&&e.set.updated_at===s.set.updated_at&&e.set.is_dropset===s.set.is_dropset&&e.set.parent_set_index===s.set.parent_set_index&&((r=e.previousSet)==null?void 0:r.weight)===((c=s.previousSet)==null?void 0:c.weight)&&((i=e.previousSet)==null?void 0:i.is_done)===((d=s.previousSet)==null?void 0:d.is_done)&&e.isLastInGroup===s.isLastInGroup&&e.onAddDropset===s.onAddDropset&&e.onDeleteDropset===s.onDeleteDropset}),et=({set:e,displayIndex:s,onChange:r,onDelete:c})=>{const i=`workout_set_draft:${e.id}`,d=n=>n==null?"":String(n).replace(".",","),m=n=>{if(n==="")return null;const a=Number(n.replace(",","."));return Number.isFinite(a)?a:null},u=n=>{let a=n.replace(".",",");a=a.replace(/[^\d,]/g,"");const b=a.indexOf(",");return b!==-1&&(a=a.slice(0,b+1)+a.slice(b+1).replace(/,/g,"")),a},k=n=>{const a=n.trim();return a===""?"":a.replace(/[^0-9]/g,"")},[v,y]=o.useState(d(e.weight)),[C,A]=o.useState(e.reps??""),[j,p]=o.useState(e.is_done),[L,D]=o.useState(!1),$=fe(v,500),R=fe(C,500);o.useEffect(()=>{try{const n=localStorage.getItem(i);if(!n)return;const a=JSON.parse(n),b=new Date(e.updated_at).getTime();a.updatedAt>b&&(y(a.weight===""?"":d(a.weight)),A(a.reps??""),p(a.isDone))}catch{}},[]),o.useEffect(()=>{p(e.is_done)},[e.is_done]);const M=ye.useRef(r);o.useEffect(()=>{M.current=r},[r]),o.useEffect(()=>{(async()=>{var x;const a=m($),b=R.trim()===""?null:R.trim();if(a!==(e.weight??null)||b!==(e.reps??null)||j!==e.is_done){const _={weight:a===null?"":a,reps:b,isDone:j,updatedAt:Date.now()};try{localStorage.setItem(i,JSON.stringify(_))}catch{}D(!0);const{error:E}=await V.from("workout_sets").update({weight:a,reps:b,is_done:j,updated_at:new Date().toISOString()}).eq("id",e.id);if(E)console.error("Error saving warmup set:",E);else{try{localStorage.removeItem(i)}catch{}const I={...e,weight:a,reps:b,is_done:j,updated_at:new Date().toISOString()};(x=M.current)==null||x.call(M,I)}setTimeout(()=>D(!1),500)}})()},[$,R,e.id,e.weight,e.reps,e.is_done,j,i]),o.useEffect(()=>{const n=m($)!==null,a=R.trim()!=="",b=n&&a;b&&!j?p(!0):!b&&j&&p(!1)},[$,R,j]);const O=j?"bg-sky-400/80":"bg-transparent",q=j?"text-black":"text-inherit",S=j?"setrow-input-done-white":"";return t.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${O}`,children:[t.jsx("div",{className:`col-span-1 text-center font-medium ${q} flex items-center justify-start pl-1 sm:pl-2`,children:t.jsx("span",{children:s})}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:v,onChange:n=>y(u(n.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${S} ${q}`})}),t.jsx("div",{className:"col-span-2 flex justify-center",children:t.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:C,onChange:n=>A(k(n.target.value)),className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${S} ${q}`})}),t.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2",children:c&&t.jsx("button",{type:"button",onClick:()=>c(e.id),className:`warmup-delete-btn w-6 h-6 flex items-center justify-center rounded transition-colors flex-shrink-0 ${j?"hover:bg-black/10 text-black/70":"hover:bg-white/20 text-white/70"}`,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4",children:t.jsx("path",{fillRule:"evenodd",d:"M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z",clipRule:"evenodd"})})})}),L&&t.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},tt=ye.memo(et,(e,s)=>e.set.id===s.set.id&&e.set.weight===s.set.weight&&e.set.reps===s.set.reps&&e.set.is_done===s.set.is_done&&e.set.updated_at===s.set.updated_at&&e.displayIndex===s.displayIndex&&e.onDelete===s.onDelete),Ie=()=>{try{const e=localStorage.getItem("settings:timerStep");return e?Number(e):30}catch{return 30}},st=({restSeconds:e,exerciseId:s,onAdjustRestSeconds:r,timerStep:c})=>{const{t:i}=ie(),d=s?`rest_timer:${s}`:void 0,[m,u]=o.useState(()=>c??Ie());o.useEffect(()=>{if(c!==void 0)u(c);else{const S=()=>{u(Ie())};window.addEventListener("storage",S);const n=()=>{u(Ie())};return window.addEventListener("focus",n),()=>{window.removeEventListener("storage",S),window.removeEventListener("focus",n)}}},[c]);const k=o.useRef(null),v=o.useRef(e),y=o.useRef({time:e,isActive:!1,endAt:null}),[C,A]=o.useState(()=>{if(!d)return{time:e,isActive:!1,endAt:null};try{const S=localStorage.getItem(d);if(!S)return{time:e,isActive:!1,endAt:null};const n=JSON.parse(S),a=360*60*1e3;if(Date.now()-n.savedAt>a)return localStorage.removeItem(d),{time:e,isActive:!1,endAt:null};if(n.isActive&&n.endAt){const b=Math.max(0,Math.floor((n.endAt-Date.now())/1e3));return b>0?{time:b,isActive:!0,endAt:n.endAt}:(localStorage.removeItem(d),{time:n.restSeconds,isActive:!1,endAt:null})}return{time:n.restSeconds,isActive:!1,endAt:null}}catch(S){return console.error("Error restoring timer state:",S),{time:e,isActive:!1,endAt:null}}}),{time:j,isActive:p,endAt:L}=C,D=o.useCallback((S,n)=>{if(d)try{const a={endAt:S.endAt,isActive:S.isActive,restSeconds:n??y.current.time??e,savedAt:Date.now()};localStorage.setItem(d,JSON.stringify(a))}catch(a){console.error("Error persisting timer:",a)}},[d,e]),$=o.useRef(D);o.useEffect(()=>{$.current=D},[D]),o.useEffect(()=>{y.current={time:j,isActive:p,endAt:L}},[j,p,L]),o.useEffect(()=>{if(!p||!L){k.current&&(window.clearInterval(k.current),k.current=null);return}let S=!1;const n=()=>{if(S)return;const b=Date.now(),x=Math.max(0,L-b),_=Math.floor(x/1e3);A(E=>({...E,time:_})),_<=0&&(S=!0,A(E=>({...E,isActive:!1,endAt:null,time:e})),k.current&&(window.clearInterval(k.current),k.current=null),d&&localStorage.removeItem(d))};n();const a=window.setInterval(n,1e3);return k.current=a,()=>{S=!0,k.current&&(window.clearInterval(k.current),k.current=null)}},[p,L,d,e]),o.useEffect(()=>{!p&&e!==v.current&&A(S=>({...S,time:e})),v.current=e},[e,p]),o.useEffect(()=>()=>{k.current&&(window.clearInterval(k.current),k.current=null);const{isActive:S,endAt:n}=y.current;S&&n&&$.current({endAt:n,isActive:!0})},[]);const R=()=>{A(S=>{if(S.isActive)return D({endAt:null,isActive:!1},S.time),k.current&&(window.clearInterval(k.current),k.current=null),{time:S.time,isActive:!1,endAt:null};const n=Date.now()+S.time*1e3;return D({endAt:n,isActive:!0},S.time),{time:S.time,isActive:!0,endAt:n}})},M=()=>{A({time:e,isActive:!1,endAt:null}),k.current&&(window.clearInterval(k.current),k.current=null),d&&localStorage.removeItem(d)},O=S=>{A(n=>{const a=Math.max(0,n.time+S);if(a===0)return D({endAt:null,isActive:!1},0),k.current&&(window.clearInterval(k.current),k.current=null),{time:0,isActive:!1,endAt:null};if(n.isActive){const b=Date.now()+a*1e3;return D({endAt:b,isActive:!0},a),{time:a,isActive:!0,endAt:b}}return D({endAt:null,isActive:!1},a),{time:a,isActive:!1,endAt:null}}),r==null||r(S)},q=S=>{const n=Math.floor(S/60),a=S%60;return`${n}:${a<10?"0":""}${a}`};return t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"flex items-center justify-center gap-4",children:[t.jsx("button",{onClick:()=>O(-m),disabled:j<=0&&!p,className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),t.jsx("div",{className:`text-6xl font-mono font-semibold leading-none min-w-[4ch] text-center ${p?"text-white":""}`,children:q(j)}),t.jsx("button",{onClick:()=>O(m),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("line",{x1:"8",y1:"3",x2:"8",y2:"13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]})})]}),t.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3",children:[t.jsx("button",{onClick:R,className:`btn-glass btn-glass-icon-lg ${p?"btn-glass-danger":"btn-glass-primary"}`,children:p?i.timer.stop:i.timer.start}),t.jsx("button",{onClick:M,className:"btn-glass btn-glass-icon-sm btn-glass-secondary",children:i.timer.reset})]})]})},rt=7200*1e3,Te=new Map,nt=(e,s,r)=>`${e}:${s}:${r||"none"}`,ot=e=>{const s=Te.get(e);if(!s)return;if(Date.now()-s.timestamp>rt){Te.delete(e);return}return s.data},ve=(e,s)=>{Te.set(e,{data:s,timestamp:Date.now()})},it=({exercise:e,workoutDate:s,onUpdateExercise:r,onDeleteExercise:c})=>{var ce;const{t:i}=ie(),[d,m]=o.useState(e.name),[u,k]=o.useState(e.sets),[v,y]=o.useState(()=>e.workout_sets.filter(h=>h.is_warmup).length),[C,A]=o.useState(e.rest_seconds),[j,p]=o.useState(!1),[L,D]=o.useState(null),[$,R]=o.useState("idle"),M=o.useRef(null),{user:O}=Be(),q=fe(d,500),S=fe(C,500),[n,a]=o.useState(!1),b=o.useRef(e.name),x=o.useRef(e);o.useEffect(()=>{x.current=e},[e]);const _=o.useCallback(()=>{const h=M.current;h&&(h.style.height="auto",h.style.height=`${h.scrollHeight}px`)},[]);o.useEffect(()=>{e.name!==b.current&&(m(e.name),b.current=e.name),k(e.sets),A(e.rest_seconds),y(e.workout_sets.filter(h=>h.is_warmup).length)},[e.id,e.sets,e.rest_seconds,e.workout_sets]),o.useEffect(()=>{if(!O)return;const h=q.trim(),l=Re(h);if(!l){D(null),R("idle");return}const w=nt(O.id,l,s??null),f=ot(w);if(f!==void 0){D(f),R("ready");return}let N=!1;return R("loading"),(async()=>{try{let F=V.from("workouts").select("id, workout_date, name, user_id").eq("user_id",O.id);s&&(F=F.lt("workout_date",s));const{data:W,error:J}=await F.order("workout_date",{ascending:!0});if(N)return;if(J)throw J;const Z=(W||[]).map(Y=>({id:Y.id,date:Y.workout_date,name:Y.name})),se=new Map;Z.forEach(Y=>se.set(Y.id,{date:Y.date,name:Y.name}));const P=Z.map(Y=>Y.id);if(P.length===0){D(null),ve(w,null),R("ready");return}const{data:le,error:_e}=await V.from("workout_exercises").select("id, name, workout_id").in("workout_id",P);if(N)return;if(_e)throw _e;const he=new Set,pe=new Map;if((le||[]).forEach(Y=>{const ue=(Y.name??"").trim();if(ue&&Re(ue)===l){const ee=Y.id;he.add(ee);const me=Y.workout_id;me&&pe.set(ee,me)}}),he.size===0){D(null),ve(w,null),R("ready");return}const{data:je,error:Ne}=await V.from("exercise_progress_view").select("workout_date, workout_name, workout_id, exercise_id, max_weight, reps_at_max_weight").in("workout_id",P).in("exercise_id",Array.from(he));if(N)return;if(Ne)throw Ne;let we=(je||[]).map(Y=>({workout_date:Y.workout_date,workout_name:Y.workout_name,workout_id:Y.workout_id,exercise_id:Y.exercise_id,max_weight:Y.max_weight,reps_at_max_weight:Y.reps_at_max_weight}));if(we.length===0){const{data:Y,error:ue}=await V.from("workout_sets").select("id, workout_exercise_id, weight, reps, is_done, updated_at").in("workout_exercise_id",Array.from(he)).order("updated_at",{ascending:!1});if(N)return;if(ue)throw ue;we=(Y||[]).filter(ee=>ee.weight!==null&&Number(ee.weight)===0).filter(ee=>ee.is_done||typeof ee.reps=="string"&&ee.reps.trim()!=="").map(ee=>{const me=ee.workout_exercise_id,ke=pe.get(me);if(!ke)return null;const ge=se.get(ke);return ge?{workout_date:ge.date,workout_name:ge.name,workout_id:ke,exercise_id:me,max_weight:0,reps_at_max_weight:ee.reps}:null}).filter(ee=>ee!==null)}if(we.length===0){D(null),ve(w,null),R("ready");return}const Se=Xe(h,we),xe=Se.dataPoints[Se.dataPoints.length-1];if(!xe){D(null),ve(w,null),R("ready");return}const Ce={weight:xe.weight,reps:xe.reps,workoutDate:xe.date};D(Ce),ve(w,Ce),R("ready")}catch(F){console.error("Failed to fetch last exercise performance",F),R("error")}})(),()=>{N=!0}},[q,O,s]),o.useLayoutEffect(()=>{_()},[_,d]),o.useLayoutEffect(()=>{if(typeof ResizeObserver>"u")return;const h=M.current;if(!h)return;const l=new ResizeObserver(()=>{_()});return l.observe(h),()=>l.disconnect()},[_]),o.useEffect(()=>{(async()=>{if(!(q.trim()===""||q===e.name))try{await V.from("workout_exercises").update({name:q}).eq("id",e.id);const l={...e,name:q};b.current=q,r(l)}catch(l){console.error("Failed to update exercise name",l)}})()},[q]),o.useEffect(()=>{(async()=>{if(S!==e.rest_seconds)try{await V.from("workout_exercises").update({rest_seconds:S}).eq("id",e.id);const l={...e,rest_seconds:S};r(l)}catch(l){console.error("Failed to update rest seconds",l)}})()},[S,e,r]);const E=h=>{A(l=>Math.max(0,l+h))},I=async h=>{if(!(h<1||h===u||j)){p(!0);try{if(h>u){const l=Array.from({length:h-u},(F,W)=>({workout_exercise_id:e.id,set_index:u+W+1,is_dropset:!1})),{data:w,error:f}=await V.from("workout_sets").insert(l).select();if(f)throw f;const N=[...e.workout_sets,...w||[]].sort((F,W)=>{const J=F.is_dropset??!1,Z=W.is_dropset??!1,se=J?F.parent_set_index??F.set_index:F.set_index,P=Z?W.parent_set_index??W.set_index:W.set_index;return se!==P?se-P:J!==Z?J?1:-1:F.set_index-W.set_index});await V.from("workout_exercises").update({sets:h}).eq("id",e.id);const K={...e,sets:h,workout_sets:N};r(K)}else{const w=e.workout_sets.filter(W=>!W.is_dropset&&W.set_index>h).map(W=>W.id),f=new Set(w);let N=0;for(const W of e.workout_sets){if(!W.is_dropset&&W.set_index>h){f.add(W.id);let J=N+1;for(;J<e.workout_sets.length&&e.workout_sets[J].is_dropset;)f.add(e.workout_sets[J].id),J++}N++}if(f.size>0){const{error:W}=await V.from("workout_sets").delete().in("id",Array.from(f));if(W)throw W}const K=e.workout_sets.filter(W=>!f.has(W.id));await V.from("workout_exercises").update({sets:h}).eq("id",e.id);const F={...e,sets:h,workout_sets:K};r(F)}k(h)}catch(l){console.error("Failed to change sets count",l),alert(i.exercise.errors.failedToChangeSets)}finally{p(!1)}}},B=async()=>{const{error:h}=await V.from("workout_sets").delete().eq("workout_exercise_id",e.id);if(h){console.error("Failed to delete sets of exercise",h),alert(i.exercise.errors.failedToDeleteSets);return}const{error:l}=await V.from("workout_exercises").delete().eq("id",e.id);if(l){console.error("Failed to delete exercise",l),alert(i.exercise.errors.failedToDeleteExercise);return}c&&c(e.id)},G=i.common.max,z=h=>h==null?"—":String(h).replace(".",","),H=h=>{if(h==null)return"—";const l=h.trim();return l?l==="0"?G:l:"—"},Q=()=>d.trim()?$==="loading"?t.jsx("span",{className:"text-gray-400",children:i.exercise.searchingLastResult}):$==="error"?t.jsx("span",{className:"text-red-300",children:i.exercise.loadError}):L?t.jsxs("span",{className:"text-white text-base font-semibold",children:[z(L.weight)," ",i.common.kg," × ",H(L.reps)]}):t.jsx("span",{className:"text-gray-500",children:i.exercise.noDataBeforeDate}):t.jsx("span",{className:"text-gray-500",children:i.exercise.enterNameToSeeResult}),ne=o.useCallback(h=>{const l=x.current,w={...l,workout_sets:l.workout_sets.map(f=>f.id===h.id?h:f)};r(w)},[r]),oe=o.useCallback(async h=>{const l=x.current,w=l.workout_sets.findIndex(N=>N.id===h);if(w===-1)return;const f=l.workout_sets[w];try{const N=f.is_dropset?f.parent_set_index??f.set_index:f.set_index,F=Math.max(...l.workout_sets.map(le=>le.set_index))+1,{data:W,error:J}=await V.from("workout_sets").insert({workout_exercise_id:l.id,set_index:F,weight:null,reps:null,is_done:!1,is_dropset:!0,parent_set_index:N,updated_at:new Date().toISOString()}).select().single();if(J)throw J;let Z=w+1;for(;Z<l.workout_sets.length&&l.workout_sets[Z].is_dropset;)Z++;const se=[...l.workout_sets];se.splice(Z,0,W);const P={...l,workout_sets:se};r(P)}catch(N){console.error("Failed to add dropset",N),alert(i.exercise.errors.failedToAddDropset)}},[r]),ae=o.useCallback(async h=>{const l=x.current,w=l.workout_sets.find(f=>f.id===h);if(!(!w||!w.is_dropset))try{const{error:f}=await V.from("workout_sets").delete().eq("id",h);if(f)throw f;const N={...l,workout_sets:l.workout_sets.filter(K=>K.id!==h)};r(N)}catch(f){console.error("Failed to delete dropset",f),alert(i.exercise.errors.failedToDeleteDropset)}},[r]),re=o.useCallback((h,l,w)=>{const f=w[l+1];return h.is_dropset,!f||!f.is_dropset},[]),g=async h=>{if(!(h<0||h===v||j)){p(!0);try{const l=e.workout_sets.filter(f=>f.is_warmup),w=l.length;if(h>w){const f=e.workout_sets.length>0?Math.max(...e.workout_sets.map(P=>P.set_index)):0,N=Array.from({length:h-w},(P,le)=>({workout_exercise_id:e.id,set_index:f+le+1,is_dropset:!1,is_warmup:!0})),{data:K,error:F}=await V.from("workout_sets").insert(N).select();if(F)throw F;const W=[...l,...K||[]],J=e.workout_sets.filter(P=>!P.is_warmup),Z=[...W,...J],se={...e,workout_sets:Z};r(se)}else{const N=l.slice(h).map(W=>W.id);if(N.length>0){const{error:W}=await V.from("workout_sets").delete().in("id",N);if(W)throw W}const K=e.workout_sets.filter(W=>!N.includes(W.id)),F={...e,workout_sets:K};r(F)}y(h)}catch(l){console.error("Failed to change warmup sets count",l),alert(i.exercise.errors.failedToChangeSets)}finally{p(!1)}}},T=o.useCallback(async h=>{const l=x.current,w=l.workout_sets.find(f=>f.id===h);if(!(!w||!w.is_warmup))try{const{error:f}=await V.from("workout_sets").delete().eq("id",h);if(f)throw f;const N=l.workout_sets.filter(F=>F.id!==h),K={...l,workout_sets:N};r(K)}catch(f){console.error("Failed to delete warmup set",f)}},[r]),U=e.workout_sets.filter(h=>h.is_warmup),de=e.workout_sets.filter(h=>!h.is_warmup);return t.jsxs("div",{id:`exercise-${e.id}`,className:"glass card-dark p-4 exercise-card",children:[t.jsxs("div",{className:"exercise-card-header mb-3",children:[t.jsxs("div",{className:"name-wrap relative",children:[t.jsx("textarea",{value:d,onChange:h=>m(h.target.value),ref:M,rows:1,className:"w-full text-base sm:text-lg font-bold text-white whitespace-pre-wrap bg-white/10 hover:bg-white/15 focus:bg-white/10 border border-white/20 hover:border-white/30 focus:border-white/50 focus:ring-2 focus:ring-white/25 focus:outline-none rounded-xl px-4 pr-9 py-3 min-h-[3rem] resize-none overflow-y-hidden leading-relaxed transition-colors"}),d&&d.trim()!==""&&t.jsx("button",{type:"button",onClick:()=>{m(""),requestAnimationFrame(()=>_())},"aria-label":i.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),t.jsx("button",{"aria-label":i.exercise.deleteExercise,className:"delete-btn btn-glass btn-glass-icon btn-glass-outline",onClick:()=>a(!0),type:"button",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("path",{d:"M3 6h18"}),t.jsx("path",{d:"M8 6l1-2h6l1 2"}),t.jsx("path",{d:"M10 11v6"}),t.jsx("path",{d:"M14 11v6"}),t.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"rounded-2xl bg-white/5 px-4 py-3 text-xs sm:text-sm text-gray-300",children:[t.jsxs("div",{className:"mb-1 flex items-center justify-between gap-3",children:[t.jsx("span",{className:"font-semibold text-white",children:i.exercise.lastWeight}),(L==null?void 0:L.workoutDate)&&t.jsx("span",{className:"text-[0.7rem] uppercase tracking-wide text-gray-400",children:Ee(L.workoutDate)})]}),Q()]}),t.jsx("div",{className:"flex justify-center",children:t.jsx(st,{restSeconds:C,exerciseId:e.id,onAdjustRestSeconds:E})}),t.jsxs("div",{className:"flex items-center text-sm py-3 sm:py-4 px-2 rounded-lg warmup-row-header",children:[t.jsxs("span",{className:"w-[100px] whitespace-nowrap font-medium text-sky-300",children:[i.exercise.warmupSets,":"]}),t.jsxs("div",{className:"inline-flex items-center gap-2",children:[t.jsx("button",{disabled:j||v<=0,onClick:()=>g(v-1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),t.jsx("span",{className:"min-w-[3ch] text-center text-white font-semibold",children:v}),t.jsx("button",{disabled:j||v>=10,onClick:()=>g(v+1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("line",{x1:"8",y1:"3",x2:"8",y2:"13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]})})]})]}),U.length>0&&t.jsxs("div",{className:"space-y-2 !mt-0 pt-1",children:[t.jsxs("div",{className:"warmup-sets-header grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden",children:[t.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:i.exercise.set}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:i.exercise.weight}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:i.exercise.reps}),t.jsx("div",{className:"col-span-1"})]}),t.jsx("div",{className:"space-y-2",children:U.map((h,l)=>t.jsx(tt,{set:h,displayIndex:l+1,onChange:ne,onDelete:T},h.id))})]}),t.jsxs("div",{className:"flex items-center text-sm py-3 sm:py-4 px-2 rounded-lg exercise-row-header",children:[t.jsxs("span",{className:"w-[100px] whitespace-nowrap font-medium",children:[i.exercise.sets,":"]}),t.jsxs("div",{className:"inline-flex items-center gap-2",children:[t.jsx("button",{disabled:j||u<=1,onClick:()=>I(u-1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})})}),t.jsx("span",{className:"min-w-[3ch] text-center text-white font-semibold",children:u}),t.jsx("button",{disabled:j||u>=30,onClick:()=>I(u+1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("line",{x1:"8",y1:"3",x2:"8",y2:"13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"}),t.jsx("line",{x1:"3",y1:"8",x2:"13",y2:"8",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]})})]}),((ce=e.reps)==null?void 0:ce.trim())&&t.jsxs("div",{className:"ml-auto whitespace-nowrap font-medium",children:[i.exercise.reps,": ",e.reps]})]})]}),t.jsxs("div",{className:"space-y-3 pt-1",children:[t.jsxs("div",{className:"grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden exercise-sets-header",children:[t.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:i.exercise.set}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:i.exercise.weight}),t.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:i.exercise.reps}),t.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2 whitespace-nowrap",children:i.exercise.toFailure})]}),t.jsx("div",{className:"space-y-2",children:de.map((h,l,w)=>{let f;if(!h.is_dropset){for(let N=l-1;N>=0;N--)if(!w[N].is_dropset){f=w[N];break}}return t.jsx(ze,{set:h,previousSet:f,onChange:ne,onAddDropset:oe,onDeleteDropset:ae,isLastInGroup:re(h,l,w)},h.id)})})]}),t.jsx(Ke,{open:n,onOpenChange:a,title:i.exercise.deleteExercise,description:e.name?i.exercise.deleteExerciseDesc.replace("{name}",e.name):i.exercise.deleteExerciseDescNoName,confirmText:i.common.delete,cancelText:i.common.cancel,variant:"danger",onConfirm:B})]})},at=ye.memo(it,(e,s)=>{const r=e.exercise,c=s.exercise;if(r.id!==c.id||r.name!==c.name||r.sets!==c.sets||r.rest_seconds!==c.rest_seconds||r.reps!==c.reps||e.workoutDate!==s.workoutDate||r.workout_sets.length!==c.workout_sets.length)return!1;for(let i=0;i<r.workout_sets.length;i++){const d=r.workout_sets[i],m=c.workout_sets[i];if(d.id!==m.id||d.weight!==m.weight||d.reps!==m.reps||d.is_done!==m.is_done||d.is_dropset!==m.is_dropset||d.parent_set_index!==m.parent_set_index||d.is_warmup!==m.is_warmup)return!1}return!0}),Ve=({normalizedDate:e,className:s=""})=>{const r=qe();return t.jsx("button",{onClick:()=>r("/calendar",{state:{refreshDate:e}}),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors z-10 bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${s}`,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})},lt=({normalizedDate:e,workoutName:s,isEditingName:r,editNameValue:c,isSavingWorkoutName:i,isScrolling:d,inputRef:m,onStartEditName:u,onChangeEditName:k,onSaveEditName:v,onCancelEditName:y,actionsRef:C,actionsBtnRef:A,onToggleActions:j,workoutIcon:p,editIconValue:L,onOpenIconPicker:D})=>{var O;const{t:$}=ie(),R=r?L:p,M=R?De[R]:null;return t.jsxs("div",{className:`glass card-dark p-4 flex items-center gap-4 header-container ${d?"scrolling":""}`,children:[t.jsx(Ve,{normalizedDate:e,className:"shrink-0"}),t.jsx("div",{className:"flex-1 text-center",children:r?t.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:D,disabled:i,className:"shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-50",title:$.iconPicker.title,children:M?t.jsx(M.component,{size:28}):t.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-gray-400",children:[t.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"}),t.jsx("path",{d:"M12 8v8M8 12h8"})]})}),t.jsxs("div",{className:"relative flex-1",children:[t.jsx("input",{ref:m,type:"text",value:c,onChange:q=>k(q.target.value),disabled:i,className:"w-full bg-white/10 text-lg font-bold text-white placeholder:text-gray-500 focus:outline-none focus:bg-white/20 rounded-md px-3 pr-9 py-2 transition-colors disabled:opacity-70",placeholder:((O=$.workout.emptyState)==null?void 0:O.title)||"Workout name"}),c&&t.jsx("button",{type:"button",onClick:()=>k(""),"aria-label":$.common.clear,className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),t.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.jsx("button",{onClick:v,disabled:i,className:"shrink-0 p-1.5 rounded-full hover:bg-green-500/20 transition-colors disabled:opacity-50",title:$.common.save,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),t.jsx("button",{onClick:y,disabled:i,className:"shrink-0 p-1.5 rounded-full hover:bg-red-500/20 transition-colors disabled:opacity-50",title:$.common.cancel,children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[M&&t.jsx("div",{className:"shrink-0 w-10 h-10 flex items-center justify-center",children:t.jsx(M.component,{size:32})}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-bold text-white",children:s}),t.jsxs("p",{className:"text-md transition-all duration-300 workout-date-text",children:[$.workoutHeader.date,": ",Ee(e)]})]}),t.jsx("button",{onClick:u,className:"shrink-0 p-1.5 rounded-full hover:bg-white/10 transition-colors",title:$.common.edit||"Edit",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})})]})}),t.jsx("div",{className:"relative",ref:C,children:t.jsx("button",{ref:A,type:"button","aria-label":$.profile.menu,className:"inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10",onClick:j,children:t.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[t.jsx("circle",{cx:"12",cy:"5",r:"1"}),t.jsx("circle",{cx:"12",cy:"12",r:"1"}),t.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})})]})},ct=({open:e,templates:s,isCreating:r,onClose:c,onReplaceWithTemplate:i})=>{const{t:d}=ie();return e?We.createPortal(t.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[t.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:c}),t.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h2",{className:"text-lg font-semibold",children:d.workoutTemplateSelect.title}),t.jsx("button",{onClick:c,className:"px-2 py-1 text-sm text-gray-300 hover:text-white",children:"✕"})]}),s.length===0?t.jsx("p",{className:"text-gray-400",children:d.workoutTemplateSelect.noTemplates}):t.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-y-auto overscroll-contain pr-1",children:s.map(m=>t.jsx("button",{onClick:()=>i(m),disabled:r,className:"w-full text-left px-4 py-2 rounded-md border border-white/20 text-gray-100 hover:bg-white/5 disabled:opacity-50",children:r?d.workoutTemplateSelect.applying:m.name},m.id))})]})]}),document.body):null};function dt({normalizedDate:e,templates:s,isCreating:r,onCreateWorkout:c,onCreateCustomWorkout:i}){const{t:d}=ie();return r?t.jsx("div",{className:"px-4 pt-4",children:t.jsx(Fe,{message:d.workoutEmptyState.creating})}):t.jsxs("div",{className:"max-w-lg mx-auto px-4 pt-4",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[t.jsx(Ve,{normalizedDate:e}),t.jsx("h1",{className:"flex-1 text-xl font-bold text-center",children:d.workoutEmptyState.workoutOn.replace("{date}",Ee(e))})]}),t.jsxs("div",{className:"mt-4 p-6 text-center",children:[s.length>0?t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:d.workoutEmptyState.selectTemplate}),t.jsx("div",{className:"space-y-2",children:s.map(m=>t.jsx("button",{onClick:()=>c(m),disabled:r,className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md disabled:opacity-50",children:m.name},m.id))})]}):t.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[t.jsx("p",{className:"text-gray-400",children:d.workoutEmptyState.createTemplateFirst}),t.jsxs(Je,{to:"/templates/new",className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md",children:[t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),d.workoutEmptyState.createTemplate]})]}),t.jsx("div",{className:"mt-4",children:t.jsx("button",{type:"button",onClick:i,disabled:r,className:"btn-dashed",children:d.workoutEmptyState.createCustomDay})})]})]})}function ut({isCardio:e,isSaving:s,onToggle:r}){const{t:c}=ie();return t.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[t.jsx("p",{className:"text-white text-lg font-bold mb-3 text-center",children:c.workoutCardio.question}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>{e&&r()},disabled:s,className:`flex-1 py-2.5 px-4 rounded-xl font-medium transition duration-200 ease-in-out ${e?"bg-red-500/30 text-white border border-red-400/40 supports-[hover:hover]:hover:bg-red-500/40 supports-[hover:hover]:hover:shadow-sm":"bg-red-500/80 text-white shadow-lg border border-red-400/60"} active:brightness-100 disabled:cursor-not-allowed disabled:pointer-events-none focus:outline-none focus-visible:outline-none [-webkit-tap-highlight-color:transparent]`,children:c.workoutCardio.no}),t.jsx("button",{onClick:()=>{e||r()},disabled:s,className:`flex-1 py-2.5 px-4 rounded-xl font-medium transition duration-200 ease-in-out ${e?"bg-green-500/80 text-white shadow-lg border border-green-400/60":"bg-green-500/30 text-white border border-green-400/40 supports-[hover:hover]:hover:bg-green-500/40 supports-[hover:hover]:hover:shadow-sm"} active:brightness-100 disabled:cursor-not-allowed disabled:pointer-events-none focus:outline-none focus-visible:outline-none [-webkit-tap-highlight-color:transparent]`,children:c.workoutCardio.yes})]})]})}function mt({notes:e,isSaving:s,onChange:r}){const{t:c}=ie();return t.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-white text-lg font-bold",children:c.workoutNotes.title}),s&&t.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[t.jsx("span",{className:"w-3 h-3 border border-white/30 border-t-white rounded-full animate-spin"}),c.workoutNotes.saving]})]}),t.jsx("textarea",{value:e,onChange:i=>r(i.target.value),placeholder:c.workoutNotes.placeholder,rows:5,className:"w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-400 text-sm resize-none focus:outline-none focus:ring-1 focus:ring-blue-500/50 focus:border-blue-500/50 transition-colors"})]})}function ft({isOpen:e,menuPos:s,onReorder:r,onChangeTemplate:c,onDelete:i,onClose:d}){const{t:m}=ie();return!e||!s?null:We.createPortal(t.jsxs("div",{className:"fixed menu-popover",style:{top:s.top,left:s.left,width:192},role:"menu",children:[t.jsx("button",{onClick:()=>{d(),r()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:m.workoutActions.reorderExercises}),t.jsx("button",{onClick:()=>{d(),c()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:m.workoutActions.changeWorkout}),t.jsx("button",{onClick:()=>{d(),i()},className:"w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors rounded-lg",children:m.workoutActions.delete})]}),document.body)}function ht({normalizedDate:e,exercisesLength:s,scrollKey:r,location:c}){const[i,d]=o.useState(!1),m=o.useRef(!1),u=o.useRef(0),k=o.useRef(!1),v=o.useRef(!1);return o.useEffect(()=>{k.current=!1,v.current=!1},[e,c.key]),o.useEffect(()=>{if(!e||s===0||v.current)return;const y=()=>{var O;const j=(O=c.state)==null?void 0:O.focusExerciseId;if(!j||k.current)return!1;const p=document.getElementById(`exercise-${j}`);if(!p)return!1;k.current=!0,m.current=!0;const L=document.querySelector(".header-container"),D=L?L.getBoundingClientRect().bottom:0,$=12,R=p.getBoundingClientRect(),M=Math.max(0,window.scrollY+R.top-D-$);return window.scrollTo({top:M,behavior:"smooth"}),p.animate&&p.animate([{boxShadow:"0 0 0 rgba(59,130,246,0)"},{boxShadow:"0 0 0 4px rgba(59,130,246,0.6)"},{boxShadow:"0 0 0 rgba(59,130,246,0)"}],{duration:1200,easing:"ease-in-out"}),setTimeout(()=>{m.current=!1},600),!0},C=()=>{try{const j=localStorage.getItem(r);if(j){const p=parseInt(j,10);Number.isNaN(p)||(m.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:p,behavior:"auto"}),u.current=p,setTimeout(()=>{m.current=!1},100)})}))}}catch(j){console.error("Error restoring scroll:",j)}};y()||C(),v.current=!0},[e,s,r,c.state]),o.useEffect(()=>{if(!e)return;let y=!1;const C=()=>{u.current=window.scrollY,d(window.scrollY>0),!y&&!m.current&&(window.requestAnimationFrame(()=>{try{localStorage.setItem(r,String(u.current))}catch{}y=!1}),y=!0)};return window.addEventListener("scroll",C,{passive:!0}),()=>window.removeEventListener("scroll",C)},[e,r]),o.useEffect(()=>()=>{if(e&&u.current>0)try{localStorage.setItem(r,String(u.current))}catch{}},[e,r]),{isScrolling:i}}const X=new Map,Le=3e4,pt=e=>{if(!e)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const s=new Date(e);return Number.isNaN(s.getTime())?null:Ue(s)};function wt(){const{date:e}=Ye(),{user:s}=Be(),r=Ge(),c=V,i=o.useMemo(()=>pt(e),[e]),d=i?`workout-page:${i}`:"workout-page",[m,u]=Ze({key:d,initialState:{workout:null,exercises:[],templates:[],loading:!0,isCreating:!1,isSelectTemplateOpen:!1,hasInitialData:!1,isAddingExercise:!1,workoutName:"",isSavingWorkoutName:!1,isCardio:!1,isSavingCardio:!1,workoutIcon:null,workoutNotes:"",isSavingNotes:!1},ttl:1800*1e3}),{workout:k,exercises:v,templates:y,loading:C,isCreating:A,isSelectTemplateOpen:j,hasInitialData:p,isAddingExercise:L,workoutName:D,isSavingWorkoutName:$,isCardio:R,isSavingCardio:M,workoutIcon:O,workoutNotes:q,isSavingNotes:S}=m,n=o.useCallback(g=>u(T=>({...T,workout:g,workoutName:(g==null?void 0:g.name)??"",isSavingWorkoutName:!1,isCardio:(g==null?void 0:g.is_cardio)??!1,isSavingCardio:!1,workoutIcon:(g==null?void 0:g.icon)??null,workoutNotes:(g==null?void 0:g.notes)??"",isSavingNotes:!1})),[u]),a=o.useCallback(g=>u(T=>({...T,exercises:typeof g=="function"?g(T.exercises):g})),[u]),b=o.useCallback(g=>u(T=>({...T,templates:typeof g=="function"?g(T.templates):g})),[u]),x=o.useCallback(g=>u(T=>({...T,loading:g})),[u]),_=o.useCallback(g=>u(T=>({...T,isCreating:g})),[u]),E=o.useCallback(g=>u(T=>({...T,isSelectTemplateOpen:g})),[u]),I=o.useCallback(g=>u(T=>({...T,hasInitialData:g})),[u]),B=o.useCallback(g=>u(T=>({...T,isAddingExercise:g})),[u]),G=o.useCallback(g=>u(T=>({...T,workoutName:g})),[u]),z=o.useCallback(g=>u(T=>({...T,isSavingWorkoutName:g})),[u]),H=o.useCallback(g=>u(T=>({...T,isCardio:g})),[u]),Q=o.useCallback(g=>u(T=>({...T,isSavingCardio:g})),[u]),ne=o.useCallback(g=>u(T=>({...T,workoutIcon:g})),[u]),oe=o.useCallback(g=>u(T=>({...T,workoutNotes:g})),[u]),ae=o.useCallback(g=>u(T=>({...T,isSavingNotes:g})),[u]),re=o.useCallback(async(g=!1,T=!1)=>{if(!s||!i){n(null),a([]),x(!1),I(!0);return}const U=`${s.id}:${i}`,de=Date.now();if(X.has(U)){const f=X.get(U),N=de-f.timestamp;if(g&&N<Le){p||(n(f.workout),a(f.exercises),x(!1),I(!0));return}N>=Le&&(p||(n(f.workout),a(f.exercises),I(!0)),T=!0)}T||x(!0);const{data:ce,error:h}=await c.from("workouts").select("*").eq("user_id",s.id).eq("workout_date",i).order("created_at",{ascending:!1}).limit(1);let l=(ce==null?void 0:ce[0])??null;if(h)console.error("Error fetching workout:",h);else if(l){if(l.template_id&&!l.icon)try{const{data:K}=await c.from("workout_templates").select("icon").eq("id",l.template_id).single();K!=null&&K.icon&&(l={...l,icon:K.icon},c.from("workouts").update({icon:K.icon}).eq("id",l.id).then(()=>{},()=>{}))}catch{}n(l);const{data:f,error:N}=await c.from("workout_exercises").select("id, name, sets, reps, rest_seconds, position, workout_id, workout_sets ( id, workout_exercise_id, set_index, weight, reps, is_done, is_dropset, parent_set_index, is_warmup, updated_at )").eq("workout_id",l.id).order("position");if(N)console.error("Error fetching exercises:",N);else{const K=f||[];K.forEach(F=>{F.workout_sets&&F.workout_sets.sort((W,J)=>{const Z=W.is_dropset??!1,se=J.is_dropset??!1,P=Z?W.parent_set_index??W.set_index:W.set_index,le=se?J.parent_set_index??J.set_index:J.set_index;return P!==le?P-le:Z!==se?Z?1:-1:W.set_index-J.set_index})}),a(K),X.set(U,{workout:l,exercises:K,timestamp:de})}}else n(null),a([]),X.set(U,{workout:null,exercises:[],timestamp:de});const w=s?`templates-cache:${s.id}`:void 0;if(w)try{const f=localStorage.getItem(w);if(f){const N=JSON.parse(f);N.data&&b(N.data)}}catch{}c.from("workout_templates").select("id, name, created_at, user_id, icon, is_archived").eq("user_id",s.id).eq("is_archived",!1).then(({data:f,error:N})=>{if(N)console.error("Error fetching templates:",N.message);else if(b(f||[]),w)try{localStorage.setItem(w,JSON.stringify({ts:Date.now(),data:f}))}catch{}}),x(!1),I(!0)},[s,i,p,n,a,x,I,b]);return o.useEffect(()=>{re()},[re]),o.useEffect(()=>{const g=()=>{document.visibilityState==="visible"&&re(!0)};return document.addEventListener("visibilitychange",g),()=>document.removeEventListener("visibilitychange",g)},[re]),o.useEffect(()=>{i&&(localStorage.setItem("lastWorkoutPath",`/workout/${i}`),localStorage.setItem("lastWorkoutTimestamp",Date.now().toString()))},[i]),{user:s,normalizedDate:i,location:r,workout:k,exercises:v,templates:y,loading:C,isCreating:A,isSelectTemplateOpen:j,hasInitialData:p,isAddingExercise:L,workoutName:D,isSavingWorkoutName:$,isCardio:R,isSavingCardio:M,workoutIcon:O,workoutNotes:q,isSavingNotes:S,setPageState:u,setWorkout:n,setExercises:a,setTemplates:b,setLoading:x,setIsCreating:_,setIsSelectTemplateOpen:E,setHasInitialData:I,setIsAddingExercise:B,setWorkoutName:G,setIsSavingWorkoutName:z,setIsCardio:H,setIsSavingCardio:Q,setWorkoutIcon:ne,setWorkoutNotes:oe,setIsSavingNotes:ae,fetchWorkoutData:re}}function xt({user:e,normalizedDate:s,workout:r,exercises:c,setPageState:i,setWorkout:d,setExercises:m,setIsCreating:u,setIsAddingExercise:k,setWorkoutName:v,setIsSelectTemplateOpen:y,fetchWorkoutData:C,isAddingExercise:A}){const j=qe(),p=V,L=o.useCallback(n=>{i(a=>{const b=a.exercises.map(x=>x.id===n.id?n:x);if(e&&s&&a.workout){const x=`${e.id}:${s}`;X.set(x,{workout:a.workout,exercises:b,timestamp:Date.now()})}return{...a,exercises:b}})},[e,s,i]),D=o.useCallback(n=>{i(a=>{const b=a.exercises.filter(x=>String(x.id)!==String(n));if(e&&s&&a.workout){const x=`${e.id}:${s}`;X.set(x,{workout:a.workout,exercises:b,timestamp:Date.now()})}return{...a,exercises:b}})},[e,s,i]),$=o.useCallback(async()=>{if(!(!e||!s||!r||A)){k(!0);try{const n=c.length>0?Math.max(...c.map(G=>typeof G.position=="number"?G.position:0))+1:1,{data:a,error:b}=await p.from("workout_exercises").insert({workout_id:r.id,name:"",sets:1,reps:"",rest_seconds:150,position:n}).select("id, name, sets, reps, rest_seconds, position, workout_id");if(b)throw b;const x=a==null?void 0:a[0];if(!x)throw new Error(te().hooks.failedToCreateExercise);const{data:_,error:E}=await p.from("workout_sets").insert({workout_exercise_id:x.id,set_index:1,weight:null,reps:null,is_done:!1,is_dropset:!1,updated_at:new Date().toISOString()}).select("id, workout_exercise_id, set_index, weight, reps, is_done, is_dropset, updated_at");if(E)throw E;const I=_==null?void 0:_[0];if(!I)throw new Error(te().hooks.failedToCreateSet);const B={...x,workout_sets:[I]};i(G=>{if(!G.workout)return G;const z=[...G.exercises,B].sort((H,Q)=>H.position-Q.position);if(e&&s){const H=`${e.id}:${s}`,Q=X.get(H);Q&&X.set(H,{workout:Q.workout,exercises:z,timestamp:Date.now()})}return{...G,exercises:z}})}catch(n){console.error("Failed to add exercise:",n),alert(te().hooks.failedToAddExercise)}finally{k(!1)}}},[e,s,r,c,A,i,k]),R=o.useCallback(async()=>{if(!(!e||!s)){u(!0);try{const{data:n,error:a}=await p.from("workouts").insert({user_id:e.id,workout_date:s,name:te().hooks.newWorkout,template_id:null}).select().single();if(a)throw a;if(!n)throw new Error(te().hooks.failedToCreateWorkoutEntry);d(n),m([]),v(n.name);const b=`${e.id}:${s}`;X.set(b,{workout:n,exercises:[],timestamp:Date.now()})}catch(n){console.error("Failed to create custom workout:",n),alert(te().hooks.failedToCreateWorkoutTryAgain)}finally{u(!1)}}},[e,s,u,d,m,v]),M=o.useCallback(async n=>{if(!(!e||!s)){u(!0);try{const[{data:a},{data:b}]=await Promise.all([p.from("template_exercises").select("*").eq("template_id",n.id),p.from("workout_templates").select("id, name, icon").eq("id",n.id).single()]),x=(b==null?void 0:b.icon)??n.icon??null,_=(b==null?void 0:b.name)??n.name,{data:E}=await p.from("workouts").insert({user_id:e.id,workout_date:s,name:_,template_id:n.id,icon:x}).select().single();if(!E)throw new Error("Failed to create workout entry.");const I=(a||[]).map(H=>({workout_id:E.id,name:H.name,sets:H.sets,reps:H.reps,rest_seconds:H.rest_seconds,position:H.position})),{data:B}=await p.from("workout_exercises").insert(I).select();if(!B)throw new Error("Failed to create workout exercises.");const G=B.flatMap(H=>Array.from({length:H.sets},(Q,ne)=>({workout_exercise_id:H.id,set_index:ne+1})));await p.from("workout_sets").insert(G);const z=`${e.id}:${s}`;X.delete(z),await C()}catch(a){console.error("Failed to create workout from template:",a),alert(te().hooks.failedToCreateFromTemplate+a.message)}finally{u(!1)}}},[e,s,u,C]),O=o.useCallback(async n=>{if(!(!e||!s||!r))try{u(!0);const[{data:a,error:b},{data:x,error:_}]=await Promise.all([p.from("template_exercises").select("*").eq("template_id",n.id),p.from("workout_templates").select("id, name, icon").eq("id",n.id).single()]);if(b)throw b;if(_)throw _;const{data:E,error:I}=await p.from("workout_exercises").select("id").eq("workout_id",r.id);if(I)throw I;const B=(E||[]).map(g=>g.id);if(B.length>0){const{error:g}=await p.from("workout_sets").delete().in("workout_exercise_id",B);if(g)throw g;const{error:T}=await p.from("workout_exercises").delete().eq("workout_id",r.id);if(T)throw T}const G=(x==null?void 0:x.icon)??n.icon??null,z=(x==null?void 0:x.name)??n.name,{error:H}=await p.from("workouts").update({name:z,template_id:n.id,icon:G}).eq("id",r.id);if(H)throw H;const Q=(a||[]).map(g=>({workout_id:r.id,name:g.name,sets:g.sets,reps:g.reps,rest_seconds:g.rest_seconds,position:g.position})),{data:ne,error:oe}=await p.from("workout_exercises").insert(Q).select();if(oe)throw oe;const ae=(ne||[]).flatMap(g=>Array.from({length:g.sets},(T,U)=>({workout_exercise_id:g.id,set_index:U+1})));if(ae.length>0){const{error:g}=await p.from("workout_sets").insert(ae);if(g)throw g}const re=`${e.id}:${s}`;X.delete(re),y(!1),await C()}catch(a){console.error("Failed to replace workout from template:",a),alert(te().hooks.failedToChangeWorkout+a.message)}finally{u(!1)}},[e,s,r,u,y,C]),q=o.useCallback(async()=>{if(!r)return;const{error:n}=await p.from("workouts").delete().eq("id",r.id);if(n){console.error("Error deleting workout:",n),alert(te().hooks.failedToDeleteWorkout);return}if(e&&s){const a=`${e.id}:${s}`;X.delete(a)}j("/calendar",{state:{removedDate:s}})},[r,e,s,j]),S=o.useCallback(async n=>{if(!e||!r)return;const a=new Map(n.map((x,_)=>[x.id,_+1]));m(x=>{const _=x.map(E=>({...E,position:a.get(E.id)??E.position}));return _.sort((E,I)=>(E.position??0)-(I.position??0)),_});const b=n.map((x,_)=>({id:x.id,position:_+1}));try{if(await Promise.all(b.map(async x=>{const{error:_}=await p.from("workout_exercises").update({position:x.position}).eq("id",x.id);if(_)throw _})),e&&s){const x=`${e.id}:${s}`,_=X.get(x);if(_){const E=[..._.exercises].map(I=>({...I,position:a.get(I.id)??I.position})).sort((I,B)=>(I.position??0)-(B.position??0));X.set(x,{workout:_.workout,exercises:E,timestamp:Date.now()})}}}catch(x){console.error("Failed to save new order:",x),alert(te().hooks.failedToSaveOrder),await C()}},[e,r,s,m,C]);return{handleUpdateExercise:L,handleDeleteExercise:D,handleAddExercise:$,handleCreateCustomWorkout:R,handleCreateWorkout:M,handleReplaceWithTemplate:O,handleDeleteWorkout:q,handleSaveNewOrder:S}}function gt({user:e,normalizedDate:s,workout:r,exercises:c,workoutName:i,workoutIcon:d,setWorkout:m,setWorkoutName:u,setIsSavingWorkoutName:k}){const v=V,y=o.useRef(null),[C,A]=o.useState(!1),[j,p]=o.useState(i),[L,D]=o.useState(d),[$,R]=o.useState(!1);o.useEffect(()=>{C&&y.current&&(y.current.focus(),y.current.select())},[C]);const M=o.useCallback(()=>{p(i),D(d),A(!0)},[i,d]),O=o.useCallback(async()=>{if(!e||!s||!r)return;const x=j.trim();if(x.length===0){p(i),D(d),A(!1);return}const _=x!==r.name,E=L!==r.icon;if(!_&&!E){A(!1);return}k(!0);try{const I={};_&&(I.name=x),E&&(I.icon=L);const{data:B,error:G}=await v.from("workouts").update(I).eq("id",r.id).select().single();if(G)throw G;if(!B)throw new Error(te().hooks.failedToUpdateWorkout);m(B),p(x),D(B.icon),A(!1);const z=`${e.id}:${s}`;X.set(z,{workout:B,exercises:c,timestamp:Date.now()})}catch(I){console.error("Failed to update workout:",I),alert(te().hooks.failedToSaveChanges)}finally{k(!1)}},[e,s,r,c,j,L,i,d,m,k]),q=o.useCallback(()=>{p(i),D(d),A(!1)},[i,d]),S=o.useCallback(()=>{R(!0)},[]),n=o.useCallback(x=>{D(x)},[]),a=o.useCallback(async()=>{if(!e||!s||!r)return;const x=i.trim();if(x.length===0){u(r.name);return}if(x!==r.name){k(!0);try{const{data:_,error:E}=await v.from("workouts").update({name:x}).eq("id",r.id).select().single();if(E)throw E;if(!_)throw new Error(te().hooks.failedToUpdateWorkoutName);m(_);const I=`${e.id}:${s}`;X.set(I,{workout:_,exercises:c,timestamp:Date.now()})}catch(_){console.error("Failed to update workout name:",_),alert(te().hooks.failedToSaveName),u(r.name)}finally{k(!1)}}},[e,s,r,c,i,m,u,k]),b=o.useCallback(x=>{x.key==="Enter"&&x.currentTarget.blur()},[]);return{inputRef:y,isEditingName:C,editNameValue:j,editIconValue:L,isIconPickerOpen:$,setIsIconPickerOpen:R,setEditNameValue:p,handleStartEditName:M,handleSaveEditName:O,handleCancelEditName:q,handleOpenIconPicker:S,handleIconChange:n,handleSaveWorkoutName:a,handleWorkoutNameKeyDown:b}}function bt({user:e,normalizedDate:s,workout:r,exercises:c,isCardio:i,setIsCardio:d,setIsSavingCardio:m,setWorkout:u}){const k=V;return{handleToggleCardio:o.useCallback(async()=>{if(!e||!s||!r)return;const y=!i;d(y),m(!0);try{const{data:C,error:A}=await k.from("workouts").update({is_cardio:y}).eq("id",r.id).select().single();if(A)throw A;if(!C)throw new Error(te().hooks.failedToUpdateCardio);u(C);const j=`${e.id}:${s}`;X.set(j,{workout:C,exercises:c,timestamp:Date.now()})}catch(C){console.error("Failed to update cardio status:",C),alert(te().hooks.failedToSaveCardio),d(!y)}finally{m(!1)}},[e,s,r,c,i,d,m,u])}}function kt({user:e,normalizedDate:s,workout:r,workoutNotes:c,setIsSavingNotes:i}){const d=V,m=fe(c,800),u=o.useRef(c);o.useEffect(()=>{u.current=c},[c]),o.useEffect(()=>{if(!e||!s||!r||m===(r.notes??""))return;(async()=>{i(!0);try{const{error:v}=await d.from("workouts").update({notes:m||null}).eq("id",r.id);if(v)throw v;const y=`${e.id}:${s}`,C=X.get(y);C&&C.workout&&X.set(y,{...C,workout:{...C.workout,notes:m||null},timestamp:Date.now()})}catch(v){console.error("Failed to save notes:",v)}finally{i(!1)}})()},[m,e,s,r==null?void 0:r.id,i])}function vt({user:e,workout:s,setWorkout:r}){const c=V,i=o.useCallback(async()=>{if(!e||!s)return;const v=new Date().toISOString(),{error:y}=await c.from("workouts").update({start_time:v}).eq("id",s.id);if(y){console.error("Error starting workout:",y);return}r({...s,start_time:v})},[e,s,r,c]),d=o.useCallback(async()=>{if(!e||!s)return;const v=new Date().toISOString(),{error:y}=await c.from("workouts").update({end_time:v}).eq("id",s.id);if(y){console.error("Error ending workout:",y);return}r({...s,end_time:v})},[e,s,r,c]),m=o.useCallback(async v=>{if(!e||!s)return;const{error:y}=await c.from("workouts").update({start_time:v}).eq("id",s.id);if(y){console.error("Error updating start time:",y);return}r({...s,start_time:v})},[e,s,r,c]),u=o.useCallback(async v=>{if(!e||!s)return;const{error:y}=await c.from("workouts").update({end_time:v}).eq("id",s.id);if(y){console.error("Error updating end time:",y);return}r({...s,end_time:v})},[e,s,r,c]),k=o.useCallback(async()=>{if(!e||!s)return;const{error:v}=await c.from("workouts").update({start_time:null,end_time:null}).eq("id",s.id);if(v){console.error("Error clearing workout time:",v);return}r({...s,start_time:null,end_time:null})},[e,s,r,c]);return{startTime:(s==null?void 0:s.start_time)??null,endTime:(s==null?void 0:s.end_time)??null,handleStartWorkout:i,handleEndWorkout:d,handleUpdateStartTime:m,handleUpdateEndTime:u,handleClearWorkoutTime:k}}const $e=e=>e?new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"",yt=(e,s)=>{const r=new Date(e),i=new Date(s).getTime()-r.getTime(),d=Math.floor(i/(1e3*60*60)),m=Math.floor(i%(1e3*60*60)/(1e3*60)),u=Math.floor(i%(1e3*60)/1e3);return d>0?`${d}ч ${m}м ${u}с`:m>0?`${m}м ${u}с`:`${u}с`},Me=e=>{if(!e)return"";const s=new Date(e),r=c=>c.toString().padStart(2,"0");return`${r(s.getHours())}:${r(s.getMinutes())}:${r(s.getSeconds())}`},Oe=(e,s)=>{const r=s?new Date(s):new Date,[c,i,d]=e.split(":").map(Number);return r.setHours(c,i,d||0,0),r.toISOString()},_t=({startTime:e,endTime:s,onUpdateStartTime:r,onUpdateEndTime:c,onClear:i})=>{const[d,m]=o.useState(!1),[u,k]=o.useState(""),[v,y]=o.useState("");if(!e&&!s)return null;const C=()=>{k(Me(e)),y(Me(s)),m(!0)},A=()=>{u&&e&&r(Oe(u,e)),v&&s&&c(Oe(v,s)),m(!1)},j=()=>{m(!1)};return t.jsxs("div",{className:"glass card-dark p-4 space-y-2",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-lg font-semibold text-white",children:"Время тренировки"}),t.jsxs("div",{className:"flex items-center gap-1",children:[!d&&t.jsx("button",{type:"button",onClick:C,className:"p-1.5 rounded-full hover:bg-white/10 transition-colors",title:"Редактировать время",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-300",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),t.jsx("button",{type:"button",onClick:i,className:"p-1.5 rounded-full hover:bg-red-500/20 transition-colors",title:"Удалить время",children:t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]}),t.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Начало:"}),d?t.jsx("input",{type:"time",step:"1",value:u,onChange:p=>k(p.target.value),className:"bg-white/10 text-green-400 font-mono text-sm rounded px-2 py-1 focus:outline-none focus:bg-white/20"}):t.jsx("span",{className:"text-green-400 font-mono",children:$e(e)})]}),s&&t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:"Конец:"}),d?t.jsx("input",{type:"time",step:"1",value:v,onChange:p=>y(p.target.value),className:"bg-white/10 text-red-400 font-mono text-sm rounded px-2 py-1 focus:outline-none focus:bg-white/20"}):t.jsx("span",{className:"text-red-400 font-mono",children:$e(s)})]}),d&&t.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[t.jsx("button",{type:"button",onClick:j,className:"px-3 py-1 rounded bg-white/10 hover:bg-white/20 text-gray-300 text-sm transition-colors",children:"Отмена"}),t.jsx("button",{type:"button",onClick:A,className:"px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-sm transition-colors",children:"Сохранить"})]}),!d&&e&&s&&t.jsxs("div",{className:"flex justify-between pt-2 border-t border-white/10",children:[t.jsx("span",{children:"Длительность:"}),t.jsx("span",{className:"text-yellow-400 font-mono",children:yt(e,s)})]})]})]})};function Ae(e,s,r){const c=e.slice(),[i]=c.splice(s,1);return c.splice(r,0,i),c}const jt=({open:e,items:s,onClose:r,onSave:c})=>{const{t:i}=ie(),[d,m]=o.useState([]),u=o.useRef(null),[k,v]=o.useState(!1),[y,C]=o.useState(null),A=o.useRef(0),j=o.useRef(null),p=o.useMemo(()=>s.slice().sort((n,a)=>(n.position??0)-(a.position??0)),[s]);if(o.useEffect(()=>{e&&m(p)},[e,p]),He(e),!e)return null;const L=(n,a)=>{a<0||a>=d.length||m(b=>Ae(b,n,a))},D=n=>a=>{u.current=n,a.dataTransfer.effectAllowed="move"},$=n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},R=n=>a=>{a.preventDefault();const b=u.current;if(u.current=null,b==null||b===n)return;const x=d.findIndex(E=>E.id===b),_=d.findIndex(E=>E.id===n);x===-1||_===-1||m(E=>Ae(E,x,_))},M=n=>a=>{const b=a.touches[0];A.current=b.clientY,C(n)},O=n=>{if(!y)return;const b=n.touches[0].clientY,x=b-A.current,_=d.findIndex(B=>B.id===y);if(_===-1)return;const I=Math.round(x/60);if(Math.abs(I)>=1){const B=_+I;B>=0&&B<d.length&&B!==_&&(m(G=>Ae(G,_,B)),A.current=b)}},q=()=>{C(null)},S=async()=>{v(!0);try{await c(d.map((n,a)=>({...n,position:a+1}))),r()}finally{v(!1)}};return We.createPortal(t.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[t.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:r}),t.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-4",children:[t.jsx("h2",{className:"text-lg font-semibold mb-3",children:i.reorderExercises.title}),t.jsx("ol",{ref:j,className:"space-y-2 max-h-[55vh] overflow-y-auto pr-1",onTouchMove:O,onTouchEnd:q,children:d.map((n,a)=>t.jsxs("li",{draggable:!0,onDragStart:D(n.id),onDragOver:$,onDrop:R(n.id),className:`rounded-lg p-2 flex items-center gap-2 hover:bg-white/5 transition-colors ${y===n.id?"bg-white/20 scale-105":""}`,children:[t.jsxs("span",{className:"select-none w-6 text-center opacity-70",children:[a+1,"."]}),t.jsx("button",{type:"button","aria-label":i.reorderExercises.drag,className:"cursor-grab px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 active:cursor-grabbing touch-none",draggable:!0,onDragStart:D(n.id),onTouchStart:M(n.id),children:"⋮⋮"}),t.jsx("div",{className:"flex-1 whitespace-normal break-words leading-snug",children:n.name||i.reorderExercises.noName}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>L(a,a-1),disabled:a===0,children:"↑"}),t.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>L(a,a+1),disabled:a===d.length-1,children:"↓"})]})]},n.id))}),t.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[t.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:r,disabled:k,children:i.common.cancel}),t.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-primary",onClick:S,disabled:k,children:k?i.reorderExercises.saving:i.common.save})]})]})]}),document.body)},Nt=({open:e,value:s,onClose:r,onChange:c})=>{const{t:i}=ie();if(!e)return null;const d=Object.keys(De),m=u=>{c(u),r()};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:r,children:t.jsxs("div",{className:"glass card-dark p-4 rounded-xl w-[90%] max-w-sm mx-auto",onClick:u=>u.stopPropagation(),children:[t.jsx("h2",{className:"text-lg font-semibold text-white mb-4 text-center",children:i.workoutIconPicker.title}),t.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[t.jsxs("button",{type:"button",onClick:()=>m(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${s===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[t.jsx("div",{className:"w-10 h-10 flex items-center justify-center text-gray-500",children:t.jsx("svg",{viewBox:"0 0 24 24",width:"28",height:"28",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:t.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),t.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:i.workoutIconPicker.none})]}),d.map(u=>{const{component:k,label:v}=De[u],y=s===u;return t.jsxs("button",{type:"button",onClick:()=>m(u),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${y?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[t.jsx("div",{className:"w-10 h-10 flex items-center justify-center",children:t.jsx(k,{size:28})}),t.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:v})]},u)})]}),t.jsx("button",{type:"button",onClick:r,className:"mt-4 w-full py-2 text-gray-400 hover:text-white transition-colors",children:i.common.cancel})]})})},Ot=()=>{const{t:e}=ie(),s=wt(),{user:r,normalizedDate:c,location:i,workout:d,exercises:m,templates:u,isCreating:k,isSelectTemplateOpen:v,hasInitialData:y,isAddingExercise:C,workoutName:A,isSavingWorkoutName:j,isCardio:p,isSavingCardio:L,workoutIcon:D,workoutNotes:$,isSavingNotes:R,setPageState:M,setWorkout:O,setExercises:q,setIsCreating:S,setIsSelectTemplateOpen:n,setIsAddingExercise:a,setWorkoutName:b,setIsSavingWorkoutName:x,setIsCardio:_,setIsSavingCardio:E,setWorkoutNotes:I,setIsSavingNotes:B,fetchWorkoutData:G}=s,{isActionsOpen:z,menuPos:H,actionsRef:Q,actionsBtnRef:ne,toggleActions:oe,closeActions:ae}=Qe(),{handleUpdateExercise:re,handleDeleteExercise:g,handleAddExercise:T,handleCreateCustomWorkout:U,handleCreateWorkout:de,handleReplaceWithTemplate:ce,handleDeleteWorkout:h,handleSaveNewOrder:l}=xt({user:r,normalizedDate:c,workout:d,exercises:m,setPageState:M,setWorkout:O,setExercises:q,setIsCreating:S,setIsAddingExercise:a,setWorkoutName:b,setIsSelectTemplateOpen:n,fetchWorkoutData:G,isAddingExercise:C}),{inputRef:w,isEditingName:f,editNameValue:N,editIconValue:K,isIconPickerOpen:F,setIsIconPickerOpen:W,setEditNameValue:J,handleStartEditName:Z,handleSaveEditName:se,handleCancelEditName:P,handleOpenIconPicker:le,handleIconChange:_e}=gt({user:r,normalizedDate:c,workout:d,exercises:m,workoutName:A,workoutIcon:D,setWorkout:O,setWorkoutName:b,setIsSavingWorkoutName:x}),{handleToggleCardio:he}=bt({user:r,normalizedDate:c,workout:d,exercises:m,isCardio:p,setIsCardio:_,setIsSavingCardio:E,setWorkout:O});kt({user:r,normalizedDate:c,workout:d,workoutNotes:$,setIsSavingNotes:B});const{startTime:pe,endTime:je,handleStartWorkout:Ne,handleEndWorkout:we,handleUpdateStartTime:Se,handleUpdateEndTime:xe,handleClearWorkoutTime:Ce}=vt({user:r,workout:d,setWorkout:O}),[Y,ue]=o.useState(!1),[ee,me]=o.useState(!1),ke=`scroll:workout:${c??""}`,{isScrolling:ge}=ht({normalizedDate:c,exercisesLength:m.length,scrollKey:ke,location:i});return He(v),y?c?d?t.jsxs("div",{className:"relative px-4 space-y-4 pt-4 pb-10",children:[t.jsx("div",{className:`status-bar-blur ${ge?"visible":""}`}),t.jsx(lt,{normalizedDate:c,workoutName:A,isEditingName:f,editNameValue:N,isSavingWorkoutName:j,isScrolling:ge,inputRef:w,onStartEditName:Z,onChangeEditName:J,onSaveEditName:se,onCancelEditName:P,actionsRef:Q,actionsBtnRef:ne,onToggleActions:oe,workoutIcon:D,editIconValue:K,onOpenIconPicker:le}),!pe&&t.jsx("button",{type:"button",onClick:Ne,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary",children:"Старт тренировки"}),t.jsx("div",{className:"space-y-4",children:m.map(be=>t.jsx(at,{exercise:be,workoutDate:c,onUpdateExercise:re,onDeleteExercise:g},be.id))}),pe&&!je&&t.jsx("button",{type:"button",onClick:we,className:"btn-glass btn-glass-full btn-glass-md bg-red-600 hover:bg-red-700 text-white font-semibold",children:"Завершить тренировку"}),t.jsx("div",{children:t.jsx("button",{type:"button",onClick:T,disabled:C,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary text-white disabled:opacity-50",children:C?e.workout.adding:e.workout.addExercise})}),t.jsx(ut,{isCardio:p,isSaving:L,onToggle:he}),t.jsx(mt,{notes:$,isSaving:R,onChange:I}),t.jsx(_t,{startTime:pe,endTime:je,onUpdateStartTime:Se,onUpdateEndTime:xe,onClear:Ce}),t.jsx(ct,{open:v,templates:u,isCreating:k,onClose:()=>n(!1),onReplaceWithTemplate:ce}),t.jsx(jt,{open:ee,onClose:()=>me(!1),items:m.map(be=>({id:be.id,name:be.name,position:be.position??0})),onSave:l}),t.jsx(Ke,{open:Y,onOpenChange:ue,title:e.workout.deleteWorkout,description:e.workout.deleteWorkoutDesc.replace("{date}",Ee(c)),confirmText:e.common.delete,cancelText:e.common.cancel,variant:"danger",onConfirm:h}),t.jsx(Nt,{open:F,value:K,onClose:()=>W(!1),onChange:_e}),t.jsx(ft,{isOpen:z,menuPos:H,onReorder:()=>me(!0),onChangeTemplate:()=>n(!0),onDelete:()=>ue(!0),onClose:ae})]}):t.jsx(dt,{normalizedDate:c,templates:u,isCreating:k,onCreateWorkout:de,onCreateCustomWorkout:U}):null:t.jsx(Fe,{message:e.common.loading})};export{Ot as default};
