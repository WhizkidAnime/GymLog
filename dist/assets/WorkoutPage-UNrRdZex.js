import{j as e,s as U,u as Je,W as He}from"./index-BgIe2abQ.js";import{f as qe,r as o,e as Ve,c as Ke,j as dt,u as ut,L as ft}from"./vendor-BVca5W6X.js";import{u as mt}from"./usePageState-6XNG0ilq.js";import{u as $e}from"./useDebounce-C2cqH541.js";import{C as Ge}from"./confirm-dialog-Dim5dJ6T.js";import{c as Re,f as ht}from"./date-helpers-BoyNci5t.js";import{n as Pe,p as wt}from"./exercise-name-BJxyXXn3.js";import{W as Fe}from"./workout-icons-Dz0_SFCQ.js";import{u as Xe}from"./use-modal-scroll-lock-DlG-D3y9.js";import{u as pt}from"./use-workout-actions-menu-C-5wTXkz.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const gt=({set:t,previousSet:r,onChange:d,onAddDropset:_,onDeleteDropset:a,isLastInGroup:n})=>{const p=`workout_set_draft:${t.id}`,x=`workout_set_last_non_max_reps:${t.id}`,y=l=>l==null?"":String(l).replace(".",","),g=l=>{if(l==="")return null;const f=Number(l.replace(",","."));return Number.isFinite(f)?f:null},M=l=>{let f=l.replace(".",",");f=f.replace(/[^\d,]/g,"");const S=f.indexOf(",");return S!==-1&&(f=f.slice(0,S+1)+f.slice(S+1).replace(/,/g,"")),f},D="макс.",q=l=>l==null?"":l==="0"?D:l,b=l=>{const f=l.trim();if(f==="")return null;const S=f.toLowerCase();return S==="макс"||S==="макс."||/^0+$/.test(f)?"0":f},R=l=>{const f=l.trim();return f===""?"":/^0+$/.test(f)||f.toLowerCase().startsWith("макс")?D:f.replace(/[^0-9]/g,"")},j=q(t.reps),[P,B]=o.useState(y(t.weight)),[A,O]=o.useState(j),[ee,v]=o.useState(b(j)==="0"?null:j||null),[i,h]=o.useState(t.is_done),[$,te]=o.useState(!1),[X,J]=o.useState(()=>b(j)==="0"),ie=$e(P,500),Q=$e(A,500),ae=!(t.is_dropset??!1)&&!!r&&r.is_done&&r.weight!==null&&g(P)===null,ge=l=>{v(l);try{l&&l.trim()!==""?localStorage.setItem(x,l):localStorage.removeItem(x)}catch{}};o.useEffect(()=>{try{const l=localStorage.getItem(p);if(!l)return;const f=JSON.parse(l),S=new Date(t.updated_at).getTime();if(f.updatedAt>S){B(f.weight===""?"":y(f.weight));const K=q(f.reps);O(K);const se=b(K)==="0"?null:K||null;ge(se),h(f.isDone)}}catch{}},[]),o.useEffect(()=>{h(t.is_done)},[t.is_done]),o.useEffect(()=>{if(t.reps==="0")try{const l=localStorage.getItem(x);l&&l.trim()!==""&&v(l)}catch{}},[t.reps,x]);const ce=qe.useRef(d);o.useEffect(()=>{ce.current=d},[d]),o.useEffect(()=>{(async()=>{var K;const f=g(ie),S=b(Q);if(f!==(t.weight??null)||S!==(t.reps??null)||i!==t.is_done){const se={weight:f===null?"":f,reps:S,isDone:i,updatedAt:Date.now()};try{localStorage.setItem(p,JSON.stringify(se))}catch{}te(!0);const{error:oe}=await U.from("workout_sets").update({weight:f,reps:S,is_done:i,updated_at:new Date().toISOString()}).eq("id",t.id);if(oe)console.error("Error saving set:",oe);else{try{localStorage.removeItem(p)}catch{}const we={...t,weight:f,reps:S,is_done:i,updated_at:new Date().toISOString()};(K=ce.current)==null||K.call(ce,we)}setTimeout(()=>te(!1),500)}})()},[ie,Q,t.id,t.weight,t.reps,t.is_done,i,p]),o.useEffect(()=>{const l=g(ie)!==null,f=b(Q)!==null,S=l&&f;S&&!i?h(!0):!S&&i&&h(!1)},[ie,Q,i]);const le=i?"bg-green-500":"bg-transparent",he=i?"text-black":"text-inherit",de=i?"setrow-input-done-white":"",u=b(A)==="0",m=X||u,C=()=>{const l=b(A),f=l!==null&&l!=="0";if(m)u&&(ee!==null&&ee.trim()!==""?O(ee):O("")),J(!1);else{if(f){J(!0);return}b(A)!=="0"&&A.trim()!==""&&ge(A),O(D),J(!0)}},k=t.is_dropset??!1,z=i?k?k&&i?"bg-purple-500/80":"":le:k?"bg-purple-500/10 border-l-2 border-purple-500/50 ml-3":"";return e.jsxs("div",{className:`relative grid grid-cols-6 gap-3 items-center p-2 rounded-md transition-colors duration-300 ${z||le}`,children:[e.jsxs("div",{className:`col-span-1 text-center font-medium ${he} flex items-center justify-center`,children:[k&&e.jsx("span",{className:`text-xs mr-0.5 dropset-indicator ${i?"is-done":""}`,children:"↳"}),e.jsx("span",{children:k?"ДС":t.set_index}),!k&&n&&_&&e.jsx("button",{type:"button",onClick:()=>_(t.id),"aria-label":"Добавить дропсет",className:`absolute left-12 w-5 h-5 flex items-center justify-center rounded transition-colors flex-shrink-0 dropset-btn ${i?"is-done hover:bg-black/10":"hover:bg-white/10"}`,title:"Добавить дропсет",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-4 h-4",children:e.jsx("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})})})]}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"decimal",placeholder:"0",value:P,onChange:l=>B(M(l.target.value)),className:`w-[72px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${de} ${he}`})}),ae&&e.jsx("button",{type:"button",onClick:()=>{!r||r.weight===null||B(y(r.weight))},"aria-label":"Скопировать вес из предыдущего подхода",className:"btn-glass btn-glass-icon-round btn-glass-secondary absolute text-white h-6 w-6 p-0",style:{left:"50%",top:"50%",transform:"translate(-50%, -50%)",transition:"none",width:"1.5rem",height:"1.5rem",minWidth:"1.5rem",minHeight:"1.5rem",padding:0},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"12",height:"12",fill:"none",stroke:"currentColor",strokeWidth:"2.2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"5 15 12 8 19 15"})})}),e.jsx("div",{className:"col-span-2 flex justify-center",children:e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",placeholder:"0",value:A,onChange:l=>{const f=R(l.target.value);if(O(f),b(f)!=="0"){const S=f.trim()===""?null:f;ge(S)}},className:`w-[64px] p-1 text-center rounded-md border-gray-600 shadow-sm placeholder:text-gray-400 focus:placeholder-transparent outline-none focus-visible:outline-none setrow-input ${de} ${he}`})}),e.jsxs("div",{className:"col-span-1 flex items-center justify-center",children:[!k&&e.jsx("input",{type:"checkbox",checked:m,onChange:C,"aria-label":"Подход в отказ (макс.)",className:"h-6 w-6 rounded-md border border-gray-300 bg-white outline-none focus-visible:outline-none flex-shrink-0",style:{accentColor:"#000000",color:"#0a0a0a"}}),k&&e.jsxs("div",{className:"flex items-center justify-end gap-1 w-14",children:[n&&_?e.jsx("button",{type:"button",onClick:()=>_(t.id),"aria-label":"Добавить дропсет",className:`w-6 h-6 flex items-center justify-center rounded transition-colors flex-shrink-0 font-bold dropset-btn ${i?"is-done hover:bg-black/10":"hover:bg-white/20"}`,title:"Добавить дропсет",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{d:"M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"})})}):e.jsx("div",{className:"w-6 h-6 flex-shrink-0"}),a&&e.jsx("button",{type:"button",onClick:()=>a(t.id),"aria-label":"Удалить дропсет",className:`w-6 h-6 flex items-center justify-center rounded transition-colors flex-shrink-0 font-bold dropset-btn ${i?"is-done hover:bg-black/10":"hover:bg-white/20"}`,title:"Удалить дропсет",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{fillRule:"evenodd",d:"M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z",clipRule:"evenodd"})})})]})]}),$&&e.jsx("div",{className:"absolute right-2 top-2 h-2 w-2 bg-blue-500 rounded-full animate-ping"})]})},xt=qe.memo(gt,(t,r)=>{var d,_,a,n;return t.set.id===r.set.id&&t.set.weight===r.set.weight&&t.set.reps===r.set.reps&&t.set.is_done===r.set.is_done&&t.set.set_index===r.set.set_index&&t.set.updated_at===r.set.updated_at&&t.set.is_dropset===r.set.is_dropset&&t.set.parent_set_index===r.set.parent_set_index&&((d=t.previousSet)==null?void 0:d.weight)===((_=r.previousSet)==null?void 0:_.weight)&&((a=t.previousSet)==null?void 0:a.is_done)===((n=r.previousSet)==null?void 0:n.is_done)&&t.isLastInGroup===r.isLastInGroup&&t.onAddDropset===r.onAddDropset&&t.onDeleteDropset===r.onDeleteDropset}),We=()=>{try{const t=localStorage.getItem("settings:timerStep");return t?Number(t):30}catch{return 30}},bt=({restSeconds:t,exerciseId:r,onAdjustRestSeconds:d,timerStep:_})=>{const a=r?`rest_timer:${r}`:void 0,[n,p]=o.useState(()=>_??We());o.useEffect(()=>{if(_!==void 0)p(_);else{const v=()=>{p(We())};window.addEventListener("storage",v);const i=()=>{p(We())};return window.addEventListener("focus",i),()=>{window.removeEventListener("storage",v),window.removeEventListener("focus",i)}}},[_]);const x=o.useRef(null),y=o.useRef(t),g=o.useRef({time:t,isActive:!1,endAt:null}),[M,D]=o.useState(()=>{if(!a)return{time:t,isActive:!1,endAt:null};try{const v=localStorage.getItem(a);if(!v)return{time:t,isActive:!1,endAt:null};const i=JSON.parse(v),h=360*60*1e3;if(Date.now()-i.savedAt>h)return localStorage.removeItem(a),{time:t,isActive:!1,endAt:null};if(i.isActive&&i.endAt){const $=Math.max(0,Math.floor((i.endAt-Date.now())/1e3));return $>0?{time:$,isActive:!0,endAt:i.endAt}:(localStorage.removeItem(a),{time:i.restSeconds,isActive:!1,endAt:null})}return{time:i.restSeconds,isActive:!1,endAt:null}}catch(v){return console.error("Error restoring timer state:",v),{time:t,isActive:!1,endAt:null}}}),{time:q,isActive:b,endAt:R}=M,j=o.useCallback((v,i)=>{if(a)try{const h={endAt:v.endAt,isActive:v.isActive,restSeconds:i??g.current.time??t,savedAt:Date.now()};localStorage.setItem(a,JSON.stringify(h))}catch(h){console.error("Error persisting timer:",h)}},[a,t]),P=o.useRef(j);o.useEffect(()=>{P.current=j},[j]),o.useEffect(()=>{g.current={time:q,isActive:b,endAt:R}},[q,b,R]),o.useEffect(()=>{if(!b||!R){x.current&&(window.clearInterval(x.current),x.current=null);return}let v=!1;const i=()=>{if(v)return;const $=Date.now(),te=Math.max(0,R-$),X=Math.floor(te/1e3);D(J=>({...J,time:X})),X<=0&&(v=!0,D(J=>({...J,isActive:!1,endAt:null,time:t})),x.current&&(window.clearInterval(x.current),x.current=null),a&&localStorage.removeItem(a))};i();const h=window.setInterval(i,1e3);return x.current=h,()=>{v=!0,x.current&&(window.clearInterval(x.current),x.current=null)}},[b,R,a,t]),o.useEffect(()=>{!b&&t!==y.current&&D(v=>({...v,time:t})),y.current=t},[t,b]),o.useEffect(()=>()=>{x.current&&(window.clearInterval(x.current),x.current=null);const{isActive:v,endAt:i}=g.current;v&&i&&P.current({endAt:i,isActive:!0})},[]);const B=()=>{D(v=>{if(v.isActive)return j({endAt:null,isActive:!1},v.time),x.current&&(window.clearInterval(x.current),x.current=null),{time:v.time,isActive:!1,endAt:null};const i=Date.now()+v.time*1e3;return j({endAt:i,isActive:!0},v.time),{time:v.time,isActive:!0,endAt:i}})},A=()=>{D({time:t,isActive:!1,endAt:null}),x.current&&(window.clearInterval(x.current),x.current=null),a&&localStorage.removeItem(a)},O=v=>{D(i=>{const h=Math.max(0,i.time+v);if(h===0)return j({endAt:null,isActive:!1},0),x.current&&(window.clearInterval(x.current),x.current=null),{time:0,isActive:!1,endAt:null};if(i.isActive){const $=Date.now()+h*1e3;return j({endAt:$,isActive:!0},h),{time:h,isActive:!0,endAt:$}}return j({endAt:null,isActive:!1},h),{time:h,isActive:!1,endAt:null}}),d==null||d(v)},ee=v=>{const i=Math.floor(v/60),h=v%60;return`${i}:${h<10?"0":""}${h}`};return e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:()=>O(-n),disabled:q<=0&&!b,className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"-"}),e.jsx("div",{className:`text-6xl font-mono font-semibold leading-none min-w-[4ch] text-center ${b?"text-white":""}`,children:ee(q)}),e.jsx("button",{onClick:()=>O(n),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-3",children:[e.jsx("button",{onClick:B,className:`btn-glass btn-glass-icon-lg ${b?"btn-glass-danger":"btn-glass-primary"}`,children:b?"Стоп":"Старт"}),e.jsx("button",{onClick:A,className:"btn-glass btn-glass-icon-sm btn-glass-secondary",children:"Сброс"})]})]})},kt=7200*1e3,Be=new Map,vt=(t,r,d)=>`${t}:${r}:${d||"none"}`,_t=t=>{const r=Be.get(t);if(!r)return;if(Date.now()-r.timestamp>kt){Be.delete(t);return}return r.data},Ae=(t,r)=>{Be.set(t,{data:r,timestamp:Date.now()})},yt=({exercise:t,workoutDate:r,onUpdateExercise:d,onDeleteExercise:_})=>{var de;const[a,n]=o.useState(t.name),[p,x]=o.useState(t.sets),[y,g]=o.useState(t.rest_seconds),[M,D]=o.useState(!1),[q,b]=o.useState(null),[R,j]=o.useState("idle"),P=o.useRef(null),{user:B}=Je(),A=$e(a,500),O=$e(y,500),[ee,v]=o.useState(!1),i=o.useRef(t.name),h=o.useRef(t);o.useEffect(()=>{h.current=t},[t]);const $=o.useCallback(()=>{const u=P.current;u&&(u.style.height="auto",u.style.height=`${u.scrollHeight}px`)},[]);o.useEffect(()=>{t.name!==i.current&&(n(t.name),i.current=t.name),x(t.sets),g(t.rest_seconds)},[t.id,t.sets,t.rest_seconds]),o.useEffect(()=>{if(!B)return;const u=A.trim(),m=Pe(u);if(!m){b(null),j("idle");return}const C=vt(B.id,m,r??null),k=_t(C);if(k!==void 0){b(k),j("ready");return}let T=!1;return j("loading"),(async()=>{try{let z=U.from("workouts").select("id, workout_date, name, user_id").eq("user_id",B.id);r&&(z=z.lt("workout_date",r));const{data:l,error:f}=await z.order("workout_date",{ascending:!0});if(T)return;if(f)throw f;const S=(l||[]).map(I=>({id:I.id,date:I.workout_date,name:I.name})),K=new Map;S.forEach(I=>K.set(I.id,{date:I.date,name:I.name}));const se=S.map(I=>I.id);if(se.length===0){b(null),Ae(C,null),j("ready");return}const{data:oe,error:we}=await U.from("workout_exercises").select("id, name, workout_id").in("workout_id",se);if(T)return;if(we)throw we;const fe=new Set,be=new Map;if((oe||[]).forEach(I=>{const ke=(I.name??"").trim();if(ke&&Pe(ke)===m){const Z=I.id;fe.add(Z);const ve=I.workout_id;ve&&be.set(Z,ve)}}),fe.size===0){b(null),Ae(C,null),j("ready");return}const{data:Te,error:Se}=await U.from("exercise_progress_view").select("workout_date, workout_name, workout_id, exercise_id, max_weight, reps_at_max_weight").in("workout_id",se).in("exercise_id",Array.from(fe));if(T)return;if(Se)throw Se;let _e=(Te||[]).map(I=>({workout_date:I.workout_date,workout_name:I.workout_name,workout_id:I.workout_id,exercise_id:I.exercise_id,max_weight:I.max_weight,reps_at_max_weight:I.reps_at_max_weight}));if(_e.length===0){const{data:I,error:ke}=await U.from("workout_sets").select("id, workout_exercise_id, weight, reps, is_done, updated_at").in("workout_exercise_id",Array.from(fe)).order("updated_at",{ascending:!1});if(T)return;if(ke)throw ke;_e=(I||[]).filter(Z=>Z.weight!==null&&Number(Z.weight)===0).filter(Z=>Z.is_done||typeof Z.reps=="string"&&Z.reps.trim()!=="").map(Z=>{const ve=Z.workout_exercise_id,Ie=be.get(ve);if(!Ie)return null;const De=K.get(Ie);return De?{workout_date:De.date,workout_name:De.name,workout_id:Ie,exercise_id:ve,max_weight:0,reps_at_max_weight:Z.reps}:null}).filter(Z=>Z!==null)}if(_e.length===0){b(null),Ae(C,null),j("ready");return}const Ee=wt(u,_e),ye=Ee.dataPoints[Ee.dataPoints.length-1];if(!ye){b(null),Ae(C,null),j("ready");return}const Ce={weight:ye.weight,reps:ye.reps,workoutDate:ye.date};b(Ce),Ae(C,Ce),j("ready")}catch(z){console.error("Failed to fetch last exercise performance",z),j("error")}})(),()=>{T=!0}},[A,B,r]),o.useLayoutEffect(()=>{$()},[$,a]),o.useLayoutEffect(()=>{if(typeof ResizeObserver>"u")return;const u=P.current;if(!u)return;const m=new ResizeObserver(()=>{$()});return m.observe(u),()=>m.disconnect()},[$]),o.useEffect(()=>{(async()=>{if(!(A.trim()===""||A===t.name))try{await U.from("workout_exercises").update({name:A}).eq("id",t.id);const m={...t,name:A};i.current=A,d(m)}catch(m){console.error("Failed to update exercise name",m)}})()},[A]),o.useEffect(()=>{(async()=>{if(O!==t.rest_seconds)try{await U.from("workout_exercises").update({rest_seconds:O}).eq("id",t.id);const m={...t,rest_seconds:O};d(m)}catch(m){console.error("Failed to update rest seconds",m)}})()},[O,t,d]);const te=u=>{g(m=>Math.max(0,m+u))},X=async u=>{if(!(u<1||u===p||M)){D(!0);try{if(u>p){const m=Array.from({length:u-p},(z,l)=>({workout_exercise_id:t.id,set_index:p+l+1,is_dropset:!1})),{data:C,error:k}=await U.from("workout_sets").insert(m).select();if(k)throw k;const T=[...t.workout_sets,...C||[]].sort((z,l)=>{const f=z.is_dropset??!1,S=l.is_dropset??!1,K=f?z.parent_set_index??z.set_index:z.set_index,se=S?l.parent_set_index??l.set_index:l.set_index;return K!==se?K-se:f!==S?f?1:-1:z.set_index-l.set_index});await U.from("workout_exercises").update({sets:u}).eq("id",t.id);const ue={...t,sets:u,workout_sets:T};d(ue)}else{const C=t.workout_sets.filter(l=>!l.is_dropset&&l.set_index>u).map(l=>l.id),k=new Set(C);let T=0;for(const l of t.workout_sets){if(!l.is_dropset&&l.set_index>u){k.add(l.id);let f=T+1;for(;f<t.workout_sets.length&&t.workout_sets[f].is_dropset;)k.add(t.workout_sets[f].id),f++}T++}if(k.size>0){const{error:l}=await U.from("workout_sets").delete().in("id",Array.from(k));if(l)throw l}const ue=t.workout_sets.filter(l=>!k.has(l.id));await U.from("workout_exercises").update({sets:u}).eq("id",t.id);const z={...t,sets:u,workout_sets:ue};d(z)}x(u)}catch(m){console.error("Failed to change sets count",m),alert("Не удалось изменить количество подходов")}finally{D(!1)}}},J=async()=>{const{error:u}=await U.from("workout_sets").delete().eq("workout_exercise_id",t.id);if(u){console.error("Failed to delete sets of exercise",u),alert("Не удалось удалить подходы упражнения. Попробуйте снова.");return}const{error:m}=await U.from("workout_exercises").delete().eq("id",t.id);if(m){console.error("Failed to delete exercise",m),alert("Не удалось удалить упражнение. Попробуйте снова.");return}_&&_(t.id)},ie="макс.",Q=u=>u==null?"—":String(u).replace(".",","),ne=u=>{if(u==null)return"—";const m=u.trim();return m?m==="0"?ie:m:"—"},ae=()=>a.trim()?R==="loading"?e.jsx("span",{className:"text-gray-400",children:"Поиск последнего результата…"}):R==="error"?e.jsx("span",{className:"text-red-300",children:"Не удалось загрузить данные"}):q?e.jsxs("span",{className:"text-white text-base font-semibold",children:[Q(q.weight)," кг × ",ne(q.reps)]}):e.jsx("span",{className:"text-gray-500",children:"До этой даты нет данных по этому упражнению"}):e.jsx("span",{className:"text-gray-500",children:"Введите название, чтобы увидеть прошлый результат"}),ge=o.useCallback(u=>{const m=h.current,C={...m,workout_sets:m.workout_sets.map(k=>k.id===u.id?u:k)};d(C)},[d]),ce=o.useCallback(async u=>{const m=h.current,C=m.workout_sets.findIndex(T=>T.id===u);if(C===-1)return;const k=m.workout_sets[C];try{const T=k.is_dropset?k.parent_set_index??k.set_index:k.set_index,z=Math.max(...m.workout_sets.map(oe=>oe.set_index))+1,{data:l,error:f}=await U.from("workout_sets").insert({workout_exercise_id:m.id,set_index:z,weight:null,reps:null,is_done:!1,is_dropset:!0,parent_set_index:T,updated_at:new Date().toISOString()}).select().single();if(f)throw f;let S=C+1;for(;S<m.workout_sets.length&&m.workout_sets[S].is_dropset;)S++;const K=[...m.workout_sets];K.splice(S,0,l);const se={...m,workout_sets:K};d(se)}catch(T){console.error("Failed to add dropset",T),alert("Не удалось добавить дропсет")}},[d]),le=o.useCallback(async u=>{const m=h.current,C=m.workout_sets.find(k=>k.id===u);if(!(!C||!C.is_dropset))try{const{error:k}=await U.from("workout_sets").delete().eq("id",u);if(k)throw k;const T={...m,workout_sets:m.workout_sets.filter(ue=>ue.id!==u)};d(T)}catch(k){console.error("Failed to delete dropset",k),alert("Не удалось удалить дропсет")}},[d]),he=o.useCallback((u,m,C)=>{const k=C[m+1];return u.is_dropset,!k||!k.is_dropset},[]);return e.jsxs("div",{id:`exercise-${t.id}`,className:"glass card-dark p-4 exercise-card",children:[e.jsxs("div",{className:"exercise-card-header mb-3",children:[e.jsxs("div",{className:"name-wrap relative",children:[e.jsx("textarea",{value:a,onChange:u=>n(u.target.value),ref:P,rows:1,className:"w-full text-base sm:text-lg font-bold text-white whitespace-pre-wrap bg-white/10 hover:bg-white/15 focus:bg-white/10 border border-white/20 hover:border-white/30 focus:border-white/50 focus:ring-2 focus:ring-white/25 focus:outline-none rounded-xl px-4 pr-9 py-3 min-h-[3rem] resize-none overflow-y-hidden leading-relaxed transition-colors"}),a&&a.trim()!==""&&e.jsx("button",{type:"button",onClick:()=>{n(""),requestAnimationFrame(()=>$())},"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("button",{"aria-label":"Удалить упражнение",className:"delete-btn btn-glass btn-glass-icon btn-glass-outline",onClick:()=>v(!0),type:"button",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M8 6l1-2h6l1 2"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"})]})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-2xl bg-white/5 px-4 py-3 text-xs sm:text-sm text-gray-300",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between gap-3",children:[e.jsx("span",{className:"font-semibold text-white",children:"Последний рабочий вес"}),(q==null?void 0:q.workoutDate)&&e.jsx("span",{className:"text-[0.7rem] uppercase tracking-wide text-gray-400",children:Re(q.workoutDate)})]}),ae()]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(bt,{restSeconds:y,exerciseId:t.id,onAdjustRestSeconds:te})}),e.jsxs("div",{className:"flex items-center justify-between text-sm py-3 sm:py-4 px-2 rounded-lg exercise-row-header",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"whitespace-nowrap font-medium",children:"Подходы:"}),e.jsxs("div",{className:"inline-flex items-center gap-2",children:[e.jsx("button",{disabled:M||p<=1,onClick:()=>X(p-1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"−"}),e.jsx("span",{className:"min-w-[3ch] text-center text-white font-semibold",children:p}),e.jsx("button",{disabled:M||p>=30,onClick:()=>X(p+1),className:"btn-glass btn-glass-icon-round btn-glass-secondary",children:"+"})]})]}),((de=t.reps)==null?void 0:de.trim())&&e.jsxs("div",{className:"ml-3 flex-1 text-right whitespace-nowrap font-medium",children:["Повторы: ",t.reps]})]})]}),e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-3 text-sm sm:text-base font-semibold px-2 sm:px-3 py-2 rounded-lg overflow-hidden exercise-sets-header",children:[e.jsx("div",{className:"col-span-1 flex items-center justify-start pl-1 sm:pl-2 whitespace-nowrap",children:"Подход"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Вес (кг)"}),e.jsx("div",{className:"col-span-2 flex items-center justify-center whitespace-nowrap",children:"Повторы"}),e.jsx("div",{className:"col-span-1 flex items-center justify-end pr-1 sm:pr-2 whitespace-nowrap",children:"В отказ"})]}),e.jsx("div",{className:"space-y-2",children:t.workout_sets.map((u,m,C)=>{let k;if(!u.is_dropset){for(let T=m-1;T>=0;T--)if(!C[T].is_dropset){k=C[T];break}}return e.jsx(xt,{set:u,previousSet:k,onChange:ge,onAddDropset:ce,onDeleteDropset:le,isLastInGroup:he(u,m,C)},u.id)})})]}),e.jsx(Ge,{open:ee,onOpenChange:v,title:"Удалить упражнение?",description:t.name?`Вы собираетесь удалить упражнение "${t.name}". Действие необратимо.`:"Вы собираетесь удалить упражнение. Действие необратимо.",cancelText:"Отмена",variant:"danger",onConfirm:J})]})},jt=qe.memo(yt,(t,r)=>{const d=t.exercise,_=r.exercise;if(d.id!==_.id||d.name!==_.name||d.sets!==_.sets||d.rest_seconds!==_.rest_seconds||d.reps!==_.reps||t.workoutDate!==r.workoutDate||d.workout_sets.length!==_.workout_sets.length)return!1;for(let a=0;a<d.workout_sets.length;a++){const n=d.workout_sets[a],p=_.workout_sets[a];if(n.id!==p.id||n.weight!==p.weight||n.reps!==p.reps||n.is_done!==p.is_done||n.is_dropset!==p.is_dropset||n.parent_set_index!==p.parent_set_index)return!1}return!0}),Qe=({normalizedDate:t,className:r=""})=>{const d=Ve();return e.jsx("button",{onClick:()=>d("/calendar",{state:{refreshDate:t}}),className:`inline-flex items-center justify-center p-2 rounded-full border border-transparent text-white transition-colors z-10 bg-transparent hover:border-white active:border-white focus:outline-none back-button-plain ${r}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})},Nt=({normalizedDate:t,workoutName:r,isEditingName:d,editNameValue:_,isSavingWorkoutName:a,isScrolling:n,inputRef:p,onStartEditName:x,onChangeEditName:y,onSaveEditName:g,onCancelEditName:M,actionsRef:D,actionsBtnRef:q,onToggleActions:b,workoutIcon:R,editIconValue:j,onOpenIconPicker:P})=>{const B=d?j:R,A=B?Fe[B]:null;return e.jsxs("div",{className:`glass card-dark p-4 flex items-center gap-4 header-container ${n?"scrolling":""}`,children:[e.jsx(Qe,{normalizedDate:t,className:"shrink-0"}),e.jsx("div",{className:"flex-1 text-center",children:d?e.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:P,disabled:a,className:"shrink-0 w-12 h-12 flex items-center justify-center rounded-lg bg-white/10 hover:bg-white/20 transition-colors disabled:opacity-50",title:"Выбрать иконку",children:A?e.jsx(A.component,{size:28}):e.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",className:"text-gray-400",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"}),e.jsx("path",{d:"M12 8v8M8 12h8"})]})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:p,type:"text",value:_,onChange:O=>y(O.target.value),disabled:a,className:"w-full bg-white/10 text-lg font-bold text-white placeholder:text-gray-500 focus:outline-none focus:bg-white/20 rounded-md px-3 pr-9 py-2 transition-colors disabled:opacity-70",placeholder:"Название тренировки"}),_&&e.jsx("button",{type:"button",onClick:()=>y(""),"aria-label":"Очистить",className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-white/10 text-gray-300",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:g,disabled:a,className:"shrink-0 p-1.5 rounded-full hover:bg-green-500/20 transition-colors disabled:opacity-50",title:"Сохранить",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:M,disabled:a,className:"shrink-0 p-1.5 rounded-full hover:bg-red-500/20 transition-colors disabled:opacity-50",title:"Отмена",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[A&&e.jsx("div",{className:"shrink-0 w-10 h-10 flex items-center justify-center",children:e.jsx(A.component,{size:32})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-white",children:r}),e.jsxs("p",{className:"text-md transition-all duration-300 workout-date-text",children:["Дата: ",Re(t)]})]}),e.jsx("button",{onClick:x,className:"shrink-0 p-1.5 rounded-full hover:bg-white/10 transition-colors",title:"Редактировать название",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})})]})}),e.jsx("div",{className:"relative",ref:D,children:e.jsx("button",{ref:q,type:"button","aria-label":"Меню действий",className:"inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10",onClick:b,children:e.jsxs("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[e.jsx("circle",{cx:"12",cy:"5",r:"1"}),e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})})]})},St=({open:t,templates:r,isCreating:d,onClose:_,onReplaceWithTemplate:a})=>t?Ke.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:_}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Выберите шаблон"}),e.jsx("button",{onClick:_,className:"px-2 py-1 text-sm text-gray-300 hover:text-white",children:"✕"})]}),r.length===0?e.jsx("p",{className:"text-gray-400",children:"Нет доступных шаблонов."}):e.jsx("div",{className:"space-y-2 max-h-[70vh] overflow-y-auto overscroll-contain pr-1",children:r.map(n=>e.jsx("button",{onClick:()=>a(n),disabled:d,className:"w-full text-left px-4 py-2 rounded-md border border-white/20 text-gray-100 hover:bg-white/5 disabled:opacity-50",children:d?"Применение...":n.name},n.id))})]})]}),document.body):null;function Et({normalizedDate:t,exercisesLength:r,scrollKey:d,location:_}){const[a,n]=o.useState(!1),p=o.useRef(!1),x=o.useRef(0),y=o.useRef(!1),g=o.useRef(!1);return o.useEffect(()=>{y.current=!1,g.current=!1},[t,_.key]),o.useEffect(()=>{if(!t||r===0||g.current)return;const M=()=>{var ee;const b=(ee=_.state)==null?void 0:ee.focusExerciseId;if(!b||y.current)return!1;const R=document.getElementById(`exercise-${b}`);if(!R)return!1;y.current=!0,p.current=!0;const j=document.querySelector(".header-container"),P=j?j.getBoundingClientRect().bottom:0,B=12,A=R.getBoundingClientRect(),O=Math.max(0,window.scrollY+A.top-P-B);return window.scrollTo({top:O,behavior:"smooth"}),R.animate&&R.animate([{boxShadow:"0 0 0 rgba(59,130,246,0)"},{boxShadow:"0 0 0 4px rgba(59,130,246,0.6)"},{boxShadow:"0 0 0 rgba(59,130,246,0)"}],{duration:1200,easing:"ease-in-out"}),setTimeout(()=>{p.current=!1},600),!0},D=()=>{try{const b=localStorage.getItem(d);if(b){const R=parseInt(b,10);Number.isNaN(R)||(p.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{window.scrollTo({top:R,behavior:"auto"}),x.current=R,setTimeout(()=>{p.current=!1},100)})}))}}catch(b){console.error("Error restoring scroll:",b)}};M()||D(),g.current=!0},[t,r,d,_.state]),o.useEffect(()=>{if(!t)return;let M=!1;const D=()=>{x.current=window.scrollY,n(window.scrollY>0),!M&&!p.current&&(window.requestAnimationFrame(()=>{try{localStorage.setItem(d,String(x.current))}catch{}M=!1}),M=!0)};return window.addEventListener("scroll",D,{passive:!0}),()=>window.removeEventListener("scroll",D)},[t,d]),o.useEffect(()=>()=>{if(t&&x.current>0)try{localStorage.setItem(d,String(x.current))}catch{}},[t,d]),{isScrolling:a}}function Oe(t,r,d){const _=t.slice(),[a]=_.splice(r,1);return _.splice(d,0,a),_}const Ct=({open:t,items:r,onClose:d,onSave:_})=>{const[a,n]=o.useState([]),p=o.useRef(null),[x,y]=o.useState(!1),[g,M]=o.useState(null),D=o.useRef(0),q=o.useRef(null),b=o.useMemo(()=>r.slice().sort((i,h)=>(i.position??0)-(h.position??0)),[r]);if(o.useEffect(()=>{t&&n(b)},[t,b]),Xe(t),!t)return null;const R=(i,h)=>{h<0||h>=a.length||n($=>Oe($,i,h))},j=i=>h=>{p.current=i,h.dataTransfer.effectAllowed="move"},P=i=>{i.preventDefault(),i.dataTransfer.dropEffect="move"},B=i=>h=>{h.preventDefault();const $=p.current;if(p.current=null,$==null||$===i)return;const te=a.findIndex(J=>J.id===$),X=a.findIndex(J=>J.id===i);te===-1||X===-1||n(J=>Oe(J,te,X))},A=i=>h=>{const $=h.touches[0];D.current=$.clientY,M(i)},O=i=>{if(!g)return;const $=i.touches[0].clientY,te=$-D.current,X=a.findIndex(Q=>Q.id===g);if(X===-1)return;const ie=Math.round(te/60);if(Math.abs(ie)>=1){const Q=X+ie;Q>=0&&Q<a.length&&Q!==X&&(n(ne=>Oe(ne,X,Q)),D.current=$)}},ee=()=>{M(null)},v=async()=>{y(!0);try{await _(a.map((i,h)=>({...i,position:h+1}))),d()}finally{y(!1)}};return Ke.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 overscroll-contain",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60",onClick:d}),e.jsxs("div",{className:"relative w-full max-w-md glass card-dark rounded-xl shadow-xl p-4",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Порядок упражнений"}),e.jsx("ol",{ref:q,className:"space-y-2 max-h-[55vh] overflow-y-auto pr-1",onTouchMove:O,onTouchEnd:ee,children:a.map((i,h)=>e.jsxs("li",{draggable:!0,onDragStart:j(i.id),onDragOver:P,onDrop:B(i.id),className:`rounded-lg p-2 flex items-center gap-2 hover:bg-white/5 transition-colors ${g===i.id?"bg-white/20 scale-105":""}`,children:[e.jsxs("span",{className:"select-none w-6 text-center opacity-70",children:[h+1,"."]}),e.jsx("button",{type:"button","aria-label":"Перетащить",className:"cursor-grab px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 active:cursor-grabbing touch-none",draggable:!0,onDragStart:j(i.id),onTouchStart:A(i.id),children:"⋮⋮"}),e.jsx("div",{className:"flex-1 whitespace-normal break-words leading-snug",children:i.name||"Без названия"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>R(h,h-1),disabled:h===0,children:"↑"}),e.jsx("button",{type:"button",className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:()=>R(h,h+1),disabled:h===a.length-1,children:"↓"})]})]},i.id))}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-secondary",onClick:d,disabled:x,children:"Отмена"}),e.jsx("button",{className:"btn-glass btn-glass-sm btn-glass-primary",onClick:v,disabled:x,children:x?"Сохранение…":"Сохранить"})]})]})]}),document.body)},It=({open:t,value:r,onClose:d,onChange:_})=>{if(!t)return null;const a=Object.keys(Fe),n=p=>{_(p),d()};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm",onClick:d,children:e.jsxs("div",{className:"glass card-dark p-4 rounded-xl w-[90%] max-w-sm mx-auto",onClick:p=>p.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4 text-center",children:"Выберите иконку"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>n(null),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${r===null?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center text-gray-500",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"28",height:"28",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("circle",{cx:"12",cy:"12",r:"9",strokeDasharray:"4 2"})})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-400",children:"Нет"})]}),a.map(p=>{const{component:x,label:y}=Fe[p],g=r===p;return e.jsxs("button",{type:"button",onClick:()=>n(p),className:`flex flex-col items-center justify-center p-2 rounded-lg transition-all ${g?"bg-white/20 ring-2 ring-white/50":"bg-white/5 hover:bg-white/10"}`,children:[e.jsx("div",{className:"w-10 h-10 flex items-center justify-center",children:e.jsx(x,{size:28})}),e.jsx("span",{className:"text-[10px] mt-1 text-gray-300",children:y})]},p)})]}),e.jsx("button",{type:"button",onClick:d,className:"mt-4 w-full py-2 text-gray-400 hover:text-white transition-colors",children:"Отмена"})]})})},G=new Map,Ye=3e4,Dt=t=>{if(!t)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const r=new Date(t);return Number.isNaN(r.getTime())?null:ht(r)},zt=()=>{const{date:t}=dt(),{user:r}=Je(),d=Ve(),_=ut(),a=U,n=o.useMemo(()=>Dt(t),[t]),p=n?`workout-page:${n}`:"workout-page",[x,y]=mt({key:p,initialState:{workout:null,exercises:[],templates:[],loading:!0,isCreating:!1,isSelectTemplateOpen:!1,hasInitialData:!1,isAddingExercise:!1,workoutName:"",isSavingWorkoutName:!1,isCardio:!1,isSavingCardio:!1,workoutIcon:null,workoutNotes:"",isSavingNotes:!1},ttl:1800*1e3}),{workout:g,exercises:M,templates:D,loading:q,isCreating:b,isSelectTemplateOpen:R,hasInitialData:j,isAddingExercise:P,workoutName:B,isSavingWorkoutName:A,isCardio:O,isSavingCardio:ee,workoutIcon:v,workoutNotes:i,isSavingNotes:h}=x,{isActionsOpen:$,menuPos:te,actionsRef:X,actionsBtnRef:J,toggleActions:ie,closeActions:Q}=pt(),ne=s=>y(c=>({...c,workout:s,workoutName:(s==null?void 0:s.name)??"",isSavingWorkoutName:!1,isCardio:(s==null?void 0:s.is_cardio)??!1,isSavingCardio:!1,workoutIcon:(s==null?void 0:s.icon)??null,workoutNotes:(s==null?void 0:s.notes)??"",isSavingNotes:!1})),ae=s=>y(c=>({...c,exercises:typeof s=="function"?s(c.exercises):s})),ge=s=>y(c=>({...c,templates:typeof s=="function"?s(c.templates):s})),ce=s=>y(c=>({...c,loading:s})),le=s=>y(c=>({...c,isCreating:s})),he=s=>y(c=>({...c,isSelectTemplateOpen:s})),de=s=>y(c=>({...c,hasInitialData:s})),u=s=>y(c=>({...c,isAddingExercise:s})),m=s=>y(c=>({...c,workoutName:s})),C=s=>y(c=>({...c,isSavingWorkoutName:s})),k=s=>y(c=>({...c,isCardio:s})),T=s=>y(c=>({...c,isSavingCardio:s})),ue=s=>y(c=>({...c,workoutNotes:s})),z=s=>y(c=>({...c,isSavingNotes:s})),[l,f]=o.useState(!1),[S,K]=o.useState(!1),[se,oe]=o.useState(B),[we,fe]=o.useState(v),be=o.useRef(null),[Te,Se]=o.useState(!1),[_e,Ee]=o.useState(!1),ye=`scroll:workout:${n??""}`,{isScrolling:Ce}=Et({normalizedDate:n,exercisesLength:M.length,scrollKey:ye,location:_});Xe(R);const I=o.useCallback(async(s=!1,c=!1)=>{if(!r||!n){ne(null),ae([]),ce(!1),de(!0);return}const N=`${r.id}:${n}`,w=Date.now();if(G.has(N)){const F=G.get(N),V=w-F.timestamp;if(s&&V<Ye){j||(ne(F.workout),ae(F.exercises),ce(!1),de(!0));return}V>=Ye&&(j||(ne(F.workout),ae(F.exercises),de(!0)),c=!0)}c||ce(!0);const{data:E,error:H}=await a.from("workouts").select("*").eq("user_id",r.id).eq("workout_date",n).order("created_at",{ascending:!1}).limit(1);let L=(E==null?void 0:E[0])??null;if(H)console.error("Error fetching workout:",H);else if(L){if(L.template_id&&!L.icon)try{const{data:W}=await a.from("workout_templates").select("icon").eq("id",L.template_id).single();W!=null&&W.icon&&(L={...L,icon:W.icon},a.from("workouts").update({icon:W.icon}).eq("id",L.id).then(()=>{},()=>{}))}catch{}ne(L);const{data:F,error:V}=await a.from("workout_exercises").select("id, name, sets, reps, rest_seconds, position, workout_id, workout_sets ( id, workout_exercise_id, set_index, weight, reps, is_done, is_dropset, parent_set_index, updated_at )").eq("workout_id",L.id).order("position");if(V)console.error("Error fetching exercises:",V);else{const W=F||[];W.forEach(me=>{me.workout_sets&&me.workout_sets.sort((pe,xe)=>{const je=pe.is_dropset??!1,Me=xe.is_dropset??!1,Y=je?pe.parent_set_index??pe.set_index:pe.set_index,Ne=Me?xe.parent_set_index??xe.set_index:xe.set_index;return Y!==Ne?Y-Ne:je!==Me?je?1:-1:pe.set_index-xe.set_index})}),ae(W),G.set(N,{workout:L,exercises:W,timestamp:w})}}else ne(null),ae([]),G.set(N,{workout:null,exercises:[],timestamp:w});const re=r?`templates-cache:${r.id}`:void 0;if(re)try{const F=localStorage.getItem(re);if(F){const V=JSON.parse(F);V.data&&ge(V.data)}}catch{}a.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).then(({data:F,error:V})=>{if(V)console.error("Error fetching templates:",V.message);else if(ge(F||[]),re)try{localStorage.setItem(re,JSON.stringify({ts:Date.now(),data:F}))}catch{}}),ce(!1),de(!0)},[r,n,j]);o.useEffect(()=>{I()},[I]),o.useEffect(()=>{const s=()=>{document.visibilityState==="visible"&&I(!0)};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[I]),o.useEffect(()=>{n&&(localStorage.setItem("lastWorkoutPath",`/workout/${n}`),localStorage.setItem("lastWorkoutTimestamp",Date.now().toString()))},[n]),o.useEffect(()=>{S&&be.current&&(be.current.focus(),be.current.select())},[S]);const ke=o.useCallback(s=>{y(c=>{const N=c.exercises.map(w=>w.id===s.id?s:w);if(r&&n&&c.workout){const w=`${r.id}:${n}`;G.set(w,{workout:c.workout,exercises:N,timestamp:Date.now()})}return{...c,exercises:N}})},[r,n]),Z=o.useCallback(s=>{y(c=>{const N=c.exercises.filter(w=>w.id!==s);if(r&&n&&c.workout){const w=`${r.id}:${n}`;G.set(w,{workout:c.workout,exercises:N,timestamp:Date.now()})}return{...c,exercises:N}})},[r,n]),ve=async()=>{if(!(!r||!n||!g||P)){u(!0);try{const s=M.length>0?Math.max(...M.map(F=>typeof F.position=="number"?F.position:0))+1:1,{data:c,error:N}=await a.from("workout_exercises").insert({workout_id:g.id,name:"",sets:1,reps:"",rest_seconds:150,position:s}).select("id, name, sets, reps, rest_seconds, position, workout_id");if(N)throw N;const w=c==null?void 0:c[0];if(!w)throw new Error("Не удалось создать упражнение");const{data:E,error:H}=await a.from("workout_sets").insert({workout_exercise_id:w.id,set_index:1,weight:null,reps:null,is_done:!1,is_dropset:!1,updated_at:new Date().toISOString()}).select("id, workout_exercise_id, set_index, weight, reps, is_done, is_dropset, updated_at");if(H)throw H;const L=E==null?void 0:E[0];if(!L)throw new Error("Не удалось создать подход");const re={...w,workout_sets:[L]};y(F=>{if(!F.workout)return F;const V=[...F.exercises,re].sort((W,me)=>W.position-me.position);if(r&&n){const W=`${r.id}:${n}`,me=G.get(W);me&&G.set(W,{workout:me.workout,exercises:V,timestamp:Date.now()})}return{...F,exercises:V}})}catch(s){console.error("Failed to add exercise:",s),alert("Не удалось добавить упражнение. Попробуйте снова.")}finally{u(!1)}}},Ie=async()=>{if(!(!r||!n)){le(!0);try{const{data:s,error:c}=await a.from("workouts").insert({user_id:r.id,workout_date:n,name:"Новая тренировка",template_id:null}).select().single();if(c)throw c;if(!s)throw new Error("Не удалось создать тренировку");ne(s),ae([]),m(s.name);const N=`${r.id}:${n}`;G.set(N,{workout:s,exercises:[],timestamp:Date.now()})}catch(s){console.error("Failed to create custom workout:",s),alert("Не удалось создать тренировку. Попробуйте снова.")}finally{le(!1)}}},De=async s=>{if(!(!r||!n)){le(!0);try{const[{data:c},{data:N}]=await Promise.all([a.from("template_exercises").select("*").eq("template_id",s.id),a.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]),w=(N==null?void 0:N.icon)??s.icon??null,E=(N==null?void 0:N.name)??s.name,{data:H}=await a.from("workouts").insert({user_id:r.id,workout_date:n,name:E,template_id:s.id,icon:w}).select().single();if(!H)throw new Error("Failed to create workout entry.");const L=(c||[]).map(W=>({workout_id:H.id,name:W.name,sets:W.sets,reps:W.reps,rest_seconds:W.rest_seconds,position:W.position})),{data:re}=await a.from("workout_exercises").insert(L).select();if(!re)throw new Error("Failed to create workout exercises.");const F=re.flatMap(W=>Array.from({length:W.sets},(me,pe)=>({workout_exercise_id:W.id,set_index:pe+1})));await a.from("workout_sets").insert(F);const V=`${r.id}:${n}`;G.delete(V),await I()}catch(c){console.error("Failed to create workout from template:",c),alert(`Не удалось создать тренировку: ${c.message}`)}finally{le(!1)}}},Ze=()=>{oe(B),fe(v),K(!0)},Ue=async()=>{if(!r||!n||!g)return;const s=se.trim();if(s.length===0){oe(B),fe(v),K(!1);return}const c=s!==g.name,N=we!==g.icon;if(!c&&!N){K(!1);return}C(!0);try{const w={};c&&(w.name=s),N&&(w.icon=we);const{data:E,error:H}=await a.from("workouts").update(w).eq("id",g.id).select().single();if(H)throw H;if(!E)throw new Error("Не удалось обновить тренировку");ne(E),oe(s),fe(E.icon),K(!1);const L=`${r.id}:${n}`;G.set(L,{workout:E,exercises:M,timestamp:Date.now()})}catch(w){console.error("Failed to update workout:",w),alert("Не удалось сохранить изменения. Попробуйте снова.")}finally{C(!1)}},et=()=>{oe(B),fe(v),K(!1)},tt=()=>{Ee(!0)},st=s=>{fe(s)},ze=async()=>{if(!r||!n||!g)return;const s=!O;k(s),T(!0);try{const{data:c,error:N}=await a.from("workouts").update({is_cardio:s}).eq("id",g.id).select().single();if(N)throw N;if(!c)throw new Error("Не удалось обновить статус кардио");ne(c);const w=`${r.id}:${n}`;G.set(w,{workout:c,exercises:M,timestamp:Date.now()})}catch(c){console.error("Failed to update cardio status:",c),alert("Не удалось сохранить статус кардио."),k(!s)}finally{T(!1)}},Le=$e(i,800),rt=o.useRef(i);o.useEffect(()=>{rt.current=i},[i]),o.useEffect(()=>{if(!r||!n||!g||Le===(g.notes??""))return;(async()=>{z(!0);try{const{error:c}=await a.from("workouts").update({notes:Le||null}).eq("id",g.id);if(c)throw c;const N=`${r.id}:${n}`,w=G.get(N);w&&w.workout&&G.set(N,{...w,workout:{...w.workout,notes:Le||null},timestamp:Date.now()})}catch(c){console.error("Failed to save notes:",c)}finally{z(!1)}})()},[Le,r,n,g==null?void 0:g.id]);const nt=()=>{g&&f(!0)},ot=async s=>{if(!r||!g)return;const c=new Map(s.map((w,E)=>[w.id,E+1]));ae(w=>{const E=w.map(H=>({...H,position:c.get(H.id)??H.position}));return E.sort((H,L)=>(H.position??0)-(L.position??0)),E});const N=s.map((w,E)=>({id:w.id,position:E+1}));try{if(await Promise.all(N.map(async w=>{const{error:E}=await a.from("workout_exercises").update({position:w.position}).eq("id",w.id);if(E)throw E})),r&&n){const w=`${r.id}:${n}`,E=G.get(w);if(E){const H=[...E.exercises].map(L=>({...L,position:c.get(L.id)??L.position})).sort((L,re)=>(L.position??0)-(re.position??0));G.set(w,{workout:E.workout,exercises:H,timestamp:Date.now()})}}}catch(w){console.error("Failed to save new order:",w),alert("Не удалось сохранить порядок. Я вернул предыдущие данные."),await I()}},it=async()=>{if(!g)return;const{error:s}=await a.from("workouts").delete().eq("id",g.id);if(s){console.error("Error deleting workout:",s),alert("Не удалось удалить тренировку.");return}if(r&&n){const c=`${r.id}:${n}`;G.delete(c)}d("/calendar",{state:{removedDate:n}})},at=()=>{he(!0)},ct=async s=>{if(!(!r||!n||!g))try{le(!0);const[{data:c,error:N},{data:w,error:E}]=await Promise.all([a.from("template_exercises").select("*").eq("template_id",s.id),a.from("workout_templates").select("id, name, icon").eq("id",s.id).single()]);if(N)throw N;if(E)throw E;const{data:H,error:L}=await a.from("workout_exercises").select("id").eq("workout_id",g.id);if(L)throw L;const re=(H||[]).map(Y=>Y.id);if(re.length>0){const{error:Y}=await a.from("workout_sets").delete().in("workout_exercise_id",re);if(Y)throw Y;const{error:Ne}=await a.from("workout_exercises").delete().eq("workout_id",g.id);if(Ne)throw Ne}const F=(w==null?void 0:w.icon)??s.icon??null,V=(w==null?void 0:w.name)??s.name,{error:W}=await a.from("workouts").update({name:V,template_id:s.id,icon:F}).eq("id",g.id);if(W)throw W;const me=(c||[]).map(Y=>({workout_id:g.id,name:Y.name,sets:Y.sets,reps:Y.reps,rest_seconds:Y.rest_seconds,position:Y.position})),{data:pe,error:xe}=await a.from("workout_exercises").insert(me).select();if(xe)throw xe;const je=(pe||[]).flatMap(Y=>Array.from({length:Y.sets},(Ne,lt)=>({workout_exercise_id:Y.id,set_index:lt+1})));if(je.length>0){const{error:Y}=await a.from("workout_sets").insert(je);if(Y)throw Y}const Me=`${r.id}:${n}`;G.delete(Me),he(!1),await I()}catch(c){console.error("Failed to replace workout from template:",c),alert(`Не удалось изменить тренировку: ${c.message}`)}finally{le(!1)}};return j?n?g?e.jsxs("div",{className:"relative px-4 space-y-4 pt-4 pb-10",children:[e.jsx("div",{className:`status-bar-blur ${Ce?"visible":""}`}),e.jsx(Nt,{normalizedDate:n,workoutName:B,isEditingName:S,editNameValue:se,isSavingWorkoutName:A,isScrolling:Ce,inputRef:be,onStartEditName:Ze,onChangeEditName:oe,onSaveEditName:Ue,onCancelEditName:et,actionsRef:X,actionsBtnRef:J,onToggleActions:ie,workoutIcon:v,editIconValue:we,onOpenIconPicker:tt}),e.jsx("div",{className:"space-y-4",children:M.map(s=>e.jsx(jt,{exercise:s,workoutDate:n,onUpdateExercise:ke,onDeleteExercise:Z},s.id))}),e.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[e.jsx("p",{className:"text-white text-lg font-bold mb-3 text-center",children:"Было кардио?"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>{O&&ze()},disabled:ee,className:`flex-1 py-2.5 px-4 rounded-xl font-medium transition duration-200 ease-in-out ${O?"bg-red-500/30 text-white border border-red-400/40 supports-[hover:hover]:hover:bg-red-500/40 supports-[hover:hover]:hover:shadow-sm":"bg-red-500/80 text-white shadow-lg border border-red-400/60"} active:brightness-100 disabled:cursor-not-allowed disabled:pointer-events-none focus:outline-none focus-visible:outline-none [-webkit-tap-highlight-color:transparent]`,children:"Нет"}),e.jsx("button",{onClick:()=>{O||ze()},disabled:ee,className:`flex-1 py-2.5 px-4 rounded-xl font-medium transition duration-200 ease-in-out ${O?"bg-green-500/80 text-white shadow-lg border border-green-400/60":"bg-green-500/30 text-white border border-green-400/40 supports-[hover:hover]:hover:bg-green-500/40 supports-[hover:hover]:hover:shadow-sm"} active:brightness-100 disabled:cursor-not-allowed disabled:pointer-events-none focus:outline-none focus-visible:outline-none [-webkit-tap-highlight-color:transparent]`,children:"Да"})]})]}),e.jsxs("div",{className:"glass card-dark p-4 rounded-md",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("p",{className:"text-white text-lg font-bold",children:"Заметки"}),h&&e.jsxs("span",{className:"text-xs text-gray-400 flex items-center gap-1",children:[e.jsx("span",{className:"w-3 h-3 border border-white/30 border-t-white rounded-full animate-spin"}),"Сохранение..."]})]}),e.jsx("textarea",{value:i,onChange:s=>ue(s.target.value),placeholder:"Как себя чувствовали, что получилось, над чем надо поработать",rows:5,className:"w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-400 text-sm resize-none focus:outline-none focus:ring-1 focus:ring-blue-500/50 focus:border-blue-500/50 transition-colors"})]}),e.jsx("div",{children:e.jsx("button",{type:"button",onClick:ve,disabled:P,className:"btn-glass btn-glass-full btn-glass-md btn-glass-primary disabled:opacity-50",children:P?"Добавление...":"Добавить упражнение"})}),e.jsx(St,{open:R,templates:D,isCreating:b,onClose:()=>he(!1),onReplaceWithTemplate:ct}),e.jsx(Ct,{open:Te,onClose:()=>Se(!1),items:M.map(s=>({id:s.id,name:s.name,position:s.position??0})),onSave:ot}),e.jsx(Ge,{open:l,onOpenChange:f,title:"Удалить тренировку?",description:`Вы собираетесь удалить тренировку на ${Re(n)}. Действие необратимо.`,confirmText:"Удалить",cancelText:"Отмена",variant:"danger",onConfirm:it}),e.jsx(It,{open:_e,value:we,onClose:()=>Ee(!1),onChange:st}),$&&te&&Ke.createPortal(e.jsxs("div",{className:"fixed menu-popover",style:{top:te.top,left:te.left,width:192},role:"menu",children:[e.jsx("button",{onClick:()=>{Q(),Se(!0)},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Поменять порядок упражнений"}),e.jsx("button",{onClick:()=>{Q(),at()},className:"w-full text-left px-4 py-2 hover:bg-white/10 text-gray-100 transition-colors rounded-lg",children:"Изменить тренировку"}),e.jsx("button",{onClick:()=>{Q(),nt()},className:"w-full text-left px-4 py-2 text-red-400 hover:bg-red-500/10 transition-colors rounded-lg",children:"Удалить"})]}),document.body)]}):b?e.jsx("div",{className:"px-4 pt-4",children:e.jsx(He,{message:"Создание..."})}):e.jsxs("div",{className:"max-w-lg mx-auto px-4 pt-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(Qe,{normalizedDate:n}),e.jsxs("h1",{className:"flex-1 text-xl font-bold text-center",children:["Тренировка на ",Re(n)]})]}),e.jsxs("div",{className:"mt-4 p-6 text-center",children:[D.length>0?e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Выбрать шаблон"}),e.jsx("div",{className:"space-y-2",children:D.map(s=>e.jsx("button",{onClick:()=>De(s),disabled:b,className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md disabled:opacity-50",children:s.name},s.id))})]}):e.jsxs("div",{className:"flex flex-col items-center space-y-3",children:[e.jsx("p",{className:"text-gray-400",children:"Сначала создайте шаблон."}),e.jsxs(ft,{to:"/templates/new",className:"btn-glass btn-glass-primary btn-glass-full btn-glass-md",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Создать шаблон"]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"button",onClick:Ie,disabled:b,className:"btn-dashed",children:"Создать свой день"})})]})]}):null:e.jsx(He,{message:"Загрузка..."})};export{zt as default};
