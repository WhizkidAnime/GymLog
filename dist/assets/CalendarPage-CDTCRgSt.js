import{u as O,s as K,j as a}from"./index-Bc8oTa1J.js";import{e as P,u as R,r as f,f as z}from"./vendor-BVca5W6X.js";import{u as q}from"./usePageState-6XNG0ilq.js";import{f as D,g as B,a as U,b as V}from"./date-helpers-BoyNci5t.js";import{W as G}from"./workout-icons-BPHmSILd.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const m=new Map,F=3e4,ae=()=>{var N,M;const{user:n}=O(),E=P(),h=R(),[Y,g]=q({key:"calendar-page",initialState:{currentDate:new Date,workouts:[],loading:!0,hasInitialData:!1},ttl:1800*1e3}),{currentDate:t,workouts:$,loading:W,hasInitialData:u}=Y,I=e=>{g(s=>({...s,currentDate:e}))},y=e=>{g(s=>({...s,workouts:e}))},b=e=>{g(s=>({...s,loading:e}))},x=e=>{g(s=>({...s,hasInitialData:e}))},l=f.useCallback(async(e=!1,s=!1)=>{if(!n)return;const o=`${n.id}:${t.getFullYear()}-${t.getMonth()}`,r=Date.now();let p=s;if(m.has(o)){const i=m.get(o),c=r-i.timestamp;if(e&&c<F){u||(y(i.workouts),b(!1),x(!0));return}c>=F&&(u||(y(i.workouts),x(!0)),p=!0)}p||b(!0);const w=new Date(t.getFullYear(),t.getMonth(),1),d=new Date(t.getFullYear(),t.getMonth()+1,0),{data:L,error:_}=await K.from("workouts").select("id, workout_date, template_id, icon, workout_templates(icon)").eq("user_id",n.id).gte("workout_date",D(w)).lte("workout_date",D(d));if(_)console.error("Error fetching workouts:",_);else{const i=(L||[]).map(c=>{var C;return{...c,template_icon:((C=c.workout_templates)==null?void 0:C.icon)||null,workout_icon:c.icon||null}});y(i),m.set(o,{workouts:i,timestamp:r})}b(!1),x(!0)},[n,t,u]);f.useEffect(()=>{u||l()},[t.getFullYear(),t.getMonth(),n]),f.useEffect(()=>{var o;if(!n||!((o=h.state)==null?void 0:o.removedDate))return;const s=`${n.id}:${t.getFullYear()}-${t.getMonth()}`;m.delete(s),l(!1,!1)},[(N=h.state)==null?void 0:N.removedDate,n,t,l]),f.useEffect(()=>{var o;if(!n||!((o=h.state)==null?void 0:o.refreshDate))return;const s=`${n.id}:${t.getFullYear()}-${t.getMonth()}`;m.delete(s),l(!1,!1)},[(M=h.state)==null?void 0:M.refreshDate,n,t,l]),f.useEffect(()=>{const e=()=>{document.visibilityState==="visible"&&l(!0)};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[l]);const S=B(t),T=U(t),A=["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],v=new Date,H=e=>{const s=new Date(t.getFullYear(),t.getMonth(),e);E(`/workout/${D(s)}`)},k=e=>{const s=new Date(t.getFullYear(),t.getMonth()+e,1);I(s),x(!1)},j=new Map;return $.forEach(e=>j.set(e.workout_date,e)),a.jsx("div",{className:"px-4 pt-4 pb-4 w-full max-w-5xl mx-auto flex flex-col items-center",children:W&&!u?a.jsx("div",{className:"fixed inset-0 flex items-center justify-center",style:{background:"transparent"},children:a.jsxs("div",{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"relative w-12 h-12",children:a.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),a.jsx("p",{className:"text-white text-center",children:"Загрузка календаря..."})]})}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex justify-between items-center mb-6 glass p-2 rounded-xl w-full max-w-xl",children:[a.jsx("button",{onClick:()=>k(-1),className:"p-2 rounded-full text-white transition-colors focus:outline-none",style:{WebkitTapHighlightColor:"transparent"},children:"<"}),a.jsx("h1",{className:"text-xl font-bold text-center capitalize",children:V(t)}),a.jsx("button",{onClick:()=>k(1),className:"p-2 rounded-full text-white transition-colors focus:outline-none",style:{WebkitTapHighlightColor:"transparent"},children:">"})]}),a.jsx("div",{className:"grid grid-cols-7 gap-3 text-center text-sm text-gray-500 mb-3 w-full max-w-xl",children:A.map(e=>a.jsx("div",{children:e},e))}),a.jsxs("div",{className:"grid grid-cols-7 gap-x-2 gap-y-4 w-full max-w-xl",children:[Array.from({length:T}).map((e,s)=>a.jsx("div",{},`empty-${s}`)),Array.from({length:S},(e,s)=>s+1).map(e=>{const s=e===v.getDate()&&t.getMonth()===v.getMonth()&&t.getFullYear()===v.getFullYear(),o=D(new Date(t.getFullYear(),t.getMonth(),e)),r=j.get(o),p=!!r,w=(r==null?void 0:r.workout_icon)||(r==null?void 0:r.template_icon),d=w?G[w]:null;return a.jsxs("div",{onClick:()=>H(e),className:"relative flex flex-col items-center justify-center h-12 w-10 sm:h-13 sm:w-11 md:h-14 md:w-12 lg:h-16 lg:w-14 cursor-pointer mx-auto overflow-visible focus:outline-none",style:{WebkitTapHighlightColor:"transparent"},children:[a.jsx("span",{className:`flex items-center justify-center h-8 w-8 sm:h-9 sm:w-9 md:h-10 md:w-10 lg:h-12 lg:w-12 rounded-full ${s?"bg-blue-600 text-white":"text-gray-100"} transition-colors`,children:e}),p&&a.jsx("div",{className:"pointer-events-none absolute -bottom-4 flex items-center justify-center",children:d?a.jsx("div",{className:"flex items-center justify-center",style:{color:d.color},children:z.createElement(d.component,{size:16,className:"opacity-90"})}):a.jsx("div",{className:"h-1.5 w-1.5 bg-blue-500 rounded-full"})})]},e)})]})]})})};export{ae as default};
