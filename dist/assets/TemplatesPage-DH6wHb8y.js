import{u as A,a as L,s as m,j as e,W as B}from"./index-DnCyT_Hf.js";import{e as M,r as o,f as j,L as P,c as R}from"./vendor-BVca5W6X.js";import{u as I}from"./usePageState-6XNG0ilq.js";import{C as F}from"./confirm-dialog-CKxUmst0.js";import{g as $}from"./template-sharing-BGRrxy0h.js";import{T as H}from"./template-saved-dialog-CzQqM-SW.js";import{u as Z}from"./use-workout-actions-menu-C-5wTXkz.js";import{W as E}from"./workout-icons-BL1p9R4x.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";import"./use-modal-scroll-lock-DlG-D3y9.js";const K="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='512'%20height='512'%20viewBox='0%200%2024%2024'%3e%3cpath%20fill='%23ffffff'%20d='M21%2014a1%201%200%200%200-1%201v4a1%201%200%200%201-1%201H5a1%201%200%200%201-1-1v-4a1%201%200%200%200-2%200v4a3%203%200%200%200%203%203h14a3%203%200%200%200%203-3v-4a1%201%200%200%200-1-1Zm-9.71%201.71a1%201%200%200%200%20.33.21a.94.94%200%200%200%20.76%200a1%201%200%200%200%20.33-.21l4-4a1%201%200%200%200-1.42-1.42L13%2012.59V3a1%201%200%200%200-2%200v9.59l-2.29-2.3a1%201%200%201%200-1.42%201.42Z'/%3e%3c/svg%3e",U=({id:r,name:k,onDeleted:l,onShare:N})=>{const{t:n}=L(),[i,d]=j.useState(!1),[C,c]=j.useState(!1),{isActionsOpen:u,menuPos:h,actionsRef:S,actionsBtnRef:v,toggleActions:_,closeActions:b}=Z(),f=()=>{b(),N(r,k)},x=()=>{b(),c(!0)},w=async()=>{if(!i){d(!0);try{const{error:p}=await m.from("template_exercises").delete().eq("template_id",r);if(p)throw p;const{error:g}=await m.from("workout_templates").delete().eq("id",r);if(g)throw g;l(r),c(!1)}catch(p){console.error("Error deleting template",p),alert(n.templates.deleteError)}finally{d(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{ref:v,onClick:_,className:"p-2 text-white hover:text-gray-300 transition-colors","aria-label":"Меню шаблона",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 8c1.1 0 2-1 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 1-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 1-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})})}),u&&h&&R.createPortal(e.jsxs("div",{ref:S,className:"fixed menu-popover space-y-0.5",style:{top:h.top,left:h.left,width:192},role:"menu",children:[e.jsx("button",{onClick:f,className:"w-full text-left px-4 py-2 text-sm text-gray-100 hover:bg-white/10 transition-colors rounded-lg",children:n.templates.share}),e.jsx("button",{onClick:x,disabled:i,className:"w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 disabled:opacity-50 transition-colors rounded-lg",children:i?n.templates.deleting:n.templates.delete})]}),document.body)]}),e.jsx(F,{open:C,onOpenChange:c,title:n.templates.deleteConfirm,description:n.templates.deleteConfirmDesc,confirmText:n.common.delete,cancelText:n.common.cancel,variant:"danger",onConfirm:w})]})},le=()=>{const{user:r}=A(),k=M(),{t:l}=L(),[N,n]=o.useState(!1),[i,d]=o.useState(null),[C,c]=o.useState(!1),[u,h]=o.useState(null),[S,v]=o.useState(!1),[_,b]=o.useState(null),[f,x]=I({key:"templates-page",initialState:{templates:[],loading:!0},ttl:1800*1e3}),{templates:w,loading:p}=f,g=t=>{x(a=>({...a,templates:t,loading:!1}))},D=t=>{x(a=>({...a,loading:t}))},T=j.useCallback(async()=>{if(!r)return;f.templates.length>0||D(!0);const{data:a,error:s}=await m.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).order("created_at",{ascending:!1});s?console.error("Error fetching templates:",s):g(a||[])},[r,f.templates.length]),O=t=>{x(a=>({...a,templates:a.templates.filter(s=>s.id!==t)})),T()},z=async t=>{var a;try{if((a=navigator.clipboard)!=null&&a.writeText)return await navigator.clipboard.writeText(t),{ok:!0}}catch(s){console.warn("clipboard writeText failed:",s)}try{const s=document.createElement("textarea");s.value=t,s.setAttribute("readonly",""),s.style.position="absolute",s.style.left="-9999px",document.body.appendChild(s),s.select();const y=document.execCommand("copy");return document.body.removeChild(s),y?{ok:!0}:{ok:!1,reason:"execCommand returned false"}}catch(s){return{ok:!1,reason:String(s)}}},W=async(t,a)=>{n(!0);try{const{data:s,error:y}=await m.from("template_exercises").select("name, sets, reps, rest_seconds, position").eq("template_id",t).order("position");if(y)throw y;if(!s||s.length===0){alert(l.templates.emptyTemplateError);return}const q=await $({name:a,exercises:s});h(q),c(!0),b(a)}catch(s){console.error("Error sharing template:",s),alert(l.templates.shareError+((s==null?void 0:s.message)||String(s)))}finally{n(!1)}};return o.useEffect(()=>{T()},[r,T]),o.useEffect(()=>{const t=m.channel("workout_templates_changes").on("postgres_changes",{event:"*",schema:"public",table:"workout_templates",filter:r?`user_id=eq.${r.id}`:void 0},()=>{(async()=>{if(!r)return;const{data:a}=await m.from("workout_templates").select("id, name, created_at, user_id, icon").eq("user_id",r.id).order("created_at",{ascending:!1});g(a||[])})()}).subscribe();return()=>{m.removeChannel(t)}},[r]),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"relative flex justify-start items-center mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold",children:l.templates.title}),e.jsx("div",{className:"absolute right-0 -top-3 h-10 w-28","aria-hidden":"true"})]}),i&&e.jsx(H,{open:!!i,onOpenChange:d,templateName:i}),p?e.jsx(B,{message:l.templates.loading}):w.length===0?e.jsx("div",{className:"mt-4 p-8 text-center glass",children:e.jsx("p",{className:"text-gray-500",children:l.templates.empty})}):e.jsx("div",{className:"space-y-3",children:w.map(t=>e.jsxs("div",{className:"relative p-4 glass card-dark flex items-center justify-between gap-3",children:[e.jsxs("button",{onClick:()=>window.location.hash=`#/templates/${t.id}`,className:"text-left flex-1 hover:opacity-90 flex items-center gap-3",children:[t.icon&&E[t.icon]&&e.jsx("div",{style:{color:E[t.icon].color},children:j.createElement(E[t.icon].component,{size:24})}),e.jsx("h2",{className:"font-semibold text-lg text-gray-100",children:t.name})]}),e.jsx(U,{id:t.id,name:t.name,onDeleted:O,onShare:W})]},t.id))}),e.jsxs("div",{className:"fixed left-0 right-0 bottom-[calc(env(safe-area-inset-bottom)+5.75rem)] z-30 flex justify-center gap-3",children:[e.jsx(P,{to:"/templates/new",className:"glass-button-create",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4v16m8-8H4"})})}),e.jsx("button",{onClick:()=>k("/templates/import"),className:"glass-button-create",title:"Импортировать шаблон",children:e.jsx("img",{src:K,alt:"Импорт шаблона",className:"h-5 w-5"})})]}),N&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:e.jsx("div",{className:"glass card-dark p-6 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white",children:l.templates.generatingLink})]})})}),C&&u&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:e.jsxs("div",{className:"glass card-dark p-6 rounded-xl max-w-lg w-[92%] max-h-[85vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:l.templates.shareTitle}),e.jsx("textarea",{readOnly:!0,value:u,rows:3,onFocus:t=>t.currentTarget.select(),className:"mb-4 w-full resize-none bg-black/30 text-gray-100 rounded-md p-3 font-mono text-xs leading-relaxed break-all max-h-[40vh] overflow-y-auto"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx("button",{onClick:async()=>{if(!u)return;v(!0);const t=await z(u);v(!1),t.ok?(d(`${_}`),setTimeout(()=>d(null),2e3),c(!1)):alert(l.templates.copyError+`

Error: `+t.reason)},className:"glass-button-create",children:S?l.common.copying:l.common.copy}),e.jsx("button",{onClick:()=>c(!1),className:"glass-button-danger",children:l.common.close})]})]})})]})};export{le as default};
