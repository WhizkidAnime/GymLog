import{u as I,s as C,a as H,j as e}from"./index-CMRT6TmP.js";import{r as x,e as Q}from"./vendor-BVca5W6X.js";import{u as E}from"./useDebounce-C2cqH541.js";import{c as L}from"./date-helpers-C_0boXDq.js";import{u as R}from"./use-scroll-restoration-CZtb4aM8.js";import{u as U}from"./usePageState-6XNG0ilq.js";import"./supabase-CWpvgLJU.js";import"./charts-33RH-A39.js";const $=180*1e3;function q(){const{user:g}=I(),[t,r]=U({key:"exercise-history-page",initialState:{searchQuery:"",results:[],loading:!1,hasSearched:!1,lastUpdated:null,lastQuery:null},ttl:1800*1e3}),{searchQuery:h,results:m,loading:y,hasSearched:k,lastUpdated:d,lastQuery:u}=t,o=x.useRef(0),w=x.useCallback(s=>{r(a=>({...a,searchQuery:s}))},[r]),N=x.useCallback(()=>{o.current+=1,r(s=>s.searchQuery===""&&s.results.length===0&&!s.hasSearched&&!s.loading&&s.lastUpdated===null&&s.lastQuery===null?s:{...s,searchQuery:"",results:[],hasSearched:!1,loading:!1,lastUpdated:null,lastQuery:null})},[r]),j=x.useCallback(async s=>{const a=s.trim();if(!g||!a){r(n=>({...n,results:[],hasSearched:!1,loading:!1,lastUpdated:null}));return}const l=++o.current;r(n=>o.current!==l?n:{...n,loading:!0,hasSearched:!0});try{const{data:n,error:f}=await C.from("workout_exercises").select(`
          id,
          name,
          workout_id,
          workout_sets (
            set_index,
            weight,
            reps,
            is_done,
            is_dropset,
            parent_set_index
          ),
          workouts!inner (
            id,
            workout_date,
            name,
            user_id
          )
        `).eq("workouts.user_id",g.id).ilike("name",`%${a}%`).order("workouts(workout_date)",{ascending:!1});if(f)throw f;const v=[];n&&n.forEach(c=>{if(!c.workouts)return;const D=(c.workout_sets||[]).map(i=>({setIndex:i.set_index,weight:i.weight,reps:i.reps,isDone:i.is_done,isDropset:i.is_dropset??!1,parentSetIndex:i.parent_set_index??null})).sort((i,p)=>{const S=i.isDropset?i.parentSetIndex??i.setIndex:i.setIndex,_=p.isDropset?p.parentSetIndex??p.setIndex:p.setIndex;return S!==_?S-_:i.isDropset!==p.isDropset?i.isDropset?1:-1:i.setIndex-p.setIndex});v.push({exerciseName:c.name,exerciseId:c.id,workoutDate:c.workouts.workout_date,workoutName:c.workouts.name,workoutId:c.workouts.id,sets:D})}),r(c=>o.current!==l?c:{...c,results:v,lastUpdated:Date.now(),lastQuery:a})}catch(n){console.error("Error searching exercises:",n),r(f=>o.current!==l?f:{...f,results:[]})}finally{r(n=>o.current!==l?n:{...n,loading:!1})}},[g,r]),b=x.useCallback(s=>{const a=s.trim();return a?!!(u===a&&d&&Date.now()-d<$):!1},[u,d]);return{pageState:t,searchQuery:h,results:m,loading:y,hasSearched:k,lastUpdated:d,lastQuery:u,setSearchQuery:w,clearSearch:N,searchExercises:j,shouldUseCache:b}}const K=()=>{const g=Q(),{t}=H(),{searchQuery:r,results:h,loading:m,hasSearched:y,setSearchQuery:k,clearSearch:d,searchExercises:u,shouldUseCache:o}=q(),w=E(r,500),N="scroll:exercise-history",j=x.useRef(null);x.useEffect(()=>{const s=w.trim();if(!s){d();return}o(s)||u(s)},[w,u,o,d]),R({key:N,enabled:h.length>0}),x.useEffect(()=>{const s=()=>{if(document.visibilityState==="visible"){const a=r.trim();a&&!o(a)&&u(a)}};return document.addEventListener("visibilitychange",s),()=>document.removeEventListener("visibilitychange",s)},[r,u,o]);const b=(s,a)=>{g(`/workout/${s}`,{state:{focusExerciseId:a}})};return e.jsxs("div",{className:"p-4 space-y-4 max-w-4xl mx-auto pt-safe",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:t.exerciseHistory.title}),e.jsx("div",{className:"glass card-dark rounded-full px-4 py-3 search-container",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-5 w-5 text-gray-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 21l-4.35-4.35m0 0A7.5 7.5 0 103.5 10.5a7.5 7.5 0 0013.15 6.15z"})}),e.jsx("input",{ref:j,type:"text",value:r,onChange:s=>k(s.target.value),placeholder:t.exerciseHistory.searchPlaceholder,"aria-label":t.exerciseHistory.searchAriaLabel,className:"flex-1 bg-transparent border-0 outline-none ring-0 focus:outline-none focus:ring-0 appearance-none text-white placeholder-white/60 text-base shadow-none search-input"}),e.jsx("button",{type:"button",onClick:()=>{var s;d(),(s=j.current)==null||s.focus()},"aria-label":t.common.clear,"aria-hidden":!r,className:`shrink-0 w-7 h-7 grid place-items-center rounded-full text-gray-400 hover:text-gray-200 hover:bg-white/10 transition ${r?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"h-4 w-4",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 6l12 12M18 6L6 18"})})})]})}),m&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"relative w-12 h-12",children:e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin"})}),e.jsx("p",{className:"text-white text-center",children:t.exerciseHistory.searching})]})}),!m&&y&&h.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-400 text-lg",children:t.exerciseHistory.notFound}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:t.exerciseHistory.notFoundHint})]}),!m&&!y&&!r&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-16 w-16 mx-auto text-gray-600 mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),e.jsx("p",{className:"text-gray-400 text-lg",children:t.exerciseHistory.emptyTitle}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:t.exerciseHistory.emptyHint})]}),!m&&h.length>0&&e.jsx("div",{className:"space-y-4",children:h.map((s,a)=>e.jsxs("div",{className:"glass card-dark rounded-lg p-4 hover:bg-white/5 transition-colors cursor-pointer",onClick:()=>b(s.workoutDate,s.exerciseId),children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-baseline justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-white leading-tight",children:s.exerciseName}),e.jsx("p",{className:"text-sm font-medium text-blue-400 shrink-0",children:L(s.workoutDate)})]}),e.jsx("p",{className:"text-sm text-gray-400 mt-0.5",children:s.workoutName})]}),e.jsx("div",{className:"space-y-2",children:s.sets.length>0?e.jsx("div",{className:"grid grid-cols-1 gap-2",children:s.sets.map((l,n)=>e.jsxs("div",{className:`grid grid-cols-[96px_1fr_1fr] items-center gap-2 px-3 py-2 rounded border ${l.isDropset?"bg-purple-500/10 border-purple-500/30 ml-4":"bg-gray-800/30 border-gray-700/60"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 whitespace-nowrap",children:[l.isDone&&e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-gray-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),l.isDropset?e.jsxs("span",{className:"text-sm text-purple-400 flex items-center gap-1",children:[e.jsx("span",{className:"text-xs",children:"↓"})," ",t.exerciseHistory.drop]}):e.jsxs("span",{className:"text-sm text-gray-400",children:[t.exerciseHistory.set," ",l.setIndex]})]}),e.jsxs("div",{className:"text-sm flex items-baseline gap-1 whitespace-nowrap tabular-nums",children:[e.jsxs("span",{className:"text-gray-400",children:[t.exerciseHistory.weight,":"]}),e.jsx("span",{className:"text-white",children:l.weight!==null?`${l.weight} ${t.common.kg}`:"—"})]}),e.jsxs("div",{className:"text-sm flex items-baseline gap-1 whitespace-nowrap tabular-nums",children:[e.jsxs("span",{className:"text-gray-400",children:[t.exerciseHistory.reps,":"]}),e.jsx("span",{className:"text-white",children:l.reps??"—"})]})]},n))}):e.jsx("p",{className:"text-sm text-gray-500",children:t.exerciseHistory.noSetsData})})]},`${s.workoutId}-${a}`))})]})};export{K as default};
